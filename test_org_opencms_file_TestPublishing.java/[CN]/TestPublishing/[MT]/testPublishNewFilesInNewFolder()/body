{
  CmsObject cms=getCmsObject();
  echo("Testing publishing new files in new folder");
  String source="/folder1/image1.gif";
  String newFolder="/new_folder/";
  String newFile=newFolder + "new_file";
  String newSibling=newFolder + "new_sibling";
  cms.createResource(newFolder,CmsResourceTypeFolder.C_RESOURCE_TYPE_ID);
  cms.unlockResource(newFolder);
  storeResources(cms,newFolder);
  CmsProject project=getTestProject(cms);
  cms.getRequestContext().setCurrentProject(project);
  cms.copyResource(source,newFile,I_CmsConstants.C_COPY_AS_NEW);
  cms.unlockResource(newFile);
  cms.copyResource(source,newSibling,I_CmsConstants.C_COPY_AS_SIBLING);
  cms.unlockResource(newSibling);
  echo("Publishing the resource directly");
  storeResources(cms,newFile);
  boolean error;
  try {
    OpenCmsTestLogAppender.setBreakOnError(false);
    cms.publishResource(newFile);
    error=true;
  }
 catch (  CmsSecurityException e) {
    error=false;
  }
  OpenCmsTestLogAppender.setBreakOnError(true);
  if (error) {
    fail("A resource in a new folder could be published without generating an error!");
  }
  assertFilter(cms,newFile,OpenCmsTestResourceFilter.FILTER_EQUAL);
  echo("Publishing another sibling");
  cms.lockResource(source);
  cms.touch(source,System.currentTimeMillis(),I_CmsConstants.C_DATE_UNCHANGED,I_CmsConstants.C_DATE_UNCHANGED,false);
  cms.unlockResource(source);
  storeResources(cms,newSibling);
  cms.publishResource(source,true,new CmsShellReport());
  assertFilter(cms,newSibling,OpenCmsTestResourceFilter.FILTER_EQUAL);
  echo("Publishing the test project");
  cms.publishProject();
  assertFilter(cms,newFile,OpenCmsTestResourceFilter.FILTER_EQUAL);
  assertFilter(cms,newSibling,OpenCmsTestResourceFilter.FILTER_EQUAL);
  echo("Publishing the offline project");
  cms.getRequestContext().setCurrentProject(cms.readProject("Offline"));
  cms.publishProject();
  assertFilter(cms,newFolder,OpenCmsTestResourceFilter.FILTER_PUBLISHRESOURCE);
  assertState(cms,newFolder,I_CmsConstants.C_STATE_UNCHANGED);
  assertFilter(cms,newFile,OpenCmsTestResourceFilter.FILTER_EQUAL);
  assertFilter(cms,newSibling,OpenCmsTestResourceFilter.FILTER_EQUAL);
  echo("Publishing the test project again");
  cms.getRequestContext().setCurrentProject(project);
  cms.publishProject();
  assertFilter(cms,newFile,OpenCmsTestResourceFilter.FILTER_PUBLISHRESOURCE);
  assertState(cms,newFile,I_CmsConstants.C_STATE_UNCHANGED);
  assertFilter(cms,newSibling,OpenCmsTestResourceFilter.FILTER_PUBLISHRESOURCE);
  assertState(cms,newSibling,I_CmsConstants.C_STATE_UNCHANGED);
}

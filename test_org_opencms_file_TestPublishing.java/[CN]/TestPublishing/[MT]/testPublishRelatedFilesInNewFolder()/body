{
  CmsObject cms=getCmsObject();
  echo("Testing publishing of related files in an unpublished folder");
  String folderName="/testFolder/";
  String fileName="/testFolder/testFile.gif";
  String srcName="sourceTest.html";
  cms.createResource(folderName,CmsResourceTypeFolder.RESOURCE_TYPE_ID);
  cms.createResource(fileName,CmsResourceTypeImage.getStaticTypeId());
  String content=CmsXmlPageFactory.createDocument(Locale.ENGLISH,CmsEncoder.ENCODING_UTF_8);
  CmsResource source=cms.createResource(srcName,CmsResourceTypeXmlPage.getStaticTypeId(),content.getBytes(CmsEncoder.ENCODING_UTF_8),null);
  CmsFile file=cms.readFile(srcName);
  CmsXmlPage page=CmsXmlPageFactory.unmarshal(cms,file);
  String element="test";
  page.addValue(element,Locale.ENGLISH);
  content="<img src='" + fileName + "'>";
  page.setStringValue(cms,element,Locale.ENGLISH,content);
  file.setContents(page.marshal());
  cms.writeFile(file);
  CmsPublishList pubList=OpenCms.getPublishManager().getPublishList(cms,source,false);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  CmsPublishList relatedList=OpenCms.getPublishManager().getRelatedResourcesToPublish(cms,pubList);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  assertTrue(relatedList.getDeletedFolderList().isEmpty());
  assertEquals(1,relatedList.getFolderList().size());
  assertEquals(1,relatedList.getFileList().size());
  CmsPublishList mergedList=OpenCms.getPublishManager().mergePublishLists(cms,pubList,relatedList);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  assertTrue(relatedList.getDeletedFolderList().isEmpty());
  assertEquals(1,relatedList.getFolderList().size());
  assertEquals(1,relatedList.getFileList().size());
  assertTrue(mergedList.getDeletedFolderList().isEmpty());
  assertEquals(1,mergedList.getFolderList().size());
  assertEquals(2,mergedList.getFileList().size());
}

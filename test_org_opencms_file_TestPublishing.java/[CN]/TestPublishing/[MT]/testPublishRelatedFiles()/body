{
  CmsObject cms=getCmsObject();
  echo("Testing publishing of related files");
  String resName="index.html";
  cms.lockResource(resName);
  cms.setDateLastModified(resName,System.currentTimeMillis(),false);
  CmsResource resource=cms.readResource(resName,CmsResourceFilter.DEFAULT);
  CmsPublishList pubList=OpenCms.getPublishManager().getPublishList(cms,resource,false);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  assertTrue(pubList.getFileList().contains(resource));
  CmsPublishList relatedList=OpenCms.getPublishManager().getRelatedResourcesToPublish(cms,pubList);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  assertTrue(pubList.getFileList().contains(resource));
  assertTrue(relatedList.getAllResources().isEmpty());
  String relResName="folder1/image2.gif";
  cms.lockResource(relResName);
  cms.setDateLastModified(relResName,System.currentTimeMillis(),false);
  CmsResource relatedRes=cms.readResource(relResName,CmsResourceFilter.DEFAULT);
  relatedList=OpenCms.getPublishManager().getRelatedResourcesToPublish(cms,pubList);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  assertTrue(pubList.getFileList().contains(resource));
  assertTrue(relatedList.getDeletedFolderList().isEmpty());
  assertTrue(relatedList.getFolderList().isEmpty());
  assertEquals(1,relatedList.getFileList().size());
  assertTrue(relatedList.getFileList().contains(relatedRes));
  CmsPublishList mergedList=OpenCms.getPublishManager().mergePublishLists(cms,pubList,relatedList);
  assertTrue(pubList.getDeletedFolderList().isEmpty());
  assertTrue(pubList.getFolderList().isEmpty());
  assertEquals(1,pubList.getFileList().size());
  assertTrue(pubList.getFileList().contains(resource));
  assertTrue(relatedList.getDeletedFolderList().isEmpty());
  assertTrue(relatedList.getFolderList().isEmpty());
  assertEquals(1,relatedList.getFileList().size());
  assertTrue(relatedList.getFileList().contains(relatedRes));
  assertTrue(mergedList.getDeletedFolderList().isEmpty());
  assertTrue(mergedList.getFolderList().isEmpty());
  assertEquals(2,mergedList.getFileList().size());
  assertTrue(mergedList.getFileList().contains(relatedRes));
  assertTrue(mergedList.getFileList().contains(resource));
}

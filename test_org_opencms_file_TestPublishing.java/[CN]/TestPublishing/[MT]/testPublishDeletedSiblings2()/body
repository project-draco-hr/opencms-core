{
  CmsObject cms=getCmsObject();
  String folder="/testdelete";
  String source="/testdelete/testdeletesib2-1.html";
  String sibling="/testdelete/testdeletesib2-2.html";
  echo("testing publishing of deleted siblings, 2nd issue");
  cms.createResource(folder,CmsResourceTypeFolder.RESOURCE_TYPE_ID);
  CmsResource src=cms.createResource(source,CmsResourceTypePlain.getStaticTypeId());
  CmsFile file=CmsFile.upgrade(src,cms);
  file.setContents("test text".getBytes());
  cms.writeFile(file);
  cms.createSibling(source,sibling,null);
  OpenCms.getPublishManager().publishResource(cms,folder);
  OpenCms.getPublishManager().waitWhileRunning();
  CmsProject online=cms.readProject(CmsProject.ONLINE_PROJECT_ID);
  CmsProject offline=cms.getRequestContext().currentProject();
  cms.getRequestContext().setCurrentProject(online);
  storeResources(cms,source);
  storeResources(cms,sibling);
  cms.getRequestContext().setCurrentProject(offline);
  cms.lockResource(sibling);
  cms.deleteResource(sibling,CmsResource.DELETE_REMOVE_SIBLINGS);
  cms.unlockResource(sibling);
  cms.getRequestContext().setCurrentProject(online);
  assertFilter(cms,source,OpenCmsTestResourceFilter.FILTER_EQUAL);
  assertFilter(cms,sibling,OpenCmsTestResourceFilter.FILTER_EQUAL);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,sibling,true,new CmsShellReport(cms.getRequestContext().getLocale()));
  OpenCms.getPublishManager().waitWhileRunning();
  cms.getRequestContext().setCurrentProject(online);
  assertFalse(cms.existsResource(sibling,CmsResourceFilter.ALL));
  assertFalse(cms.existsResource(source,CmsResourceFilter.ALL));
  cms.getRequestContext().setCurrentProject(offline);
  List list=cms.readDeletedResources(folder,false);
  assertEquals(2,list.size());
  CmsHistoryFile histFile=(CmsHistoryFile)list.get(0);
  assertEquals(cms.getRequestContext().addSiteRoot(source),histFile.getRootPath());
  assertEquals(2,histFile.getVersion());
  file=CmsFile.upgrade(histFile,cms);
  assertEquals(new String("test text".getBytes()),new String(file.getContents()));
  CmsHistoryFile histFile2=(CmsHistoryFile)list.get(1);
  assertEquals(cms.getRequestContext().addSiteRoot(sibling),histFile2.getRootPath());
  assertEquals(2,histFile2.getVersion());
  file=CmsFile.upgrade(histFile2,cms);
  assertEquals(new String("test text".getBytes()),new String(file.getContents()));
}

{
  CmsSimpleMail mail=new CmsSimpleMail();
  String fromAddress=from.getEmail();
  if (fromAddress == null || fromAddress.equals("")) {
    fromAddress=OpenCms.getSystemInfo().getMailSettings().getMailFromDefault();
  }
  if (fromAddress == null || fromAddress.equals("")) {
    throw new CmsException("[" + CmsTaskAction.class.getName() + "] "+ "Error in sending email,Unknown sender email address.",CmsException.C_BAD_NAME);
  }
  if (fromAddress.indexOf("@") == -1 || fromAddress.indexOf(".") == -1) {
    throw new CmsException("[" + CmsTaskAction.class.getName() + "] "+ "Error in sending email,Unknown sender email address: "+ fromAddress,CmsException.C_BAD_NAME);
  }
  if (to.size() == 0) {
    throw new CmsException("[" + CmsTaskAction.class.getName() + "] "+ "Error in sending email,Unknown recipient email address.",CmsException.C_BAD_NAME);
  }
 else   if (createAddresses) {
    List receivers=new ArrayList(to.size());
    for (int i=0; i < to.size(); i++) {
      CmsUser rec=(CmsUser)to.get(i);
      try {
        receivers.add(new InternetAddress(rec.getEmail()));
      }
 catch (      AddressException e) {
        throw new CmsException("[" + CmsTaskAction.class.getName() + "] "+ "Error in sending email, invalid recipient email address.",CmsException.C_BAD_NAME);
      }
    }
    mail.setTo(receivers);
  }
 else {
    mail.setTo(to);
  }
  try {
    mail.setFrom(fromAddress);
  }
 catch (  MessagingException e) {
    throw new CmsException("[" + CmsTaskAction.class.getName() + "] "+ "Error in sending email, invalid sender email address.",CmsException.C_BAD_NAME);
  }
  mail.setSubject(subject == null ? "" : subject);
  mail.setMsg(content == null ? "" : content);
  return mail;
}

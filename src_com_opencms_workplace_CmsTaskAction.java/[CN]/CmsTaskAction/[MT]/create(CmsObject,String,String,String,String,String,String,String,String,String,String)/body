{
  CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
  if (roleName.equals(C_ALL_ROLES)) {
    roleName=cms.readUser(agentName).getDefaultGroup().getName();
  }
  int priority=Integer.parseInt(priorityString);
  String splittetDate[]=Utils.split(timeoutString,".");
  GregorianCalendar cal=new GregorianCalendar(Integer.parseInt(splittetDate[2]),Integer.parseInt(splittetDate[1]) - 1,Integer.parseInt(splittetDate[0]),0,0,0);
  long timeout=cal.getTime().getTime();
  CmsTask task=cms.createTask(agentName,roleName,taskName,taskcomment,timeout,priority);
  cms.setTaskPar(task.getId(),C_TASKPARA_ACCEPTATION,paraAcceptation);
  cms.setTaskPar(task.getId(),C_TASKPARA_ALL,paraAll);
  cms.setTaskPar(task.getId(),C_TASKPARA_COMPLETION,paraCompletion);
  cms.setTaskPar(task.getId(),C_TASKPARA_DELIVERY,paraDelivery);
  String comment=lang.getLanguageValue("task.label.forrole") + ": " + roleName+ "\n";
  comment+=lang.getLanguageValue("task.label.editor") + ": " + Utils.getFullName(cms.readUser(agentName))+ "\n";
  comment+=taskcomment;
  cms.writeTaskLog(task.getId(),comment,C_TASKLOGTYPE_CREATED);
  StringBuffer contentBuf=new StringBuffer(lang.getLanguageValue("task.email.create.content"));
  contentBuf.append("\n");
  contentBuf.append(lang.getLanguageValue("task.label.project"));
  contentBuf.append(": ");
  String projectname="?";
  try {
    projectname=cms.readTask(task.getRoot()).getName();
  }
 catch (  Exception exc) {
  }
  contentBuf.append(projectname);
  contentBuf.append("\n");
  contentBuf.append(lang.getLanguageValue("task.label.task"));
  contentBuf.append(": ");
  contentBuf.append(task.getName());
  contentBuf.append("\n");
  contentBuf.append(lang.getLanguageValue("task.label.actuator"));
  contentBuf.append(": ");
  contentBuf.append(Utils.getFullName(cms.readOwner(task)));
  int projectid=cms.readProject(task).getId();
  String servletPath=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getServletPath();
  String serverName=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getServerName();
  CmsXmlWpConfigFile conf=new CmsXmlWpConfigFile(cms);
  String actionPath=conf.getWorkplaceActionPath();
  contentBuf.append("\n\n\nhttp://" + serverName + servletPath+ actionPath+ "login.html?startTaskId="+ task.getId()+ "&startProjectId="+ projectid);
  String subject=lang.getLanguageValue("task.email.create.subject");
  CmsUser[] users={cms.readAgent(task)};
  com.opencms.defaults.CmsMail mail=null;
  try {
    mail=new com.opencms.defaults.CmsMail(cms,cms.readOwner(task),users,subject,contentBuf.toString(),"text/plain");
  }
 catch (  CmsException e) {
    if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
      A_OpenCms.log(C_OPENCMS_INFO,"[CmsTaskAction] Could not generate mail while creating task for " + cms.readOwner(task).getName() + ". ");
      A_OpenCms.log(C_OPENCMS_INFO,"[CmsTaskAction] " + e);
    }
  }
  if (cms.getTaskPar(task.getId(),C_TASKPARA_ALL) != null) {
    if (cms.getTaskPar(task.getId(),C_TASKPARA_ALL).equals("checked")) {
      try {
        mail=new com.opencms.defaults.CmsMail(cms,cms.readOwner(task),cms.readGroup(task),subject,contentBuf.toString(),"text/plain");
      }
 catch (      CmsException e) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(C_OPENCMS_INFO,"[CmsTaskAction] Could not generate mail while creating task for " + cms.readOwner(task).getName() + ". ");
          A_OpenCms.log(C_OPENCMS_INFO,"[CmsTaskAction] " + e);
        }
      }
    }
  }
  if (mail != null) {
    mail.start();
  }
}

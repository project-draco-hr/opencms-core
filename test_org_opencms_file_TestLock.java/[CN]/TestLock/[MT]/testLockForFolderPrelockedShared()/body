{
  CmsObject cms=getCmsObject();
  echo("Testing locking of folders with shared prelocks");
  String folder="/folder1/subfolder12/";
  String source="/folder1/subfolder11/page1.html";
  String sibling1="/folder1/subfolder12/page1.html";
  String sibling2="/folder2/subfolder22/page1.html";
  storeResources(cms,folder);
  cms.lockResource(source);
  assertLock(cms,source,CmsLock.C_TYPE_EXCLUSIVE);
  assertLock(cms,sibling1,CmsLock.C_TYPE_SHARED_EXCLUSIVE);
  assertLock(cms,sibling2,CmsLock.C_TYPE_SHARED_EXCLUSIVE);
  cms.lockResource(folder);
  List resources=cms.getResourcesInFolder(folder,CmsResourceFilter.DEFAULT);
  Iterator i=resources.iterator();
  while (i.hasNext()) {
    CmsResource res=(CmsResource)i.next();
    if (cms.getSitePath(res).equals(sibling1)) {
      assertLock(cms,cms.getSitePath(res),CmsLock.C_TYPE_SHARED_INHERITED);
    }
 else {
      assertLock(cms,cms.getSitePath(res),CmsLock.C_TYPE_INHERITED);
    }
  }
  assertLock(cms,source,CmsLock.C_TYPE_EXCLUSIVE);
  assertLock(cms,sibling2,CmsLock.C_TYPE_SHARED_EXCLUSIVE);
  cms.unlockResource(folder);
  assertLock(cms,folder,CmsLock.C_TYPE_UNLOCKED);
  resources=cms.getResourcesInFolder(folder,CmsResourceFilter.DEFAULT);
  i=resources.iterator();
  while (i.hasNext()) {
    CmsResource res=(CmsResource)i.next();
    if (cms.getSitePath(res).equals(sibling1)) {
      assertLock(cms,cms.getSitePath(res),CmsLock.C_TYPE_SHARED_EXCLUSIVE);
    }
 else {
      assertLock(cms,cms.getSitePath(res),CmsLock.C_TYPE_UNLOCKED);
    }
  }
  assertLock(cms,source,CmsLock.C_TYPE_EXCLUSIVE);
  assertLock(cms,sibling2,CmsLock.C_TYPE_SHARED_EXCLUSIVE);
  cms.unlockResource(source);
  assertLock(cms,source,CmsLock.C_TYPE_UNLOCKED);
  assertLock(cms,sibling1,CmsLock.C_TYPE_UNLOCKED);
  assertLock(cms,sibling2,CmsLock.C_TYPE_UNLOCKED);
}

{
  CmsUser user=m_securityManager.readUser(userName);
  CmsProject project=null;
  try {
    project=m_securityManager.readProject(projectId);
  }
 catch (  CmsDbEntryNotFoundException e) {
    project=m_securityManager.readProject(CmsProject.ONLINE_PROJECT_ID);
  }
  String requestedResource=null;
  if (req != null) {
    requestedResource=getPathInfo(req);
  }
  if (requestedResource == null) {
    requestedResource="/";
  }
  String remoteAddr;
  if (req != null) {
    remoteAddr=req.getHeader(CmsRequestUtil.HEADER_X_FORWARDED_FOR);
    if (remoteAddr == null) {
      remoteAddr=req.getRemoteAddr();
    }
  }
 else {
    remoteAddr=CmsContextInfo.LOCALHOST;
  }
  CmsI18nInfo i18nInfo;
  if (m_localeManager.isInitialized()) {
    String resourceName;
    if (requestedResource.startsWith(CmsWorkplace.VFS_PATH_SYSTEM)) {
      resourceName=requestedResource;
    }
 else {
      resourceName=currentSite.concat(requestedResource);
    }
    i18nInfo=m_localeManager.getI18nInfo(req,user,project,resourceName);
  }
 else {
    i18nInfo=new CmsI18nInfo(Locale.ENGLISH,getSystemInfo().getDefaultEncoding());
  }
  requestedResource=CmsEncoder.decode(requestedResource);
  CmsContextInfo contextInfo=new CmsContextInfo(user,project,requestedResource,currentSite,i18nInfo.getLocale(),i18nInfo.getEncoding(),remoteAddr);
  return initCmsObject(contextInfo);
}

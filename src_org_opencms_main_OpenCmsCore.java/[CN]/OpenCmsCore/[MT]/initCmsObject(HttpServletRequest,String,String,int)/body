{
  CmsUser user=m_securityManager.readUser(userName);
  CmsProject project=m_securityManager.readProject(projectId);
  String requestedResource=null;
  if (req != null) {
    requestedResource=req.getPathInfo();
  }
  if (requestedResource == null) {
    requestedResource="/";
  }
  String remoteAddr;
  if (req != null) {
    remoteAddr=req.getHeader(I_CmsConstants.C_HEADER_X_FORWARDED_FOR);
    if (remoteAddr == null) {
      remoteAddr=req.getRemoteAddr();
    }
  }
 else {
    remoteAddr=I_CmsConstants.C_IP_LOCALHOST;
  }
  CmsI18nInfo i18nInfo;
  if (m_localeManager.isInitialized()) {
    String resourceName;
    if (requestedResource.startsWith(I_CmsWpConstants.C_VFS_PATH_SYSTEM)) {
      resourceName=requestedResource;
    }
 else {
      resourceName=currentSite.concat(requestedResource);
    }
    i18nInfo=m_localeManager.getI18nInfo(req,user,project,resourceName);
  }
 else {
    i18nInfo=new CmsI18nInfo(Locale.ENGLISH,getSystemInfo().getDefaultEncoding());
  }
  requestedResource=CmsEncoder.decode(requestedResource);
  CmsContextInfo contextInfo=new CmsContextInfo(user,project,requestedResource,currentSite,i18nInfo.getLocale(),i18nInfo.getEncoding(),remoteAddr);
  return initCmsObject(contextInfo);
}

{
  CmsObject cms=initCmsObjectFromSession(req);
  if (cms != null) {
    return cms;
  }
  CmsSite site=getSiteManager().matchRequest(req);
  I_CmsAuthorizationHandler.I_PrivilegedLoginAction loginAction=new I_CmsAuthorizationHandler.I_PrivilegedLoginAction(){
    private CmsObject m_adminCms;
    public CmsObject doLogin(    HttpServletRequest request,    String principal) throws CmsException {
      try {
        CmsUser user=m_adminCms.readUser(principal);
        if (!user.isEnabled()) {
          throw new CmsException(Messages.get().container(Messages.ERR_INVALID_INIT_USER_2,user.getName(),"-"));
        }
        CmsContextInfo contextInfo=new CmsContextInfo(m_adminCms.getRequestContext());
        contextInfo.setUserName(principal);
        return initCmsObject(m_adminCms,contextInfo);
      }
  finally {
        m_adminCms=null;
      }
    }
    public void setCmsObject(    CmsObject adminCms){
      m_adminCms=adminCms;
    }
  }
;
  loginAction.setCmsObject(initCmsObject(req,res,OpenCms.getDefaultUsers().getUserAdmin(),null,null));
  cms=m_authorizationHandler.initCmsObject(req,loginAction);
  if (cms != null) {
    return cms;
  }
  m_authorizationHandler.requestAuthorization(req,res,getLoginFormURL(req,res));
  cms=initCmsObject(req,m_securityManager.readUser(null,OpenCms.getDefaultUsers().getUserGuest()),site.getSiteRoot(),CmsProject.ONLINE_PROJECT_ID,"");
  return cms;
}

{
  CmsObject cms;
  HttpSession session=req.getSession(false);
  String sessionId;
  String userName=null;
  if (session != null) {
    sessionId=session.getId();
  }
 else {
    sessionId=req.getParameter("JSESSIONID");
  }
  if (sessionId != null) {
    userName=m_sessionInfoManager.getUser(sessionId).getName();
  }
  CmsSite site=getSiteManager().matchRequest(req);
  if (userName != null) {
    Integer project=m_sessionInfoManager.getCurrentProject(sessionId);
    String siteroot=null;
    if ((getSiteManager().getWorkplaceSiteMatcher().equals(site.getSiteMatcher()))) {
      siteroot=m_sessionInfoManager.getCurrentSite(sessionId);
    }
    if (siteroot == null) {
      siteroot=site.getSiteRoot();
    }
    cms=initCmsObject(req,userName,siteroot,project.intValue());
  }
 else {
    cms=initCmsObject(req,OpenCms.getDefaultUsers().getUserGuest(),site.getSiteRoot(),I_CmsConstants.C_PROJECT_ONLINE_ID);
    if (m_useBasicAuthentication) {
      checkBasicAuthorization(cms,req,res);
    }
  }
  return cms;
}

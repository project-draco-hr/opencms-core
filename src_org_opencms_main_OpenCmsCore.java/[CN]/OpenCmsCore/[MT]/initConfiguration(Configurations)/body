{
  m_conf=conf;
  m_defaultEncoding=getDefaultEncoding();
  m_defaultEncoding=conf.getString("defaultContentEncoding",m_defaultEncoding);
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". OpenCms encoding     : " + m_defaultEncoding);
  }
  String systemEncoding=null;
  try {
    systemEncoding=System.getProperty("file.encoding");
  }
 catch (  SecurityException se) {
  }
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". System file.encoding : " + systemEncoding);
  }
  if (!m_defaultEncoding.equals(systemEncoding)) {
    String msg="OpenCms startup failure: System file.encoding '" + systemEncoding + "' not equal to OpenCms encoding '"+ m_defaultEncoding+ "'";
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL))     OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,". Critical init error/1: " + msg);
    throw new Exception(msg);
  }
  try {
    if (!java.nio.charset.Charset.isSupported(m_defaultEncoding)) {
      m_defaultEncoding=OpenCms.getDefaultEncoding();
    }
  }
 catch (  Throwable t) {
  }
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Encoding set to      : " + m_defaultEncoding);
  }
  String ethernetAddress=conf.getString("server.ethernet.address",CmsUUID.getDummyEthernetAddress());
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Ethernet address used: " + ethernetAddress);
  }
  CmsUUID.init(ethernetAddress);
  try {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      String jdkinfo=System.getProperty("java.vm.name") + " ";
      jdkinfo+=System.getProperty("java.vm.version") + " ";
      jdkinfo+=System.getProperty("java.vm.info") + " ";
      jdkinfo+=System.getProperty("java.vm.vendor") + " ";
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Java VM in use       : " + jdkinfo);
      String osinfo=System.getProperty("os.name") + " ";
      osinfo+=System.getProperty("os.version") + " ";
      osinfo+=System.getProperty("os.arch") + " ";
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Operating sytem      : " + osinfo);
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL))     OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,". Critical init error/2: " + e.getMessage());
    throw e;
  }
  m_defaultUsers=CmsDefaultUsers.initialize(conf);
  try {
    m_driverManager=CmsDriverManager.newInstance(conf);
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,". Critical init error/3: " + e.getMessage());
    }
    throw new CmsException("Database init failed",CmsException.C_RB_INIT_ERROR,e);
  }
  try {
    Hashtable mimeTypes=m_driverManager.readMimeTypes();
    setMimeTypes(mimeTypes);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Found mime types     : " + mimeTypes.size() + " entrys");
    }
    if (!new Boolean(System.getProperty("opencms.disableScheduler")).booleanValue()) {
      m_table=new CmsCronTable(m_driverManager.readCronTable());
      m_scheduler=new CmsCronScheduler(this,m_table);
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT))       OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". OpenCms scheduler    : enabled");
    }
 else {
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT))       OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". OpenCms scheduler    : disabled");
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,". Critical init error/5: " + e.getMessage());
    }
    throw e;
  }
  m_linkManager=new CmsLinkManager();
  String flexExportUrl=conf.getString(CmsJspLoader.C_LOADER_JSPEXPORTURL,null);
  if (null != flexExportUrl) {
    if (flexExportUrl.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
      flexExportUrl=flexExportUrl.substring(0,flexExportUrl.length() - 1);
    }
    setRuntimeProperty(CmsJspLoader.C_LOADER_JSPEXPORTURL,flexExportUrl);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". JSP export URL       : using value from opencms.properties - " + flexExportUrl);
    }
  }
  Boolean flexErrorPageCommit=conf.getBoolean(CmsJspLoader.C_LOADER_ERRORPAGECOMMIT,new Boolean(true));
  setRuntimeProperty(CmsJspLoader.C_LOADER_ERRORPAGECOMMIT,flexErrorPageCommit);
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". JSP errorPage commit : " + (flexErrorPageCommit.booleanValue() ? "enabled" : "disabled"));
  }
  try {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Flex cache init      : starting");
    }
    new CmsFlexCache(conf);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Flex cache init      : finished");
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Flex cache init      : non-critical error " + e.toString());
    }
  }
  try {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". ResourceLoader init  : starting");
    }
    m_loaderManager=new CmsLoaderManager(conf);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". ResourceLoader init  : finished");
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". ResourceLoader init  : non-critical error " + e.toString());
    }
  }
  try {
    boolean translationEnabled=conf.getBoolean("directory.translation.enabled",false);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Directory translation: " + (translationEnabled ? "enabled" : "disabled"));
    }
    if (translationEnabled) {
      String[] translations=conf.getStringArray("directory.translation.rules");
      m_directoryTranslator=new CmsResourceTranslator(translations,false);
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Directory translation: non-critical error " + e.toString());
    }
  }
  if (m_directoryTranslator == null)   m_directoryTranslator=new CmsResourceTranslator(new String[0],false);
  try {
    boolean translationEnabled=conf.getBoolean("filename.translation.enabled",false);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Filename translation : " + (translationEnabled ? "enabled" : "disabled"));
    }
    if (translationEnabled) {
      String[] translations=conf.getStringArray("filename.translation.rules");
      m_fileTranslator=new CmsResourceTranslator(translations,true);
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Filename translation : non-critical error " + e.toString());
    }
  }
  if (m_fileTranslator == null)   m_fileTranslator=new CmsResourceTranslator(new String[0],false);
  m_defaultFilenames=null;
  try {
    m_defaultFilenames=conf.getStringArray("directory.default.files");
    for (int i=0; i < m_defaultFilenames.length; i++) {
      m_defaultFilenames[i]=m_defaultFilenames[i].trim();
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
        OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Default file         : " + (i + 1) + " - "+ m_defaultFilenames[i]);
      }
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Default file         : non-critical error " + e.toString());
    }
  }
  if (m_defaultFilenames == null) {
    m_defaultFilenames=new String[0];
  }
  String[] immuResources=conf.getStringArray("import.immutable.resources");
  if (immuResources == null)   immuResources=new String[0];
  List immutableResourcesOri=java.util.Arrays.asList(immuResources);
  ArrayList immutableResources=new ArrayList();
  for (int i=0; i < immutableResourcesOri.size(); i++) {
    String path=((String)immutableResourcesOri.get(i)).trim();
    if (path != null && !"".equals(path)) {
      immutableResources.add(path);
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
        OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Immutable resource   : " + (i + 1) + " - "+ path);
      }
    }
  }
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Immutable resources  : " + ((immutableResources.size() > 0) ? "enabled" : "disabled"));
  }
  setRuntimeProperty("import.immutable.resources",immutableResources);
  try {
    m_userDefaultLanguage=conf.getString("workplace.user.default.language",I_CmsWpConstants.C_DEFAULT_LANGUAGE);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". User data init       : Default language is '" + m_userDefaultLanguage + "'");
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". User data init       : non-critical error " + e.toString());
    }
  }
  m_passwordValidatingClass=conf.getString("passwordvalidatingclass","com.opencms.util.PasswordValidtation");
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Password validation  : " + m_passwordValidatingClass);
  }
  Integer fileMaxUploadSize=new Integer(conf.getInteger("workplace.file.maxuploadsize",-1));
  setRuntimeProperty("workplace.file.maxuploadsize",fileMaxUploadSize);
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". File max. upload size: " + (fileMaxUploadSize.intValue() > 0 ? (fileMaxUploadSize + " KB") : "unlimited"));
  }
  Boolean showUserGroupIcon=conf.getBoolean("workplace.administration.showusergroupicon",new Boolean(true));
  setRuntimeProperty("workplace.administration.showusergroupicon",showUserGroupIcon);
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Show user/group icon : " + (showUserGroupIcon.booleanValue() ? "yes" : "no"));
  }
  try {
    List resourceInitClasses=OpenCms.getRegistry().getResourceInit();
    Iterator i=resourceInitClasses.iterator();
    while (i.hasNext()) {
      String currentClass=(String)i.next();
      try {
        m_checkFile.add(Class.forName(currentClass).newInstance());
        if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
          OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Resource init class  : " + currentClass + " instanciated");
        }
      }
 catch (      Exception e1) {
        if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
          OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Resource init class  : non-critical error " + e1.toString());
        }
      }
    }
  }
 catch (  Exception e2) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Resource init class  : non-critical error " + e2.toString());
    }
  }
  String propertyDialogHandler=OpenCms.getRegistry().getPropertyDialogHandler();
  try {
    setRuntimeProperty("propertydialoghandler",Class.forName(propertyDialogHandler).newInstance());
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Property dialog class: " + propertyDialogHandler);
    }
  }
 catch (  Exception e) {
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Property dialog class: non-critical error " + e.toString());
    }
  }
  m_siteManager=CmsSiteManager.initialize(conf);
  Boolean supportOldLocales=conf.getBoolean("compatibility.support.oldlocales",new Boolean(false));
  setRuntimeProperty("compatibility.support.oldlocales",supportOldLocales);
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Old locale support   : " + (supportOldLocales.booleanValue() ? "enabled" : "disabled"));
  }
  String webappUrl=conf.getString("compatibility.support.import.old.webappurl",null);
  if (webappUrl != null) {
    setRuntimeProperty("compatibility.support.import.old.webappurl",webappUrl);
  }
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Old webapp URL       : " + ((webappUrl == null) ? "not set!" : webappUrl));
  }
  String[] propNames=conf.getStringArray("compatibility.support.import.remove.propertytags");
  if (propNames == null)   propNames=new String[0];
  List propertyNamesOri=java.util.Arrays.asList(propNames);
  ArrayList propertyNames=new ArrayList();
  for (int i=0; i < propertyNamesOri.size(); i++) {
    String name=((String)propertyNamesOri.get(i)).trim();
    if (name != null && !"".equals(name)) {
      propertyNames.add(name);
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
        OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Clear import property: " + (i + 1) + " - "+ name);
      }
    }
  }
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Remove properties    : " + ((propertyNames.size() > 0) ? "enabled" : "disabled"));
  }
  setRuntimeProperty("compatibility.support.import.remove.propertytags",propertyNames);
  String[] appNames=conf.getStringArray("compatibility.support.webAppNames");
  if (appNames == null) {
    appNames=new String[0];
  }
  List webAppNamesOri=java.util.Arrays.asList(appNames);
  ArrayList webAppNames=new ArrayList();
  for (int i=0; i < webAppNamesOri.size(); i++) {
    String name=((String)webAppNamesOri.get(i)).trim();
    if (name != null && !"".equals(name)) {
      webAppNames.add(name);
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
        OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Old context path     : " + (i + 1) + " - "+ name);
      }
    }
  }
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Old context support  : " + ((webAppNames.size() > 0) ? "enabled" : "disabled"));
  }
  setRuntimeProperty("compatibility.support.webAppNames",webAppNames);
  m_exportProperties=new CmsStaticExportManager();
  m_exportProperties.setStaticExportEnabled("true".equalsIgnoreCase(conf.getString("staticexport.enabled","false")));
  m_exportProperties.setExportPropertyDefault("true".equalsIgnoreCase(conf.getString("staticexport.export_default","false")));
  String[] exportSuffixes=conf.getStringArray("staticexport.export_suffixes");
  if (exportSuffixes == null) {
    exportSuffixes=new String[0];
  }
  m_exportProperties.setExportSuffixes(exportSuffixes);
  m_exportProperties.setExportPath(com.opencms.boot.CmsBase.getAbsoluteWebPath(CmsBase.getAbsoluteWebPath(conf.getString("staticexport.export_path"))));
  String rfsPrefix=conf.getString("staticexport.prefix_rfs","${CONTEXT_NAME}/export");
  String vfsPrefix=conf.getString("staticexport.prefix_vfs","${CONTEXT_NAME}${SERVLET_NAME}");
  String contextName="/" + CmsBase.getWebAppName();
  if ("/ROOT".equals(contextName))   contextName="";
  String servletName=conf.getString("servlet.mapping");
  rfsPrefix=CmsStringSubstitution.substitute(rfsPrefix,"${CONTEXT_NAME}",contextName);
  rfsPrefix=CmsStringSubstitution.substitute(rfsPrefix,"${SERVLET_NAME}",servletName);
  vfsPrefix=CmsStringSubstitution.substitute(vfsPrefix,"${CONTEXT_NAME}",contextName);
  vfsPrefix=CmsStringSubstitution.substitute(vfsPrefix,"${SERVLET_NAME}",servletName);
  m_exportProperties.setRfsPrefix(rfsPrefix);
  m_exportProperties.setVfsPrefix(vfsPrefix);
  m_exportProperties.setExportRelativeLinks(conf.getBoolean("staticexport.relative_links",false));
  m_exportProperties.setExportnames();
  if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INIT)) {
    OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Static export        : " + (m_exportProperties.isStaticExportEnabled() ? "enabled" : "disabled"));
    if (m_exportProperties.isStaticExportEnabled()) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Export default       : " + m_exportProperties.getExportPropertyDefault());
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Export path          : " + m_exportProperties.getExportPath());
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Export rfs prefix    : " + m_exportProperties.getRfsPrefix());
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Export vfs prefix    : " + m_exportProperties.getVfsPrefix());
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INIT,". Export link style    : " + (m_exportProperties.relativLinksInExport() ? "relative" : "absolute"));
    }
  }
}

{
  CmsFlexController.removeController(req);
  boolean canWrite=(!res.isCommitted() && !res.containsHeader("Location"));
  int status=-1;
  boolean isGuest=true;
  if (t instanceof ServletException) {
    ServletException s=(ServletException)t;
    if (s.getRootCause() != null) {
      t=s.getRootCause();
    }
  }
 else   if (t instanceof CmsSecurityException) {
    if (canWrite) {
      try {
        m_authorizationHandler.requestAuthorization(req,res,getLoginFormURL(req,res));
      }
 catch (      IOException ioe) {
      }
      return;
    }
  }
 else   if (t instanceof CmsDbEntryNotFoundException) {
    status=HttpServletResponse.SC_SERVICE_UNAVAILABLE;
    isGuest=false;
  }
 else   if (t instanceof CmsVfsResourceNotFoundException) {
    status=HttpServletResponse.SC_NOT_FOUND;
  }
 else   if (t instanceof CmsException) {
    if (t.getCause() != null) {
      t=t.getCause();
    }
    LOG.error(t.getLocalizedMessage(),t);
  }
  if (status < 1) {
    status=HttpServletResponse.SC_INTERNAL_SERVER_ERROR;
  }
  res.setStatus(status);
  try {
    if ((cms != null) && (cms.getRequestContext().currentUser() != null)) {
      isGuest=isGuest && (cms.getRequestContext().currentUser().isGuestUser() || cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupGuests()));
    }
  }
 catch (  CmsException e) {
    LOG.error(e.getLocalizedMessage(),e);
  }
  if (canWrite) {
    res.setContentType("text/html");
    CmsRequestUtil.setNoCacheHeaders(res);
    if (!isGuest && (cms != null) && !cms.getRequestContext().currentProject().isOnlineProject()) {
      try {
        res.setStatus(HttpServletResponse.SC_OK);
        res.getWriter().print(createErrorBox(t,req,cms));
      }
 catch (      IOException e) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
 else {
      try {
        res.sendError(status,t.toString());
      }
 catch (      IOException e) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
  }
}

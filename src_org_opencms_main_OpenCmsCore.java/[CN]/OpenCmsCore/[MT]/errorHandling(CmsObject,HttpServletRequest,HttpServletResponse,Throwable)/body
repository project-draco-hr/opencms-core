{
  boolean canWrite=!res.isCommitted() && !res.containsHeader("Location");
  int status=-1;
  boolean isNotGuest=false;
  if (t instanceof ServletException) {
    ServletException s=(ServletException)t;
    if (s.getRootCause() != null) {
      t=s.getRootCause();
    }
  }
 else   if (t instanceof CmsSecurityException) {
    if (canWrite) {
      try {
        requestAuthorization(req,res);
      }
 catch (      IOException ioe) {
      }
      return;
    }
  }
 else   if (t instanceof CmsDbEntryNotFoundException) {
    status=HttpServletResponse.SC_SERVICE_UNAVAILABLE;
    isNotGuest=true;
  }
 else   if (t instanceof CmsVfsResourceNotFoundException) {
    status=HttpServletResponse.SC_NOT_FOUND;
  }
 else   if (t instanceof CmsException) {
    if (t.getCause() != null) {
      t=t.getCause();
    }
  }
  if (status < 1) {
    status=HttpServletResponse.SC_INTERNAL_SERVER_ERROR;
  }
  res.setStatus(status);
  try {
    isNotGuest=isNotGuest || (cms != null && cms.getRequestContext().currentUser() != null && (!OpenCms.getDefaultUsers().getUserGuest().equals(cms.getRequestContext().currentUser().getName())) && ((cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupUsers())) || (cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupProjectmanagers())) || (cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupAdministrators()))));
  }
 catch (  CmsException e) {
  }
  if (canWrite) {
    res.setContentType("text/html");
    res.setHeader(I_CmsConstants.C_HEADER_CACHE_CONTROL,I_CmsConstants.C_HEADER_VALUE_NO_CACHE);
    res.setHeader(I_CmsConstants.C_HEADER_PRAGMA,I_CmsConstants.C_HEADER_VALUE_NO_CACHE);
    if (isNotGuest && cms != null) {
      try {
        res.getWriter().print(createErrorBox(t,req,cms));
      }
 catch (      IOException e) {
      }
    }
 else {
      try {
        res.sendError(status,t.toString());
      }
 catch (      IOException e) {
      }
    }
  }
}

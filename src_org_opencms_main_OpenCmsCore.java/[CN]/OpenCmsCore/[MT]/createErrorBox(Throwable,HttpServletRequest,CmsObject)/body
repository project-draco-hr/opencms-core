{
  Properties htmlProps=new Properties();
  try {
    htmlProps.load(getClass().getClassLoader().getResourceAsStream(C_FILE_HTML_MESSAGES));
  }
 catch (  Throwable thr) {
    if (getLog(this).isErrorEnabled()) {
      getLog(this).error("Could not load " + C_FILE_HTML_MESSAGES,thr);
    }
  }
  Locale locale=null;
  HttpSession session=request.getSession(false);
  if (session != null) {
    CmsWorkplaceSettings settings=(CmsWorkplaceSettings)session.getAttribute(CmsWorkplace.C_SESSION_WORKPLACE_SETTINGS);
    if (settings != null) {
      locale=settings.getUserSettings().getLocale();
    }
  }
  if (locale == null) {
    CmsAcceptLanguageHeaderParser headerParser=new CmsAcceptLanguageHeaderParser(request);
    List locales=headerParser.getAcceptedLocales();
    if (locales != null && locales.size() > 0) {
      locale=(Locale)locales.get(0);
    }
 else {
      locale=Locale.ENGLISH;
    }
  }
  CmsMessages messages=new CmsMessages(CmsWorkplaceMessages.C_BUNDLE_NAME,locale);
  Throwable cause=CmsFlexController.getThrowable(request);
  if (cause == null) {
    cause=t;
  }
  String errorHtml;
  errorHtml=htmlProps.getProperty("C_ERROR_DIALOG_START") + htmlProps.getProperty("C_STYLES") + htmlProps.getProperty("C_ERROR_DIALOG_END");
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${title}",messages.key("error.system.message"));
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${encoding}",getSystemInfo().getDefaultEncoding());
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${warnimageuri}",CmsWorkplace.getSkinUri() + "explorer/report_error.gif");
  if (cause.getLocalizedMessage() != null) {
    errorHtml=CmsStringSubstitution.substitute(errorHtml,"${message}","<p><b>" + CmsStringSubstitution.substitute(cause.getLocalizedMessage(),"\n","\n<br>") + "</b></p>");
  }
 else {
    errorHtml=CmsStringSubstitution.substitute(errorHtml,"${message}","<p><b>" + CmsStringSubstitution.substitute(cause.toString(),"\n","\n<br>") + "</b></p>");
  }
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${resource_key}",messages.key("error.system.resource"));
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${version_key}",messages.key("error.system.version"));
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${context_key}",messages.key("error.system.context"));
  String errorUri=CmsFlexController.getThrowableResourceUri(request);
  if (errorUri == null) {
    errorUri=cms.getRequestContext().getUri();
  }
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${resource}",errorUri);
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${version}",getSystemInfo().getVersionName());
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${context}",getSystemInfo().getOpenCmsContext());
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${bt_close}",messages.key("button.close"));
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${bt_details}",messages.key("button.detail"));
  String exception=CmsException.getStackTraceAsString(cause);
  exception=CmsStringSubstitution.substitute(exception,"\\","\\\\");
  exception=CmsStringSubstitution.substitute(exception,"\r\n","\\n");
  exception=CmsStringSubstitution.substitute(exception,"\n","\\n");
  String details="<html><body bgcolor='#fffff'><pre>" + exception + "</pre></body></html>";
  errorHtml=CmsStringSubstitution.substitute(errorHtml,"${details}",details);
  return errorHtml;
}

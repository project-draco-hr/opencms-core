{
  CmsObject cms=new CmsObject();
  CmsUser user=m_driverManager.readUser(userName);
  CmsProject project=m_driverManager.readProject(projectId);
  String requestedResource=null;
  if (req != null) {
    requestedResource=req.getPathInfo();
  }
  if (requestedResource == null) {
    requestedResource="/";
  }
  String remoteAddr;
  if (req != null) {
    remoteAddr=req.getHeader(I_CmsConstants.C_HEADER_X_FORWARDED_FOR);
    if (remoteAddr == null) {
      remoteAddr=req.getRemoteAddr();
    }
  }
 else {
    remoteAddr=I_CmsConstants.C_IP_LOCALHOST;
  }
  Locale locale=null;
  String encoding=null;
  CmsI18nInfo i18nInfo;
  if (getLocaleManager() != null) {
    if (requestedResource.startsWith(I_CmsWpConstants.C_VFS_PATH_WORKPLACE) || requestedResource.startsWith(I_CmsWpConstants.C_VFS_PATH_MODULES) || requestedResource.startsWith(I_CmsWpConstants.C_VFS_PATH_LOGIN)) {
      i18nInfo=getWorkplaceManager().getI18nInfo(req,user,project,currentSite.concat(requestedResource));
    }
 else {
      i18nInfo=getLocaleManager().getLocaleHandler().getI18nInfo(req,user,project,currentSite.concat(requestedResource));
    }
    if (req != null) {
      String localeParam;
      if ((localeParam=req.getParameter(I_CmsConstants.C_PARAMETER_LOCALE)) != null) {
        locale=CmsLocaleManager.getLocale(localeParam);
      }
      encoding=req.getParameter(I_CmsConstants.C_PARAMETER_ENCODING);
    }
    if (locale == null) {
      locale=i18nInfo.getLocale();
    }
    if (encoding == null) {
      encoding=i18nInfo.getEncoding();
    }
    if (locale == null) {
      locale=getLocaleManager().getDefaultLocale();
      if (OpenCms.getLog(this).isDebugEnabled()) {
        OpenCms.getLog(this).debug("No locale found - using default: " + locale);
      }
    }
    if (encoding == null) {
      encoding=getSystemInfo().getDefaultEncoding();
      if (OpenCms.getLog(this).isDebugEnabled()) {
        OpenCms.getLog(this).debug("No encoding found - using default: " + encoding);
      }
    }
  }
 else {
    locale=Locale.ENGLISH;
    encoding=getSystemInfo().getDefaultEncoding();
  }
  CmsRequestContext context=new CmsRequestContext(user,project,requestedResource,currentSite,locale,encoding,remoteAddr,m_directoryTranslator,m_fileTranslator);
  cms.init(m_driverManager,context,sessionStorage);
  return cms;
}

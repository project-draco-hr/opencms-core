{
  CmsObject adminCms;
  try {
    adminCms=initCmsObject(req,res,getDefaultUsers().getUserAdmin(),null);
  }
 catch (  CmsException e) {
    throw new IOException(Messages.get().getBundle().key(Messages.ERR_INVALID_INIT_USER_2,getDefaultUsers().getUserAdmin(),null));
  }
  String path=adminCms.getRequestContext().getUri();
  CmsProperty propertyLoginForm=null;
  String redirectURL=null;
  try {
    propertyLoginForm=adminCms.readPropertyObject(path,CmsPropertyDefinition.PROPERTY_LOGIN_FORM,true);
  }
 catch (  Throwable t) {
    if (LOG.isWarnEnabled()) {
      LOG.warn(Messages.get().getBundle().key(Messages.LOG_ERROR_READING_AUTH_PROP_2,CmsPropertyDefinition.PROPERTY_LOGIN_FORM,path),t);
    }
  }
  CmsHttpAuthenticationSettings httpAuthenticationSettings=getSystemInfo().getHttpAuthenticationSettings();
  String pathWithParams=CmsRequestUtil.encodeParamsWithUri(path,req);
  if (propertyLoginForm != null && propertyLoginForm != CmsProperty.getNullProperty() && CmsStringUtil.isNotEmpty(propertyLoginForm.getValue())) {
    redirectURL=propertyLoginForm.getValue() + "?__loginform=true&" + CmsWorkplaceManager.PARAM_LOGIN_REQUESTED_RESOURCE+ "="+ pathWithParams;
  }
 else   if (!httpAuthenticationSettings.useBrowserBasedHttpAuthentication() && CmsStringUtil.isNotEmpty(httpAuthenticationSettings.getFormBasedHttpAuthenticationUri())) {
    redirectURL=httpAuthenticationSettings.getFormBasedHttpAuthenticationUri() + "?" + CmsWorkplaceManager.PARAM_LOGIN_REQUESTED_RESOURCE+ "="+ pathWithParams;
  }
  if (redirectURL == null) {
    res.setHeader(CmsRequestUtil.HEADER_WWW_AUTHENTICATE,"BASIC realm=\"" + getSystemInfo().getOpenCmsContext() + "\"");
    res.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
  }
 else {
    redirectURL=m_linkManager.substituteLink(adminCms,redirectURL,null,true);
    if (LOG.isDebugEnabled()) {
      LOG.debug(Messages.get().getBundle().key(Messages.LOG_AUTHENTICATE_PROPERTY_2,redirectURL,path));
    }
    res.sendRedirect(redirectURL);
  }
}

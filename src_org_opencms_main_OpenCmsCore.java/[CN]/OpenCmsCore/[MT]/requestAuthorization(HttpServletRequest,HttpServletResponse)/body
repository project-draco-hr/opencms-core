{
  String servletPath=null;
  String redirectURL=null;
  if (m_useBasicAuthentication) {
    res.setHeader(I_CmsConstants.C_HEADER_WWW_AUTHENTICATE,"BASIC realm=\"" + getSystemInfo().getOpenCmsContext() + "\"");
    res.setStatus(401);
  }
 else {
    servletPath=req.getContextPath() + req.getServletPath();
    try {
      CmsObject adminCms=initCmsObject(req,res,getDefaultUsers().getUserAdmin(),null);
      CmsProperty propertyLoginForm=adminCms.readPropertyObject(I_CmsConstants.C_PROPERTY_LOGIN_FORM,req.getPathInfo(),true);
      if (org.opencms.main.OpenCms.getLog(this).isDebugEnabled()) {
        org.opencms.main.OpenCms.getLog(this).debug("resource: " + req.getPathInfo());
        org.opencms.main.OpenCms.getLog(this).debug("property: " + propertyLoginForm);
      }
      if (propertyLoginForm != CmsProperty.getNullProperty() && propertyLoginForm.getValue() != null && !"".equals(propertyLoginForm.getValue())) {
        redirectURL=servletPath + propertyLoginForm.getValue() + "?__loginform=true&requestedResource="+ req.getPathInfo();
      }
    }
 catch (    CmsException e) {
      if (org.opencms.main.OpenCms.getLog(this).isErrorEnabled()) {
        org.opencms.main.OpenCms.getLog(this).error("Error reading property \"" + I_CmsConstants.C_PROPERTY_LOGIN_FORM + "\"",e);
      }
    }
 finally {
      if (redirectURL == null) {
        redirectURL=servletPath + m_authenticationFormURI + "?requestedResource="+ req.getPathInfo();
      }
    }
    if (org.opencms.main.OpenCms.getLog(this).isDebugEnabled()) {
      org.opencms.main.OpenCms.getLog(this).debug("Redirecting response for authentication to: " + redirectURL);
    }
    res.sendRedirect(redirectURL);
  }
}

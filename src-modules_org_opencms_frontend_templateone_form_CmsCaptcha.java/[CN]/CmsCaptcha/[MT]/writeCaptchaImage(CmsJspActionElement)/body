{
  ByteArrayOutputStream captchaImageOutput=new ByteArrayOutputStream();
  try {
    String sessionId=cms.getRequest().getSession().getId();
    Locale locale=cms.getRequestContext().getLocale();
    BufferedImage captchaImage=getImageCaptchaService().getImageChallengeForID(sessionId,locale);
    JPEGImageEncoder jpegEncoder=JPEGCodec.createJPEGEncoder(captchaImageOutput);
    jpegEncoder.encode(captchaImage);
  }
 catch (  Exception e) {
    if (LOG.isErrorEnabled()) {
      LOG.error(e.getLocalizedMessage());
    }
    cms.getResponse().sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
    return;
  }
  cms.getResponse().setHeader("Cache-Control","no-store");
  cms.getResponse().setHeader("Pragma","no-cache");
  cms.getResponse().setDateHeader("Expires",0);
  cms.getResponse().setContentType("image/jpeg");
  ServletOutputStream out=cms.getResponse().getOutputStream();
  out.write(captchaImageOutput.toByteArray());
  out.flush();
  out.close();
}

{
  CmsFile file;
  String vfsName=cms.getRequestContext().removeSiteRoot(data.getVfsName());
  String rfsName=data.getRfsName();
  CmsResource resource=data.getResource();
  if (resource.isFile()) {
    file=cms.readFile(vfsName);
  }
 else {
    file=OpenCmsCore.getInstance().initResource(cms,vfsName);
    vfsName=vfsName + file.getName();
    rfsName+=C_EXPORT_DEFAULT_FILE;
  }
  int loaderId=file.getLoaderId();
  I_CmsResourceLoader loader=OpenCms.getLoaderManager().getLoader(loaderId);
  if ((loader == null) || ((loaderId != CmsDumpLoader.C_RESOURCE_LOADER_ID) && (loaderId != CmsJspLoader.C_RESOURCE_LOADER_ID) && (loaderId != CmsPageLoader.C_RESOURCE_LOADER_ID))) {
    throw new CmsException("Unable to export VFS file " + vfsName + ", invalid loader id "+ loaderId);
  }
  String exportFolderName=getExportPath() + CmsResource.getFolderPath(rfsName).substring(1);
  File exportFolder=new File(exportFolderName);
  if (!exportFolder.exists()) {
    if (!exportFolder.mkdirs()) {
      throw new CmsException("Creation of export folder failed for RFS file " + rfsName);
    }
  }
  String exportFileName=getExportPath() + rfsName.substring(1);
  File exportFile=new File(exportFileName);
  FileOutputStream exportStream;
  try {
    exportStream=new FileOutputStream(exportFile);
  }
 catch (  Throwable t) {
    throw new CmsException("Creation of export output stream failed for RFS file " + rfsName);
  }
  String mimetype=OpenCms.getMimeType(file.getName(),cms.getRequestContext().getEncoding());
  res.setContentType(mimetype);
  String oldUri=cms.getRequestContext().getUri();
  cms.getRequestContext().setUri(vfsName);
  byte[] content=loader.export(cms,file,req,res);
  cms.getRequestContext().setUri(oldUri);
  exportStream.write(content);
  exportStream.close();
  if (OpenCms.isLogging(CmsLog.CHANNEL_STATICEXPORT,CmsLog.LEVEL_INFO)) {
    OpenCms.log(CmsLog.CHANNEL_STATICEXPORT,CmsLog.LEVEL_INFO,"Exported vfs file '" + vfsName + "' to rfs file '"+ rfsName+ "'");
  }
}

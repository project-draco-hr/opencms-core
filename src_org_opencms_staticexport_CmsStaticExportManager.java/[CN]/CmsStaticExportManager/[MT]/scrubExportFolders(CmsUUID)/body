{
  Set scrubedFolders=new HashSet();
  Set scrubedFiles=new HashSet();
  CmsObject cms=OpenCms.initCmsObject(OpenCms.getDefaultUsers().getUserExport());
  List publishedResources;
  try {
    publishedResources=cms.readPublishedResources(publishHistoryId);
  }
 catch (  CmsException e) {
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error("Static export manager could not read list of changes resources for project ID " + publishHistoryId);
    }
    return;
  }
  Iterator it=publishedResources.iterator();
  while (it.hasNext()) {
    CmsPublishedResource res=(CmsPublishedResource)it.next();
    if (res.isNew() || res.isUnChanged() || !res.isVfsResource()) {
      continue;
    }
    List siblings=Collections.singletonList(res.getRootPath());
    if (res.getLinkCount() > 1) {
      try {
        List li=cms.getAllVfsLinks(res.getRootPath());
        siblings=new ArrayList();
        for (int i=0, l=li.size(); i < l; i++) {
          siblings.add(cms.readAbsolutePath((CmsResource)li.get(i)));
        }
      }
 catch (      CmsException e) {
        siblings=Collections.singletonList(res.getRootPath());
      }
    }
    for (int i=0, l=siblings.size(); i < l; i++) {
      String vfsName=(String)siblings.get(i);
      String rfsName=getRfsName(cms,vfsName);
      if (OpenCms.getLog(this).isDebugEnabled()) {
        OpenCms.getLog(this).debug("Static export checking for deletion vfsName='" + vfsName + "' rfsName='"+ rfsName+ "'");
      }
      if (rfsName.startsWith(getRfsPrefix()) && (!scrubedFiles.contains(vfsName)) && (!scrubedFolders.contains(CmsResource.getFolderPath(vfsName)))) {
        scrubedFiles.add(vfsName);
        String exportFileName;
        if (res.isFolder()) {
          if (res.isDeleted()) {
            String exportFolderName=CmsLinkManager.normalizeRfsPath(getExportPath() + rfsName.substring(getRfsPrefix().length() + 1));
            try {
              File exportFolder=new File(exportFolderName);
              if (exportFolder.exists() && exportFolder.canWrite()) {
                purgeDirectory(exportFolder);
                exportFolder.delete();
                if (OpenCms.getLog(this).isInfoEnabled()) {
                  OpenCms.getLog(this).info("Static export deleted export folder'" + exportFolderName + "'");
                }
                scrubedFolders.add(vfsName);
                continue;
              }
            }
 catch (            Throwable t) {
              if (OpenCms.getLog(this).isWarnEnabled()) {
                OpenCms.getLog(this).warn("Error deleting static export folder vfsName='" + vfsName + "' rfsName='"+ exportFolderName+ "'",t);
              }
            }
          }
          rfsName+=C_EXPORT_DEFAULT_FILE;
          if (OpenCms.getLog(this).isDebugEnabled()) {
            OpenCms.getLog(this).debug("Static export folder index file rfsName='" + rfsName + "'");
          }
        }
        exportFileName=CmsLinkManager.normalizeRfsPath(getExportPath() + rfsName.substring(getRfsPrefix().length() + 1));
        try {
          File exportFile=new File(exportFileName);
          if (exportFile.exists() && exportFile.canWrite()) {
            exportFile.delete();
            if (OpenCms.getLog(this).isInfoEnabled()) {
              OpenCms.getLog(this).info("Static export deleted exported rfs file '" + rfsName + "'");
            }
          }
        }
 catch (        Throwable t) {
          if (OpenCms.getLog(this).isWarnEnabled()) {
            OpenCms.getLog(this).warn("Error deleting static export file vfsName='" + vfsName + "' rfsName='"+ exportFileName+ "'",t);
          }
        }
      }
    }
  }
}

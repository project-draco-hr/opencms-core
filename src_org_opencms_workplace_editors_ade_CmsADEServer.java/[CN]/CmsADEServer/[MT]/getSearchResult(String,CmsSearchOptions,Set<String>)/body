{
  CmsObject cms=getCmsObject();
  JSONObject result=new JSONObject();
  JSONArray elements=new JSONArray();
  result.put(JsonResponse.ELEMENTS.getName(),elements);
  CmsUser user=cms.getRequestContext().currentUser();
  if (options.isValid()) {
    String indexName=new CmsUserSettings(user).getWorkplaceSearchIndexName();
    int pageSize=m_manager.getSearchPageSize(cms);
    CmsSearchParameters params=new CmsSearchParameters(options.getText());
    params.setIndex(indexName);
    params.setMatchesPerPage(pageSize);
    params.setSearchPage(options.getPage() + 1);
    params.setResourceTypes(options.getTypesAsList());
    CmsSearch searchBean=new CmsSearch();
    searchBean.init(cms);
    searchBean.setParameters(params);
    searchBean.setSearchRoot(options.getLocation());
    List<CmsSearchResult> searchResults=searchBean.getSearchResult();
    if (searchResults != null) {
      CmsElementUtil elemUtil=new CmsElementUtil(cms,getRequest().getParameter(ReqParam.URI.getName()),getRequest(),getResponse());
      Iterator<CmsSearchResult> it=searchResults.iterator();
      while (it.hasNext()) {
        CmsSearchResult sr=it.next();
        String uri=cms.getRequestContext().removeSiteRoot(sr.getPath());
        try {
          CmsResource resource=cms.readResource(uri);
          JSONObject resElement=elemUtil.getElementData(new CmsContainerElementBean(resource.getStructureId(),null,null),types);
          elements.put(resElement);
        }
 catch (        Exception e) {
          if (!LOG.isDebugEnabled()) {
            LOG.warn(e.getLocalizedMessage());
          }
          LOG.debug(e.getLocalizedMessage(),e);
        }
      }
    }
    int results=searchBean.getSearchPage() * searchBean.getMatchesPerPage();
    boolean hasMore=(searchBean.getSearchResultCount() > results);
    result.put(JsonSearch.HASMORE.getName(),hasMore);
    result.put(JsonSearch.COUNT.getName(),searchBean.getSearchResultCount());
  }
 else {
    result.put(JsonSearch.HASMORE.getName(),false);
    result.put(JsonSearch.COUNT.getName(),0);
  }
  m_sessionCache.setCacheADESearchOptions(options);
  return result;
}

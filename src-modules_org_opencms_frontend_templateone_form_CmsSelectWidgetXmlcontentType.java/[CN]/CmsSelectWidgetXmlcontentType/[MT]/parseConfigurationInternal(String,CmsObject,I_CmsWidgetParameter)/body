{
  CmsFile file=((I_CmsXmlContentValue)param).getDocument().getFile();
  m_macroCmsObject.getRequestContext().setUri(file.getRootPath());
  List mappings=CmsStringUtil.splitAsList(configuration,'|');
  Iterator itMappings=mappings.iterator();
  String mapping;
  String[] keyValue;
  String key;
  String value;
  boolean displayMacroFound=false, sortMacroFound=false, folderFound=false, typeFound=false;
  LOG.info("Setting macro %(currentsite) to: " + cms.getRequestContext().getSiteRoot());
  m_macroResolver.addMacro(MACROKEY_CURRENT_SITE,cms.getRequestContext().getSiteRoot());
  while (itMappings.hasNext()) {
    mapping=(String)itMappings.next();
    keyValue=CmsStringUtil.splitAsArray(mapping,'=');
    if (keyValue.length != 2) {
      throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEYVALUE_LENGTH_1,mapping));
    }
    key=keyValue[0].trim();
    value=keyValue[1].trim();
    m_macroResolver.setResourceName(file.getName());
    if (CONFIGURATION_OPTION_DISPLAY_MACRO.equals(key)) {
      if (displayMacroFound) {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_DUPLICATE_2,key,configuration));
      }
      m_displayOptionMacro=value;
      displayMacroFound=true;
    }
 else     if (CONFIGURATION_OPTION_SORT_MACRO.equals(key)) {
      if (sortMacroFound) {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_DUPLICATE_2,key,configuration));
      }
      m_sortMacro=value;
      sortMacroFound=true;
    }
 else     if (CONFIGURATION_RESOURCETYPENAME.equals(key)) {
      if (typeFound) {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_DUPLICATE_2,key,configuration));
      }
      String resType="n/a";
      try {
        this.m_resourceTypeIDs=new LinkedList();
        List types=CmsStringUtil.splitAsList(value,',');
        Iterator itTypes=types.iterator();
        while (itTypes.hasNext()) {
          resType=(String)itTypes.next();
          this.m_resourceTypeIDs.add(new Integer(OpenCms.getResourceManager().getResourceType(resType).getTypeId()));
        }
      }
 catch (      CmsLoaderException e) {
        throw new CmsIllegalArgumentException(org.opencms.file.Messages.get().container(org.opencms.file.Messages.ERR_UNKNOWN_RESOURCE_TYPE_1,resType),e);
      }
      typeFound=true;
    }
 else     if (CONFIGURATION_TOPFOLDER.equals(key)) {
      if (folderFound) {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_DUPLICATE_2,key,configuration));
      }
      value=m_macroResolver.resolveMacros(value);
      try {
        CmsRequestContext context=cms.getRequestContext();
        String oldSiteRoot=context.getSiteRoot();
        context.setSiteRoot("/");
        CmsResource resource=cms.readResource(value);
        context.setSiteRoot(oldSiteRoot);
        if (resource.isFile()) {
          throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_RESOURCE_NOFOLDER_2,value,configuration));
        }
        m_resourceFolder=resource;
      }
 catch (      CmsException e) {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_RESOURCE_INVALID_2,value,configuration),e);
      }
      folderFound=true;
    }
 else     if (CONFIGURATION_IGNORE_LOCALE_MATCH.equals(key)) {
      m_ignoreLocaleMatching=Boolean.valueOf(value).booleanValue();
    }
 else {
      CmsPropertyDefinition propDef;
      try {
        propDef=cms.readPropertyDefinition(key);
      }
 catch (      CmsException e) {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_UNKNOWN_2,key,getClass().getName()),e);
      }
      if (propDef != null) {
        value=m_macroResolver.resolveMacros(value);
        m_filterProperties.put(key,value);
      }
 else {
        throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_UNKNOWN_2,key,getClass().getName()));
      }
    }
  }
  if (!displayMacroFound) {
    throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_MISSING_3,CONFIGURATION_OPTION_DISPLAY_MACRO,configuration,getClass().getName()));
  }
  if (!folderFound) {
    throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_MISSING_3,CONFIGURATION_TOPFOLDER,configuration,getClass().getName()));
  }
  if (!typeFound) {
    throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_SELECTWIDGET_CONFIGURATION_KEY_MISSING_3,CONFIGURATION_RESOURCETYPENAME,configuration,getClass().getName()));
  }
}

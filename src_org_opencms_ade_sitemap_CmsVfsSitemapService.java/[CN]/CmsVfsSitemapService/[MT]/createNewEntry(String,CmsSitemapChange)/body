{
  CmsObject cms=getCmsObject();
  CmsClientSitemapEntry newEntry=null;
  if (change.getParentId() != null) {
    CmsResource parentFolder=cms.readResource(change.getParentId());
    String entryPath="";
    CmsResource entryFolder=null;
    CmsResource newRes=null;
    byte[] content=null;
    List<CmsProperty> properties=Collections.emptyList();
    CmsResource copyPage=null;
    if (change.getNewCopyResourceId() != null) {
      copyPage=cms.readResource(change.getNewCopyResourceId());
      content=cms.readFile(copyPage).getContents();
      properties=cms.readPropertyObjects(copyPage,false);
    }
    if (isRedirectType(change.getNewResourceTypeId())) {
      entryPath=CmsStringUtil.joinPaths(cms.getSitePath(parentFolder),change.getName());
      newRes=cms.createResource(entryPath,change.getNewResourceTypeId(),null,Collections.singletonList(new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,change.getName(),null)));
      cms.writePropertyObjects(newRes,generateInheritProperties(change,newRes));
      applyNavigationChanges(change,newRes);
    }
 else {
      String entryFolderPath=CmsStringUtil.joinPaths(cms.getSitePath(parentFolder),change.getName() + "/");
      boolean idWasNull=change.getEntryId() == null;
      if (idWasNull) {
        change.setEntryId(new CmsUUID());
      }
      entryFolder=new CmsResource(change.getEntryId(),new CmsUUID(),entryFolderPath,CmsResourceTypeFolder.getStaticTypeId(),true,0,cms.getRequestContext().getCurrentProject().getUuid(),CmsResource.STATE_NEW,System.currentTimeMillis(),cms.getRequestContext().getCurrentUser().getId(),System.currentTimeMillis(),cms.getRequestContext().getCurrentUser().getId(),CmsResource.DATE_RELEASED_DEFAULT,CmsResource.DATE_EXPIRED_DEFAULT,1,0,System.currentTimeMillis(),0);
      entryFolder=cms.createResource(entryFolderPath,OpenCms.getResourceManager().getResourceType(CmsResourceTypeFolder.getStaticTypeName()).getTypeId(),null,generateInheritProperties(change,entryFolder));
      if (idWasNull) {
        change.setEntryId(entryFolder.getStructureId());
      }
      applyNavigationChanges(change,entryFolder);
      entryPath=CmsStringUtil.joinPaths(entryFolderPath,"index.html");
      boolean isContainerPage=change.getNewResourceTypeId() == CmsResourceTypeXmlContainerPage.getContainerPageTypeIdSafely();
      if (isContainerPage && (copyPage != null)) {
        CmsXmlContainerPage page=CmsXmlContainerPageFactory.unmarshal(cms,cms.readFile(copyPage),true,true);
        ensureSingleLocale(page,entryFolder);
        boolean isFunctionDetail=(change.getCreateParameter() != null) && CmsUUID.isValidUUID(change.getCreateParameter());
        if (isFunctionDetail) {
          CmsUUID functionStructureId=new CmsUUID(change.getCreateParameter());
          CmsResource functionFormatter=cms.readResource(CmsXmlDynamicFunctionHandler.FORMATTER_PATH);
          addFunctionDetailElement(cms,page,functionStructureId,functionFormatter.getStructureId());
        }
        content=page.marshal();
      }
      newRes=cms.createResource(entryPath,change.getNewResourceTypeId(),content,properties);
      cms.writePropertyObjects(newRes,generateOwnProperties(change));
    }
    if (entryFolder != null) {
      tryUnlock(entryFolder);
      newEntry=toClientEntry(getNavBuilder().getNavigationForResource(cms.getSitePath(entryFolder)),false);
    }
    tryUnlock(newRes);
    if (newEntry == null) {
      newEntry=toClientEntry(getNavBuilder().getNavigationForResource(cms.getSitePath(newRes)),false);
    }
    newEntry.setPosition(-1);
    change.getClipBoardData().getModifications().remove(null);
    change.getClipBoardData().getModifications().put(newEntry.getId(),newEntry);
  }
  return newEntry;
}

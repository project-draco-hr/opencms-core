{
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  String filter=(String)parameters.get("projectfilter");
  String projectId=(String)parameters.get("projectid");
  if (projectId == null || "".equalsIgnoreCase(projectId)) {
    projectId=(String)session.getValue("projectid");
    if (projectId == null || "".equalsIgnoreCase(projectId)) {
      projectId="" + cms.getRequestContext().currentProject().getId();
    }
  }
  xmlTemplateDocument.setData("projectid",projectId);
  String action=(String)parameters.get("action");
  if (filter == null || "".equalsIgnoreCase(filter)) {
    filter=(String)session.getValue("projectfilter");
    if (filter == null || "".equalsIgnoreCase(filter)) {
      filter="all";
    }
    xmlTemplateDocument.setData("filter",filter);
    xmlTemplateDocument.setData("loadheader",xmlTemplateDocument.getProcessedDataValue("LOADHEADER",this));
  }
 else {
    xmlTemplateDocument.setData("filter",filter);
    xmlTemplateDocument.setData("loadheader",xmlTemplateDocument.getProcessedDataValue("NOTLOADHEADER",this));
  }
  session.putValue("projectfilter",filter);
  session.putValue("projectid",projectId);
  if (action != null && "restoreproject".equalsIgnoreCase(action)) {
    session.removeValue("projectid");
    session.removeValue("projectfilter");
    try {
      CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + "empty.html");
    }
 catch (    IOException exc) {
      throw new CmsException("Could not redirect to empty.html",exc);
    }
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

{
  CmsFlexController controller=CmsFlexController.getController(req);
  CmsObject cms=controller.getCmsObject();
  boolean actAsTemplate=false;
  CmsResource containerPage=cms.readResource(cms.getRequestContext().getUri());
  if (containerPage.getTypeId() != CmsResourceTypeContainerPage.getStaticTypeId()) {
    String cntPagePath=cms.readPropertyObject(containerPage,CmsPropertyDefinition.PROPERTY_TEMPLATE_ELEMENTS,true).getValue("");
    try {
      containerPage=cms.readResource(cntPagePath);
    }
 catch (    CmsException e) {
      throw new CmsIllegalStateException(Messages.get().container(Messages.ERR_CONTAINER_PAGE_NOT_FOUND_3,cms.getRequestContext().getUri(),CmsPropertyDefinition.PROPERTY_TEMPLATE_ELEMENTS,cntPagePath),e);
    }
    if (containerPage.getTypeId() != CmsResourceTypeContainerPage.getStaticTypeId()) {
      throw new CmsIllegalStateException(Messages.get().container(Messages.ERR_CONTAINER_PAGE_NOT_FOUND_3,cms.getRequestContext().getUri(),CmsPropertyDefinition.PROPERTY_TEMPLATE_ELEMENTS,cntPagePath));
    }
    actAsTemplate=true;
  }
 else   if (req.getParameter(CmsContainerPageBean.TEMPLATE_ELEMENT_PARAMETER) != null) {
    actAsTemplate=true;
  }
  CmsContainerPageBean cntPage=CmsContainerPageCache.getInstance().getCache(cms,containerPage,cms.getRequestContext().getLocale());
  Locale locale=cntPage.getLocale();
  if (!cntPage.getContainers().containsKey(containerName)) {
    throw new CmsIllegalStateException(Messages.get().container(Messages.LOG_CONTAINER_NOT_FOUND_3,cms.getSitePath(containerPage),locale,containerName));
  }
  CmsContainerBean container=cntPage.getContainers().get(containerName);
  if (!containerType.equals(container.getType())) {
    throw new CmsIllegalStateException(Messages.get().container(Messages.LOG_WRONG_CONTAINER_TYPE_4,new Object[]{cms.getSitePath(containerPage),locale,containerName,containerType}));
  }
  int maxElements=-1;
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(containerMaxElements)) {
    try {
      maxElements=Integer.parseInt(containerMaxElements);
    }
 catch (    NumberFormatException e) {
      throw new CmsIllegalStateException(Messages.get().container(Messages.LOG_WRONG_CONTAINER_MAXELEMENTS_4,new Object[]{cms.getSitePath(containerPage),locale,containerName,containerMaxElements}),e);
    }
    container.setMaxElements(maxElements);
  }
  CmsXmlEntityResolver entityResolver=new CmsXmlEntityResolver(cms);
  int renderElems=container.getElements().size();
  if ((maxElements > -1) && (renderElems > maxElements)) {
    renderElems=maxElements;
  }
  if (actAsTemplate) {
    if (!cntPage.getTypes().contains(CmsContainerPageBean.TYPE_TEMPLATE)) {
      throw new CmsIllegalStateException(Messages.get().container(Messages.ERR_CONTAINER_PAGE_NO_TYPE_3,cms.getRequestContext().getUri(),cms.getSitePath(containerPage),CmsContainerPageBean.TYPE_TEMPLATE));
    }
    if (containerType.equals(CmsContainerPageBean.TYPE_TEMPLATE)) {
      renderElems--;
      CmsResource resUri;
      if (req.getParameter(CmsContainerPageBean.TEMPLATE_ELEMENT_PARAMETER) != null) {
        CmsUUID id=new CmsUUID(req.getParameter(CmsContainerPageBean.TEMPLATE_ELEMENT_PARAMETER));
        resUri=cms.readResource(id);
      }
 else {
        resUri=cms.readResource(cms.getRequestContext().getUri());
      }
      List<CmsRelation> relations=cms.getRelationsForResource(resUri,CmsRelationFilter.TARGETS.filterType(CmsRelationType.XSD));
      CmsXmlContentDefinition contentDef=null;
      if ((relations != null) && !relations.isEmpty()) {
        String xsd=cms.getSitePath(relations.get(0).getTarget(cms,CmsResourceFilter.ALL));
        contentDef=entityResolver.getCachedContentDefinition(xsd);
      }
      if (contentDef == null) {
        CmsXmlContent content=CmsXmlContentFactory.unmarshal(cms,cms.readFile(resUri));
        contentDef=content.getContentDefinition();
      }
      String elementFormatter=contentDef.getContentHandler().getFormatters().get(containerType);
      if (CmsStringUtil.isEmptyOrWhitespaceOnly(elementFormatter)) {
        throw new CmsIllegalStateException(Messages.get().container(Messages.ERR_XSD_NO_TEMPLATE_FORMATTER_3,cms.getRequestContext().getUri(),contentDef.getSchemaLocation(),CmsContainerPageBean.TYPE_TEMPLATE));
      }
      CmsJspTagInclude.includeTagAction(pageContext,elementFormatter,cms.getSitePath(resUri),false,null,req,res);
    }
  }
  for (  CmsContainerElementBean element : container.getElements()) {
    if (renderElems < 1) {
      break;
    }
    renderElems--;
    CmsResource resUri=element.getElement();
    if (resUri.getTypeId() == CmsResourceTypeContainerPage.getStaticTypeId()) {
      CmsContainerPageBean subcntPage=CmsContainerPageCache.getInstance().getCache(cms,resUri,cms.getRequestContext().getLocale());
      CmsContainerBean subcontainer=subcntPage.getContainers().values().iterator().next();
      for (      CmsContainerElementBean subelement : subcontainer.getElements()) {
        String subelementUri=cms.getSitePath(subelement.getElement());
        List<CmsRelation> relations=cms.getRelationsForResource(subelement.getElement(),CmsRelationFilter.TARGETS.filterType(CmsRelationType.XSD));
        CmsXmlContentDefinition contentDef=null;
        if ((relations != null) && !relations.isEmpty()) {
          String xsd=cms.getSitePath(relations.get(0).getTarget(cms,CmsResourceFilter.ALL));
          contentDef=entityResolver.getCachedContentDefinition(xsd);
        }
        if (contentDef == null) {
          CmsXmlContent content=CmsXmlContentFactory.unmarshal(cms,cms.readFile(subelement.getElement()));
          contentDef=content.getContentDefinition();
        }
        String subelementFormatter=contentDef.getContentHandler().getFormatters().get(containerType);
        if (CmsStringUtil.isEmptyOrWhitespaceOnly(subelementFormatter)) {
          subelementFormatter=cms.getSitePath(subelement.getFormatter());
        }
        if (CmsStringUtil.isEmptyOrWhitespaceOnly(subelementFormatter)) {
          throw new CmsIllegalStateException(Messages.get().container(Messages.ERR_XSD_NO_TEMPLATE_FORMATTER_3,subelementUri,contentDef.getSchemaLocation(),containerType));
        }
        CmsJspTagInclude.includeTagAction(pageContext,subelementFormatter,subelementUri,false,null,req,res);
      }
    }
 else {
      String elementUri=cms.getSitePath(element.getElement());
      String elementFormatter=cms.getSitePath(element.getFormatter());
      CmsJspTagInclude.includeTagAction(pageContext,elementFormatter,elementUri,false,null,req,res);
    }
  }
}

{
  I_CmsFormatterBean formatterBean=null;
  String settingsKey=CmsFormatterConfig.getSettingsKeyForContainer(containerName);
  if ((element.getFormatterId() != null) && !element.getFormatterId().isNullUUID()) {
    if (!element.getElementSettings().containsKey(settingsKey)) {
      for (      I_CmsFormatterBean formatter : adeConfig.getFormatters(cms,element.getResource()).getAllMatchingFormatters(containerType,containerWidth,allowNested)) {
        if (element.getFormatterId().equals(formatter.getJspStructureId())) {
          String formatterConfigId=formatter.getId();
          if (formatterConfigId == null) {
            formatterConfigId=CmsFormatterConfig.SCHEMA_FORMATTER_ID;
          }
          formatterBean=formatter;
          break;
        }
      }
    }
 else {
      String formatterConfigId=element.getElementSettings().get(settingsKey);
      if (CmsUUID.isValidUUID(formatterConfigId)) {
        formatterBean=OpenCms.getADEManager().getCachedFormatters(cms.getRequestContext().getCurrentProject().isOnlineProject()).getFormatters().get(new CmsUUID(formatterConfigId));
      }
 else       if (CmsFormatterConfig.SCHEMA_FORMATTER_ID.equals(formatterConfigId)) {
        try {
          formatterBean=OpenCms.getResourceManager().getResourceType(element.getResource().getTypeId()).getFormattersForResource(cms,element.getResource()).getDefaultFormatter(containerType,containerWidth,allowNested);
        }
 catch (        CmsLoaderException e) {
          LOG.error(e.getLocalizedMessage(),e);
        }
      }
    }
  }
 else {
    if (element.getElementSettings().containsKey(settingsKey)) {
      String formatterConfigId=element.getElementSettings().get(settingsKey);
      if (CmsUUID.isValidUUID(formatterConfigId)) {
        formatterBean=OpenCms.getADEManager().getCachedFormatters(cms.getRequestContext().getCurrentProject().isOnlineProject()).getFormatters().get(new CmsUUID(formatterConfigId));
      }
    }
    if (formatterBean == null) {
      formatterBean=adeConfig.getFormatters(cms,element.getResource()).getDefaultFormatter(containerType,containerWidth,allowNested);
    }
  }
  return formatterBean;
}

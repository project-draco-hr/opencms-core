{
  I_CmsFormatterBean formatterBean=null;
  String settingsKey=CmsFormatterConfig.getSettingsKeyForContainer(containerName);
  if (element.getFormatterId() != null) {
    if (!element.getSettings().containsKey(settingsKey)) {
      for (      I_CmsFormatterBean formatter : adeConfig.getFormatters(cms,element.getResource()).getAllMatchingFormatters(containerType,containerWidth)) {
        if (element.getFormatterId().equals(formatter.getJspStructureId())) {
          String formatterConfigId=formatter.getId();
          if (formatterConfigId == null) {
            formatterConfigId=CmsFormatterConfig.SCHEMA_FORMATTER_ID;
          }
          element.getSettings().put(CmsFormatterConfig.getSettingsKeyForContainer(containerName),formatterConfigId);
          formatterBean=formatter;
          break;
        }
      }
    }
 else {
      String formatterConfigId=element.getSettings().get(settingsKey);
      if (CmsUUID.isValidUUID(formatterConfigId)) {
        formatterBean=OpenCms.getADEManager().getCachedFormatters(cms.getRequestContext().getCurrentProject().isOnlineProject()).getFormatters().get(new CmsUUID(formatterConfigId));
      }
    }
  }
 else {
    if (element.getSettings().containsKey(settingsKey)) {
      String formatterConfigId=element.getSettings().get(settingsKey);
      if (CmsUUID.isValidUUID(formatterConfigId)) {
        formatterBean=OpenCms.getADEManager().getCachedFormatters(cms.getRequestContext().getCurrentProject().isOnlineProject()).getFormatters().get(new CmsUUID(formatterConfigId));
      }
    }
    if (formatterBean == null) {
      formatterBean=adeConfig.getFormatters(cms,element.getResource()).getDefaultFormatter(containerType,containerWidth);
    }
    if (formatterBean != null) {
      String formatterConfigId=formatterBean.getId();
      if (formatterConfigId == null) {
        formatterConfigId=CmsFormatterConfig.SCHEMA_FORMATTER_ID;
      }
      element.getSettings().put(settingsKey,formatterConfigId);
      element.setFormatterId(formatterBean.getJspStructureId());
    }
 else {
      element.setFormatterId(null);
    }
  }
  return formatterBean;
}

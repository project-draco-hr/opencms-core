{
  ServletRequest req=pageContext.getRequest();
  ServletResponse res=pageContext.getResponse();
  String containerType=getType();
  int containerWidth=getContainerWidth();
  boolean isOnline=cms.getRequestContext().currentProject().isOnlineProject();
  CmsResource resUri=cms.readResource(element.getElementId());
  if (resUri.getTypeId() == CmsResourceTypeXmlContainerPage.SUB_CONTAINER_TYPE_ID) {
    CmsXmlSubContainer xmlSubContainer=CmsXmlSubContainerFactory.unmarshal(cms,resUri,req);
    CmsSubContainerBean subContainer=xmlSubContainer.getSubContainer(cms,cms.getRequestContext().getLocale());
    if (!subContainer.getTypes().contains(containerType)) {
      throw new CmsIllegalStateException(Messages.get().container(Messages.ERR_XSD_NO_TEMPLATE_FORMATTER_3,resUri.getRootPath(),OpenCms.getResourceManager().getResourceType(resUri).getTypeName(),containerType));
    }
    element.setSitePath(cms.getSitePath(resUri));
    printElementWrapperTagStart(isOnline,cms,resUri,element,true);
    for (    CmsContainerElementBean subelement : subContainer.getElements()) {
      CmsResource subelementRes=cms.readResource(subelement.getElementId());
      String subelementUri=cms.getSitePath(subelementRes);
      String subelementFormatter=OpenCms.getADEManager().getFormatterForContainerTypeAndWidth(cms,subelementRes,containerType,containerWidth);
      if (CmsStringUtil.isEmptyOrWhitespaceOnly(subelementFormatter) && LOG.isErrorEnabled()) {
        LOG.error(new CmsIllegalStateException(Messages.get().container(Messages.ERR_XSD_NO_TEMPLATE_FORMATTER_3,subelementUri,OpenCms.getResourceManager().getResourceType(subelementRes).getTypeName(),containerType)));
        continue;
      }
      subelement.setSitePath(subelementUri);
      printElementWrapperTagStart(isOnline,cms,subelementRes,subelement,false);
      CmsJspTagInclude.includeTagAction(pageContext,subelementFormatter,null,false,null,Collections.singletonMap(CmsADEManager.ATTR_CURRENT_ELEMENT,(Object)subelement),req,res);
      printElementWrapperTagEnd(isOnline);
    }
    printElementWrapperTagEnd(isOnline);
  }
 else {
    String elementFormatter=cms.getSitePath(cms.readResource(element.getFormatterId()));
    element.setSitePath(cms.getSitePath(resUri));
    printElementWrapperTagStart(isOnline,cms,resUri,element,false);
    CmsJspTagInclude.includeTagAction(pageContext,elementFormatter,null,false,null,Collections.singletonMap(CmsADEManager.ATTR_CURRENT_ELEMENT,(Object)element),req,res);
    printElementWrapperTagEnd(isOnline);
  }
}

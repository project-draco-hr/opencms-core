{
  I_CmsFormatterBean formatterBean=null;
  if ((element.getFormatterId() != null) && cms.existsResource(element.getFormatterId())) {
    if (!element.getSettings().containsKey(CmsFormatterConfig.getSettingsKeyForContainer(getName()))) {
      for (      I_CmsFormatterBean formatter : adeConfig.getFormatters(cms,element.getResource()).getAllMatchingFormatters(containerType,containerWidth)) {
        if (element.getFormatterId().equals(formatter.getJspStructureId())) {
          String formatterConfigId=formatter.getId();
          if (formatterConfigId == null) {
            formatterConfigId=CmsFormatterConfig.SCHEMA_FORMATTER_ID;
          }
          element.getSettings().put(CmsFormatterConfig.getSettingsKeyForContainer(getName()),formatterConfigId);
          formatterBean=formatter;
        }
      }
    }
 else {
      String formatterConfigId=element.getSettings().get(CmsFormatterConfig.getSettingsKeyForContainer(getName()));
      if (CmsUUID.isValidUUID(formatterConfigId)) {
        formatterBean=OpenCms.getADEManager().getCachedFormatters(false).getFormatters().get(formatterConfigId);
      }
    }
  }
 else {
    formatterBean=adeConfig.getFormatters(cms,element.getResource()).getDefaultFormatter(containerType,containerWidth);
    if (formatterBean != null) {
      String formatterConfigId=formatterBean.getId();
      if (formatterConfigId == null) {
        formatterConfigId=CmsFormatterConfig.SCHEMA_FORMATTER_ID;
      }
      element.getSettings().put(CmsFormatterConfig.getSettingsKeyForContainer(getName()),formatterConfigId);
      element.setFormatterId(formatterBean.getJspStructureId());
    }
 else {
      element.setFormatterId(null);
    }
  }
  return formatterBean;
}

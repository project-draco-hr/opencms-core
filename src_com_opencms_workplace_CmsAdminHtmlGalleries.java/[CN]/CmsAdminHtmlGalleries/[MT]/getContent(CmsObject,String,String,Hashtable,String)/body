{
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  String lasturl=getLastUrl(cms,parameters);
  getInitial(session,parameters);
  String foldername=getGalleryPath(cms,session,parameters);
  CmsFolder thefolder=cms.readFolder(foldername);
  if (foldername.equals(C_VFS_GALLERY_HTML) && templateFile.endsWith("administration_head_htmlgalleries2")) {
    xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,C_VFS_PATH_WORKPLACE + "administration/htmlgallery/administration_head_htmlgalleries1",elementName,parameters,templateSelector);
  }
  try {
    String parent=CmsResource.getParentFolder(cms.readAbsolutePath(thefolder));
    if (foldername.startsWith(C_VFS_GALLERY_HTML) && (parent.equals(C_VFS_GALLERY_HTML)) && templateFile.endsWith("administration_head_htmlgalleries1")) {
      xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,C_VFS_PATH_WORKPLACE + "administration/htmlgallery/administration_head_htmlgalleries2",elementName,parameters,templateSelector);
    }
  }
 catch (  Exception e) {
  }
  String action=(String)parameters.get("action");
  String title=(String)parameters.get("TITLE");
  if ("new".equals(action)) {
    String galleryname=(String)parameters.get("NAME");
    String group=(String)parameters.get("GROUP");
    if (galleryname != null && group != null && galleryname != "" && group != "") {
      try {
        String superfolder=getConfigFile(cms).getHtmlGalleryPath();
        CmsResource folder=cms.createResource(superfolder + galleryname,CmsResourceTypeFolder.C_RESOURCE_TYPE_ID);
        if (title != null) {
          cms.writeProperty(cms.readAbsolutePath(folder),C_PROPERTY_TITLE,title);
        }
        try {
          cms.unlockResource(cms.readAbsolutePath(folder),false);
        }
 catch (        CmsException e) {
          String parent=CmsResource.getParentFolder(cms.readAbsolutePath(folder));
          cms.unlockResource(parent,false);
          cms.unlockResource(cms.readAbsolutePath(folder),false);
        }
      }
 catch (      CmsException ex) {
        xmlTemplateDocument.setData("ERRORDETAILS",CmsException.getStackTraceAsString(ex));
        templateSelector="error";
      }
    }
 else {
      templateSelector="datamissing";
    }
  }
 else   if ("snippet".equalsIgnoreCase(action)) {
    if (foldername != null) {
      String filename=(String)parameters.get("NEUNAME");
      String pagetitle=(String)parameters.get("NEUTITEL");
      String type=(String)parameters.get("type");
      if (filename != null && !"".equals(filename)) {
        List properties=null;
        if (pagetitle != null) {
          properties=new ArrayList();
          properties.add(new org.opencms.file.CmsProperty(I_CmsConstants.C_PROPERTY_TITLE,pagetitle,null));
        }
 else {
          properties=Collections.EMPTY_LIST;
        }
        int t=OpenCms.getResourceManager().getResourceType(type).getTypeId();
        cms.createResource(foldername + filename,t,new byte[0],properties);
      }
    }
  }
  xmlTemplateDocument.setData("link_value",foldername);
  xmlTemplateDocument.setData("lasturl",lasturl);
  xmlTemplateDocument.setData("galleryRootFolder",C_VFS_GALLERY_HTML);
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

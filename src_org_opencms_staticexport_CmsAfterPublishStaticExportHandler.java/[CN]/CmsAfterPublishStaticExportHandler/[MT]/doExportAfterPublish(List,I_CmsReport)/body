{
  boolean templatesFound;
  CmsObject cmsExportObject=OpenCms.initCmsObject(OpenCms.getDefaultUsers().getUserExport());
  List resourcesToExport=getRelatedResources(cmsExportObject,resources);
  templatesFound=exportNonTemplateResources(cmsExportObject,resourcesToExport,report);
  if ((templatesFound) || (!OpenCms.getStaticExportManager().getQuickPlainExport())) {
    CmsStaticExportManager manager=OpenCms.getStaticExportManager();
    Set resourceFilter=new HashSet();
    Iterator itExpRes=resourcesToExport.iterator();
    while (itExpRes.hasNext()) {
      CmsPublishedResource pubResource=(CmsPublishedResource)itExpRes.next();
      String rfsName=manager.getRfsName(cmsExportObject,"",pubResource.getRootPath());
      resourceFilter.add(rfsName.substring(manager.getRfsPrefixForRfsName(rfsName).length()));
    }
    long timestamp=0;
    List publishedTemplateResources;
    boolean newTemplateLinksFound;
    int linkMode=CmsStaticExportManager.EXPORT_LINK_WITHOUT_PARAMETER;
    do {
      publishedTemplateResources=cmsExportObject.readStaticExportResources(linkMode,timestamp);
      newTemplateLinksFound=publishedTemplateResources.size() > 0;
      if (newTemplateLinksFound) {
        if (linkMode == CmsStaticExportManager.EXPORT_LINK_WITHOUT_PARAMETER) {
          linkMode=CmsStaticExportManager.EXPORT_LINK_WITH_PARAMETER;
          publishedTemplateResources.retainAll(resourceFilter);
        }
 else {
          timestamp=System.currentTimeMillis();
          Iterator itPubTemplates=publishedTemplateResources.iterator();
          while (itPubTemplates.hasNext()) {
            String rfsName=(String)itPubTemplates.next();
            if (!resourceFilter.contains(rfsName.substring(0,rfsName.lastIndexOf('_')))) {
              itPubTemplates.remove();
            }
          }
        }
        if (publishedTemplateResources == null || publishedTemplateResources.isEmpty()) {
          break;
        }
        exportTemplateResources(cmsExportObject,publishedTemplateResources,report);
      }
    }
 while (newTemplateLinksFound);
  }
}

{
  String storedSiteRoot=cms.getRequestContext().getSiteRoot();
  try {
    cms.getRequestContext().setSiteRoot("/");
    if (publishedResources == null) {
      return getAllResources(cms);
    }
 else {
      Map resourceMap=new HashMap();
      Iterator itPubRes=publishedResources.iterator();
      while (itPubRes.hasNext()) {
        CmsPublishedResource pubResource=(CmsPublishedResource)itPubRes.next();
        if (cms.existsResource(pubResource.getRootPath())) {
          CmsResource vfsResource=cms.readResource(pubResource.getRootPath());
          if (!vfsResource.isInternal()) {
            Iterator itSiblings=getSiblings(cms,pubResource).iterator();
            while (itSiblings.hasNext()) {
              CmsPublishedResource sibling=(CmsPublishedResource)itSiblings.next();
              resourceMap.put(sibling.getRootPath(),sibling);
            }
          }
        }
 else {
          resourceMap.put(pubResource.getRootPath(),pubResource);
        }
        boolean match=false;
        Iterator itExportRules=OpenCms.getStaticExportManager().getExportRules().iterator();
        while (itExportRules.hasNext()) {
          CmsStaticExportExportRule rule=(CmsStaticExportExportRule)itExportRules.next();
          Set relatedResources=rule.getRelatedResources(cms,pubResource);
          if (relatedResources != null) {
            Iterator itRelatedRes=relatedResources.iterator();
            while (itRelatedRes.hasNext()) {
              CmsPublishedResource relatedRes=(CmsPublishedResource)itRelatedRes.next();
              resourceMap.put(relatedRes.getRootPath(),relatedRes);
            }
            match=true;
          }
        }
        if (!match) {
          return getAllResources(cms);
        }
      }
      return new ArrayList(resourceMap.values());
    }
  }
  finally {
    cms.getRequestContext().setSiteRoot(storedSiteRoot);
  }
}

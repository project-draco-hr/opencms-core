{
  if (LOG.isDebugEnabled()) {
    LOG.debug(Messages.get().key(Messages.LOG_SCRUBBING_EXPORT_FOLDERS_1,publishHistoryId));
  }
  Set scrubedFolders=new HashSet();
  Set scrubedFiles=new HashSet();
  CmsObject cms;
  try {
    cms=OpenCms.initCmsObject(OpenCms.getDefaultUsers().getUserExport());
  }
 catch (  CmsException e) {
    LOG.error(Messages.get().key(Messages.LOG_INIT_FAILED_0),e);
    return;
  }
  List publishedResources;
  try {
    publishedResources=cms.readPublishedResources(publishHistoryId);
  }
 catch (  CmsException e) {
    LOG.error(Messages.get().key(Messages.LOG_READING_CHANGED_RESOURCES_FAILED_1,publishHistoryId),e);
    return;
  }
  Iterator it=publishedResources.iterator();
  while (it.hasNext()) {
    CmsPublishedResource res=(CmsPublishedResource)it.next();
    if (res.isUnChanged() || !res.isVfsResource()) {
      continue;
    }
    if (!res.isDeleted()) {
      continue;
    }
    List siblings=Collections.singletonList(res.getRootPath());
    if (res.getSiblingCount() > 1) {
      try {
        List li=cms.readSiblings(res.getRootPath(),CmsResourceFilter.ALL);
        siblings=new ArrayList();
        for (int i=0, l=li.size(); i < l; i++) {
          siblings.add(((CmsResource)li.get(i)).getRootPath());
        }
      }
 catch (      CmsException e) {
        siblings=Collections.singletonList(res.getRootPath());
      }
    }
    for (int i=0, l=siblings.size(); i < l; i++) {
      String vfsName=(String)siblings.get(i);
      String rfsName=OpenCms.getStaticExportManager().getRfsName(cms,vfsName);
      if (LOG.isDebugEnabled()) {
        LOG.debug(Messages.get().key(Messages.LOG_CHECKING_STATIC_EXPORT_2,vfsName,rfsName));
      }
      if (rfsName.startsWith(OpenCms.getStaticExportManager().getRfsPrefix()) && (!scrubedFiles.contains(vfsName)) && (!scrubedFolders.contains(CmsResource.getFolderPath(vfsName)))) {
        scrubedFiles.add(vfsName);
        String exportFileName;
        if (res.isFolder()) {
          if (res.isDeleted()) {
            String exportFolderName=CmsFileUtil.normalizePath(OpenCms.getStaticExportManager().getExportPath() + rfsName.substring(OpenCms.getStaticExportManager().getRfsPrefix().length()));
            try {
              File exportFolder=new File(exportFolderName);
              if (exportFolder.exists() && exportFolder.canWrite()) {
                CmsFileUtil.purgeDirectory(exportFolder);
                if (LOG.isDebugEnabled()) {
                  LOG.info(Messages.get().key(Messages.LOG_FOLDER_DELETED_1,exportFolderName));
                }
                scrubedFolders.add(vfsName);
                continue;
              }
            }
 catch (            Throwable t) {
              if (LOG.isWarnEnabled()) {
                LOG.warn(Messages.get().key(Messages.LOG_FOLDER_DELETION_FAILED_2,vfsName,exportFolderName));
              }
            }
          }
          rfsName+=CmsStaticExportManager.C_EXPORT_DEFAULT_FILE;
          if (LOG.isDebugEnabled()) {
            LOG.debug(Messages.get().key(Messages.LOG_FOLDER_1,rfsName));
          }
        }
        exportFileName=CmsFileUtil.normalizePath(OpenCms.getStaticExportManager().getExportPath() + rfsName.substring(OpenCms.getStaticExportManager().getRfsPrefix().length() + 1));
        try {
          File exportFile=new File(exportFileName);
          if (exportFile.exists() && exportFile.canWrite()) {
            exportFile.delete();
            if (LOG.isInfoEnabled()) {
              LOG.info(Messages.get().key(Messages.LOG_FILE_DELETED_1,rfsName));
            }
          }
        }
 catch (        Throwable t) {
          if (LOG.isWarnEnabled()) {
            LOG.warn(Messages.get().key(Messages.LOG_FILE_DELETION_FAILED_2,vfsName,exportFileName));
          }
        }
      }
    }
  }
}

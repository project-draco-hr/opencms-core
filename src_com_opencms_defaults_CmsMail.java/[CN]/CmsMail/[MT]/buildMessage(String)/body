{
  String mail_encoding="ISO-8859-1";
  if (smtpHost == null || "".equals(smtpHost)) {
    throw new CmsException("No SMTP server given.");
  }
  Properties props=System.getProperties();
  props.put("mail.smtp.host",smtpHost);
  Session session=Session.getDefaultInstance(props,null);
  MimeMessage msg=new MimeMessage(session);
  InternetAddress[] to=new InternetAddress[m_to.length];
  for (int i=0; i < m_to.length; i++) {
    to[i]=new InternetAddress(m_to[i]);
  }
  msg.setFrom(new InternetAddress(m_from));
  msg.setRecipients(Message.RecipientType.TO,to);
  InternetAddress[] cc=null;
  if (m_cc != null) {
    cc=new InternetAddress[m_cc.length];
    for (int i=0; i < m_cc.length; i++) {
      cc[i]=new InternetAddress(m_cc[i]);
    }
    msg.setRecipients(Message.RecipientType.CC,cc);
  }
  InternetAddress[] bcc=null;
  if (m_bcc != null) {
    bcc=new InternetAddress[m_bcc.length];
    for (int i=0; i < m_bcc.length; i++) {
      bcc[i]=new InternetAddress(m_bcc[i]);
    }
    msg.setRecipients(Message.RecipientType.BCC,bcc);
  }
  msg.setSubject(m_subject,mail_encoding);
  Vector v=new Vector();
  if (m_cms != null) {
    Enumeration enum=m_cms.getRequestContext().getRequest().getFileNames();
    while (enum.hasMoreElements()) {
      v.addElement(enum.nextElement());
    }
  }
  int size=v.size();
  int numAttach=m_attachContent.size();
  if (size != 0 || numAttach != 0) {
    MimeBodyPart mbp1=new MimeBodyPart();
    Multipart mp=new MimeMultipart();
    if (m_type.equals("text/html")) {
      mbp1.setDataHandler(new DataHandler(new CmsByteArrayDataSource(m_content,m_type,mail_encoding)));
    }
 else {
      mbp1.setText(m_content,mail_encoding);
    }
    mp.addBodyPart(mbp1);
    for (int i=0; i < numAttach; i++) {
      MimeBodyPart mbpAttach=new MimeBodyPart();
      if ("text/html".equals((String)m_attachType.elementAt(i))) {
        mbpAttach.setDataHandler(new DataHandler(new CmsByteArrayDataSource((String)m_attachContent.elementAt(i),"text/html",mail_encoding)));
      }
 else {
        mbpAttach.setText((String)m_attachContent.elementAt(i),mail_encoding);
      }
      mp.addBodyPart(mbpAttach);
    }
    for (int i=0; i < size; i++) {
      String filename=(String)v.elementAt(i);
      if (!"unknown".equalsIgnoreCase(filename)) {
        MimetypesFileTypeMap mimeTypeMap=new MimetypesFileTypeMap();
        String mimeType=mimeTypeMap.getContentType(filename);
        MimeBodyPart mbp=new MimeBodyPart();
        mbp.setDataHandler(new DataHandler(new CmsByteArrayDataSource(m_cms.getRequestContext().getRequest().getFile(filename),mimeType)));
        mbp.setFileName(filename);
        mp.addBodyPart(mbp);
      }
    }
    msg.setContent(mp);
  }
 else {
    if (m_type.equals("text/html")) {
      msg.setDataHandler(new DataHandler(new CmsByteArrayDataSource(m_content,m_type,mail_encoding)));
    }
 else {
      msg.setContent(m_content,m_type);
    }
  }
  msg.setSentDate(new Date());
  return msg;
}

{
  try {
    CmsResource resource=cmsObject.readFileHeader(filename,CmsResourceFilter.ALL);
    int currentProject=cmsObject.getRequestContext().currentProject().getId();
    CmsUUID userId=cmsObject.getRequestContext().currentUser().getId();
    CmsLock lock=cmsObject.getLock(filename);
    boolean locked=!(lock.isNullLock() || (lock.getUserId().equals(userId) && lock.getProjectId() == currentProject));
    if (currentProject == I_CmsConstants.C_PROJECT_ONLINE_ID) {
      return null;
    }
 else     if (!cmsObject.getResourceType(resource.getType()).isDirectEditable()) {
      return null;
    }
 else     if (CmsResource.getName(filename).startsWith(org.opencms.main.I_CmsConstants.C_TEMP_PREFIX)) {
      return C_DIRECT_EDIT_MODE_INACTIVE;
    }
 else     if (!cmsObject.isInsideCurrentProject(resource)) {
      return C_DIRECT_EDIT_MODE_INACTIVE;
    }
 else     if (!cmsObject.hasPermissions(resource,new CmsPermissionSet(I_CmsConstants.C_PERMISSION_WRITE))) {
      if (locked) {
        return C_DIRECT_EDIT_MODE_DISABLED;
      }
 else {
        return C_DIRECT_EDIT_MODE_INACTIVE;
      }
    }
 else     if (locked) {
      return C_DIRECT_EDIT_MODE_DISABLED;
    }
    if ((element != null) && (resource.getType() == CmsResourceTypeXmlPage.C_RESOURCE_TYPE_ID)) {
      CmsXmlPage page=(CmsXmlPage)req.getAttribute(filename);
      if (page == null) {
        page=CmsXmlPage.read(cmsObject,cmsObject.readFile(filename));
        req.setAttribute(filename,page);
      }
      Locale locale=OpenCms.getLocaleManager().getBestMatchingLocale(null,OpenCms.getLocaleManager().getDefaultLocales(cmsObject,filename),page.getLocales());
      if (!page.hasElement(element,locale) || !page.isEnabled(element,locale)) {
        return C_DIRECT_EDIT_MODE_INACTIVE;
      }
    }
    return C_DIRECT_EDIT_MODE_ENABLED;
  }
 catch (  CmsException e) {
    if (OpenCms.getLog(this).isWarnEnabled()) {
      OpenCms.getLog(this).warn("Error while calculation edit mode for " + filename,e);
    }
    return C_DIRECT_EDIT_MODE_INACTIVE;
  }
}

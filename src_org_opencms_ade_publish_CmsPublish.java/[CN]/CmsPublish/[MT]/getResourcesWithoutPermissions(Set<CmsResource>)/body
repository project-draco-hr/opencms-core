{
  Set<CmsUUID> projectIds=new HashSet<CmsUUID>();
  try {
    for (    CmsProject project : OpenCms.getOrgUnitManager().getAllManageableProjects(m_cms,"",true)) {
      projectIds.add(project.getUuid());
    }
  }
 catch (  CmsException e) {
    LOG.error(e.getLocalizedMessage(),e);
  }
  ResourcesAndRelated result=new ResourcesAndRelated();
  for (  CmsResource resource : getPublishResourcesInternal().getResources()) {
    if (exclude.contains(resource)) {
      continue;
    }
    try {
      if (!projectIds.contains(resource.getProjectLastModified()) && !m_cms.hasPermissions(resource,CmsPermissionSet.ACCESS_DIRECT_PUBLISH)) {
        result.getResources().add(resource);
      }
    }
 catch (    Exception e) {
      if (LOG.isErrorEnabled()) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
  }
  for (  CmsResource resource : getPublishResourcesInternal().getRelatedResources()) {
    if (exclude.contains(resource)) {
      continue;
    }
    try {
      if (!m_cms.hasPermissions(resource,CmsPermissionSet.ACCESS_DIRECT_PUBLISH)) {
        result.getRelatedResources().add(resource);
      }
    }
 catch (    Exception e) {
      if (LOG.isErrorEnabled()) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
  }
  return result;
}

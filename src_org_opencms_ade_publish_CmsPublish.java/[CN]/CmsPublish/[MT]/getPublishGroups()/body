{
  Set<CmsResource> published=getAlreadyPublishedResources();
  Set<CmsResource> exclude=new HashSet<CmsResource>(published);
  ResourcesAndRelated permissions=getResourcesWithoutPermissions(exclude);
  exclude.addAll(permissions.getResources());
  exclude.addAll(permissions.getRelatedResources());
  ResourcesAndRelated locked=getBlockingLockedResources(exclude);
  exclude.clear();
  exclude.addAll(published);
  exclude.addAll(permissions.getResources());
  exclude.addAll(locked.getResources());
  ResourcesAndRelated pubResources=new ResourcesAndRelated();
  pubResources.getResources().addAll(getPublishResources().getResources());
  pubResources.getResources().removeAll(exclude);
  pubResources.getRelatedResources().addAll(getPublishResources().getRelatedResources());
  pubResources.getRelatedResources().removeAll(permissions.getRelatedResources());
  pubResources.getRelatedResources().removeAll(locked.getRelatedResources());
  if (getPublishResources().getResources().isEmpty()) {
    return new ArrayList<CmsPublishGroup>();
  }
  List<CmsResource> resourcesWithoutTempfiles=new ArrayList<CmsResource>();
  for (  CmsResource res : getPublishResources().getResources()) {
    if (!CmsResource.isTemporaryFileName(res.getRootPath())) {
      resourcesWithoutTempfiles.add(res);
    }
  }
  Set<CmsResource> allPubRes=new HashSet<CmsResource>(pubResources.getRelatedResources());
  allPubRes.addAll(pubResources.getResources());
  List<CmsResource> pubList=new ArrayList<CmsResource>();
  try {
    pubList=OpenCms.getPublishManager().getUsersPubList(m_cms);
  }
 catch (  CmsException e) {
    LOG.error(e.getLocalizedMessage(),e);
  }
  CmsPublishGroupHelper groupHelper=new CmsPublishGroupHelper(m_workplaceLocale);
  List<CmsResourceGroup> resourceGroups=groupHelper.getGroups(resourcesWithoutTempfiles);
  List<CmsPublishGroup> resultGroups=new ArrayList<CmsPublishGroup>();
  for (  CmsResourceGroup resGroup : resourceGroups) {
    CmsPublishGroup publishGroup=convertResourceGroup(resGroup,pubList,allPubRes,published,permissions,locked);
    resultGroups.add(publishGroup);
  }
  return resultGroups;
}

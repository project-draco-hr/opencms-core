{
  CmsUser user=m_cms.getRequestContext().getCurrentUser();
  CmsLockFilter blockingFilter=CmsLockFilter.FILTER_ALL;
  blockingFilter=blockingFilter.filterNotLockableByUser(user);
  ResourcesAndRelated result=new ResourcesAndRelated();
  Map<String,CmsResource> cache1=Maps.newHashMap();
  for (  CmsResource resource : getPublishResourcesInternal().getResources()) {
    if (exclude.contains(resource)) {
      continue;
    }
    try {
      result.getResources().addAll(m_cms.getLockedResourcesWithCache(resource,blockingFilter,cache1));
    }
 catch (    Exception e) {
      if (LOG.isErrorEnabled()) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
  }
  for (  CmsResource resource : getPublishResourcesInternal().getRelatedResources()) {
    if (exclude.contains(resource)) {
      continue;
    }
    try {
      result.getRelatedResources().addAll(m_cms.getLockedResourcesWithCache(resource,blockingFilter,cache1));
    }
 catch (    Exception e) {
      if (LOG.isErrorEnabled()) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
  }
  return result;
}

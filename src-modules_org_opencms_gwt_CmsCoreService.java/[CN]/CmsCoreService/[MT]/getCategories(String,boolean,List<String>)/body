{
  CmsObject cms=getCmsObject();
  CmsCategoryService catService=CmsCategoryService.getInstance();
  String resourceIcon=getIcon(CmsResourceTypeFolder.RESOURCE_TYPE_NAME);
  List<String> repositories=new ArrayList<String>();
  if ((refPaths != null) && !refPaths.isEmpty()) {
    for (    String refPath : refPaths) {
      repositories.addAll(catService.getCategoryRepositories(getCmsObject(),refPath));
    }
  }
 else {
    repositories.add(CmsCategoryService.CENTRALIZED_REPOSITORY);
  }
  CmsCategoryTreeEntry result=null;
  try {
    result=new CmsCategoryTreeEntry(fromPath);
    result.setIconResource(resourceIcon);
    List<CmsCategory> categories=catService.readCategoriesForRepositories(cms,fromPath,includeSubCats,repositories);
    CmsCategoryTreeEntry parent=result;
    for (    CmsCategory category : categories) {
      CmsCategoryTreeEntry current=new CmsCategoryTreeEntry(category);
      current.setIconResource(resourceIcon);
      String parentPath=CmsResource.getParentFolder(current.getPath());
      if (!parentPath.equals(parent.getPath())) {
        parent=findCategory(result,parentPath);
      }
      parent.addChild(current);
    }
  }
 catch (  Throwable e) {
    error(e);
  }
  return result;
}

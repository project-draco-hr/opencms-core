{
  CmsObject cms=getCmsObject();
  CmsCategoryService catService=CmsCategoryService.getInstance();
  List<String> repositories=new ArrayList<String>();
  if ((refPaths != null) && !refPaths.isEmpty()) {
    for (    String refPath : refPaths) {
      repositories.addAll(catService.getCategoryRepositories(getCmsObject(),refPath));
    }
  }
 else {
    repositories.add(CmsCategoryService.CENTRALIZED_REPOSITORY);
  }
  CmsCategoryTreeEntry result=null;
  String iconPath="";
  try {
    result=new CmsCategoryTreeEntry(fromPath);
    iconPath=CmsWorkplace.getResourceUri(CmsWorkplace.RES_PATH_FILETYPES + OpenCms.getWorkplaceManager().getExplorerTypeSetting(CmsResourceTypeFolder.RESOURCE_TYPE_NAME).getIcon());
    result.setIconResource(iconPath);
    List<CmsCategory> categories=catService.readCategoriesForRepositories(cms,fromPath,includeSubCats,repositories);
    CmsCategoryTreeEntry parent=result;
    for (    CmsCategory category : categories) {
      CmsCategoryTreeEntry current=new CmsCategoryTreeEntry(category);
      iconPath=CmsWorkplace.getResourceUri(CmsWorkplace.RES_PATH_FILETYPES + OpenCms.getWorkplaceManager().getExplorerTypeSetting(CmsResourceTypeFolder.RESOURCE_TYPE_NAME).getIcon());
      current.setIconResource(iconPath);
      String parentPath=CmsResource.getParentFolder(current.getPath());
      if (!parentPath.equals(parent.getPath())) {
        parent=findCategory(result,parentPath);
      }
      parent.addChild(current);
    }
  }
 catch (  Throwable e) {
    error(e);
  }
  return result;
}

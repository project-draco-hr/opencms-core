{
  String template=null;
  String filename=null;
  String link=null;
  String foldername=null;
  String type=null;
  I_CmsSession session=cms.getRequestContext().getSession(true);
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  CmsXmlLanguageFile lang=xmlTemplateDocument.getLanguageFile();
  String initial=(String)parameters.get(C_PARA_INITIAL);
  if (initial != null) {
    session.removeValue(C_PARA_FILE);
    session.removeValue(C_PARA_LINK);
    session.removeValue(C_PARA_VIEWFILE);
    session.removeValue("lasturl");
  }
  getLastUrl(cms,parameters);
  link=cms.getRequestContext().getRequest().getParameter(C_PARA_LINK);
  if (link != null) {
    session.putValue(C_PARA_LINK,link);
  }
  String navtitle=(String)parameters.get(C_PARA_NAVTEXT);
  String navpos=(String)parameters.get(C_PARA_NAVPOS);
  String notChange=(String)parameters.get("newlink");
  String linkName=null;
  CmsFile editFile=null;
  CmsResource linkResource=null;
  String content=null;
  String step=cms.getRequestContext().getRequest().getParameter("step");
  if (notChange != null && notChange.equals("false") && step == null) {
    linkName=(String)parameters.get("file");
    editFile=cms.readFile(linkName);
    content=new String(editFile.getContents());
    xmlTemplateDocument.setData("LINKNAME",editFile.getName());
    xmlTemplateDocument.setData("LINK",editFile.getAbsolutePath());
    xmlTemplateDocument.setData("LINKVALUE",content);
    template="change";
  }
  filename=cms.getRequestContext().getRequest().getParameter(C_PARA_FILE);
  if (filename != null) {
    session.putValue(C_PARA_FILE,filename);
  }
  link=cms.getRequestContext().getRequest().getParameter(C_PARA_LINK);
  if (link != null) {
    session.putValue(C_PARA_LINK,link);
  }
  if (step != null) {
    if (step.equals("1")) {
      foldername=(String)session.getValue(C_PARA_FILELIST);
      if (foldername == null) {
        foldername=cms.rootFolder().getAbsolutePath();
      }
      filename=(String)session.getValue(C_PARA_FILE);
      link=(String)session.getValue(C_PARA_LINK);
      String title=lang.getLanguageValue("explorer.linkto") + " " + link;
      type="link";
      if (notChange != null && notChange.equals("false")) {
        linkName=(String)parameters.get("file");
        editFile=cms.readFile(linkName);
        editFile.setContents(link.getBytes());
        cms.writeFile(editFile);
        cms.writeProperty(linkName,C_PROPERTY_TITLE,title);
        linkResource=(CmsResource)editFile;
      }
 else {
        Hashtable prop=new Hashtable();
        prop.put(C_PROPERTY_TITLE,title);
        linkResource=cms.createResource(foldername,filename,type,prop,link.getBytes());
      }
      if (navtitle != null) {
        cms.writeProperty(linkResource.getAbsolutePath(),C_PROPERTY_NAVTEXT,navtitle);
        if (navpos != null) {
          updateNavPos(cms,linkResource,navpos);
        }
      }
      session.removeValue(C_PARA_FILE);
      session.removeValue(C_PARA_VIEWFILE);
      session.removeValue(C_PARA_LINK);
      try {
        String lastUrl=(String)session.getValue("lasturl");
        String redirectUrl;
        if (lastUrl != null) {
          cms.getRequestContext().getResponse().sendRedirect(lastUrl);
        }
 else {
          cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + C_WP_EXPLORER_FILELIST);
        }
      }
 catch (      Exception e) {
        throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + C_WP_EXPLORER_FILELIST,CmsException.C_UNKNOWN_EXCEPTION,e);
      }
      return null;
    }
  }
 else {
    session.removeValue(C_PARA_FILE);
    session.removeValue(C_PARA_VIEWFILE);
  }
  String cancelUrl;
  cancelUrl=(String)session.getValue("lasturl");
  if (cancelUrl == null) {
    cancelUrl=C_WP_EXPLORER_FILELIST;
  }
  xmlTemplateDocument.setData("lasturl",cancelUrl);
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,template);
}

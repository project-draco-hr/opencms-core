{
  boolean success=true;
  byte[] content=null;
  String fullname=null;
  CmsResource res=null;
  try {
    if (m_importingChannelData) {
      String channelId=null;
      try {
        if ((type.equalsIgnoreCase(CmsResourceTypeFolder.C_RESOURCE_TYPE_NAME)) && (!destination.endsWith(C_FOLDER_SEPARATOR))) {
          destination+=C_FOLDER_SEPARATOR;
        }
        CmsResource channel=m_cms.readFileHeader(C_ROOT + destination);
        channelId=m_cms.readProperty(m_cms.readAbsolutePath(channel),I_CmsConstants.C_PROPERTY_CHANNELID);
      }
 catch (      Exception e) {
      }
      if (channelId == null) {
        int newChannelId=org.opencms.db.CmsIdGenerator.nextId(C_TABLE_CHANNELID);
        channelId="" + newChannelId;
      }
      properties.put(I_CmsConstants.C_PROPERTY_CHANNELID,channelId);
    }
    if (source != null) {
      content=getFileBytes(source);
    }
    if (m_importVersion < 2) {
      if ("page".equals(type) || ("plain".equals(type)) || ("XMLTemplate".equals(type))) {
        if (DEBUG > 0) {
          System.err.println("#########################");
          System.err.println("[" + this.getClass().getName() + ".importResource()]: starting conversion of \""+ type+ "\" resource "+ source+ ".");
        }
        content=convertFile(source,content);
      }
      if (m_importVersion == 0) {
        if (!(new CmsCompatibleCheck()).isTemplateCompatible(m_importPath + destination,content,type)) {
          type=CmsResourceTypeCompatiblePlain.C_RESOURCE_TYPE_NAME;
          m_report.print(m_report.key("report.must_set_to") + type + " ",I_CmsReport.C_FORMAT_WARNING);
        }
      }
    }
    if (m_importVersion < 3) {
      if ("page".equals(type)) {
        m_pageStorage.add(destination);
      }
 else       if ("folder".equals(type)) {
        if (destination.startsWith(C_VFS_PATH_BODIES)) {
          m_folderStorage.add(destination);
        }
      }
    }
    int resType=m_cms.getResourceTypeId(type);
    int size=0;
    if (content != null)     size=content.length;
    CmsUUID curUser=m_cms.getRequestContext().currentUser().getId();
    CmsUUID newUuidstructure=new CmsUUID();
    CmsUUID newUuidcontent=new CmsUUID();
    CmsUUID newUuidresource=new CmsUUID();
    if (uuid != null) {
      newUuidstructure=new CmsUUID(uuid);
    }
    if (uuidfile != null) {
      newUuidcontent=new CmsUUID(uuidfile);
    }
    if (uuidresource != null) {
      newUuidresource=new CmsUUID(uuidresource);
    }
    String resname=destination;
    if (resname.endsWith("/")) {
      resname=resname.substring(0,resname.length() - 1);
    }
    if (resname.lastIndexOf("/") > 0) {
      resname=resname.substring(resname.lastIndexOf("/") + 1,resname.length());
    }
    CmsResource resource=new CmsResource(newUuidstructure,newUuidresource,CmsUUID.getNullUUID(),newUuidcontent,resname,resType,new Integer(0).intValue(),m_cms.getRequestContext().currentProject().getId(),0,I_CmsConstants.C_STATE_NEW,curUser,m_cms.getResourceType(resType).getLoaderId(),lastmodified,curUser,lastmodified,curUser,size,m_cms.getRequestContext().currentProject().getId(),1);
    res=m_cms.importResource(resource,content,properties,m_importPath + destination);
    if (res != null) {
      if (CmsResourceTypePage.C_RESOURCE_TYPE_NAME.equals(type)) {
        m_importedPages.add(I_CmsConstants.C_FOLDER_SEPARATOR + destination);
      }
    }
    m_report.println(m_report.key("report.ok"),I_CmsReport.C_FORMAT_OK);
  }
 catch (  Exception exc) {
    success=false;
    m_report.println(exc);
    try {
      Thread.sleep(1000);
    }
 catch (    Exception e) {
    }
  }
  byte[] digestContent={0};
  if (content != null) {
    digestContent=m_digest.digest(content);
  }
  if (success && (fullname != null)) {
    if (writtenFilenames != null) {
      writtenFilenames.addElement(fullname);
    }
    if (fileCodes != null) {
      fileCodes.addElement(new String(digestContent));
    }
  }
  return res;
}

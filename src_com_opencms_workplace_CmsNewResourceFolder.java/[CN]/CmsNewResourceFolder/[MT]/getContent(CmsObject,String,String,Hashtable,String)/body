{
  String template=null;
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  CmsXmlLanguageFile lang=xmlTemplateDocument.getLanguageFile();
  I_CmsSession session=cms.getRequestContext().getSession(true);
  I_CmsRegistry registry=cms.getRegistry();
  boolean extendedNavigation="on".equals(registry.getSystemValue("extendedNavigation"));
  String initial=(String)parameters.get("initial");
  if (initial != null) {
    clearSession(session);
    xmlTemplateDocument.setData("name","");
    xmlTemplateDocument.setData("title","");
  }
  xmlTemplateDocument.setData("navtext","");
  xmlTemplateDocument.setData("doOnload","");
  String currentFilelist=(String)session.getValue(C_PARA_FILELIST);
  if (currentFilelist == null) {
    currentFilelist=cms.rootFolder().getAbsolutePath();
  }
  if ((extendedNavigation) && (cms.rootFolder().getAbsolutePath().equals(currentFilelist))) {
    xmlTemplateDocument.setData("frameTitle",lang.getLanguageValue("label.ebtitle"));
  }
 else {
    xmlTemplateDocument.setData("frameTitle",lang.getLanguageValue("title.newfolder"));
  }
  if (extendedNavigation) {
    xmlTemplateDocument.setData("endbutton",lang.getLanguageValue("button.nextscreen"));
  }
 else {
    xmlTemplateDocument.setData("endbutton",lang.getLanguageValue("button.endwizard"));
  }
  String newFolder=(String)parameters.get(C_PARA_NEWFOLDER);
  String title=(String)parameters.get(C_PARA_TITLE);
  String navtitle=(String)parameters.get(C_PARA_NAVTEXT);
  String navpos=(String)parameters.get(C_PARA_NAVPOS);
  String step=(String)parameters.get("step");
  if (step != null) {
    if (step.equals("extNavError")) {
      step="1";
      newFolder=(String)session.getValue(C_SESSIONHEADER + C_PARA_NEWFOLDER);
      title=(String)session.getValue(C_SESSIONHEADER + C_PARA_TITLE);
      navtitle=(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVTEXT);
      navpos=(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVPOS);
    }
    if (step.equals("1")) {
      session.putValue(C_SESSIONHEADER + C_PARA_NEWFOLDER,newFolder);
      session.putValue(C_SESSIONHEADER + C_PARA_TITLE,title);
      if (navtitle != null) {
        session.putValue(C_SESSIONHEADER + C_PARA_NAVTEXT,navtitle);
        session.putValue(C_SESSIONHEADER + C_PARA_NAVPOS,navpos);
      }
 else {
        session.removeValue(C_SESSIONHEADER + C_PARA_NAVTEXT);
        session.removeValue(C_SESSIONHEADER + C_PARA_NAVPOS);
      }
      if (extendedNavigation) {
        Hashtable preprops=(Hashtable)session.getValue(C_SESSIONHEADER + "extendedProperties");
        setNavDefault(xmlTemplateDocument,preprops,newFolder);
        if (cms.rootFolder().getAbsolutePath().equals(currentFilelist)) {
          xmlTemplateDocument.setData("displaySektLogo",xmlTemplateDocument.getProcessedDataValue("SektLogo",this));
          xmlTemplateDocument.setData("displayFolderLogo","");
        }
 else {
          xmlTemplateDocument.setData("displayFolderLogo",xmlTemplateDocument.getProcessedDataValue("folderLogo",this));
          xmlTemplateDocument.setData("displaySektLogo","");
        }
        template="extendedNav";
      }
 else {
        try {
          CmsFolder folder=cms.createFolder(currentFilelist,newFolder);
          cms.lockResource(folder.getAbsolutePath());
          cms.writeProperty(folder.getAbsolutePath(),C_PROPERTY_TITLE,title);
          if (navtitle != null) {
            cms.writeProperty(folder.getAbsolutePath(),C_PROPERTY_NAVTEXT,navtitle);
            if (navpos != null) {
              updateNavPos(cms,folder,navpos);
              try {
                cms.unlockResource(folder.getAbsolutePath());
              }
 catch (              CmsException e) {
              }
              session.putValue(C_PARA_FILELIST,folder.getAbsolutePath());
              xmlTemplateDocument.setData("indexlocation",folder.getAbsolutePath());
            }
            template="update2";
          }
 else {
            template="update";
          }
          clearSession(session);
        }
 catch (        CmsException ex) {
          xmlTemplateDocument.setData("details",Utils.getStackTrace(ex));
          return startProcessing(cms,xmlTemplateDocument,"",parameters,"error_system");
        }
      }
    }
 else     if ("2".equals(step)) {
      String back=(String)parameters.get("back");
      newFolder=(String)session.getValue(C_SESSIONHEADER + C_PARA_NEWFOLDER);
      title=(String)session.getValue(C_SESSIONHEADER + C_PARA_TITLE);
      navtitle=(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVTEXT);
      navpos=(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVPOS);
      Hashtable allProperties=new Hashtable();
      insertProperty(allProperties,C_PROPERTY_TITLE,title);
      insertProperty(allProperties,C_PROPERTY_NAVTEXT,navtitle);
      fillProperties(allProperties,parameters);
      session.putValue(C_SESSIONHEADER + "extendedProperties",allProperties);
      if (back == null) {
        try {
          int propError=checkProperties(cms,allProperties);
          if (propError > 0) {
            template="error_" + propError;
            return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
          }
          CmsFolder folder=cms.createFolder(currentFilelist,newFolder);
          cms.lockResource(folder.getAbsolutePath());
          cms.writeProperties(folder.getAbsolutePath(),allProperties);
          if ((navtitle != null) && (navpos != null)) {
            updateNavPos(cms,folder,navpos);
            try {
              cms.unlockResource(folder.getAbsolutePath());
            }
 catch (            CmsException e) {
            }
            xmlTemplateDocument.setData("indexlocation",folder.getAbsolutePath());
            session.putValue(C_PARA_FILELIST,folder.getAbsolutePath());
            template="update2";
          }
 else {
            template="update";
          }
          clearSession(session);
        }
 catch (        CmsException ex) {
          xmlTemplateDocument.setData("details",Utils.getStackTrace(ex));
          return startProcessing(cms,xmlTemplateDocument,"",parameters,"error_system");
        }
      }
 else {
        xmlTemplateDocument.setData("name",newFolder);
        xmlTemplateDocument.setData("title",title);
        if (navtitle != null) {
          xmlTemplateDocument.setData("navtext",navtitle);
        }
 else {
          xmlTemplateDocument.setData("doOnload","checkInTheBox();");
        }
        template=null;
      }
    }
 else     if ("fromerror".equalsIgnoreCase(step)) {
      template=null;
      xmlTemplateDocument.setData("name",(String)session.getValue(C_SESSIONHEADER + C_PARA_NEWFOLDER));
      xmlTemplateDocument.setData("title",(String)session.getValue(C_SESSIONHEADER + C_PARA_TITLE));
      navtitle=(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVTEXT);
      if (navtitle != null) {
        xmlTemplateDocument.setData("navtext",navtitle);
      }
 else {
        xmlTemplateDocument.setData("doOnload","checkInTheBox();");
      }
    }
  }
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

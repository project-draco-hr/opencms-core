{
  String template=null;
  HttpSession session=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getSession(true);
  String currentFilelist=(String)session.getValue(C_PARA_FILELIST);
  if (currentFilelist == null) {
    currentFilelist=cms.rootFolder().getAbsolutePath();
  }
  String newFolder=(String)parameters.get(C_PARA_NEWFOLDER);
  String title=(String)parameters.get(C_PARA_TITLE);
  String navtitle=(String)parameters.get(C_PARA_NAVTITLE);
  String navpos=(String)parameters.get(C_PARA_NAVPOS);
  String step=cms.getRequestContext().getRequest().getParameter("step");
  if (step != null) {
    if (step.equals("1")) {
      try {
        CmsFolder folder=cms.createFolder(currentFilelist,newFolder);
        cms.lockResource(folder.getAbsolutePath());
        cms.writeMetainformation(folder.getAbsolutePath(),C_METAINFO_TITLE,title);
        if (navtitle != null) {
          cms.writeMetainformation(folder.getAbsolutePath(),C_METAINFO_NAVTITLE,navtitle);
          if (navpos != null) {
            updateNavPos(cms,folder,navpos);
          }
        }
        cms.unlockResource(folder.getAbsolutePath());
      }
 catch (      CmsException ex) {
        throw new CmsException("Error while creating new Folder" + ex.getMessage(),ex.getType(),ex);
      }
      template="update";
    }
  }
 else {
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

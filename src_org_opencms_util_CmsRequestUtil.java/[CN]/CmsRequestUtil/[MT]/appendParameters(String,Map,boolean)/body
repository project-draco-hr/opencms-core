{
  if (CmsStringUtil.isEmpty(url)) {
    return null;
  }
  if ((params == null) || params.isEmpty()) {
    return url;
  }
  int pos=url.indexOf(URL_DELIMITER);
  StringBuffer result=new StringBuffer(256);
  result.append(url);
  if (pos >= 0) {
    result.append(PARAMETER_DELIMITER);
  }
 else {
    result.append(URL_DELIMITER);
  }
  Map newParams=createParameterMap(params);
  Iterator i=newParams.entrySet().iterator();
  while (i.hasNext()) {
    Map.Entry entry=(Map.Entry)i.next();
    String key=(String)entry.getKey();
    Object value=entry.getValue();
    String[] values=(String[])value;
    for (int j=0; j < values.length; j++) {
      String strValue=values[j];
      if (encode) {
        strValue=CmsEncoder.encode(strValue);
      }
      result.append(key);
      result.append(PARAMETER_ASSIGNMENT);
      result.append(strValue);
      if ((j + 1) < values.length) {
        result.append(PARAMETER_DELIMITER);
      }
    }
    if (i.hasNext()) {
      result.append(PARAMETER_DELIMITER);
    }
  }
  return result.toString();
}

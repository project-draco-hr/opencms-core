{
  byte[] result;
  String masterTemplateUri=cms.readAbsolutePath(masterTemplate);
  CmsCacheDirectives cd=templateClass.collectCacheDirectives(cms,masterTemplateUri,I_CmsConstants.C_ROOT_TEMPLATE_NAME,parameters,null);
  Object cacheKey=templateClass.getKey(cms,masterTemplateUri,parameters,null);
  boolean cacheable=cd.isInternalCacheable();
  I_CmsResponse resp=cms.getRequestContext().getResponse();
  if (!resp.containsHeader("Cache-Control")) {
    if (cd.isProxyPublicCacheable() || cd.isProxyPrivateCacheable()) {
      resp.setHeader("Cache-Control","max-age=300");
      if (cd.isProxyPrivateCacheable()) {
        resp.addHeader("Cache-Control","private");
      }
    }
 else {
      resp.setHeader("Cache-Control","no-cache");
      resp.setHeader("Pragma","no-cache");
    }
  }
  if (cacheable && cache.has(cacheKey) && !templateClass.shouldReload(cms,masterTemplateUri,I_CmsConstants.C_ROOT_TEMPLATE_NAME,parameters,null)) {
    result=cache.get(cacheKey);
  }
 else {
    try {
      result=templateClass.getContent(cms,masterTemplateUri,I_CmsConstants.C_ROOT_TEMPLATE_NAME,parameters);
    }
 catch (    CmsException e) {
      cache.clearCache(cacheKey);
      if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isInfoEnabled()) {
        OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).info("[CmsRootTemplate] Could not get contents of master template " + masterTemplate.getName());
      }
      throw e;
    }
    if (cacheable) {
      cache.put(cacheKey,result);
    }
  }
  return result;
}

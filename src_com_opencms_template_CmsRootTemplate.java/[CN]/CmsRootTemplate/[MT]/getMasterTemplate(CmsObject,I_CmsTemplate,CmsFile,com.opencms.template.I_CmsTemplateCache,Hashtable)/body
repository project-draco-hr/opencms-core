{
  byte[] result;
  CmsCacheDirectives cd=templateClass.collectCacheDirectives(cms,cms.readAbsolutePath(masterTemplate),C_ROOT_TEMPLATE_NAME,parameters,null);
  boolean streamable=cms.getRequestContext().isStreaming() && cd.isStreamable();
  cms.getRequestContext().setStreaming(streamable);
  Object cacheKey=templateClass.getKey(cms,cms.readAbsolutePath(masterTemplate),parameters,null);
  boolean cacheable=cd.isInternalCacheable();
  I_CmsResponse resp=cms.getRequestContext().getResponse();
  if (!resp.containsHeader("Cache-Control")) {
    if (cd.isProxyPublicCacheable() || cd.isProxyPrivateCacheable()) {
      resp.setHeader("Cache-Control","max-age=300");
      if (cd.isProxyPrivateCacheable()) {
        resp.addHeader("Cache-Control","private");
      }
    }
 else {
      resp.setHeader("Cache-Control","no-cache");
      resp.setHeader("Pragma","no-cache");
    }
  }
  if (cacheable && cache.has(cacheKey) && !templateClass.shouldReload(cms,cms.readAbsolutePath(masterTemplate),C_ROOT_TEMPLATE_NAME,parameters,null)) {
    result=cache.get(cacheKey);
    cms.getRequestContext().setStreaming(false);
  }
 else {
    try {
      result=templateClass.getContent(cms,cms.readAbsolutePath(masterTemplate),C_ROOT_TEMPLATE_NAME,parameters);
    }
 catch (    CmsException e) {
      cache.clearCache(cacheKey);
      if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,"[CmsRootTemplate] Could not get contents of master template " + masterTemplate.getResourceName());
      }
      throw e;
    }
    if (cacheable) {
      cache.put(cacheKey,result);
    }
    if (streamable) {
      result=null;
    }
  }
  return result;
}

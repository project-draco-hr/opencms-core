{
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  String lasturl=getLastUrl(cms,parameters);
  getInitial(session,parameters);
  String foldername=getGalleryPath(cms,session,parameters);
  CmsFolder thefolder=cms.readFolder(foldername);
  if (foldername.equals(C_VFS_GALLERY_DOWNLOAD) && templateFile.endsWith("administration_head_downgalleries2")) {
    xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,C_VFS_PATH_WORKPLACE + "administration/downloadgallery/administration_head_downgalleries1",elementName,parameters,templateSelector);
  }
  try {
    String parent=CmsResource.getParentFolder(cms.getSitePath(thefolder));
    if (foldername.startsWith(C_VFS_GALLERY_DOWNLOAD) && (parent.equals(C_VFS_GALLERY_PICS)) && templateFile.endsWith("administration_head_downgalleries1")) {
      xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,C_VFS_PATH_WORKPLACE + "administration/htmlgallery/administration_head_downgalleries2",elementName,parameters,templateSelector);
    }
  }
 catch (  Exception e) {
  }
  String action=(String)parameters.get("action");
  String unzip=(String)parameters.get("unzip");
  String nofolder=(String)parameters.get("NOFOLDER");
  String newtype=(String)parameters.get(C_PARA_NEWTYPE);
  if (newtype != null) {
    session.putValue(C_PARA_NEWTYPE,newtype);
  }
 else {
    newtype=(String)session.getValue(C_PARA_NEWTYPE);
  }
  String newname=(String)parameters.get(C_PARA_NAME);
  String title=(String)parameters.get("TITLE");
  String step=(String)parameters.get("step");
  String filename=null;
  if (foldername == null) {
    foldername="";
  }
  if ("new".equals(action)) {
    String galleryname=(String)parameters.get("NAME");
    try {
      String superfolder=getConfigFile(cms).getDownGalleryPath();
      CmsFolder folder=(CmsFolder)cms.createResource(superfolder + galleryname,CmsResourceTypeFolder.C_RESOURCE_TYPE_ID);
      cms.writeProperty(cms.getSitePath(folder),C_PROPERTY_TITLE,title);
      cms.unlockResource(cms.getSitePath(folder));
    }
 catch (    CmsException ex) {
      xmlTemplateDocument.setData("ERRORDETAILS",CmsException.getStackTraceAsString(ex));
      templateSelector="error";
    }
  }
 else {
    if ("upload".equals(action)) {
      byte[] filecontent=new byte[0];
      Enumeration files=CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getFileNames();
      while (files.hasMoreElements()) {
        filename=(String)files.nextElement();
      }
      if (filename != null) {
        session.putValue(C_PARA_RESOURCE,filename);
      }
      filename=(String)session.getValue(C_PARA_RESOURCE);
      if (filename != null) {
        filecontent=CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getFile(filename);
      }
      if (filecontent != null) {
        session.putValue(C_PARA_FILECONTENT,filecontent);
      }
      filecontent=(byte[])session.getValue(C_PARA_FILECONTENT);
      if ("0".equals(step)) {
        templateSelector="";
      }
 else {
        if ("1".equals(step)) {
          if (filename != null) {
            if (filecontent.length == 0) {
              templateSelector="error";
              xmlTemplateDocument.setData("details",filename);
            }
 else {
              if (unzip != null) {
                boolean noSubFolder=(nofolder != null ? true : false);
                CmsImportFolder zip=new CmsImportFolder(filecontent,foldername,cms,noSubFolder);
                if (zip.isValidZipFile()) {
                  session.removeValue(C_PARA_RESOURCE);
                  session.removeValue(C_PARA_FILECONTENT);
                  session.removeValue(C_PARA_NEWTYPE);
                  try {
                    if ((lasturl != null) && (lasturl != "")) {
                      CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendRedirect(lasturl);
                    }
 else {
                      CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()));
                    }
                  }
 catch (                  Exception ex) {
                    throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()),CmsException.C_UNKNOWN_EXCEPTION,ex);
                  }
                  return null;
                }
              }
              templateSelector="step1";
            }
          }
        }
 else {
          if ("2".equals(step)) {
            int type=OpenCms.getResourceManager().getResourceType(newtype).getTypeId();
            if (newtype.equals(CmsResourceTypeImage.C_RESOURCE_TYPE_NAME)) {
              templateSelector="image";
              xmlTemplateDocument.setData("MIME",filename);
              xmlTemplateDocument.setData("SIZE","Not yet available");
              xmlTemplateDocument.setData("FILESIZE",new Integer(filecontent.length).toString() + " Bytes");
            }
 else {
              try {
                cms.createResource(foldername + filename,type,filecontent,Collections.EMPTY_LIST);
              }
 catch (              CmsException e) {
                session.removeValue(C_PARA_RESOURCE);
                session.removeValue(C_PARA_FILECONTENT);
                session.removeValue(C_PARA_NEWTYPE);
                xmlTemplateDocument.setData("details",CmsException.getStackTraceAsString(e));
                return startProcessing(cms,xmlTemplateDocument,"",parameters,"error2");
              }
              session.removeValue(C_PARA_RESOURCE);
              session.removeValue(C_PARA_FILECONTENT);
              session.removeValue(C_PARA_NEWTYPE);
              try {
                if ((lasturl != null) && (lasturl != "")) {
                  CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendRedirect(lasturl);
                }
 else {
                  CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()));
                }
              }
 catch (              Exception ex) {
                throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()),CmsException.C_UNKNOWN_EXCEPTION,ex);
              }
              return null;
            }
          }
 else {
            if ("3".equals(step)) {
              if (newname != null) {
                filename=newname;
              }
              int type=OpenCms.getResourceManager().getResourceType(newtype).getTypeId();
              List properties=null;
              if (title != null) {
                properties=new ArrayList();
                properties.add(new org.opencms.file.CmsProperty(I_CmsConstants.C_PROPERTY_TITLE,title,null));
              }
 else {
                properties=Collections.EMPTY_LIST;
              }
              cms.createResource(foldername + filename,type,filecontent,properties);
              session.removeValue(C_PARA_RESOURCE);
              session.removeValue(C_PARA_FILECONTENT);
              session.removeValue(C_PARA_NEWTYPE);
              session.removeValue("lasturl");
              try {
                if ((lasturl != null) && (lasturl != "")) {
                  CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendRedirect(lasturl);
                }
 else {
                  CmsXmlTemplateLoader.getResponse(cms.getRequestContext()).sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()));
                }
              }
 catch (              Exception ex) {
                throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()),CmsException.C_UNKNOWN_EXCEPTION,ex);
              }
              return null;
            }
          }
        }
      }
    }
  }
  xmlTemplateDocument.setData("link_value",foldername);
  xmlTemplateDocument.setData("lasturl",lasturl);
  xmlTemplateDocument.setData("galleryRootFolder",C_VFS_GALLERY_DOWNLOAD);
  if (filename != null) {
    xmlTemplateDocument.setData("FILENAME",filename);
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

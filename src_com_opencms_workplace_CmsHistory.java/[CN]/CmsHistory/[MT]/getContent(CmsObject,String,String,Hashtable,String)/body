{
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  String template=null;
  String initial=(String)parameters.get(C_PARA_INITIAL);
  if (initial != null) {
    session.removeValue(C_PARA_RESOURCE);
    session.removeValue("lasturl");
    session.removeValue("version");
  }
  String filename=(String)parameters.get(C_PARA_RESOURCE);
  if (filename != null) {
    session.putValue(C_PARA_RESOURCE,filename);
  }
  filename=(String)session.getValue(C_PARA_RESOURCE);
  String versionId=(String)parameters.get("versionid");
  Integer id=null;
  CmsBackupResource backupFile=null;
  String theFileName="";
  if (versionId != null) {
    id=new Integer(Integer.parseInt(versionId));
    session.putValue("version",versionId);
    backupFile=(CmsBackupResource)cms.readBackupFileHeader(filename,id.intValue());
    theFileName=backupFile.getName();
  }
 else {
    CmsFile offlineFile=(CmsFile)cms.readFileHeader(filename,CmsResourceFilter.ALL);
    theFileName=offlineFile.getName();
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  if (id != null) {
    template="detail";
    CmsBackupProject project=cms.readBackupProject(id.intValue());
    xmlTemplateDocument.setData("PROJECT",project.getName());
    String title=cms.readProperty(filename,C_PROPERTY_TITLE);
    if (title == null) {
      title="";
    }
    if (cms.getRequestContext().currentProject().getId() == C_PROJECT_ONLINE_ID) {
      xmlTemplateDocument.setData("BUTTONRESTORE",xmlTemplateDocument.getProcessedDataValue("DISABLERESTORE",this));
    }
 else {
      CmsLock lock=cms.getLock(filename);
      if ((!lock.isNullLock() && lock.getUserId() == cms.getRequestContext().currentUser().getId()) || (lock.isNullLock() && OpenCms.getWorkplaceManager().autoLockResources())) {
        xmlTemplateDocument.setData("BUTTONRESTORE",xmlTemplateDocument.getProcessedDataValue("ENABLERESTORE",this));
      }
 else {
        xmlTemplateDocument.setData("BUTTONRESTORE",xmlTemplateDocument.getProcessedDataValue("DISABLERESTORE",this));
      }
    }
    String editedBy=backupFile.getLastModifiedByName();
    xmlTemplateDocument.setData("TITLE",CmsEncoder.escapeXml(title));
    xmlTemplateDocument.setData("SIZE",new Integer(backupFile.getLength()).toString());
    xmlTemplateDocument.setData("EDITEDBY",editedBy);
    xmlTemplateDocument.setData("EDITEDAT",CmsMessages.getDateTimeShort(backupFile.getDateLastModified()));
    xmlTemplateDocument.setData("PUBLISHEDBY",project.getPublishedByName());
    xmlTemplateDocument.setData("PUBLISHEDAT",CmsMessages.getDateTimeShort(project.getPublishingDate()));
    xmlTemplateDocument.setData("PROJECTDESCRIPTION",CmsEncoder.escapeXml(project.getDescription()));
  }
  xmlTemplateDocument.setData("FILENAME",theFileName);
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

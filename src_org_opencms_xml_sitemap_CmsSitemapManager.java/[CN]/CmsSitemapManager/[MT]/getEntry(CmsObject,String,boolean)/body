{
  CmsUUID logId=null;
  if (LOG.isDebugEnabled()) {
    logId=new CmsUUID();
    LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_ENTRY_3,logId,uri,Boolean.valueOf(online)).key());
  }
  CmsXmlSitemap sitemapXml=null;
  String sitemapFolder=cms.getRequestContext().removeSiteRoot(uri);
  String originalSitemapFolder=sitemapFolder;
  boolean isRootSite=cms.getRequestContext().getSiteRoot().equals("");
  CmsSite site=null;
  if (isRootSite) {
    site=OpenCms.getSiteManager().getSiteForRootPath(uri);
  }
  while (sitemapFolder != null) {
    if (cms.existsResource(sitemapFolder)) {
      String prop=cms.readPropertyObject(sitemapFolder,CmsPropertyDefinition.PROPERTY_SITEMAP,false).getValue();
      if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(prop)) {
        if (isRootSite && (site != null)) {
          prop=site.getSiteRoot() + prop;
        }
        if (cms.existsResource(prop)) {
          sitemapXml=CmsXmlSitemapFactory.unmarshal(cms,cms.readResource(prop));
          break;
        }
      }
    }
    sitemapFolder=CmsResource.getParentFolder(sitemapFolder);
  }
  if ((sitemapXml == null) || (sitemapFolder == null)) {
    return null;
  }
  CmsSitemapBean sitemap=sitemapXml.getSitemap(cms,cms.getRequestContext().getLocale());
  if ((sitemap == null) || sitemap.getSiteEntries().isEmpty()) {
    return null;
  }
  LinkedList<String> entryPaths=new LinkedList<String>(CmsStringUtil.splitAsList(normalizePath(originalSitemapFolder.substring(sitemapFolder.length())),"/"));
  Map<String,String> properties=new HashMap<String,String>();
  properties.putAll(sitemap.getSiteEntries().get(0).getProperties());
  if (entryPaths.isEmpty()) {
    CmsSiteEntryBean entry=sitemap.getSiteEntries().get(0);
    entry.setRuntimeInfo(sitemapFolder,properties,0,null);
    LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_FOUND_3,logId,new Integer(0),entry.getUri()).key());
    return entry;
  }
  String uriPath=cms.getRequestContext().getSiteRoot() + sitemapFolder;
  List<CmsSiteEntryBean> subEntries=sitemap.getSiteEntries().get(0).getSubEntries();
  boolean finished=false;
  while (!finished) {
    String name=entryPaths.removeFirst();
    LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_ENTRY_CHECK_2,logId,uriPath).key());
    uriPath+="/" + name;
    if (m_cache.getMissingUri(uriPath,online) != null) {
      LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_ENTRY_MISSING_2,logId,uriPath).key());
      return null;
    }
    int position=0;
    int size=subEntries.size();
    for (; position < size; position++) {
      CmsSiteEntryBean entry=subEntries.get(position);
      entry.setRuntimeInfo(sitemapFolder,properties,position,null);
      m_cache.setUri(uri,entry,online);
      if (!entry.getName().equals(name)) {
        LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_NO_MATCH_3,logId,new Integer(position),entry.getUri()).key());
        continue;
      }
      LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_MATCH_3,logId,new Integer(position),entry.getUri()).key());
      if (entryPaths.isEmpty()) {
        LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_FOUND_3,logId,new Integer(position),entry.getUri()).key());
        return entry;
      }
 else {
        boolean changedSitemap=false;
        subEntries=entry.getSubEntries();
        if (subEntries.isEmpty()) {
          String subSitemapId=entry.getProperties().get(CmsSitemapManager.Property.sitemap.name());
          if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(subSitemapId)) {
            CmsResource subSitemap=cms.readResource(new CmsUUID(subSitemapId));
            LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_SUBSITEMAP_2,logId,cms.getSitePath(subSitemap)).key());
            sitemapXml=CmsXmlSitemapFactory.unmarshal(cms,subSitemap);
            sitemap=sitemapXml.getSitemap(cms,cms.getRequestContext().getLocale());
            if (sitemap == null) {
              return null;
            }
            subEntries=sitemap.getSiteEntries();
            changedSitemap=true;
          }
        }
        finished=subEntries.isEmpty();
        if (finished) {
          if ((entryPaths.size() == 1) && CmsUUID.isValidUUID(entryPaths.get(0))) {
            CmsUUID id=new CmsUUID(entryPaths.get(0));
            CmsResource contentRes=cms.readResource(id);
            String title=cms.readPropertyObject(contentRes,CmsPropertyDefinition.PROPERTY_TITLE,false).getValue(id.toString());
            HashMap<String,String> entryProps=new HashMap<String,String>(entry.getProperties());
            entryProps.put(Property.navigation.name(),Boolean.FALSE.toString());
            properties.put(Property.navigation.name(),Boolean.FALSE.toString());
            entry=new CmsSiteEntryBean(entry.getId(),entry.getOriginalUri(),entry.getResourceId(),id.toString(),title,entryProps,null);
            entry.setRuntimeInfo(sitemapFolder,properties,0,id);
            LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_FOUND_3,logId,new Integer(0),entry.getUri()).key());
            return entry;
          }
          LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_NO_SUBENTRIES_3,logId,new Integer(position),entry.getUri()).key());
        }
        if (changedSitemap) {
          sitemapFolder=cms.getRequestContext().removeSiteRoot(uriPath);
        }
        properties.putAll(entry.getProperties());
      }
      break;
    }
    if (position == size) {
      finished=true;
      LOG.debug(Messages.get().container(Messages.LOG_DEBUG_SITEMAP_NOT_FOUND_2,logId,uriPath).key());
    }
  }
  return null;
}

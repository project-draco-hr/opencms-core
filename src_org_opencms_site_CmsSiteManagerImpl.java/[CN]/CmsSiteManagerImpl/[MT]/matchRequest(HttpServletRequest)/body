{
  CmsSite site=null;
  if (isWorkplaceRequest(req)) {
    String siteParam=(String)req.getSession().getAttribute(SESSION_ATTR_SITE);
    if (siteParam != null) {
      site=OpenCms.getSiteManager().getSiteForSiteRoot(siteParam);
      if (site == null) {
        req.getSession().removeAttribute(SESSION_ATTR_SITE);
      }
    }
  }
  if (site == null) {
    CmsSiteMatcher matcher=new CmsSiteMatcher(req.getScheme(),req.getServerName(),req.getServerPort());
    site=matchSite(matcher);
  }
  if (LOG.isDebugEnabled()) {
    String requestServer=req.getScheme() + "://" + req.getServerName()+ ":"+ req.getServerPort();
    LOG.debug(Messages.get().getBundle().key(Messages.LOG_MATCHING_REQUEST_TO_SITE_2,requestServer,site.toString()));
  }
  return site;
}

{
  setCms(cms);
  setReport(report);
  setExportFileName(exportFile);
  setExportingCosData(true);
  setExportedChannelIds(new HashSet());
  getCms().getRequestContext().saveSiteRoot();
  Element exportNode;
  try {
    exportNode=openExportFile();
    getReport().println(getReport().key("report.export_channels_begin"),I_CmsReport.C_FORMAT_HEADLINE);
    getCms().getRequestContext().setSiteRoot(I_CmsConstants.VFS_FOLDER_COS);
    exportAllResources(exportNode,resourcesToExport);
    getReport().println(getReport().key("report.export_channels_end"),I_CmsReport.C_FORMAT_HEADLINE);
    Vector modules=new Vector();
    Vector moduleNames=new Vector();
    for (int i=0; i < modulesToExport.length; i++) {
      String modName=modulesToExport[i];
      if (modName != null && !"".equals(modName)) {
        moduleNames.addElement(modulesToExport[i]);
      }
    }
    Hashtable moduleExportables=new Hashtable();
    OpenCms.getRegistry().getModuleExportables(moduleExportables);
    if (moduleNames.size() == 0) {
      if (resourcesToExport.length > 0) {
        Enumeration modElements=moduleExportables.elements();
        while (modElements.hasMoreElements()) {
          modules.add(modElements.nextElement());
        }
      }
    }
 else {
      modules=moduleNames;
    }
    Enumeration enumModules=modules.elements();
    while (enumModules.hasMoreElements()) {
      String classname=(String)enumModules.nextElement();
      exportCos(exportNode,classname,getExportedChannelIds());
    }
    closeExportFile(exportNode);
  }
 catch (  SAXException se) {
    getReport().println(se);
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error("Error exporting to file " + getExportFileName(),se);
    }
    throw new CmsException(CmsException.C_UNKNOWN_EXCEPTION,se);
  }
catch (  IOException ioe) {
    getReport().println(ioe);
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error("Error exporting to file " + getExportFileName(),ioe);
    }
    throw new CmsException(CmsException.C_UNKNOWN_EXCEPTION,ioe);
  }
 finally {
    getCms().getRequestContext().restoreSiteRoot();
  }
}

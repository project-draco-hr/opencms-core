{
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String saveerror="";
  String file=(String)parameters.get(C_PARA_FILE);
  if ((file == null) || ("".equals(file))) {
    file=(String)session.getValue(C_PARA_FILE);
    session.removeValue(C_PARA_FILE);
  }
  String content=(String)parameters.get(C_PARA_CONTENT);
  if ((content == null) || ("".equals(content))) {
    content=(String)session.getValue(C_PARA_CONTENT);
    if (content != null) {
      parameters.put(C_PARA_CONTENT,content);
    }
    session.removeValue(C_PARA_CONTENT);
  }
  String action=(String)parameters.get(C_PARA_ACTION);
  String jsfile=(String)parameters.get(C_ROOT_TEMPLATE_NAME + "." + C_PARA_JSFILE);
  if ((jsfile == null) || ("".equals(jsfile))) {
    jsfile=(String)session.getValue(C_PARA_JSFILE);
    session.removeValue(C_PARA_JSFILE);
  }
  String editorframe=(String)parameters.get("root.editorframe");
  if ((editorframe == null) || ("".equals(editorframe))) {
    editorframe=(String)session.getValue("editorframe");
    session.removeValue("editorframe");
  }
  boolean checkit=false;
  boolean existsFileParam=((file != null) && (!"".equals(file)));
  boolean saveRequested=((action != null) && (C_EDIT_ACTION_SAVE.equals(action) || C_EDIT_ACTION_SAVEEXIT.equals(action)));
  boolean exitRequested=((action != null) && (C_EDIT_ACTION_EXIT.equals(action) || C_EDIT_ACTION_SAVEEXIT.equals(action)));
  I_CmsRegistry registry=cms.getRegistry();
  boolean extendedNavigation="on".equals(registry.getSystemValue("extendedNavigation"));
  Encoder enc=new Encoder();
  CmsFile editFile=null;
  if (existsFileParam && (content == null || saveRequested)) {
    editFile=readFile(cms,file);
    checkit=true;
    if (content == null) {
      content=new String(editFile.getContents());
      content=enc.escapeWBlanks(content);
      parameters.put(C_PARA_CONTENT,content);
    }
    if (saveRequested) {
      try {
        String decodedContent=enc.unescape(content);
        editFile.setContents(decodedContent.getBytes());
        cms.writeFile(editFile);
      }
 catch (      CmsException e) {
        saveerror=e.getShortException();
      }
    }
  }
  if (exitRequested && ((saveerror == null) || ("".equals(saveerror)))) {
    try {
      cms.getRequestContext().getResponse().sendCmsRedirect("/system/workplace/action/index.html");
    }
 catch (    IOException e) {
      throwException("Could not send redirect to workplace main screen.",e);
    }
    return null;
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  String sectionName=getBrowserSpecificSection(cms,xmlTemplateDocument,parameters);
  if (templateFile.equalsIgnoreCase(xmlTemplateDocument.C_TEMPLATEPATH + "edit_html_main")) {
    if (extendedNavigation) {
      xmlTemplateDocument.setData("linklist",xmlTemplateDocument.getProcessedDataValue("linklist_enabled",this));
    }
 else {
      xmlTemplateDocument.setData("linklist",xmlTemplateDocument.getProcessedDataValue("linklist_disabled",this));
    }
  }
  xmlTemplateDocument.setData(C_PARA_FILE,file);
  xmlTemplateDocument.setData(C_PARA_JSFILE,jsfile);
  xmlTemplateDocument.setData("editorframe",editorframe);
  if (checkit == true) {
    xmlTemplateDocument.setData("fileName",(String)editFile.getName());
    xmlTemplateDocument.setData("pathName",(String)editFile.getPath());
  }
  String lasturlname=null;
  if (!"".equals(saveerror)) {
    if (file != null) {
      session.putValue(C_PARA_FILE,file);
    }
    if (content != null) {
      session.putValue(C_PARA_CONTENT,content);
    }
    if (jsfile != null) {
      session.putValue(C_PARA_JSFILE,jsfile);
    }
    if (editorframe != null) {
      session.putValue("editorframe",editorframe);
    }
    sectionName="errorsave";
    xmlTemplateDocument.setData("errordetail",saveerror);
    lasturlname=(String)parameters.get("editor._TEMPLATE_");
    if (lasturlname != null) {
      lasturlname=lasturlname.substring(lasturlname.lastIndexOf("/") + 1,lasturlname.length());
    }
    xmlTemplateDocument.setData("errorlasturl",lasturlname + ".html");
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,sectionName);
}

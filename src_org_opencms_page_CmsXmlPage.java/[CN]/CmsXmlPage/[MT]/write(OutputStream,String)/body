{
  try {
    OutputFormat format=OutputFormat.createPrettyPrint();
    format.setEncoding(encoding);
    XMLWriter writer=new XMLWriter(out,format);
    writer.setEscapeText(false);
    DocumentType type=m_document.getDocType();
    if (type != null) {
      String systemId=type.getSystemID();
      if ((systemId != null) && systemId.endsWith(CmsXmlPageEntityResolver.C_XMLPAGE_DTD_OLD_SYSTEM_ID)) {
        m_document.addDocType(C_DOCUMENT_NODE,"",C_XMLPAGE_DTD_SYSTEM_ID);
      }
    }
    writer.write(m_document);
    writer.close();
  }
 catch (  Exception exc) {
    throw new CmsXmlPageException("Writing xml page failed",exc);
  }
  return out;
}

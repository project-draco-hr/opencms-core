{
  HttpServletRequest orgReq=(HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest();
  HttpSession session=orgReq.getSession(true);
  String file=(String)parameters.get(C_NEWS_PARAM_FILE);
  if (file == null) {
    file=(String)session.getValue(C_NEWS_PARAM_FILE);
  }
 else {
    session.putValue("file",file);
  }
  String action=(String)parameters.get("action");
  if (action == null) {
    action=(String)session.getValue("action");
  }
 else {
    session.putValue("action",action);
  }
  String newDate=(String)parameters.get(C_NEWS_PARAM_DATE);
  String newHeadline=(String)parameters.get(C_NEWS_PARAM_HEADLINE);
  String newShorttext=(String)parameters.get(C_NEWS_PARAM_SHORTTEXT);
  String newText=(String)parameters.get(C_NEWS_PARAM_TEXT);
  String newExternalLink=(String)parameters.get(C_NEWS_PARAM_EXTLINK);
  String newState=(String)parameters.get(C_NEWS_PARAM_STATE);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  if ("edit".equals(action)) {
    GregorianCalendar cal=new GregorianCalendar();
    if (newHeadline == null && newShorttext == null && newText == null && newExternalLink == null) {
      if (file != null && !"".equals(file)) {
        CmsNewsTemplateFile newsFile=getNewsContentFile(cms,cms.readFile(file));
        A_CmsResource newsContentFileObject=cms.readFileHeader(newsFile.getAbsoluteFilename());
        if (!newsContentFileObject.isLocked()) {
          cms.lockResource(newsFile.getAbsoluteFilename());
        }
        parameters.put(C_NEWS_PARAM_DATE,Utils.getNiceShortDate(newsFile.getNewsDate()));
        parameters.put(C_NEWS_PARAM_HEADLINE,newsFile.getNewsHeadline());
        parameters.put(C_NEWS_PARAM_SHORTTEXT,newsFile.getNewsShortText());
        parameters.put(C_NEWS_PARAM_TEXT,newsFile.getNewsText());
        parameters.put(C_NEWS_PARAM_EXTLINK,newsFile.getNewsExternalLink());
        parameters.put(C_NEWS_PARAM_STATE,new Boolean(newsFile.isNewsActive()));
        xmlTemplateDocument.setXmlData("author",newsFile.getNewsAuthor());
        session.putValue("author",newsFile.getNewsAuthor());
      }
 else {
        A_CmsUser author=cms.getRequestContext().currentUser();
        String authorText=null;
        String initials=getInitials(author);
        String firstName=author.getFirstname();
        String lastName=author.getLastname();
        if ((firstName == null || "".equals(firstName)) && (lastName == null || "".equals(lastName))) {
          authorText=initials;
        }
 else {
          authorText=firstName + " " + lastName;
          authorText=authorText.trim();
          authorText=authorText + " (" + initials+ ")";
        }
        session.putValue("author",authorText);
        xmlTemplateDocument.setXmlData("author",authorText);
        String dateText=Utils.getNiceShortDate(cal.getTime().getTime());
        parameters.put(C_NEWS_PARAM_DATE,dateText);
      }
    }
 else {
      CmsNewsTemplateFile newsContentFile=null;
      if (file == null || "".equals(file)) {
        A_CmsUser author=cms.getRequestContext().currentUser();
        String dateFileText=getDateFileText(cal);
        String newsNumber=this.getNewArticleNumber(cms,dateFileText);
        String initials=getInitials(author);
        String newsFileName=dateFileText + "-" + newsNumber+ "-"+ initials.toLowerCase();
        parameters.put(C_NEWS_PARAM_FILE,newsFileName);
        newsContentFile=createNewsFile(cms,newsFileName);
        createPageFile(cms,newsFileName);
        if (newDate == null || "".equals(newDate)) {
          newDate=Utils.getNiceShortDate(cal.getTime().getTime());
        }
        CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
        HttpServletRequest req=(HttpServletRequest)(cms.getRequestContext().getRequest().getOriginalRequest());
        String taskUrl=req.getScheme() + "://" + req.getHeader("HOST")+ req.getServletPath()+ C_NEWS_FOLDER_PAGE+ newsFileName+ "/index.html";
        String taskcomment="<A HREF=\"javascript:openwinfull('" + taskUrl + "', 'preview', 0, 0);\"> "+ taskUrl+ "</A>";
        CmsTaskAction.create(cms,C_NEWS_USER,C_NEWS_ROLE,lang.getLanguageValue("task.label.news"),taskcomment,Utils.getNiceShortDate(new Date().getTime() + 345600000),"1","","","","");
      }
 else {
        newsContentFile=getNewsContentFile(cms,cms.readFile(file));
      }
      setNewsFileContent(newsContentFile,(String)session.getValue("author"),newDate,newHeadline,newShorttext,newText,newExternalLink,newState);
      cms.unlockResource(newsContentFile.getAbsoluteFilename());
      session.removeValue("file");
      templateSelector=C_NEWS_DONE;
    }
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

{
  CmsSession session=cms.getRequestContext().getSession(true);
  String file=(String)parameters.get(C_NEWS_PARAM_FILE);
  if (file == null) {
    file=(String)session.getValue(C_NEWS_PARAM_FILE);
  }
 else {
    session.putValue(C_NEWS_PARAM_FILE,file);
  }
  String action=(String)parameters.get(C_NEWS_PARAM_ACTION);
  if (action == null) {
    action=(String)session.getValue(C_NEWS_PARAM_ACTION);
  }
 else {
    session.putValue(C_NEWS_PARAM_ACTION,action);
  }
  String newDate=(String)parameters.get(C_NEWS_PARAM_DATE);
  String newHeadline=(String)parameters.get(C_NEWS_PARAM_HEADLINE);
  String newShorttext=(String)parameters.get(C_NEWS_PARAM_SHORTTEXT);
  String newText=(String)parameters.get(C_NEWS_PARAM_TEXT);
  String newExternalLink=(String)parameters.get(C_NEWS_PARAM_EXTLINK);
  String newState=(String)parameters.get(C_NEWS_PARAM_STATE);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  if ("edit".equals(action)) {
    GregorianCalendar cal=new GregorianCalendar();
    if (newHeadline == null && newShorttext == null && newText == null && newExternalLink == null) {
      if (file != null && !"".equals(file)) {
        CmsNewsContentFile newsFile=getNewsContentFile(cms,cms.readFile(file));
        CmsResource newsContentFileObject=cms.readFileHeader(newsFile.getAbsoluteFilename());
        if (!newsContentFileObject.isLocked()) {
          cms.lockResource(newsFile.getAbsoluteFilename());
        }
        parameters.put(C_NEWS_PARAM_DATE,Utils.getNiceShortDate(newsFile.getNewsDate()));
        parameters.put(C_NEWS_PARAM_HEADLINE,Encoder.escapeXml(newsFile.getNewsHeadline()));
        parameters.put(C_NEWS_PARAM_SHORTTEXT,Encoder.escapeXml(newsFile.getNewsShortText()));
        parameters.put(C_NEWS_PARAM_TEXT,newsFile.getNewsText("\n\n",true));
        parameters.put(C_NEWS_PARAM_EXTLINK,newsFile.getNewsExternalLink());
        parameters.put(C_NEWS_PARAM_STATE,new Boolean(newsFile.isNewsActive()));
        xmlTemplateDocument.setData(C_NEWS_PARAM_AUTHOR,Encoder.escapeXml(newsFile.getNewsAuthor()));
        session.putValue(C_NEWS_PARAM_AUTHOR,newsFile.getNewsAuthor());
      }
 else {
        CmsUser author=cms.getRequestContext().currentUser();
        String authorText=null;
        String initials=getInitials(author);
        String firstName=author.getFirstname();
        String lastName=author.getLastname();
        if ((firstName == null || "".equals(firstName)) && (lastName == null || "".equals(lastName))) {
          authorText=initials;
        }
 else {
          authorText=firstName + " " + lastName;
          authorText=authorText.trim();
          authorText=authorText + " (" + initials+ ")";
        }
        session.putValue(C_NEWS_PARAM_AUTHOR,authorText);
        xmlTemplateDocument.setData(C_NEWS_PARAM_AUTHOR,authorText);
        String dateText=Utils.getNiceShortDate(cal.getTime().getTime());
        parameters.put(C_NEWS_PARAM_DATE,dateText);
      }
    }
 else {
      CmsXmlTemplateFile newsIni=new CmsXmlTemplateFile(cms,C_NEWS_INI);
      CmsNewsContentFile newsContentFile=null;
      if (file == null || "".equals(file)) {
        CmsUser author=cms.getRequestContext().currentUser();
        String dateFileText=getDateFileText(cal);
        String newsNumber=getNewArticleNumber(cms,dateFileText);
        String initials=getInitials(author);
        String newsFileName=dateFileText + "-" + newsNumber+ "-"+ initials.toLowerCase();
        parameters.put(C_NEWS_PARAM_FILE,newsFileName);
        newsContentFile=createNewsFile(cms,newsFileName);
        createPageFile(cms,newsFileName,newsIni.getDataValue("mastertemplate"));
        if (newDate == null || "".equals(newDate)) {
          newDate=Utils.getNiceShortDate(cal.getTime().getTime());
        }
        try {
          makeTask(cms,newsFileName,newsIni.getDataValue("newstask.agent"),newsIni.getDataValue("newstask.role"));
        }
 catch (        Exception e) {
          if (A_OpenCms.isLogging()) {
            A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + "Cannot create news task for news article " + newsFileName+ ". ");
            A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + e.getMessage());
          }
        }
      }
 else {
        newsContentFile=getNewsContentFile(cms,cms.readFile(file));
        cms.writeFileHeader((CmsFile)cms.readFileHeader(C_NEWS_FOLDER_PAGE + newsContentFile.getFilename() + "/index.html"));
      }
      setNewsFileContent(newsContentFile,(String)session.getValue(C_NEWS_PARAM_AUTHOR),newDate,newHeadline,newShorttext,newText,newExternalLink,newState);
      session.removeValue(C_NEWS_PARAM_FILE);
      session.removeValue(C_NEWS_PARAM_ACTION);
      session.removeValue(C_NEWS_PARAM_AUTHOR);
      templateSelector=C_NEWS_DONE;
    }
  }
  if (xmlTemplateDocument.hasData(C_NEW_DISABLED) && xmlTemplateDocument.hasData(C_NEW_ENABLED)) {
    if (cms.getRequestContext().currentProject().equals(cms.onlineProject()) || !checkWriteAccess(cms)) {
      xmlTemplateDocument.setData(C_NEW,xmlTemplateDocument.getProcessedDataValue(C_NEW_DISABLED,this));
    }
 else {
      xmlTemplateDocument.setData(C_NEW,xmlTemplateDocument.getProcessedDataValue(C_NEW_ENABLED,this));
    }
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

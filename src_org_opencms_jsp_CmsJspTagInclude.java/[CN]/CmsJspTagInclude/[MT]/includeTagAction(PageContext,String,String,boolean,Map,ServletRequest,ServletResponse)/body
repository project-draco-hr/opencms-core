{
  CmsFlexController controller=(CmsFlexController)req.getAttribute(CmsFlexController.ATTRIBUTE_NAME);
  if (target == null) {
    target=controller.getCmsObject().getRequestContext().getUri();
  }
  Map parameterMap=new HashMap();
  if (paramMap != null) {
    parameterMap.putAll(paramMap);
  }
  if (element != null) {
    addParameter(parameterMap,CmsJspTagTemplate.C_TEMPLATE_ELEMENT,element,true);
  }
  target=CmsLinkManager.getAbsoluteUri(target,controller.getCurrentRequest().getElementUri());
  try {
    target=OpenCms.getLoaderManager().resolveIncludeExtensions(target,element,editable,paramMap,req,res);
  }
 catch (  CmsException e) {
    controller.setThrowable(e,target);
    throw new JspException(e);
  }
  String directEditPermissions=null;
  String directEditIncludeFile=null;
  if (editable) {
    directEditIncludeFile=(String)context.getRequest().getAttribute(I_CmsEditorActionHandler.C_DIRECT_EDIT_INCLUDE_FILE_URI);
    if (directEditIncludeFile != null) {
      directEditPermissions=OpenCms.getWorkplaceManager().getEditorActionHandler().getEditMode(controller.getCmsObject(),target,(CmsXmlPage)req.getAttribute(CmsXmlPage.C_ATTRIBUTE_XMLPAGE_OBJECT),element);
    }
    if (directEditPermissions == null) {
      editable=false;
    }
  }
  Map oldParameterMap=req.getParameterMap();
  try {
    if (editable) {
      req.setAttribute(I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_ELEMENT,element);
      req.setAttribute(I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_LOCALE,controller.getCmsObject().getRequestContext().getLocale().toString());
      req.setAttribute(I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_TARGET,target);
      CmsUserSettings settings=new CmsUserSettings(controller.getCmsObject().getRequestContext().currentUser());
      req.setAttribute(I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_BUTTONSTYLE,"" + settings.getDirectEditButtonStyle());
      includeDirectEditElement(context,directEditIncludeFile,I_CmsEditorActionHandler.C_DIRECT_EDIT_AREA_START + "_" + directEditPermissions,req,res);
    }
    controller.getCurrentRequest().addParameterMap(parameterMap);
    context.getOut().print(CmsFlexResponse.C_FLEX_CACHE_DELIMITER);
    controller.getCurrentResponse().addToIncludeList(target,parameterMap);
    controller.getCurrentRequest().getRequestDispatcher(target).include(req,res);
    if (editable) {
      includeDirectEditElement(context,directEditIncludeFile,I_CmsEditorActionHandler.C_DIRECT_EDIT_AREA_END + "_" + directEditPermissions,req,res);
    }
  }
 catch (  ServletException e) {
    Throwable t;
    if (e.getRootCause() != null) {
      t=e.getRootCause();
    }
 else {
      t=e;
    }
    t=controller.setThrowable(t,target);
    throw new JspException(t);
  }
catch (  IOException e) {
    Throwable t=controller.setThrowable(e,target);
    throw new JspException(t);
  }
 finally {
    if (oldParameterMap != null) {
      controller.getCurrentRequest().setParameterMap(oldParameterMap);
    }
  }
}

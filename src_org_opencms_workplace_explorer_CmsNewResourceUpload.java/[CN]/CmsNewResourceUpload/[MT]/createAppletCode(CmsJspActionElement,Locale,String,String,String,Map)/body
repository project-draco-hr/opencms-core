{
  StringBuffer applet=new StringBuffer(2048);
  String scheme=jsp.getRequest().getScheme();
  String host=jsp.getRequest().getServerName();
  String path=OpenCms.getStaticExportManager().getVfsPrefix();
  int port=jsp.getRequest().getServerPort();
  String webapp=scheme + "://" + host+ ":"+ port+ OpenCms.getSystemInfo().getContextPath();
  String fileExtensions="";
  Map extensions=OpenCms.getResourceManager().getExtensionMapping();
  Iterator keys=extensions.entrySet().iterator();
  while (keys.hasNext()) {
    Map.Entry entry=(Map.Entry)keys.next();
    String key=(String)entry.getKey();
    String value=(String)entry.getValue();
    fileExtensions+=key + "=" + value+ ",";
  }
  fileExtensions=fileExtensions.substring(0,fileExtensions.length() - 1);
  long maxFileSize=OpenCms.getWorkplaceManager().getFileBytesMaxUploadSize(jsp.getCmsObject());
  HttpSession session=jsp.getRequest().getSession(false);
  String sessionId=((CmsUUID)session.getAttribute(CmsSessionInfo.ATTRIBUTE_SESSION_ID)).getStringValue();
  StringBuffer colors=new StringBuffer();
  if (appletWindowColors == null || appletWindowColors.size() == 0) {
    appletWindowColors=DEFAULT_APPLET_WINDOW_COLORS;
  }
  Iterator it=appletWindowColors.entrySet().iterator();
  Map.Entry color;
  while (it.hasNext()) {
    color=(Map.Entry)it.next();
    colors.append(color.getKey()).append('=').append(color.getValue());
    if (it.hasNext()) {
      colors.append(',');
    }
  }
  applet.append("<applet code=\"org.opencms.applet.upload.FileUploadApplet.class\" archive=\"");
  applet.append(webapp);
  applet.append("/resources/components/upload_applet/upload.jar\" width=\"500\" height=\"100\">\n");
  applet.append("<param name=\"opencms\" value=\"");
  applet.append(scheme);
  applet.append("://");
  applet.append(host);
  applet.append(":");
  applet.append(port);
  applet.append(getSkinUri());
  applet.append("filetypes/\">\n");
  applet.append("<param name=\"target\" value=\"");
  applet.append(scheme);
  applet.append("://");
  applet.append(host);
  applet.append(":");
  applet.append(port);
  applet.append(path);
  applet.append("/system/workplace/commons/newresource_upload.jsp\">\n");
  applet.append("<param name=\"redirect\" value=\"");
  applet.append(scheme);
  applet.append("://");
  applet.append(host);
  applet.append(":");
  applet.append(port);
  applet.append(path);
  if (CmsStringUtil.isEmpty(redirectUrl)) {
    applet.append(CmsWorkplace.FILE_EXPLORER_FILELIST);
  }
 else {
    applet.append(redirectUrl);
  }
  applet.append("?time=").append(System.currentTimeMillis());
  applet.append("\">\n");
  applet.append("<param name=\"targetframe\" value=\"");
  applet.append(targetFrame);
  applet.append("\">\n");
  applet.append("<param name=\"error\" value=\"");
  applet.append(scheme);
  applet.append("://");
  applet.append(host);
  applet.append(":");
  applet.append(port);
  applet.append(path);
  applet.append("/system/workplace/views/explorer/explorer_files.jsp\">\n");
  applet.append("<param name=\"sessionId\" value=\"");
  applet.append(sessionId);
  applet.append("\">\n");
  applet.append("<param name=\"filelist\" value=\"");
  applet.append(currentFolder);
  applet.append("\">\n");
  applet.append("<param name=\"filefilterselection\" value=\"");
  applet.append(getAppletFileFilterPreselectionConstant(jsp.getCmsObject(),currentFolder));
  applet.append("\">\n");
  applet.append("<param name=\"colors\" value=\"");
  applet.append(colors.toString());
  applet.append("\">\n");
  applet.append("<param name=\"fileExtensions\" value=\"");
  applet.append(fileExtensions);
  applet.append("\">\n\n");
  applet.append("<param name=\"maxsize\" value=\"");
  applet.append(maxFileSize);
  applet.append("\">\n");
  applet.append("<param name=\"actionOutputSelect\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ACTION_SELECT_0));
  applet.append("\">\n");
  applet.append("<param name=\"actionOutputCount\"value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ACTION_COUNT_0));
  applet.append("\">\n");
  applet.append("<param name=\"actionOutputCreate\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ACTION_CREATE_0));
  applet.append("\">\n");
  applet.append("<param name=\"actionOutputUpload\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ACTION_UPLOAD_0));
  applet.append("\">\n");
  applet.append("<param name=\"actionOverwriteCheck\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ACTION_OVERWRITECHECK_0));
  applet.append("\">\n");
  applet.append("<param name=\"messageOutputUpload\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_MESSAGE_UPLOAD_0));
  applet.append("\">\n");
  applet.append("<param name=\"messageOutputErrorZip\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_MESSAGE_ERROR_ZIP_0));
  applet.append("\">\n");
  applet.append("<param name=\"messageOutputErrorSize\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_MESSAGE_ERROR_SIZE_0));
  applet.append("\">\n");
  applet.append("<param name=\"messageNoPreview\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_MESSAGE_NOPREVIEW_0));
  applet.append("\">\n");
  applet.append("<param name=\"messageOutputAdding\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_MESSAGE_ADDING_0));
  applet.append(" \">\n");
  applet.append("<param name=\"errorTitle\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ERROR_TITLE_0));
  applet.append(" \">\n");
  applet.append("<param name=\"errorLine1\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ERROR_LINE1_0));
  applet.append(" \">\n");
  applet.append("<param name=\"certificateErrorTitle\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ERROR_CERT_TITLE_0));
  applet.append(" \">\n");
  applet.append("<param name=\"overwriteDialogTitle\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_OVERWRITE_DIALOG_TITLE_0));
  applet.append(" \">\n");
  applet.append("<param name=\"overwriteDialogIntro\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_OVERWRITE_DIALOG_INTRO_0));
  applet.append(" \">\n");
  applet.append("<param name=\"overwriteDialogOk\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_OVERWRITE_DIALOG_OK_0));
  applet.append(" \">\n");
  applet.append("<param name=\"overwriteDialogCancel\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_OVERWRITE_DIALOG_CANCEL_0));
  applet.append(" \">\n");
  applet.append("<param name=\"overwriteDialogLocale\" value=\"");
  applet.append(locale.toString());
  applet.append(" \">\n");
  applet.append("<param name=\"certificateErrorMessage\" value=\"");
  applet.append(Messages.get().getBundle(locale).key(Messages.GUI_UPLOADAPPLET_ERROR_CERT_MESSAGE_0));
  applet.append(" \">\n");
  applet.append("<param name=\"clientFolder\" value=\"");
  applet.append(new CmsUserSettings(jsp.getCmsObject()).getUploadAppletClientFolder());
  applet.append(" \">\n");
  applet.append("</applet>\n");
  return applet.toString();
}

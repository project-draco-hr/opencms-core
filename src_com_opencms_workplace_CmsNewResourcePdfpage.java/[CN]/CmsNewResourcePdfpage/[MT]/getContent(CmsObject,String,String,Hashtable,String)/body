{
  String template=null;
  byte[] content=new byte[0];
  CmsResource contentFile=null;
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String currentFilelist=CmsWorkplaceAction.getCurrentFolder(cms);
  if (currentFilelist == null) {
    currentFilelist=cms.readAbsolutePath(cms.rootFolder());
  }
  String newFile=(String)parameters.get(C_PARA_NEWFILE);
  String templatefile=(String)parameters.get(C_PARA_TEMPLATE);
  String navtitle=Encoder.redecodeUriComponent((String)parameters.get(C_PARA_NAVTEXT));
  String navpos=(String)parameters.get(C_PARA_NAVPOS);
  String step=cms.getRequestContext().getRequest().getParameter("step");
  if (step != null) {
    if (step.equals("1")) {
      if (newFile.indexOf(".") == -1) {
        newFile+=".pdf";
      }
      try {
        content=createPagefile(C_CLASSNAME,templatefile,C_VFS_PATH_BODIES + currentFilelist.substring(1,currentFilelist.length()) + newFile);
        checkFolders(cms,currentFilelist);
        CmsResource file=cms.createResource(currentFilelist,newFile,"pdfpage",new Hashtable(),content);
        contentFile=cms.createResource(C_VFS_PATH_BODIES + currentFilelist.substring(1,currentFilelist.length()),newFile,"plain",new Hashtable(),C_DEFAULTBODY.getBytes());
        cms.chmod(cms.readAbsolutePath(contentFile),contentFile.getAccessFlags() + C_ACCESS_INTERNAL_READ);
        if (navtitle != null) {
          cms.writeProperty(cms.readAbsolutePath(file),C_PROPERTY_NAVTEXT,navtitle);
          if (navpos != null) {
            updateNavPos(cms,file,navpos);
          }
        }
      }
 catch (      CmsException ex) {
        throw new CmsException("Error while creating new Page" + ex.getMessage(),ex.getType(),ex);
      }
      try {
        cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(cms));
      }
 catch (      Exception e) {
        throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(cms),CmsException.C_UNKNOWN_EXCEPTION,e);
      }
      return null;
    }
  }
 else {
    session.removeValue(C_PARA_FILE);
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

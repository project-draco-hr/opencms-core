{
  CmsFlexController controller=CmsFlexController.getController(getRequest());
  controller.getTopResponse().setContentType(MIMETYPE_APPLICATION_JSON);
  JSONObject result=new JSONObject();
  HttpServletRequest request=getRequest();
  CmsObject cms=getCmsObject();
  String actionParam=request.getParameter(ReqParam.ACTION.getName());
  String localeParam=request.getParameter(ReqParam.LOCALE.getName());
  String dataParam=request.getParameter(ReqParam.DATA.getName());
  JSONArray errors=new JSONArray();
  if (CmsStringUtil.isEmptyOrWhitespaceOnly(actionParam)) {
    errors.put("Missing parameter: " + ReqParam.ACTION.getName());
  }
  if (CmsStringUtil.isEmptyOrWhitespaceOnly(dataParam)) {
    errors.put("Missing parameter: " + ReqParam.DATA.getName());
  }
  if (errors.length() == 0) {
    try {
      Action action=Action.valueOf(actionParam.toUpperCase());
      cms.getRequestContext().setLocale(CmsLocaleManager.getLocale(localeParam));
      JSONObject data=new JSONObject(dataParam);
      if (action.equals(Action.ALL)) {
        JSONArray resourceTypesParam=data.getJSONArray(JsonKeys.TYPES.getName());
        List<I_CmsResourceType> resourceTypes=readContentTypes(resourceTypesParam);
        result.put(JsonKeys.TYPES.getName(),buildJSONForTypes(resourceTypes));
        Map<String,CmsGalleryTypeInfo> galleryTypes=readGalleryTypes(resourceTypes);
        result.put(JsonKeys.GALLERIES.getName(),buildJSONForGalleries(galleryTypes));
        List<CmsResource> galleryFolders=new ArrayList<CmsResource>();
        Iterator<Entry<String,CmsGalleryTypeInfo>> iGalleryTypes=galleryTypes.entrySet().iterator();
        while (iGalleryTypes.hasNext()) {
          galleryFolders.addAll(iGalleryTypes.next().getValue().getGalleries());
        }
        result.put(JsonKeys.CATEGORIES.getName(),buildJSONForCategories(readCategories(galleryFolders)));
      }
 else       if (action.equals(Action.CATEGORIES)) {
        result.put(JsonKeys.CATEGORIES.getName(),readSystemCategories());
      }
 else       if (action.equals(Action.CONTAINERS)) {
      }
 else       if (action.equals(Action.GALLERIES)) {
        JSONArray resourceTypesParam=data.getJSONArray(JsonKeys.TYPES.getName());
        List<I_CmsResourceType> resourceTypes=readContentTypes(resourceTypesParam);
        Map<String,CmsGalleryTypeInfo> galleryTypes=readGalleryTypes(resourceTypes);
        result.put(JsonKeys.GALLERIES.getName(),buildJSONForGalleries(galleryTypes));
      }
 else       if (action.equals(Action.SEARCH)) {
        JSONObject query=data.getJSONObject(JsonKeys.QUERYDATA.getName());
        result.put(JsonKeys.SEARCHRESULT.getName(),search(query));
      }
    }
 catch (    Exception e) {
      errors.put(e.getMessage());
    }
  }
  if (errors.length() != 0) {
    result.put(JsonKeys.ERRORS.getName(),errors);
  }
  result.write(getResponse().getWriter());
}

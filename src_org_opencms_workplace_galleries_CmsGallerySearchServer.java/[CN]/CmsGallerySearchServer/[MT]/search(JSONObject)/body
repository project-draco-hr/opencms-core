{
  JSONObject result=new JSONObject();
  if (query == null) {
    return result;
  }
  JSONArray types=query.getJSONArray(JsonKeys.TYPES.getName());
  int[] typesArr=transformToIntArray(types);
  JSONArray galleries=query.getJSONArray(JsonKeys.GALLERIES.getName());
  String[] galleriesArr=transformToStringArray(galleries);
  JSONArray categories=query.getJSONArray(JsonKeys.CATEGORIES.getName());
  String[] categoriesArr=transformToStringArray(categories);
  String queryStr=query.getString(JsonKeys.QUERY.getName());
  CmsGallerySearch.SortParam sortOrder=CmsGallerySearch.SortParam.valueOf(query.getString(JsonKeys.SORTORDER.getName()));
  CmsGallerySearch.SortParam sortBy=CmsGallerySearch.SortParam.valueOf(query.getString(JsonKeys.SORTBY.getName()));
  int page=query.getInt(JsonKeys.PAGE.getName());
  CmsGallerySearch gSearch=new CmsGallerySearch();
  gSearch.setCategories(categoriesArr);
  gSearch.setGalleries(galleriesArr);
  gSearch.setResultPage(page);
  gSearch.setQuery(queryStr);
  gSearch.setTypes(typesArr);
  gSearch.setSortBy(sortBy);
  gSearch.setSortOrder(sortOrder);
  result.put("sortorder",gSearch.getSortOrder().getName());
  result.put("sortby",gSearch.getSortBy().getName());
  result.put("resultcount",gSearch.getSearchResultCount());
  result.put("resultpage",gSearch.getResultPage());
  result.put("resultpagecount",gSearch.getPageCount());
  result.put("resultlist",buildJSONForSearchResult(gSearch.getResult()));
  return result;
}

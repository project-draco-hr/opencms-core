{
  CmsObject cms=getCmsObject();
  echo("Testing overwriting a deleted file");
  cms.loginUser("test1","test1");
  cms.getRequestContext().setCurrentProject(cms.readProject("testproject"));
  String source1="/folder1/page2.html";
  String source2="/folder1/image1.gif";
  String source3="/folder1/page3.html";
  String destination="/folder1/page1.html";
  storeResources(cms,source1);
  storeResources(cms,source2);
  storeResources(cms,source3);
  storeResources(cms,destination);
  cms.lockResource(destination);
  cms.deleteResource(destination,CmsResource.DELETE_PRESERVE_SIBLINGS);
  assertState(cms,destination,CmsResource.STATE_DELETED);
  cms.copyResource(source1,destination,CmsResource.COPY_AS_SIBLING);
  assertState(cms,destination,CmsResource.STATE_CHANGED);
  assertSiblingCount(cms,destination,2);
  assertLock(cms,destination,CmsLockType.EXCLUSIVE);
  assertSiblingCountIncremented(cms,source1,1);
  assertLock(cms,source1,CmsLockType.SHARED_EXCLUSIVE);
  assertFilter(cms,source1,OpenCmsTestResourceFilter.FILTER_EXISTING_SIBLING);
  assertFilter(cms,source1,destination,OpenCmsTestResourceFilter.FILTER_COPY_SOURCE_DESTINATION_AS_SIBLING);
  cms.deleteResource(destination,CmsResource.DELETE_PRESERVE_SIBLINGS);
  assertState(cms,destination,CmsResource.STATE_DELETED);
  cms.copyResource(source2,destination,CmsResource.COPY_AS_SIBLING);
  assertSiblingCountIncremented(cms,source1,0);
  assertLock(cms,source1,CmsLockType.UNLOCKED);
  assertState(cms,destination,CmsResource.STATE_CHANGED);
  assertSiblingCount(cms,destination,2);
  assertLock(cms,destination,CmsLockType.EXCLUSIVE);
  assertSiblingCountIncremented(cms,source2,1);
  assertLock(cms,source2,CmsLockType.SHARED_EXCLUSIVE);
  assertFilter(cms,source1,OpenCmsTestResourceFilter.FILTER_UNDOCHANGES_ALL);
  assertFilter(cms,source2,OpenCmsTestResourceFilter.FILTER_EXISTING_SIBLING);
  assertFilter(cms,source2,destination,OpenCmsTestResourceFilter.FILTER_COPY_SOURCE_DESTINATION_AS_SIBLING);
  cms.deleteResource(destination,CmsResource.DELETE_PRESERVE_SIBLINGS);
  assertState(cms,destination,CmsResource.STATE_DELETED);
  cms.copyResource(source3,destination,CmsResource.COPY_AS_NEW);
  assertSiblingCountIncremented(cms,source1,0);
  assertLock(cms,source1,CmsLockType.UNLOCKED);
  assertSiblingCountIncremented(cms,source2,0);
  assertLock(cms,source2,CmsLockType.UNLOCKED);
  assertState(cms,destination,CmsResource.STATE_CHANGED);
  assertSiblingCount(cms,destination,1);
  assertSiblingCount(cms,source3,1);
  assertLock(cms,destination,CmsLockType.EXCLUSIVE);
  assertFilter(cms,source1,OpenCmsTestResourceFilter.FILTER_UNDOCHANGES_ALL);
  assertFilter(cms,source2,OpenCmsTestResourceFilter.FILTER_UNDOCHANGES_ALL);
  assertFilter(cms,source3,OpenCmsTestResourceFilter.FILTER_EQUAL);
  assertFilter(cms,source3,destination,OpenCmsTestResourceFilter.FILTER_COPY_FILE_AS_NEW);
}

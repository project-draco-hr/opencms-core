{
  boolean resolveDebug=false;
  if (resolveDebug)   System.err.println("= Start resolving variant " + variant);
  int len=variant.size();
  if (cms.getMode() == I_CmsConstants.C_MODUS_EXPORT) {
    variant.setExported();
  }
  try {
    ByteArrayOutputStream baos=new ByteArrayOutputStream();
    for (int i=0; i < len; i++) {
      if (resolveDebug)       System.err.print("= Part " + i + " is a ");
      Object o=variant.get(i);
      if (o instanceof String) {
        if (resolveDebug)         System.err.println("String");
        baos.write(((String)o).getBytes(cms.getRequestContext().getEncoding()));
      }
 else       if (o instanceof byte[]) {
        if (resolveDebug)         System.err.println("byte array");
        baos.write((byte[])o);
      }
 else       if (o instanceof CmsElementLink) {
        if (resolveDebug)         System.err.println("Element Link");
        String lookupName=((CmsElementLink)o).getElementName();
        if (resolveDebug)         System.err.println("= Trying to resolve link \"" + lookupName + "\".");
        CmsElementDefinition elDef=elDefs.get(lookupName);
        if (elDef != null) {
          elDef.joinParameters(parameters);
          parameters.put("_ELEMENT_",elDef.getName());
          if (elDef.getTemplateName() != null) {
            parameters.put(elDef.getName() + "._TEMPLATE_",elDef.getTemplateName());
          }
          parameters.put(elDef.getName() + "._CLASS_",elDef.getClassName());
          if (elDef.getTemplateSelector() != null) {
            parameters.put(elDef.getName() + "._TEMPLATESELECTOR_",elDef.getTemplateSelector());
          }
 else {
            parameters.put(elDef.getName() + "._TEMPLATESELECTOR_","default");
          }
          A_CmsElement subEl=elementCache.getElementLocator().get(cms,elDef.getDescriptor(),parameters);
          if (resolveDebug)           System.err.println("= Element defintion for \"" + lookupName + "\" says: ");
          if (resolveDebug)           System.err.println("= -> Class    : " + elDef.getClassName());
          if (resolveDebug)           System.err.println("= -> Template : " + elDef.getTemplateName());
          String errorMessage="";
          if (subEl != null) {
            if (resolveDebug)             System.err.println("= Element object found for \"" + lookupName + "\". Calling getContent on this object. ");
            byte[] buffer=null;
            try {
              buffer=subEl.getContent(elementCache,cms,elDefs,lookupName,parameters,null);
            }
 catch (            Exception e) {
              if (I_CmsConstants.C_USER_TYPE_SYSTEMUSER == cms.getRequestContext().currentUser().getType() && !OpenCms.getDefaultUsers().getUserGuest().equals(cms.getRequestContext().currentUser().getName())) {
                errorMessage=e.toString();
              }
              subEl=null;
              buffer=null;
              if (e instanceof CmsException) {
                CmsException ce=(CmsException)e;
                if (ce instanceof CmsSecurityException) {
                  if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isErrorEnabled()) {
                    OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).error("Access denied in element " + lookupName,ce);
                  }
                  throw ce;
                }
 else {
                  if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isErrorEnabled()) {
                    OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).error("Error in element " + lookupName,e);
                  }
                }
              }
 else {
                if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isErrorEnabled()) {
                  OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).error("Non-CmsException in element " + lookupName,e);
                }
              }
            }
            if (buffer != null) {
              baos.write(buffer);
            }
          }
 else {
            if (resolveDebug)             System.err.println("= Cannot find Element object for \"" + lookupName + "\". Ignoring this link. ");
            if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isWarnEnabled()) {
              OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).warn(toString() + " Cannot find Element object for \"" + lookupName+ "\". Ignoring this link. ");
            }
          }
          if (subEl == null) {
            baos.write(("[" + lookupName + "] ??? ").getBytes());
            baos.write(errorMessage.getBytes());
          }
        }
 else {
          baos.write(("[" + lookupName + "] Element not defined.").getBytes());
          if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isWarnEnabled()) {
            OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).warn(toString() + " No element definition found for \"" + lookupName+ "\". Ignoring this link. ");
          }
          if (resolveDebug) {
            System.err.println("= No element definition found for \"" + lookupName + "\". Ignoring this link. ");
            System.err.println(elDefs.toString());
          }
        }
      }
 else       if (o instanceof CmsMethodLink) {
        if (resolveDebug)         System.err.println("Method Link");
        String methodName=((CmsMethodLink)o).getMethodeName();
        String methodParameter=((CmsMethodLink)o).getMethodParameter();
        A_CmsElement metEle=elementCache.getElementLocator().get(cms,new CmsElementDescriptor(m_className + "." + methodName,"METHOD"),parameters);
        byte[] buffer=null;
        if (metEle != null) {
          try {
            buffer=metEle.getContent(elementCache,cms,elDefs,null,parameters,methodParameter);
          }
 catch (          Exception e) {
            if (e instanceof CmsException) {
              if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isErrorEnabled()) {
                OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).error("Error in method " + methodName,e);
              }
            }
 else {
              if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isErrorEnabled()) {
                OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).error("Non-CmsException in method " + methodName,e);
              }
            }
          }
        }
 else {
          if (resolveDebug)           System.err.println("= Cannot find methodElemtn object for \"" + methodName + "\". Ignoring this link. ");
          if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isWarnEnabled()) {
            OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).warn(toString() + " Cannot find method Element object for \"" + methodName+ "\". Ignoring this link. ");
          }
        }
        if (buffer != null) {
          baos.write(buffer);
        }
      }
    }
    return baos.toByteArray();
  }
 catch (  IOException e) {
    if (OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).isErrorEnabled()) {
      OpenCms.getLog(CmsLog.CHANNEL_TEMPLATE_XML).error("IOException while writing to XMl template OutputStream",e);
    }
    throw new CmsException(CmsException.C_UNKNOWN_EXCEPTION,e);
  }
}

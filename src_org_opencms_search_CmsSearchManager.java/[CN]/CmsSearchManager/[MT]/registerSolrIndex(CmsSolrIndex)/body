{
  if ((m_solrConfig == null) || !m_solrConfig.isEnabled()) {
    throw new CmsConfigurationException(Messages.get().container(Messages.ERR_SOLR_NOT_ENABLED_0));
  }
  if (m_solrConfig.getServerUrl() != null) {
    return registerOnHttpServer(index);
  }
  CoreContainer coreContainer;
  if ((m_solr instanceof EmbeddedSolrServer) && (((EmbeddedSolrServer)m_solr).getCoreContainer() != null)) {
    coreContainer=((EmbeddedSolrServer)m_solr).getCoreContainer();
  }
 else {
    coreContainer=createCoreContainer();
  }
  SolrCore core=coreContainer.getCore(index.getName());
  if (core == null) {
    File dataDir=new File(index.getPath());
    if (!dataDir.exists()) {
      if (!dataDir.exists()) {
        dataDir.mkdirs();
        LOG.info(Messages.get().getBundle().key(Messages.LOG_SOLR_CREATED_INDEX_DIR_2,index.getName(),index.getPath()));
      }
    }
    CoreDescriptor descriptor=new CoreDescriptor(coreContainer,"descriptor",m_solrConfig.getHome());
    descriptor.setDataDir(dataDir.getAbsolutePath());
    core=new SolrCore(index.getName(),null,m_solrConfig.getSolrConfig(),m_solrConfig.getSolrSchema(),descriptor);
  }
  coreContainer.register(core,false);
  if (m_solr == null) {
    m_solr=new EmbeddedSolrServer(coreContainer,index.getName());
    LOG.info(Messages.get().getBundle().key(Messages.LOG_SOLR_CREATED_EMBEDDED_SERVER_1,m_solrConfig.getSolrFile().getAbsolutePath()));
  }
  return m_solr;
}

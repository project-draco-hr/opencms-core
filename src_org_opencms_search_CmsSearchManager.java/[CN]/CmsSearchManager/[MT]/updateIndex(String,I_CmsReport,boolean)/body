{
  CmsSearchIndex index=null;
  CmsSearchIndexSource indexSource=null;
  List sourceNames=null;
  String sourceName=null;
  CmsIndexingThreadManager threadManager=null;
  I_CmsIndexer indexer=null;
  List resourceNames=null;
  String resourceName=null;
  IndexWriter writer=null;
  String currentSiteRoot=null;
  CmsProject currentProject=null;
  CmsRequestContext context=m_cms.getRequestContext();
  if (report == null) {
    report=new CmsLogReport();
  }
  if (report != null) {
    report.print(report.key("search.indexing_begin"),I_CmsReport.C_FORMAT_HEADLINE);
    report.print(indexName,I_CmsReport.C_FORMAT_HEADLINE);
    report.println(report.key("search.dots"),I_CmsReport.C_FORMAT_HEADLINE);
  }
  index=getIndex(indexName);
  writer=index.getIndexWriter();
  sourceNames=index.getSourceNames();
  for (int i=0, n=sourceNames.size(); i < n; i++) {
    try {
      sourceName=(String)sourceNames.get(i);
      indexSource=(CmsSearchIndexSource)m_indexSources.get(sourceName);
      currentSiteRoot=context.getSiteRoot();
      context.setSiteRoot("/");
      currentProject=context.currentProject();
      context.setCurrentProject(m_cms.readProject(index.getProject()));
      threadManager=new CmsIndexingThreadManager(report,Long.parseLong(m_timeout),indexName);
      indexer=(I_CmsIndexer)Class.forName(indexSource.getIndexerClassName()).newInstance();
      resourceNames=indexSource.getResourcesNames();
      for (int j=0, m=resourceNames.size(); j < m; j++) {
        resourceName=(String)resourceNames.get(j);
        indexer.init(report,index,indexSource,writer,threadManager);
        indexer.updateIndex(m_cms,indexSource.getName(),resourceName);
      }
      while (wait && threadManager.isRunning()) {
        Thread.sleep(1000);
      }
      threadManager.reportStatistics();
    }
 catch (    Exception e) {
      if (report != null) {
        report.println(report.key("search.indexing_failed"),I_CmsReport.C_FORMAT_WARNING);
      }
      if (OpenCms.getLog(this).isErrorEnabled()) {
        OpenCms.getLog(this).error("Rebuilding of search index " + index.getName() + " failed!",e);
      }
    }
 finally {
      if (writer != null) {
        try {
          writer.close();
        }
 catch (        IOException e) {
        }
      }
      context.setCurrentProject(currentProject);
      if (currentSiteRoot != null) {
        context.setSiteRoot(currentSiteRoot);
      }
    }
  }
  m_resultCache.clear();
}

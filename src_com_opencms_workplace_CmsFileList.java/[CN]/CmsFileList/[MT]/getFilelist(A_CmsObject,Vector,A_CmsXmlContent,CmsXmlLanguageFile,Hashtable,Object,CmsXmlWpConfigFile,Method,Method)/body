{
  StringBuffer output=new StringBuffer();
  String foldername;
  String currentFolder;
  String title=null;
  int contextNumber=0;
  String servlets=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getServletPath();
  CmsXmlWpTemplateFile template=(CmsXmlWpTemplateFile)doc;
  Enumeration enum;
  CmsFile file;
  CmsFolder folder;
  CmsResource res;
  int filelist=getDefaultPreferences(cms);
  filelist=modifyPreferences(cms,filelist,columnsMethod,callingObject);
  template=checkDisplayedColumns(filelist,template,"");
  output.append(template.getProcessedXmlDataValue(C_LIST_HEAD,callingObject));
  enum=list.elements();
  while (enum.hasMoreElements()) {
    res=(CmsResource)enum.nextElement();
    if (checkAccess(cms,res)) {
      String displayedName=null;
      if (nameDisplayMethod != null) {
        try {
          displayedName=((String)nameDisplayMethod.invoke(callingObject,new Object[]{cms,res}));
        }
 catch (        InvocationTargetException targetEx) {
          Throwable e=targetEx.getTargetException();
          if (!(e instanceof CmsException)) {
            e.printStackTrace();
            throwException("User method " + nameDisplayMethod.getName() + " in calling class "+ callingObject.getClass().getName()+ " throwed an exception. "+ e,CmsException.C_UNKNOWN_EXCEPTION);
          }
 else {
            throw (CmsException)e;
          }
        }
catch (        Exception exc2) {
          throwException("User method " + nameDisplayMethod.getName() + " in calling class "+ callingObject.getClass().getName()+ " was found but could not be invoked. "+ exc2,CmsException.C_XML_NO_USER_METHOD);
        }
      }
 else {
        displayedName=res.getName();
      }
      if (res.isFolder()) {
        folder=(CmsFolder)res;
        template.setXmlData(C_CLASS_VALUE,getStyle(cms,folder));
        template.setXmlData(C_CONTEXT_LINK,res.getAbsolutePath());
        template.setXmlData(C_CONTEXT_MENU,getContextMenue(cms,res,template));
        template.setXmlData(C_CONTEXT_NUMBER,new Integer(contextNumber++).toString());
        A_CmsResourceType type=cms.getResourceType(folder.getType());
        String icon=icon=getIcon(cms,type,config);
        template.setXmlData(C_ICON_VALUE,config.getWpPictureUrl() + icon);
        if (res.getState() != C_STATE_DELETED) {
          template.setXmlData(C_LINK_VALUE,folder.getAbsolutePath());
        }
 else {
          template.setXmlData(C_LINK_VALUE,"#");
        }
        template.setXmlData(C_LOCK_VALUE,template.getProcessedXmlDataValue(getLock(cms,folder,template,lang),callingObject));
        template.setXmlData(C_NAME_VALUE,displayedName);
        template.setXmlData(C_NAME_FILEFOLDER,template.getProcessedXmlDataValue(getName(cms,folder),this));
        title="";
        try {
          title=cms.readMetainformation(folder.getAbsolutePath(),C_METAINFO_TITLE);
        }
 catch (        CmsException e) {
        }
        if (title == null) {
          title="";
        }
        template.setXmlData(C_TITLE_VALUE,title);
        String typename=type.getResourceName();
        typename=lang.getDataValue("fileicon." + typename);
        template.setXmlData(C_TYPE_VALUE,typename);
        long time=folder.getDateLastModified();
        template.setXmlData(C_CHANGED_VALUE,getNiceDate(time));
        template.setXmlData(C_SIZE_VALUE,"");
        template.setXmlData(C_STATE_VALUE,getState(cms,folder,lang));
        A_CmsUser owner=cms.readOwner(folder);
        template.setXmlData(C_OWNER_VALUE,owner.getName());
        A_CmsGroup group=cms.readGroup(folder);
        template.setXmlData(C_GROUP_VALUE,group.getName());
        int access=folder.getAccessFlags();
        template.setXmlData(C_ACCESS_VALUE,getAccessFlags(access));
        int lockedby=folder.isLockedBy();
        if (lockedby == C_UNKNOWN_ID) {
          template.setXmlData(C_LOCKED_VALUE,"");
        }
 else {
          template.setXmlData(C_LOCKED_VALUE,cms.lockedBy(folder).getName());
        }
        template=checkDisplayedColumns(filelist,template,C_SUFFIX_VALUE);
        output.append(template.getProcessedXmlDataValue(C_LIST_ENTRY,callingObject));
      }
 else {
        file=(CmsFile)res;
        template.setXmlData(C_CLASS_VALUE,getStyle(cms,file));
        template.setXmlData(C_CONTEXT_LINK,res.getAbsolutePath());
        template.setXmlData(C_CONTEXT_MENU,getContextMenue(cms,res,template));
        template.setXmlData(C_CONTEXT_NUMBER,new Integer(contextNumber++).toString());
        A_CmsResourceType type=cms.getResourceType(file.getType());
        String icon=getIcon(cms,type,config);
        template.setXmlData(C_ICON_VALUE,config.getWpPictureUrl() + icon);
        if (res.getState() != C_STATE_DELETED) {
          template.setXmlData(C_LINK_VALUE,servlets + file.getAbsolutePath());
        }
 else {
          template.setXmlData(C_LINK_VALUE,"#");
        }
        template.setXmlData(C_LOCK_VALUE,template.getProcessedXmlDataValue(getLock(cms,file,template,lang),callingObject));
        template.setXmlData(C_NAME_VALUE,displayedName);
        template.setXmlData(C_NAME_FILEFOLDER,template.getProcessedXmlDataValue(getName(cms,file),this));
        title="";
        try {
          title=cms.readMetainformation(file.getAbsolutePath(),C_METAINFO_TITLE);
        }
 catch (        CmsException e) {
        }
        if (title == null) {
          title="";
        }
        template.setXmlData(C_TITLE_VALUE,title);
        type=cms.getResourceType(file.getType());
        String typename=type.getResourceName();
        typename=lang.getDataValue("fileicon." + typename);
        template.setXmlData(C_TYPE_VALUE,typename);
        long time=file.getDateLastModified();
        template.setXmlData(C_CHANGED_VALUE,getNiceDate(time));
        template.setXmlData(C_SIZE_VALUE,new Integer(file.getLength()).toString());
        template.setXmlData(C_STATE_VALUE,getState(cms,file,lang));
        A_CmsUser owner=cms.readOwner(file);
        template.setXmlData(C_OWNER_VALUE,owner.getName());
        A_CmsGroup group=cms.readGroup(file);
        template.setXmlData(C_GROUP_VALUE,group.getName());
        int access=file.getAccessFlags();
        template.setXmlData(C_ACCESS_VALUE,getAccessFlags(access));
        int lockedby=file.isLockedBy();
        if (lockedby == C_UNKNOWN_ID) {
          template.setXmlData(C_LOCKED_VALUE,"");
        }
 else {
          template.setXmlData(C_LOCKED_VALUE,cms.lockedBy(file).getName());
        }
        template=checkDisplayedColumns(filelist,template,C_SUFFIX_VALUE);
        output.append(template.getProcessedXmlDataValue(C_LIST_ENTRY,callingObject));
      }
    }
  }
  return output.toString();
}

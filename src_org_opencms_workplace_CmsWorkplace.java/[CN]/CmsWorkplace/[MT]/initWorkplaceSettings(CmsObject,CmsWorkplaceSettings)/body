{
  String language=initUserLanguage(cms);
  settings.setLanguage(language);
  CmsWorkplaceMessages messages=new CmsWorkplaceMessages(cms,language);
  settings.setMessages(messages);
  settings.setUser(cms.getRequestContext().currentUser());
  settings.setUserSettings(new CmsUserSettings(settings.getUser()));
  settings.setProject(cms.getRequestContext().currentProject().getId());
  String siteRoot=cms.getRequestContext().getSiteRoot();
  boolean access=false;
  CmsResource res=null;
  try {
    res=cms.readFileHeader("/");
    access=cms.hasPermissions(res,I_CmsConstants.C_VIEW_ACCESS);
  }
 catch (  CmsException e) {
  }
  if ((res == null) || !access) {
    List sites=CmsSiteManager.getAvailableSites(cms,true);
    if (sites.size() > 0) {
      siteRoot=((CmsSite)sites.get(0)).getSiteRoot();
      cms.getRequestContext().setSiteRoot(siteRoot);
    }
  }
  settings.setSite(siteRoot);
  Hashtable startSettings=(Hashtable)cms.getRequestContext().currentUser().getAdditionalInfo(I_CmsConstants.C_ADDITIONAL_INFO_STARTSETTINGS);
  if (startSettings != null) {
    settings.setViewUri(OpenCms.getLinkManager().substituteLink(cms,(String)startSettings.get(I_CmsConstants.C_START_VIEW)));
  }
  settings.setResourceTypes(initWorkplaceResourceTypes(cms));
  return settings;
}

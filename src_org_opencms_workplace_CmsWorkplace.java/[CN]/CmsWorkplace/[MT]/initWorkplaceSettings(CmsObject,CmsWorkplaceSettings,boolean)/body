{
  CmsUser user;
  if (update) {
    try {
      user=cms.readUser(cms.getRequestContext().currentUser().getId());
    }
 catch (    CmsException e) {
      if (OpenCms.getLog(CmsWorkplace.class).isInfoEnabled()) {
        OpenCms.getLog(CmsWorkplace.class).info(e);
      }
      user=cms.getRequestContext().currentUser();
    }
  }
 else {
    user=cms.getRequestContext().currentUser();
  }
  settings.setUser(user);
  settings.setUserSettings(new CmsUserSettings(user));
  settings.setProject(cms.getRequestContext().currentProject().getId());
  CmsWorkplaceMessages messages=new CmsWorkplaceMessages(settings.getUserSettings().getLocale());
  settings.setMessages(messages);
  String siteRoot=settings.getUserSettings().getStartSite();
  if (siteRoot.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
    siteRoot=siteRoot.substring(0,siteRoot.length() - 1);
  }
  if (!"".equals(siteRoot) && CmsSiteManager.getSite(siteRoot) == null) {
    siteRoot=OpenCms.getWorkplaceManager().getDefaultUserSettings().getStartSite();
    if (siteRoot.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
      siteRoot=siteRoot.substring(0,siteRoot.length() - 1);
    }
  }
  boolean access=false;
  CmsResource res=null;
  try {
    res=cms.readResource("/");
    access=cms.hasPermissions(res,I_CmsConstants.C_VIEW_ACCESS);
  }
 catch (  CmsException e) {
    if (OpenCms.getLog(CmsWorkplace.class).isInfoEnabled()) {
      OpenCms.getLog(CmsWorkplace.class).info(e);
    }
  }
  if ((res == null) || !access) {
    List sites=CmsSiteManager.getAvailableSites(cms,true);
    if (sites.size() > 0) {
      siteRoot=((CmsSite)sites.get(0)).getSiteRoot();
      cms.getRequestContext().setSiteRoot(siteRoot);
    }
  }
  settings.setSite(siteRoot);
  settings.setExplorerResource(settings.getUserSettings().getStartFolder());
  settings.setViewUri(OpenCms.getLinkManager().substituteLink(cms,settings.getUserSettings().getStartView()));
  settings.setResourceTypes(initWorkplaceResourceTypes(cms));
  return settings;
}

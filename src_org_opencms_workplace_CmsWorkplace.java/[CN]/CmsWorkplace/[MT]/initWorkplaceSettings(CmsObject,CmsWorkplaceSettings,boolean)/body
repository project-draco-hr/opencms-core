{
  settings=initUserSettings(cms,settings,update);
  settings.setProject(cms.getRequestContext().getCurrentProject().getUuid());
  String currentSite=cms.getRequestContext().getSiteRoot();
  settings.setSite(currentSite);
  String startSiteRoot=getStartSiteRoot(cms,settings);
  cms.getRequestContext().setSiteRoot(startSiteRoot);
  try {
    String startFolder=settings.getUserSettings().getStartFolder();
    if (!cms.existsResource(startFolder,CmsResourceFilter.IGNORE_EXPIRATION)) {
      startFolder="/";
      settings.getUserSettings().setStartFolder(startFolder);
    }
    settings.setSite(startSiteRoot);
    settings.setExplorerResource(startFolder,cms);
  }
  finally {
    settings.setSite(currentSite);
    cms.getRequestContext().setSiteRoot(currentSite);
  }
  settings.setViewUri(OpenCms.getLinkManager().substituteLink(cms,settings.getUserSettings().getStartView()));
  return settings;
}

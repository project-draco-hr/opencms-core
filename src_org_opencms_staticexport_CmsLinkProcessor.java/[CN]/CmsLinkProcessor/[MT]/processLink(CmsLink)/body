{
  if (link.isInternal()) {
    if ((m_cms == null) || (link.getUri().length() == 0) || (link.getUri().charAt(0) == '#')) {
      return link.getUri();
    }
    Object obj=m_cms.getRequestContext().getAttribute(CmsObjectWrapper.ATTRIBUTE_NAME);
    if (obj != null) {
      CmsObjectWrapper wrapper=(CmsObjectWrapper)obj;
      link=new CmsLink(link.getName(),link.getType(),wrapper.rewriteLink(link.getUri()),link.isInternal());
    }
    if (!m_processEditorLinks && (m_cms.getRequestContext().getSiteRoot().length() == 0)) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getUri());
    }
    String siteRoot=link.getSiteRoot();
    if (siteRoot == null) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getUri());
    }
    return OpenCms.getLinkManager().substituteLink(m_cms,link.getVfsUri(),siteRoot);
  }
 else {
    return link.getUri();
  }
}

{
  if (link.isInternal()) {
    CmsSite site=null;
    if (!m_processEditorLinks && "".equals(m_cms.getRequestContext().getSiteRoot())) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getTarget());
    }
    String siteRoot=link.getSiteRoot();
    if (siteRoot == null) {
      return link.getTarget();
    }
 else {
      site=CmsSiteManager.getSite(siteRoot);
    }
    if (m_cms.getRequestContext().getSiteRoot().equals(siteRoot)) {
      if (m_processEditorLinks) {
        return link.getVfsTarget();
      }
 else {
        return OpenCms.getLinkManager().substituteLink(m_cms,link.getVfsTarget());
      }
    }
 else {
      return site.getUrl() + OpenCms.getOpenCmsContext() + link.getVfsTarget();
    }
  }
 else {
    return link.getTarget();
  }
}

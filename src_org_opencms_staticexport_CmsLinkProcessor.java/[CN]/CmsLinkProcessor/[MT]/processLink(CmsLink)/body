{
  if (link.isInternal()) {
    CmsSite site=null;
    if (link.getUri().startsWith("#")) {
      return link.getUri();
    }
    if (!m_processEditorLinks && "".equals(m_cms.getRequestContext().getSiteRoot())) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getUri());
    }
    String siteRoot=link.getSiteRoot();
    if (siteRoot == null) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getUri());
    }
 else {
      site=CmsSiteManager.getSite(siteRoot);
    }
    if (m_cms.getRequestContext().getSiteRoot().equals(siteRoot) || m_processEditorLinks) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getVfsUri());
    }
 else {
      return site.getUrl() + OpenCms.getLinkManager().substituteLink(m_cms,link.getVfsUri());
    }
  }
 else {
    return link.getUri();
  }
}

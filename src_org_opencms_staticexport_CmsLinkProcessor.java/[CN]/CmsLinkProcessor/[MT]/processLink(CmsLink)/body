{
  if (link.isInternal()) {
    if (link.getUri().charAt(0) == '#') {
      return link.getUri();
    }
    if (!m_processEditorLinks && (m_cms.getRequestContext().getSiteRoot().length() == 0)) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getUri());
    }
    String siteRoot=link.getSiteRoot();
    if (siteRoot == null) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getUri());
    }
    if (m_cms.getRequestContext().getSiteRoot().equals(siteRoot)) {
      return OpenCms.getLinkManager().substituteLink(m_cms,link.getVfsUri());
    }
 else {
      return CmsSiteManager.getSite(siteRoot).getUrl() + OpenCms.getLinkManager().substituteLink(m_cms,link.getVfsUri());
    }
  }
 else {
    return link.getUri();
  }
}

{
  String currentFolder=cms.getRequestContext().currentFolder().getAbsolutePath();
  String requestedUri=cms.getRequestContext().getUri();
  String servletPath=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getServletPath();
  CmsXmlTemplateFile xmlDataBlock=(CmsXmlTemplateFile)doc;
  StringBuffer result=new StringBuffer();
  if (((Hashtable)userObject).get("nav.folder") != null) {
    if (((Hashtable)userObject).get("nav.folder").equals("root")) {
      currentFolder=cms.rootFolder().getAbsolutePath();
    }
    if (((Hashtable)userObject).get("nav.folder").equals("current")) {
      currentFolder=cms.getRequestContext().currentFolder().getAbsolutePath();
    }
  }
  Vector resources=cms.getSubFolders(currentFolder);
  Vector allFile=cms.getFilesInFolder(currentFolder);
  resources.ensureCapacity(resources.size() + allFile.size());
  Enumeration e=allFile.elements();
  while (e.hasMoreElements()) {
    resources.addElement(e.nextElement());
  }
  int size=resources.size();
  int max=0;
  String navLink[]=new String[size];
  String navText[]=new String[size];
  float navPos[]=new float[size];
  for (int i=0; i < size; i++) {
    A_CmsResource currentResource=(A_CmsResource)resources.elementAt(i);
    String path=currentResource.getAbsolutePath();
    String pos=cms.readProperty(path,C_PROPERTY_NAVPOS);
    String text=cms.readProperty(path,C_PROPERTY_NAVTEXT);
    if (currentResource.getState() != C_STATE_DELETED) {
      if (pos != null && text != null && (!"".equals(pos)) && (!"".equals(text)) && ((!currentResource.getName().startsWith(C_TEMP_PREFIX)) || path.equals(requestedUri))) {
        navLink[max]=path;
        navText[max]=text;
        navPos[max]=new Float(pos).floatValue();
        max++;
      }
    }
  }
  sortNav(max,navLink,navText,navPos);
  for (int i=0; i < max; i++) {
    xmlDataBlock.setData("navText",navText[i]);
    xmlDataBlock.setData("count",new Integer(i + 1).toString());
    xmlDataBlock.setData("navLink",servletPath + navLink[i]);
    if (navLink[i].equals(currentFolder) || navLink[i].equals(requestedUri)) {
      result.append(xmlDataBlock.getProcessedDataValue("navCurrent"));
    }
 else {
      result.append(xmlDataBlock.getProcessedDataValue("navEntry"));
    }
  }
  return result.toString().getBytes();
}

{
  TopDocs hits;
  CmsGallerySearchResultList searchResults=new CmsGallerySearchResultList();
  try {
    CmsObject searchCms=OpenCms.initCmsObject(cms);
    searchCms.getRequestContext().setRequestTime(cms.getRequestContext().getRequestTime());
    searchCms.getRequestContext().setCurrentProject(searchCms.readProject(getProject()));
    BooleanFilter filter=new BooleanFilter();
    List<String> folders=new ArrayList<String>();
    if (params.getFolders() != null) {
      folders.addAll(params.getFolders());
    }
    if (params.getGalleries() != null) {
      folders.addAll(params.getGalleries());
    }
    filter=appendPathFilter(searchCms,filter,folders);
    String subsite=null;
    if (params.getReferencePath() != null) {
      subsite=OpenCms.getADEManager().getSubSiteRoot(cms,cms.getRequestContext().addSiteRoot(params.getReferencePath()));
      if (subsite != null) {
        subsite=cms.getRequestContext().removeSiteRoot(subsite);
      }
    }
    List<String> scopeFolders=getSearchRootsForScope(params.getScope(),subsite);
    filter=appendPathFilter(searchCms,filter,scopeFolders);
    filter=appendCategoryFilter(searchCms,filter,params.getCategories());
    filter=appendContainerTypeFilter(searchCms,filter,params.getContainerTypes());
    filter=appendResourceTypeFilter(searchCms,filter,params.getResourceTypes());
    filter=appendLocaleFilter(searchCms,filter,params.getLocale());
    filter=appendDateLastModifiedFilter(filter,params.getDateLastModifiedRange().getStartTime(),params.getDateLastModifiedRange().getEndTime());
    filter=appendDateCreatedFilter(filter,params.getDateCreatedRange().getStartTime(),params.getDateCreatedRange().getEndTime());
    Query query=null;
    Query fieldsQuery=null;
    indexSearcherUpdate();
    IndexSearcher searcher=getSearcher();
    Locale locale=params.getLocale() == null ? null : CmsLocaleManager.getLocale(params.getLocale());
    if (params.getSearchWords() != null) {
      BooleanQuery booleanFieldsQuery=new BooleanQuery();
      OpenCms.getLocaleManager();
      List<String> fields=params.getFields();
      fields=getLocaleExtendedFields(params.getFields(),locale);
      for (      String field : fields) {
        QueryParser p=new QueryParser(CmsLuceneIndex.LUCENE_VERSION,field,getAnalyzer());
        booleanFieldsQuery.add(p.parse(params.getSearchWords()),BooleanClause.Occur.SHOULD);
      }
      fieldsQuery=searcher.rewrite(booleanFieldsQuery);
    }
    query=fieldsQuery;
    if (query == null) {
      query=new MatchAllDocsQuery();
    }
    searcher.setDefaultFieldSortScoring(true,true);
    hits=searcher.search(query,filter,getMaxHits(),params.getSort());
    if (hits != null) {
      int hitCount=hits.totalHits > hits.scoreDocs.length ? hits.scoreDocs.length : hits.totalHits;
      int page=params.getResultPage();
      int start=-1, end=-1;
      if ((params.getMatchesPerPage() > 0) && (page > 0) && (hitCount > 0)) {
        start=params.getMatchesPerPage() * (page - 1);
        end=start + params.getMatchesPerPage();
        start=(start > hitCount) ? hitCount : start;
        end=(end > hitCount) ? hitCount : end;
      }
 else {
        start=0;
        end=hitCount;
      }
      Document doc;
      CmsGallerySearchResult searchResult;
      CmsSearchParameters searchParams=params.getCmsSearchParams();
      int visibleHitCount=hitCount;
      for (int i=0, cnt=0; (i < hitCount) && (cnt < end); i++) {
        try {
          doc=getSearcher().doc(hits.scoreDocs[i].doc);
          I_CmsSearchDocument searchDoc=new CmsLuceneDocument(doc);
          if (hasReadPermission(searchCms,searchDoc)) {
            if (cnt >= start) {
              String excerpt=null;
              if (isCreatingExcerpt() && (fieldsQuery != null)) {
                I_CmsTermHighlighter highlighter=OpenCms.getSearchManager().getHighlighter();
                excerpt=highlighter.getExcerpt(doc,this,searchParams,fieldsQuery,getAnalyzer());
              }
              searchResult=new CmsGallerySearchResult(Math.round((hits.scoreDocs[i].score / hits.getMaxScore()) * 100f),doc,excerpt,locale);
              searchResults.add(searchResult);
            }
            cnt++;
          }
 else {
            visibleHitCount--;
          }
        }
 catch (        Exception e) {
          if (LOG.isWarnEnabled()) {
            LOG.warn(Messages.get().getBundle().key(Messages.LOG_RESULT_ITERATION_FAILED_0),e);
          }
        }
      }
      searchResults.setHitCount(visibleHitCount);
    }
 else {
      searchResults.setHitCount(0);
    }
  }
 catch (  RuntimeException e) {
    throw new CmsSearchException(Messages.get().container(Messages.ERR_SEARCH_PARAMS_1,params),e);
  }
catch (  Exception e) {
    throw new CmsSearchException(Messages.get().container(Messages.ERR_SEARCH_PARAMS_1,params),e);
  }
  return searchResults;
}

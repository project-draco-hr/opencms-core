{
  if (!m_completed)   return;
  if (m_redirectTarget != null) {
    res.setOnlyBuffering(false);
    res.sendRedirect(m_redirectTarget);
  }
 else {
    res.processHeaders(m_headers,res);
    boolean hasNoSubElements=((m_elements != null) && (m_elements.size() == 1));
    java.util.Iterator i=m_elements.iterator();
    while (i.hasNext()) {
      Object o=i.next();
      if (o instanceof String) {
        java.util.HashMap map=(java.util.HashMap)i.next();
        java.util.Map oldMap=null;
        if (map != null) {
          oldMap=req.getParameterMap();
          req.addParameterMap(map);
        }
        req.getCmsRequestDispatcher((String)o).include(req,res);
        if (oldMap != null)         req.setParameterMap(oldMap);
      }
 else {
        try {
          res.writeToOutputStream((byte[])o,hasNoSubElements);
        }
 catch (        java.io.IOException e) {
          String err=this.getClass().getName() + ": Could not write to response OutputStream. ";
          if (DEBUG > 0)           System.err.println(err);
          throw new com.opencms.core.CmsException(err + "\n" + e,e);
        }
      }
    }
  }
}

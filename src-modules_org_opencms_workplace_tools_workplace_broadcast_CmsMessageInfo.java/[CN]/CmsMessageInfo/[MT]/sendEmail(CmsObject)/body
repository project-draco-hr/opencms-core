{
  CmsSimpleMail theMail=new CmsSimpleMail();
  theMail.setCharset(cms.getRequestContext().getEncoding());
  theMail.setFrom(cms.getRequestContext().currentUser().getEmail(),getFrom());
  theMail.setTo(createInternetAddresses(getTo()));
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(getCc())) {
    theMail.setCc(createInternetAddresses(getCc()));
  }
  theMail.setSubject("[" + OpenCms.getSystemInfo().getServerName() + "] "+ getSubject());
  theMail.setMsg(getMsg());
  try {
    theMail.send();
  }
 catch (  SendFailedException sf) {
    StringBuffer newTo=new StringBuffer();
    Address[] unsent=sf.getValidUnsentAddresses();
    if (unsent != null) {
      for (int i=unsent.length - 1; i >= 0; i--) {
        newTo.append(unsent[i].toString()).append(';');
      }
    }
    if (unsent != null) {
      unsent=sf.getInvalidAddresses();
      for (int i=unsent.length - 1; i >= 0; i--) {
        newTo.append(unsent[i].toString()).append(';');
      }
    }
    setTo(newTo.toString());
    throw (Exception)sf.getCause();
  }
}

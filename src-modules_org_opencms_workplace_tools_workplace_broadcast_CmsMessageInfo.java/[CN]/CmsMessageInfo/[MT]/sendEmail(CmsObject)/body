{
  CmsSimpleMail theMail=new CmsSimpleMail();
  theMail.setCharset(cms.getRequestContext().getEncoding());
  theMail.setFrom(cms.getRequestContext().currentUser().getEmail(),getFrom());
  theMail.setTo(createInternetAddresses(getTo()));
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(getCc())) {
    theMail.setCc(createInternetAddresses(getCc()));
  }
  theMail.setSubject("[" + OpenCms.getSystemInfo().getServerName() + "] "+ getSubject());
  theMail.setMsg(getMsg());
  try {
    theMail.send();
  }
 catch (  EmailException e) {
    if (e.getCause() instanceof SendFailedException) {
      SendFailedException sfe=(SendFailedException)e.getCause();
      StringBuffer newTo=new StringBuffer();
      Address[] unsent=sfe.getValidUnsentAddresses();
      if (unsent != null) {
        for (int i=unsent.length - 1; i >= 0; i--) {
          newTo.append(unsent[i].toString()).append(';');
        }
      }
      if (unsent != null) {
        unsent=sfe.getInvalidAddresses();
        for (int i=unsent.length - 1; i >= 0; i--) {
          newTo.append(unsent[i].toString()).append(';');
        }
      }
      setTo(newTo.toString());
      throw (Exception)sfe.getCause();
    }
  }
}

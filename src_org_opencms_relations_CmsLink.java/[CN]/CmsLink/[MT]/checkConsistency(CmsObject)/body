{
  if (!m_internal || (cms == null)) {
    return;
  }
  try {
    if (m_structureId == null) {
      throw new CmsException(Messages.get().container(Messages.LOG_BROKEN_LINK_NO_ID_0));
    }
    String rootPath=null;
    try {
      CmsResource res=cms.readResource(m_structureId,CmsResourceFilter.ALL);
      rootPath=res.getRootPath();
      if (res.isFile()) {
        try {
          CmsProperty detailViewProp=cms.readPropertyObject(res,CmsPropertyDefinition.PROPERTY_ADE_SITEMAP_DETAILVIEW,true);
          if (!detailViewProp.isNullProperty()) {
            String detailView=detailViewProp.getValue();
            String urlName=cms.readNewestUrlNameForId(res.getStructureId());
            if (urlName == null) {
              urlName=res.getStructureId().toString();
            }
            rootPath=cms.getRequestContext().addSiteRoot(CmsStringUtil.joinPaths(detailView,urlName));
          }
        }
 catch (        CmsException e) {
        }
      }
    }
 catch (    CmsException e) {
      CmsSitemapEntry entry=OpenCms.getSitemapManager().getEntryForId(cms,m_structureId);
      if (entry == null) {
        throw new CmsVfsResourceNotFoundException(org.opencms.db.generic.Messages.get().container(org.opencms.db.generic.Messages.ERR_READ_RESOURCE_1,m_target));
      }
      rootPath=entry.getRootPath();
    }
    if (!rootPath.equals(m_target)) {
      if (LOG.isDebugEnabled()) {
        LOG.debug(Messages.get().getBundle().key(Messages.LOG_BROKEN_LINK_UPDATED_BY_ID_3,m_structureId,m_target,rootPath));
      }
      m_target=rootPath;
      setUri();
      CmsLinkUpdateUtil.updateXml(this,m_element,true);
    }
  }
 catch (  CmsException e) {
    if (LOG.isDebugEnabled()) {
      LOG.debug(Messages.get().getBundle().key(Messages.LOG_BROKEN_LINK_BY_ID_2,m_target,m_structureId),e);
    }
    if (CmsStringUtil.isEmptyOrWhitespaceOnly(m_target)) {
      return;
    }
    String siteTarget=cms.getRequestContext().removeSiteRoot(m_target);
    try {
      CmsSitemapEntry entry=OpenCms.getSitemapManager().getEntryForUri(cms,siteTarget);
      if (entry == null) {
        throw new CmsVfsResourceNotFoundException(org.opencms.db.generic.Messages.get().container(org.opencms.db.generic.Messages.ERR_READ_RESOURCE_1,m_target));
      }
      String rootPath=entry.getRootPath();
      CmsUUID id;
      if (entry.getContentId() != null) {
        id=entry.getContentId();
      }
 else {
        id=entry.getStructureId();
      }
      if (!id.equals(m_structureId)) {
        if (LOG.isDebugEnabled()) {
          LOG.debug(Messages.get().getBundle().key(Messages.LOG_BROKEN_LINK_UPDATED_BY_NAME_3,m_target,m_structureId,id));
        }
        m_target=rootPath;
        m_structureId=id;
        CmsLinkUpdateUtil.updateXml(this,m_element,true);
      }
    }
 catch (    CmsException e1) {
      if (LOG.isDebugEnabled()) {
        LOG.debug(Messages.get().getBundle().key(Messages.LOG_BROKEN_LINK_BY_NAME_1,m_target),e1);
      }
      m_structureId=null;
    }
  }
}

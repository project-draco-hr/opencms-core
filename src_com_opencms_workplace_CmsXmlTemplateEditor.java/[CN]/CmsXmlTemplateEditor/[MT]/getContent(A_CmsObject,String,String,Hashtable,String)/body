{
  if (C_DEBUG && A_OpenCms.isLogging()) {
    A_OpenCms.log(C_OPENCMS_DEBUG,getClassName() + "getting content of element " + ((elementName == null) ? "<root>" : elementName));
    A_OpenCms.log(C_OPENCMS_DEBUG,getClassName() + "template file is: " + templateFile);
    A_OpenCms.log(C_OPENCMS_DEBUG,getClassName() + "selected template section is: " + ((templateSelector == null) ? "<default>" : templateSelector));
  }
  A_CmsRequestContext reqCont=cms.getRequestContext();
  HttpSession session=((HttpServletRequest)reqCont.getRequest().getOriginalRequest()).getSession(true);
  CmsFile editFile=null;
  String content=(String)parameters.get("CONTENT");
  String file=(String)parameters.get("file");
  String exit=(String)parameters.get("EXIT");
  String save=(String)parameters.get("save");
  String body=(String)parameters.get("body");
  String bodychange=(String)parameters.get("bodychange");
  String newbody=(String)parameters.get("newbody");
  String editor=(String)parameters.get("editor");
  String title=(String)parameters.get("title");
  String bodytitle=(String)parameters.get("bodytitle");
  String layoutTemplateFilename=(String)parameters.get("template");
  String bodyElementClassName=(String)parameters.get("bodyclass");
  String bodyElementFilename=(String)parameters.get("bodyfile");
  String preview=(String)parameters.get("preview");
  String oldEdit=(String)session.getValue("te_oldedit");
  String bodytag=(String)session.getValue("bodytag");
  String oldLayoutFilename=(String)session.getValue("te_oldlayout");
  String oldTitle=(String)session.getValue("te_title");
  String oldBody=(String)session.getValue("te_oldbody");
  String oldBodytitle=(String)session.getValue("te_oldbodytitle");
  String layoutTemplateClassName=(String)session.getValue("te_templateclass");
  String tempPageFilename=(String)session.getValue("te_temppagefile");
  String tempBodyFilename=(String)session.getValue("te_tempbodyfile");
  boolean existsContentParam=(content != null && (!"".equals(content)));
  boolean existsFileParam=(file != null && (!"".equals(file)));
  boolean existsBodyParam=(body != null && (!"".equals(body)));
  boolean existsTemplateParam=(layoutTemplateFilename != null && (!"".equals(layoutTemplateFilename)));
  boolean saveRequested=((save != null) && "1".equals(save));
  boolean exitRequested=((exit != null) && "1".equals(exit));
  boolean bodychangeRequested=((oldBody != null) && (body != null) && (!(oldBody.equals(body))));
  boolean templatechangeRequested=(oldLayoutFilename != null && layoutTemplateFilename != null && (!(oldLayoutFilename.equals(layoutTemplateFilename))));
  boolean titlechangeRequested=(oldTitle != null && title != null && (!(oldTitle.equals(title))));
  boolean previewRequested=((preview != null) && "1".equals(preview));
  boolean newbodyRequested=((newbody != null) && "1".equals(newbody));
  boolean bodytitlechangeRequested=(oldBodytitle != null && bodytitle != null && (!(oldBodytitle.equals(bodytitle))));
  if (!existsFileParam) {
    throwException("No \"file\" parameter given. Don't know which file should be edited.");
  }
  if (!existsContentParam) {
    System.err.println("***************************");
    System.err.println("*** no content given!!! ***");
    System.err.println("***************************");
    CmsXmlControlFile originalControlFile=new CmsXmlControlFile(cms,file);
    if (originalControlFile.isElementClassDefined("body")) {
      bodyElementClassName=originalControlFile.getElementClass("body");
    }
    if (originalControlFile.isElementTemplateDefined("body")) {
      bodyElementFilename=originalControlFile.getElementTemplate("body");
    }
    if ((bodyElementClassName == null) || (bodyElementFilename == null)) {
    }
    A_CmsResource pageFileResource=cms.readFileHeader(file);
    if (!pageFileResource.isLocked()) {
      cms.lockResource(file);
    }
    A_CmsResource contentFileResource=cms.readFileHeader(bodyElementFilename);
    if (!contentFileResource.isLocked()) {
      cms.lockResource(bodyElementFilename);
    }
    layoutTemplateFilename=originalControlFile.getMasterTemplate();
    layoutTemplateClassName=originalControlFile.getTemplateClass();
    oldLayoutFilename=layoutTemplateFilename;
    if (editor == null || "".equals(editor)) {
      editor=this.C_SELECTBOX_EDITORVIEWS[C_SELECTBOX_EDITORVIEWS_DEFAULT];
      parameters.put("editor",editor);
    }
    oldEdit=editor;
    title=cms.readMetainformation(file,C_METAINFO_TITLE);
    if (title == null) {
      title="";
    }
    oldTitle=title;
    tempPageFilename=createTemporaryFile(cms,pageFileResource);
    tempBodyFilename=createTemporaryFile(cms,contentFileResource);
    session.putValue("te_temppagefile",tempPageFilename);
    session.putValue("te_tempbodyfile",tempBodyFilename);
  }
  if (templatechangeRequested) {
    System.err.println("*** TEMPLATECHANGE to " + layoutTemplateFilename);
    CmsXmlControlFile temporaryControlFile=new CmsXmlControlFile(cms,tempPageFilename);
    temporaryControlFile.setMasterTemplate(layoutTemplateFilename);
    temporaryControlFile.write();
  }
  if (titlechangeRequested) {
    System.err.println("Changing document title to \"" + title + "\".");
    try {
      cms.writeMetainformation(tempPageFilename,C_METAINFO_TITLE,title);
    }
 catch (    CmsException e) {
      if (A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,getClassName() + "Could not write metainformation " + C_METAINFO_TITLE+ " for file "+ file+ ".");
        A_OpenCms.log(C_OPENCMS_INFO,getClassName() + e);
      }
    }
  }
  Object tempObj=CmsTemplateClassManager.getClassInstance(cms,layoutTemplateClassName);
  CmsXmlTemplate layoutTemplateClassObject=(CmsXmlTemplate)tempObj;
  CmsXmlTemplateFile layoutTemplateFile=layoutTemplateClassObject.getOwnTemplateFile(cms,layoutTemplateFilename,null,parameters,null);
  tempObj=CmsTemplateClassManager.getClassInstance(cms,bodyElementClassName);
  CmsXmlTemplate bodyElementClassObject=(CmsXmlTemplate)tempObj;
  CmsXmlTemplateFile bodyTemplateFile=bodyElementClassObject.getOwnTemplateFile(cms,tempBodyFilename,"body",parameters,null);
  Element bodyTag=layoutTemplateFile.getBodyTag();
  bodyTemplateFile.setBodyTag(bodyTag);
  if (!existsContentParam) {
    Vector allBodys=bodyTemplateFile.getAllSections();
    if (allBodys == null || allBodys.size() == 0) {
      body="";
    }
 else {
      body=(String)allBodys.elementAt(0);
    }
    bodytitle=bodyTemplateFile.getSectionTitle(body);
    CmsXmlControlFile temporaryControlFile=new CmsXmlControlFile(cms,tempPageFilename);
    temporaryControlFile.setElementTemplSelector("body",body);
    temporaryControlFile.setElementTemplate("body",tempBodyFilename);
    temporaryControlFile.write();
  }
  if (bodytitlechangeRequested) {
    System.err.println("Changing body title to \"" + title + "\".");
    bodyTemplateFile.setSectionTitle(oldBody,bodytitle);
  }
  if (bodychangeRequested) {
    CmsXmlControlFile temporaryControlFile=new CmsXmlControlFile(cms,tempPageFilename);
    temporaryControlFile.setElementTemplSelector("body",body);
    temporaryControlFile.write();
    bodytitle=bodyTemplateFile.getSectionTitle(body);
  }
  if (newbodyRequested) {
    int bodyNum=bodyTemplateFile.createNewSection("body");
    body="body" + bodyNum;
    CmsXmlControlFile temporaryControlFile=new CmsXmlControlFile(cms,tempPageFilename);
    temporaryControlFile.setElementTemplSelector("body",body);
    temporaryControlFile.setElementTemplate("body",tempBodyFilename);
    temporaryControlFile.write();
  }
  if (existsContentParam) {
    Encoder encoder=new Encoder();
    content=encoder.unescape(content);
    try {
      bodyTemplateFile.setEditedTemplateContent(content,oldBody,oldEdit.equals(C_SELECTBOX_EDITORVIEWS[0]));
    }
 catch (    CmsException e) {
      if (e.getType() == e.C_XML_PARSING_ERROR) {
        CmsXmlWpTemplateFile errorTemplate=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,"parseerror");
        return startProcessing(cms,errorTemplate,elementName,parameters,"parseerror");
      }
 else       throw e;
    }
    bodyTemplateFile.write();
  }
  if (previewRequested) {
    HttpServletRequest srvReq=(HttpServletRequest)reqCont.getRequest().getOriginalRequest();
    String servletPath=srvReq.getServletPath();
    try {
      reqCont.getResponse().sendCmsRedirect(tempPageFilename);
    }
 catch (    IOException e) {
      throwException("Could not send redirect preview file " + servletPath + tempPageFilename,e);
    }
    return "".getBytes();
  }
  if (saveRequested) {
    commitTemporaryFile(cms,bodyElementFilename,tempBodyFilename);
    cms.writeMetainformation(file,C_METAINFO_TITLE,cms.readMetainformation(tempPageFilename,C_METAINFO_TITLE));
    CmsXmlControlFile originalControlFile=new CmsXmlControlFile(cms,file);
    CmsXmlControlFile temporaryControlFile=new CmsXmlControlFile(cms,tempPageFilename);
    originalControlFile.setMasterTemplate(temporaryControlFile.getMasterTemplate());
    originalControlFile.write();
  }
  if (exitRequested) {
    cms.deleteFile(tempBodyFilename);
    cms.deleteFile(tempPageFilename);
    A_CmsXmlContent.clearFileCache(tempBodyFilename);
    A_CmsXmlContent.clearFileCache(tempPageFilename);
    try {
      cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceMainPath());
    }
 catch (    IOException e) {
      throwException("Could not send redirect to workplace main screen.",e);
    }
    return "".getBytes();
  }
  if (editor.equals(C_SELECTBOX_EDITORVIEWS[0])) {
    content=bodyTemplateFile.getEditableTemplateContent(this,parameters,body);
  }
 else {
    content=bodyTemplateFile.getTextEditableTemplateContent(this,parameters,body);
  }
  Encoder encoder=new Encoder();
  content=encoder.escape(content);
  parameters.put("CONTENT",content);
  parameters.put("body",body);
  parameters.put("bodyfile",bodyElementFilename);
  parameters.put("bodyclass",bodyElementClassName);
  parameters.put("template",layoutTemplateFilename);
  parameters.remove("file");
  parameters.remove("EXIT");
  parameters.remove("save");
  int numEditors=C_SELECTBOX_EDITORVIEWS.length;
  for (int i=0; i < numEditors; i++) {
    if (editor.equals(C_SELECTBOX_EDITORVIEWS[i])) {
      parameters.put("editor._CLASS_",C_SELECTBOX_EDITORVIEWS_CLASSES[i]);
      parameters.put("editor._TEMPLATE_",getConfigFile(cms).getWorkplaceTemplatePath() + C_SELECTBOX_EDITORVIEWS_TEMPLATES[i]);
    }
  }
  session.putValue("te_oldedit",editor);
  session.putValue("te_oldbody",body);
  session.putValue("te_oldbodytitle",bodytitle);
  session.putValue("te_oldlayout",layoutTemplateFilename);
  session.putValue("te_title",title);
  session.putValue("te_templateclass",layoutTemplateClassName);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  xmlTemplateDocument.setXmlData("editor",editor);
  xmlTemplateDocument.setXmlData("bodyfile",bodyElementFilename);
  xmlTemplateDocument.setXmlData("bodyclass",bodyElementClassName);
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

{
  String fileToFind=req.getParameter("filePath");
  if (CmsStringUtil.isEmpty(fileToFind)) {
    throw new ServletException(Messages.get().getBundle().key(Messages.ERR_DOWNLOAD_SERVLET_FILE_ARG_0));
  }
 else {
    CmsFlexController controller=CmsFlexController.getController(req);
    if (!OpenCms.getRoleManager().hasRole(controller.getCmsObject(),CmsRole.WORKPLACE_MANAGER) && !OpenCms.getRoleManager().hasRole(controller.getCmsObject(),CmsRole.ACCOUNT_MANAGER)) {
      CmsObject cms=controller.getCmsObject();
      CmsException exc=CmsRole.WORKPLACE_MANAGER.createRoleViolationException(cms.getRequestContext());
      throw new ServletException(exc.getLocalizedMessage(cms.getRequestContext().getLocale()));
    }
    File downloadFile=new File(fileToFind);
    res.setHeader("Content-Disposition",new StringBuffer("attachment; filename=\"").append(downloadFile.getName()).append("\"").toString());
    res.setContentLength((int)downloadFile.length());
    res=controller.getTopResponse();
    res.setContentType("application/octet-stream");
    InputStream in=null;
    ServletOutputStream outStream=null;
    outStream=res.getOutputStream();
    in=new BufferedInputStream(new FileInputStream(downloadFile));
    try {
      int bit=in.read();
      while ((bit) >= 0) {
        outStream.write(bit);
        bit=in.read();
      }
    }
 catch (    SocketException soe) {
    }
catch (    IOException ioe) {
      throw ioe;
    }
 finally {
      if (outStream != null) {
        outStream.flush();
        outStream.close();
      }
      in.close();
    }
  }
}

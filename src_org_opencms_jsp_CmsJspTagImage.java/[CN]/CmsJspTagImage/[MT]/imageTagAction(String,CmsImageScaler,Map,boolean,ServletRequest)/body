{
  CmsFlexController controller=CmsFlexController.getController(req);
  CmsObject cms=controller.getCmsObject();
  CmsResource imageRes=cms.readResource(src);
  if ((scaler.getHeight() <= 0) || (scaler.getWidth() <= 0)) {
    CmsImageScaler original=new CmsImageScaler(cms,imageRes);
    if (original.isValid()) {
      scaler=original.getReScaler(scaler);
    }
  }
  StringBuffer result=new StringBuffer(128);
  if (!partialTag) {
    result.append("<img");
  }
  result.append(" src=\"");
  String imageLink=cms.getSitePath(imageRes);
  if (scaler.isValid()) {
    imageLink+=scaler.toRequestParam();
  }
  result.append(OpenCms.getLinkManager().substituteLink(cms,imageLink));
  result.append("\"");
  if (scaler.isValid()) {
    result.append(" width=\"");
    result.append(scaler.getWidth());
    result.append("\"");
    result.append(" height=\"");
    result.append(scaler.getHeight());
    result.append("\"");
  }
  if (attributes != null) {
    Iterator i=attributes.keySet().iterator();
    while (i.hasNext()) {
      String attr=(String)i.next();
      String value=(String)attributes.get(attr);
      result.append(" ");
      result.append(attr);
      result.append("=\"");
      result.append(CmsEncoder.escapeXml(value));
      result.append("\"");
    }
  }
  if (!partialTag) {
    result.append(" />");
  }
  return result.toString();
}

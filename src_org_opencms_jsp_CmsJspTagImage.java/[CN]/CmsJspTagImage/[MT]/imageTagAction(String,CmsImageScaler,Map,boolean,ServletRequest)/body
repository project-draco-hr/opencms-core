{
  CmsFlexController controller=CmsFlexController.getController(req);
  CmsObject cms=controller.getCmsObject();
  src=CmsLinkManager.getAbsoluteUri(src,controller.getCurrentRequest().getElementUri());
  CmsUriSplitter splitSrc=new CmsUriSplitter(src);
  CmsResource imageRes=cms.readResource(splitSrc.getPrefix());
  CmsImageScaler reScaler=null;
  if (splitSrc.getQuery() != null) {
    String[] scaleStr=(String[])CmsRequestUtil.createParameterMap(splitSrc.getQuery()).get(CmsImageScaler.PARAM_SCALE);
    if (scaleStr != null) {
      reScaler=new CmsImageScaler(scaleStr[0]);
      scaler=reScaler.getCropScaler(scaler);
    }
  }
  if ((scaler.getHeight() <= 0) || (scaler.getWidth() <= 0)) {
    CmsImageScaler original=new CmsImageScaler(cms,imageRes);
    if (original.isValid()) {
      scaler=original.getReScaler(scaler);
    }
  }
  StringBuffer result=new StringBuffer(128);
  if (!partialTag) {
    result.append("<img");
  }
  result.append(" src=\"");
  String imageLink=cms.getSitePath(imageRes);
  if (scaler.isValid()) {
    imageLink+=scaler.toRequestParam();
  }
  result.append(OpenCms.getLinkManager().substituteLink(cms,imageLink));
  result.append("\"");
  if (scaler.isValid()) {
    result.append(" width=\"");
    result.append(scaler.getWidth());
    result.append("\"");
    result.append(" height=\"");
    result.append(scaler.getHeight());
    result.append("\"");
  }
  if (attributes != null) {
    Iterator i=attributes.entrySet().iterator();
    while (i.hasNext()) {
      Map.Entry entry=(Map.Entry)i.next();
      String attr=(String)entry.getKey();
      String value=(String)entry.getValue();
      result.append(" ");
      result.append(attr);
      result.append("=\"");
      result.append(CmsEncoder.escapeXml(value));
      result.append("\"");
    }
  }
  if (!partialTag) {
    result.append(" />");
  }
  return result.toString();
}

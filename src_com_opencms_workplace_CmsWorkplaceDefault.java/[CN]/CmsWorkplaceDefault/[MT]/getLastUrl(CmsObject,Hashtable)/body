{
  CmsSession session=cms.getRequestContext().getSession(true);
  String lasturl=(String)parameters.get("lasturl");
  StringBuffer encLasturl=new StringBuffer();
  boolean notfirst=false;
  if (lasturl != null) {
    int asteriskIdx=lasturl.indexOf("?");
    if (asteriskIdx > -1 && (asteriskIdx < (lasturl.length() - 1))) {
      encLasturl.append(lasturl.substring(0,asteriskIdx + 1));
      String queryString=lasturl.substring(asteriskIdx + 1);
      StringTokenizer st=new StringTokenizer(queryString,"&");
      while (st.hasMoreTokens()) {
        String currToken=st.nextToken();
        if (currToken != null && !"".equals(currToken)) {
          int idx=currToken.indexOf("=");
          if (notfirst) {
            encLasturl.append("&");
          }
 else {
            notfirst=true;
          }
          if (idx > -1) {
            String key=currToken.substring(0,idx);
            String value=(idx < (currToken.length() - 1)) ? currToken.substring(idx + 1) : "";
            encLasturl.append(key);
            encLasturl.append("=");
            encLasturl.append(Encoder.escape(value));
          }
 else {
            encLasturl.append(currToken);
          }
        }
      }
      lasturl=encLasturl.toString();
    }
    session.putValue("lasturl",lasturl);
  }
 else {
    lasturl=(String)session.getValue("lasturl");
  }
  return lasturl;
}

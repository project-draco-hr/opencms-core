{
  try {
    if (getFormConfiguration().isConfirmationMailEnabled()) {
      if (!getFormConfiguration().isConfirmationMailOptional() || "true".equals(getRequest().getParameter(CmsForm.C_PARAM_SENDCONFIRMATION))) {
        sendConfirmationMail();
      }
    }
    if (getFormConfiguration().getMailType().equals(CmsForm.C_MAILTYPE_HTML)) {
      CmsHtmlMail theMail=new CmsHtmlMail();
      if (CmsStringUtil.isNotEmpty(getFormConfiguration().getMailFrom())) {
        theMail.setFrom(getFormConfiguration().getMailFrom());
      }
      theMail.setTo(createInternetAddresses(getFormConfiguration().getMailTo()));
      theMail.setCc(createInternetAddresses(getFormConfiguration().getMailCC()));
      theMail.setBcc(createInternetAddresses(getFormConfiguration().getMailBCC()));
      theMail.setSubject(getFormConfiguration().getMailSubjectPrefix() + getFormConfiguration().getMailSubject());
      theMail.setHtmlMsg(createMailTextFromFields(true,false));
      theMail.setTextMsg(createMailTextFromFields(false,false));
      theMail.send();
    }
 else {
      CmsSimpleMail theMail=new CmsSimpleMail();
      if (CmsStringUtil.isNotEmpty(getFormConfiguration().getMailFrom())) {
        theMail.setFrom(getFormConfiguration().getMailFrom());
      }
      theMail.setTo(createInternetAddresses(getFormConfiguration().getMailTo()));
      theMail.setCc(createInternetAddresses(getFormConfiguration().getMailCC()));
      theMail.setBcc(createInternetAddresses(getFormConfiguration().getMailBCC()));
      theMail.setSubject(getFormConfiguration().getMailSubjectPrefix() + getFormConfiguration().getMailSubject());
      theMail.setMsg(createMailTextFromFields(false,false));
      theMail.send();
    }
  }
 catch (  Exception e) {
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error(e);
    }
    m_errors.put("sendmail",e.getMessage());
    return false;
  }
  return true;
}

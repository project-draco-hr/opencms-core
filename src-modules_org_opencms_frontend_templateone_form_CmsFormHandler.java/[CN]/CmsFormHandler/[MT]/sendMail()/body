{
  try {
    if (getFormConfiguration().isConfirmationMailEnabled()) {
      if (!getFormConfiguration().isConfirmationMailOptional() || Boolean.valueOf(getParameter(CmsForm.PARAM_SENDCONFIRMATION)).booleanValue()) {
        sendConfirmationMail();
      }
    }
    if (getFormConfiguration().getMailType().equals(CmsForm.MAILTYPE_HTML)) {
      CmsHtmlMail theMail=new CmsHtmlMail();
      theMail.setCharset(getCmsObject().getRequestContext().getEncoding());
      if (CmsStringUtil.isNotEmpty(getFormConfiguration().getMailFrom())) {
        theMail.setFrom(getFormConfiguration().getMailFrom());
      }
      theMail.setTo(createInternetAddresses(getFormConfiguration().getMailTo()));
      theMail.setCc(createInternetAddresses(getFormConfiguration().getMailCC()));
      theMail.setBcc(createInternetAddresses(getFormConfiguration().getMailBCC()));
      theMail.setSubject(getFormConfiguration().getMailSubjectPrefix() + getFormConfiguration().getMailSubject());
      theMail.setHtmlMsg(createMailTextFromFields(true,false));
      theMail.setTextMsg(createMailTextFromFields(false,false));
      Map fileUploads=(Map)getRequest().getSession().getAttribute(ATTRIBUTE_FILEITEMS);
      Iterator i=fileUploads.values().iterator();
      while (i.hasNext()) {
        FileItem attachment=(FileItem)i.next();
        if (attachment != null) {
          String filename=attachment.getName().substring(attachment.getName().lastIndexOf(File.separator) + 1);
          theMail.attach(new CmsByteArrayDataSource(filename,attachment.get(),OpenCms.getResourceManager().getMimeType(filename,null,"application/octet-stream")),filename,filename);
        }
      }
      theMail.send();
    }
 else {
      CmsSimpleMail theMail=new CmsSimpleMail();
      theMail.setCharset(getCmsObject().getRequestContext().getEncoding());
      if (CmsStringUtil.isNotEmpty(getFormConfiguration().getMailFrom())) {
        theMail.setFrom(getFormConfiguration().getMailFrom());
      }
      theMail.setTo(createInternetAddresses(getFormConfiguration().getMailTo()));
      theMail.setCc(createInternetAddresses(getFormConfiguration().getMailCC()));
      theMail.setBcc(createInternetAddresses(getFormConfiguration().getMailBCC()));
      theMail.setSubject(getFormConfiguration().getMailSubjectPrefix() + getFormConfiguration().getMailSubject());
      theMail.setMsg(createMailTextFromFields(false,false));
      theMail.send();
    }
  }
 catch (  Exception e) {
    if (LOG.isErrorEnabled()) {
      LOG.error(e.getLocalizedMessage(),e);
    }
    m_errors.put("sendmail",e.getMessage());
    return false;
  }
  return true;
}

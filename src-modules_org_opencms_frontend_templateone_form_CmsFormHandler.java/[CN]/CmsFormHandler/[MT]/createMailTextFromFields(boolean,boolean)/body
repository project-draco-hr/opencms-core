{
  List fieldValues=getFormConfiguration().getFields();
  StringBuffer result=new StringBuffer(fieldValues.size() * 8);
  if (isHtmlMail) {
    result.append("<html><head>\n");
    result.append("<style type=\"text/css\"><!--\n");
    String style=getMessages().key("form.email.style.body");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append("body,h1,p,td { ");
      result.append(style);
      result.append(" }\n");
    }
    style=getMessages().key("form.email.style.h1");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append("h1 { ");
      result.append(style);
      result.append(" }\n");
    }
    style=getMessages().key("form.email.style.p");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append("p { ");
      result.append(style);
      result.append(" }\n");
    }
    style=getMessages().key("form.email.style.fields");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append("table.fields { ");
      result.append(style);
      result.append(" }\n");
    }
    style=getMessages().key("form.email.style.fieldlabel");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append("td.fieldlabel { ");
      result.append(style);
      result.append(" }\n");
    }
    style=getMessages().key("form.email.style.fieldvalue");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append("td.fieldvalue { ");
      result.append(style);
      result.append(" }\n");
    }
    style=getMessages().key("form.email.style.misc");
    if (CmsStringUtil.isNotEmpty(style)) {
      result.append(getMessages().key("form.email.style.misc"));
    }
    result.append("//--></style>\n");
    result.append("</head><body>\n");
    if (isConfirmationMail) {
      result.append(getFormConfiguration().getConfirmationMailText());
    }
 else {
      result.append(getFormConfiguration().getMailText());
    }
    result.append("<table border=\"0\" class=\"fields\">\n");
  }
 else {
    if (isConfirmationMail) {
      result.append(getFormConfiguration().getConfirmationMailTextPlain());
    }
 else {
      result.append(getFormConfiguration().getMailTextPlain());
    }
    result.append("\n\n");
  }
  Iterator i=fieldValues.iterator();
  while (i.hasNext()) {
    I_CmsField current=(I_CmsField)i.next();
    if (isHtmlMail && !(current instanceof CmsPrivacyField)) {
      result.append("<tr><td class=\"fieldlabel\">");
      result.append(current.getLabel());
      result.append("</td><td class=\"fieldvalue\">");
      result.append(convertToHtmlValue(current.toString()));
      result.append("</td></tr>\n");
    }
 else     if (!(current instanceof CmsPrivacyField)) {
      result.append(current.getLabel());
      result.append("\t");
      result.append(current.toString());
      result.append("\n");
    }
  }
  if (isHtmlMail) {
    result.append("</table>\n");
    if (!isConfirmationMail && getFormConfiguration().hasConfigurationErrors()) {
      result.append("<h1>");
      result.append(getMessages().key("form.configuration.error.headline"));
      result.append("</h1>\n<p>");
      for (int k=0; k < getFormConfiguration().getConfigurationErrors().size(); k++) {
        result.append(getFormConfiguration().getConfigurationErrors().get(k));
        result.append("<br>");
      }
      result.append("</p>\n");
    }
    result.append("</body></html>");
  }
 else   if (!isConfirmationMail && getFormConfiguration().hasConfigurationErrors()) {
    result.append("\n");
    result.append(getMessages().key("form.configuration.error.headline"));
    result.append("\n");
    for (int k=0; k < getFormConfiguration().getConfigurationErrors().size(); k++) {
      result.append(getFormConfiguration().getConfigurationErrors().get(k));
      result.append("\n");
    }
  }
  return result.toString();
}

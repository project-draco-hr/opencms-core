{
  int terminatorIndex;
  if (source == null)   return null;
  StringBuffer result=new StringBuffer(source.length() * 2);
  for (int i=0; i < source.length(); i++) {
    int ch=source.charAt(i);
    if ((ch == 38) && ((terminatorIndex=source.indexOf(";",i)) > 0)) {
      if (source.substring(i + 1,terminatorIndex).matches("#[0-9]+|lt|gt|amp|quote")) {
        result.append(source.substring(i,terminatorIndex + 1));
        i=terminatorIndex;
        continue;
      }
    }
    if ((ch != 32) && ((ch > 122) || (ch < 48) || (ch == 60)|| (ch == 62))) {
      result.append("&#");
      result.append(ch);
      result.append(";");
    }
 else {
      result.append((char)ch);
    }
  }
  return new String(result);
}

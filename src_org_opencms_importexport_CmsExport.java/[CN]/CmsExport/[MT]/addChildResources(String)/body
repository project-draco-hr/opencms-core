{
  try {
    List subFolders=getCms().getSubFolders(folderName,CmsResourceFilter.IGNORE_EXPIRATION);
    List subFiles=getCms().getFilesInFolder(folderName,CmsResourceFilter.IGNORE_EXPIRATION);
    for (int i=0; i < subFiles.size(); i++) {
      CmsResource file=(CmsResource)subFiles.get(i);
      int state=file.getState();
      long age=file.getDateLastModified() < file.getDateCreated() ? file.getDateCreated() : file.getDateLastModified();
      if (getCms().getRequestContext().currentProject().isOnlineProject() || (m_includeUnchanged) || state == CmsResource.STATE_NEW || state == CmsResource.STATE_CHANGED) {
        if ((state != CmsResource.STATE_DELETED) && (!file.getName().startsWith("~")) && (age >= m_contentAge)) {
          String export=getCms().getSitePath(file);
          if (checkExportResource(export)) {
            if (isInExportableProject(file)) {
              exportFile(getCms().readFile(export,CmsResourceFilter.IGNORE_EXPIRATION));
            }
          }
        }
      }
      subFiles.set(i,null);
    }
    subFiles=null;
    for (int i=0; i < subFolders.size(); i++) {
      CmsResource folder=(CmsResource)subFolders.get(i);
      if (folder.getState() != CmsResource.STATE_DELETED) {
        String export=getCms().getSitePath(folder);
        if (checkExportResource(export)) {
          long age=folder.getDateLastModified() < folder.getDateCreated() ? folder.getDateCreated() : folder.getDateLastModified();
          if (age >= m_contentAge) {
            appendResourceToManifest(folder,false);
          }
          addChildResources(getCms().getSitePath(folder));
        }
      }
      subFolders.set(i,null);
    }
  }
 catch (  CmsImportExportException e) {
    throw e;
  }
catch (  CmsException e) {
    CmsMessageContainer message=Messages.get().container(Messages.ERR_IMPORTEXPORT_ERROR_ADDING_CHILD_RESOURCES_1,folderName);
    if (LOG.isDebugEnabled()) {
      LOG.debug(message.key(),e);
    }
    throw new CmsImportExportException(message,e);
  }
}

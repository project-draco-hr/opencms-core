{
  Map ret=buildDepsForAllModules(rfsAbsPath,mode);
  Iterator itMods;
  if (rfsAbsPath == null) {
    itMods=OpenCms.getModuleManager().getAllInstalledModules().iterator();
  }
 else {
    itMods=getAllModulesFromPath(rfsAbsPath).keySet().iterator();
  }
  while (itMods.hasNext()) {
    CmsModule module=(CmsModule)itMods.next();
    if (!moduleNames.contains(module.getName())) {
      Iterator itDeps=ret.values().iterator();
      while (itDeps.hasNext()) {
        List dependencies=(List)itDeps.next();
        dependencies.remove(module.getName());
      }
      ret.remove(module.getName());
    }
  }
  return ret;
}

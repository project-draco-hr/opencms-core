{
  if (m_jspPageContext != null) {
    if (macro.startsWith(CmsMacroResolver.C_KEY_REQUEST_PARAM)) {
      macro=macro.substring(CmsMacroResolver.C_KEY_REQUEST_PARAM.length());
      return m_jspPageContext.getRequest().getParameter(macro);
    }
    if (macro.startsWith(CmsMacroResolver.C_KEY_PAGE_CONTEXT)) {
      macro=macro.substring(CmsMacroResolver.C_KEY_PAGE_CONTEXT.length());
      int scope=m_jspPageContext.getAttributesScope(macro);
      return m_jspPageContext.getAttribute(macro,scope).toString();
    }
    if ((m_cms != null) && macro.startsWith(CmsMacroResolver.C_KEY_PROPERTY_ELEMENT)) {
      macro=macro.substring(CmsMacroResolver.C_KEY_PROPERTY_ELEMENT.length());
      CmsFlexController controller=(CmsFlexController)m_jspPageContext.getRequest().getAttribute(CmsFlexController.ATTRIBUTE_NAME);
      try {
        CmsProperty property=m_cms.readPropertyObject(controller.getCurrentRequest().getElementUri(),macro,false);
        if (property != CmsProperty.getNullProperty()) {
          return property.getValue();
        }
      }
 catch (      CmsException e) {
        if (OpenCms.getLog(this).isErrorEnabled()) {
          OpenCms.getLog(this).error("Error reading property " + macro + " of resource "+ controller.getCurrentRequest().getElementUri(),e);
        }
      }
    }
  }
  if (m_cms != null) {
    if (macro.startsWith(CmsMacroResolver.C_KEY_PROPERTY)) {
      macro=macro.substring(CmsMacroResolver.C_KEY_PROPERTY.length());
      try {
        CmsProperty property=m_cms.readPropertyObject(m_cms.getRequestContext().getUri(),macro,true);
        if (property != CmsProperty.getNullProperty()) {
          return property.getValue();
        }
      }
 catch (      CmsException e) {
        if (OpenCms.getLog(this).isErrorEnabled()) {
          OpenCms.getLog(this).error("Error reading property " + macro + " of resource "+ m_cms.getRequestContext().getUri(),e);
        }
      }
    }
    if (macro.startsWith(CmsMacroResolver.C_KEY_OPENCMS)) {
      String originalKey=macro;
      macro=macro.substring(CmsMacroResolver.C_KEY_OPENCMS.length());
      int index=CmsMacroResolver.C_VALUE_NAMES_OPENCMS.indexOf(macro);
      String value=null;
switch (index) {
case 0:
        value=m_cms.getRequestContext().getUri();
      break;
case 1:
    value=m_resourceName;
  break;
case 2:
value=m_cms.getRequestContext().getFolderUri();
break;
case 3:
value=OpenCms.getSystemInfo().getDefaultEncoding();
break;
default :
value=originalKey;
break;
}
return value;
}
if (CmsMacroResolver.KEY_CURRENT_USER_NAME.equals(macro)) {
return m_cms.getRequestContext().currentUser().getName();
}
if (CmsMacroResolver.KEY_CURRENT_USER_FIRSTNAME.equals(macro)) {
return m_cms.getRequestContext().currentUser().getFirstname();
}
if (CmsMacroResolver.KEY_CURRENT_USER_LASTNAME.equals(macro)) {
return m_cms.getRequestContext().currentUser().getLastname();
}
if (CmsMacroResolver.KEY_CURRENT_USER_FULLNAME.equals(macro)) {
return m_cms.getRequestContext().currentUser().getFullName();
}
if (CmsMacroResolver.KEY_CURRENT_USER_EMAIL.equals(macro)) {
return m_cms.getRequestContext().currentUser().getEmail();
}
if (CmsMacroResolver.KEY_CURRENT_USER_STREET.equals(macro)) {
return m_cms.getRequestContext().currentUser().getAddress();
}
if (CmsMacroResolver.KEY_CURRENT_USER_ZIP.equals(macro)) {
return (String)m_cms.getRequestContext().currentUser().getAdditionalInfo(I_CmsConstants.C_ADDITIONAL_INFO_ZIPCODE);
}
if (CmsMacroResolver.KEY_CURRENT_USER_CITY.equals(macro)) {
return (String)m_cms.getRequestContext().currentUser().getAdditionalInfo(I_CmsConstants.C_ADDITIONAL_INFO_TOWN);
}
if (CmsMacroResolver.KEY_REQUEST_URI.equals(macro)) {
return m_cms.getRequestContext().getUri();
}
if (CmsMacroResolver.KEY_REQUEST_FOLDER.equals(macro)) {
return CmsResource.getParentFolder(m_cms.getRequestContext().getUri());
}
if (CmsMacroResolver.KEY_REQUEST_ENCODING.equals(macro)) {
return m_cms.getRequestContext().getEncoding();
}
if (CmsMacroResolver.KEY_REQUEST_LOCALE.equals(macro)) {
return m_cms.getRequestContext().getLocale().toString();
}
}
if (m_locale != null) {
if (macro.startsWith(CmsMacroResolver.KEY_LOCALIZED_PREFIX)) {
String keyName=macro.substring(CmsMacroResolver.KEY_LOCALIZED_PREFIX.length());
CmsMessages messages=m_xmlContentHandler.getMessages(m_locale);
if (messages != null) {
return messages.key(keyName);
}
return CmsMessages.formatUnknownKey(keyName);
}
if (macro.startsWith(CmsMacroResolver.KEY_LOCALIZED_PREFIX)) {
return CmsMacroResolver.formatMacro(macro);
}
}
if (CmsMacroResolver.KEY_CURRENT_TIME.equals(macro)) {
return String.valueOf(System.currentTimeMillis());
}
if (m_additionalMacros != null) {
return (String)m_additionalMacros.get(macro);
}
return null;
}

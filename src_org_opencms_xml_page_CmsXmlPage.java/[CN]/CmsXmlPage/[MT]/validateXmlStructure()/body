{
  XMLReader reader;
  try {
    reader=XMLReaderFactory.createXMLReader("org.apache.xerces.parsers.SAXParser");
  }
 catch (  SAXException e) {
    if (OpenCms.getLog(this).isWarnEnabled()) {
      OpenCms.getLog(this).warn("Could not initialize Xerces SAX reader for validation",e);
    }
    return;
  }
  try {
    reader.setFeature("http://xml.org/sax/features/validation",true);
    reader.setFeature("http://apache.org/xml/features/validation/schema",true);
    reader.setFeature("http://xml.org/sax/features/namespaces",true);
    reader.setFeature("http://xml.org/sax/features/namespace-prefixes",false);
  }
 catch (  SAXNotRecognizedException e) {
    if (OpenCms.getLog(this).isWarnEnabled()) {
      OpenCms.getLog(this).warn("Required SAX reader feature not recognized",e);
    }
    return;
  }
catch (  SAXNotSupportedException e) {
    if (OpenCms.getLog(this).isWarnEnabled()) {
      OpenCms.getLog(this).warn("Required SAX reader feature not supported",e);
    }
    return;
  }
  reader.setEntityResolver(CmsXmlEntityResolver.getResolver());
  XMLErrorHandler errorHandler=new XMLErrorHandler();
  reader.setErrorHandler(errorHandler);
  String content=null;
  try {
    byte[] contentBytes=((ByteArrayOutputStream)write(new ByteArrayOutputStream(512),getEncoding())).toByteArray();
    content=new String(contentBytes,getEncoding());
    reader.parse(new InputSource(new ByteArrayInputStream(contentBytes)));
  }
 catch (  IOException e) {
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error("Could not read XML from byte array",e);
    }
    return;
  }
catch (  SAXException e) {
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error("Unexpected SAX exception while parsing content",e);
    }
    return;
  }
  if (errorHandler.getErrors().elements().size() > 0) {
    StringWriter out=new StringWriter(256);
    OutputFormat format=OutputFormat.createPrettyPrint();
    XMLWriter writer=new XMLWriter(out,format);
    try {
      writer.write(errorHandler.getErrors());
      writer.close();
    }
 catch (    IOException e) {
      if (OpenCms.getLog(this).isErrorEnabled()) {
        OpenCms.getLog(this).error("Unexpected IO exception while writing to StringWriter",e);
      }
    }
    if (content != null) {
      out.write("\n\nThe verfified XML page content was:");
      out.write("\n-------------------------------------------------------------------\n");
      out.write(content);
      out.write("\n-------------------------------------------------------------------\n");
    }
    throw new CmsXmlException("XML validation error:\n" + out.toString() + "\n");
  }
}

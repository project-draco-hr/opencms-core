{
  if (jsp != null) {
    HttpSession session=jsp.getRequest().getSession();
    CmsWorkplaceSettings settings=(CmsWorkplaceSettings)session.getAttribute(CmsWorkplaceManager.C_SESSION_WORKPLACE_SETTINGS);
    if (CmsStringUtil.isEmpty(galleryTypeName)) {
      galleryTypeName=settings.getGalleryType();
    }
 else {
      settings.setGalleryType(galleryTypeName);
    }
  }
  String className=OpenCms.getWorkplaceManager().getGalleryClassName(galleryTypeName);
  if (className == null) {
    CmsMessageContainer message;
    if (jsp == null) {
      message=Messages.get().container(Messages.LOG_UNKNOWN_GALLERY_TYPE_REQ_1,galleryTypeName);
    }
 else {
      message=Messages.get().container(Messages.LOG_UNKNOWN_GALLERY_TYPE_REQ_JSP_2,galleryTypeName,jsp.info("opencms.request.element.uri"));
    }
    LOG.error(message.key());
    throw new CmsRuntimeException(message);
  }
  try {
    Class galleryClass=Class.forName(className);
    A_CmsGallery galleryInstance=(A_CmsGallery)galleryClass.newInstance();
    galleryInstance.m_galleryTypeName=galleryTypeName;
    galleryInstance.m_galleryTypeId=OpenCms.getResourceManager().getResourceType(galleryTypeName).getTypeId();
    galleryInstance.initWorkplaceMembers(jsp);
    return galleryInstance;
  }
 catch (  Exception e) {
    CmsMessageContainer message;
    if (jsp == null) {
      message=Messages.get().container(Messages.LOG_CREATE_GALLERY_INSTANCE_FAILED_2,className,galleryTypeName);
    }
 else {
      message=Messages.get().container(Messages.LOG_CREATE_GALLERY_INSTANCE_FAILED_JSP_3,className,galleryTypeName,jsp.info("opencms.request.element.uri"));
    }
    LOG.error(message.key());
    throw new CmsRuntimeException(message);
  }
}

{
  if (Integer.parseInt(version) == CmsHistoryResourceHandler.PROJECT_OFFLINE_VERSION) {
    CmsResource resource=cms.readResource(structureId);
    return CmsFile.upgrade(resource,cms);
  }
 else {
    int ver=Integer.parseInt(version);
    if (ver < 0) {
      CmsProject project=cms.getRequestContext().currentProject();
      try {
        cms.getRequestContext().setCurrentProject(cms.readProject(CmsProject.ONLINE_PROJECT_ID));
        CmsResource resource=cms.readResource(structureId);
        return CmsFile.upgrade(resource,cms);
      }
  finally {
        cms.getRequestContext().setCurrentProject(project);
      }
    }
    return CmsFile.upgrade((CmsHistoryFile)cms.readResource(structureId,ver),cms);
  }
}

{
  try {
    List elementList=computeElements();
    if (elementList == null) {
      throw new CmsException("Elements not specified on template file!");
    }
    CmsFile file=getCms().readFile(this.getParamTempfile());
    CmsXmlPage page=CmsXmlPage.read(getCms(),file);
    boolean foundMandatory=false;
    m_changeElement="";
    Iterator i=elementList.iterator();
    while (i.hasNext()) {
      String[] currentElement=(String[])i.next();
      String elementName=currentElement[0];
      boolean isExisting=page.hasElement(elementName,getElementLocale());
      boolean isMandatory="1".equals(currentElement[2]);
      if (isMandatory || "true".equals(getJsp().getRequest().getParameter(PREFIX_PARAM_BODY + elementName))) {
        if (!isExisting) {
          page.addElement(elementName,getElementLocale());
        }
        page.setEnabled(elementName,getElementLocale(),true);
        if (isMandatory && !foundMandatory) {
          m_changeElement=elementName;
          foundMandatory=true;
        }
      }
 else {
        if (isExisting) {
          page.setEnabled(elementName,getElementLocale(),false);
        }
      }
    }
    getCms().writeFile(page.write(file));
    if (page.isEnabled(getParamElementname(),getElementLocale())) {
      m_changeElement=getParamElementname();
    }
 else     if (!foundMandatory) {
      m_changeElement=((String[])elementList.get(0))[0];
    }
  }
 catch (  CmsException e) {
    setParamErrorstack(e.getStackTraceAsString());
    setParamMessage(key("error.message.editor.elements"));
    String reason=key("error.reason.editor.elements") + "<br>\n" + key("error.suggestion.editor.elements")+ "\n";
    setParamReasonSuggestion(reason);
    getJsp().getRequest().setAttribute(C_SESSION_WORKPLACE_CLASS,this);
    try {
      getJsp().include(C_FILE_DIALOG_SCREEN_ERROR);
    }
 catch (    Exception exc) {
    }
  }
}

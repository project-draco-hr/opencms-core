{
  try {
    List elementList=computeElements();
    CmsFile file=getCms().readFile(this.getParamTempfile());
    CmsXmlPage page=CmsXmlPage.read(getCms(),file);
    boolean foundMandatory=false;
    m_changeElement="";
    Iterator i=elementList.iterator();
    while (i.hasNext()) {
      CmsDialogElement element=(CmsDialogElement)i.next();
      if (element.isMandantory() || "true".equals(getJsp().getRequest().getParameter(PREFIX_PARAM_BODY + element.getName()))) {
        if (!element.isExisting()) {
          page.addElement(element.getName(),getElementLocale());
        }
        page.setEnabled(element.getName(),getElementLocale(),true);
        if (element.isMandantory() && !foundMandatory) {
          m_changeElement=element.getName();
          foundMandatory=true;
        }
      }
 else {
        if (element.isExisting()) {
          page.setEnabled(element.getName(),getElementLocale(),true);
          if (!element.isTemplateElement() && "".equals(page.getContent(getCms(),element.getName(),getElementLocale()))) {
            page.removeElement(element.getName(),getElementLocale());
          }
 else {
            page.setEnabled(element.getName(),getElementLocale(),false);
          }
        }
      }
    }
    file=page.write(file);
    getCms().writeFile(file);
    if (page.isEnabled(getParamElementname(),getElementLocale())) {
      m_changeElement=getParamElementname();
    }
 else     if (!foundMandatory) {
      if (elementList.size() > 0) {
        m_changeElement=((CmsDialogElement)elementList.get(0)).getName();
      }
    }
  }
 catch (  CmsException e) {
    setParamErrorstack(e.getStackTraceAsString());
    setParamMessage(key("error.message.editor.elements"));
    String reason=key("error.reason.editor.elements") + "<br>\n" + key("error.suggestion.editor.elements")+ "\n";
    setParamReasonSuggestion(reason);
    getJsp().getRequest().setAttribute(C_SESSION_WORKPLACE_CLASS,this);
    try {
      getJsp().include(C_FILE_DIALOG_SCREEN_ERROR);
    }
 catch (    Exception exc) {
    }
  }
}

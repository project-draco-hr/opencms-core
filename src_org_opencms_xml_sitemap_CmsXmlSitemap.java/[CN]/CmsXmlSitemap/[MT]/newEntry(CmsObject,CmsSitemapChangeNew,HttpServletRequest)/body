{
  String entryPoint;
  if (change instanceof CmsSitemapChangeNewSubSitemapEntry) {
    entryPoint=((CmsSitemapChangeNewSubSitemapEntry)change).getEntryPoint();
  }
 else {
    entryPoint=getEntryPoint(cms);
  }
  Element entryElement=getElement(cms,change.getSitePath(),entryPoint);
  if (entryElement != null) {
    throw createEntryAlreadyExistsException(cms,change.getSitePath());
  }
  String parentPath=CmsResource.getParentFolder(change.getSitePath());
  Element parent=getElement(cms,parentPath,entryPoint);
  if (parent == null) {
    throw createEntryNotFoundException(cms,parentPath);
  }
  entryElement=parent.addElement(XmlNode.SiteEntry.name());
  CmsUUID id=change.getId();
  if (id == null) {
    id=new CmsUUID();
  }
  entryElement.addElement(XmlNode.Id.name()).addCDATA(id.toString());
  String name=CmsResource.getName(change.getSitePath());
  if (name.endsWith("/")) {
    name=name.substring(0,name.length() - 1);
  }
  entryElement.addElement(XmlNode.Name.name()).addCDATA(name);
  entryElement.addElement(XmlNode.Title.name()).addCDATA(change.getTitle());
  Element vfsFile=entryElement.addElement(XmlNode.VfsFile.name());
  String vfsPath=change.getVfsPath();
  CmsResource resource=null;
  if (vfsPath == null) {
    resource=OpenCms.getSitemapManager().createNewElement(cms,cms.getSitePath(m_file),req,CmsResourceTypeXmlContainerPage.getStaticTypeName());
    setResourceTitle(cms,resource,change.getTitle());
  }
 else {
    resource=cms.readResource(vfsPath);
  }
  fillResource(cms,vfsFile,resource);
  Map<String,CmsXmlContentProperty> propertiesConf=OpenCms.getADEManager().getElementPropertyConfiguration(cms,getFile());
  CmsXmlContentPropertyHelper.saveProperties(cms,entryElement,change.getProperties(),getFile(),propertiesConf);
  return cms.getRequestContext().addSiteRoot(change.getSitePath());
}

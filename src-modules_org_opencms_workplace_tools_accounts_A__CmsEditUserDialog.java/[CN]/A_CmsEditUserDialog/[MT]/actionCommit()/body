{
  List errors=new ArrayList();
  try {
    if (CmsStringUtil.isNotEmpty(m_pwdInfo.getNewPwd())) {
      m_pwdInfo.setConfirmation(m_pwdInfo.getConfirmation());
    }
    if (isNewUser()) {
      CmsUser newUser=createUser(m_paramOufqn + m_user.getSimpleName(),m_pwdInfo.getNewPwd(),m_user.getDescription(),m_user.getAdditionalInfo());
      newUser.setFirstname(m_user.getFirstname());
      newUser.setLastname(m_user.getLastname());
      newUser.setEmail(m_user.getEmail());
      newUser.setAddress(m_user.getAddress());
      m_user=newUser;
    }
 else     if (CmsStringUtil.isNotEmpty(m_pwdInfo.getNewPwd())) {
      if (!m_pwdInfo.getNewPwd().equals(m_pwdInfo.getConfirmation())) {
        m_pwdInfo.setConfirmation(null);
      }
      getCms().setPassword(m_user.getName(),m_pwdInfo.getNewPwd());
    }
    if (isNewUser() && CmsStringUtil.isNotEmptyOrWhitespaceOnly(getGroup())) {
      getCms().readGroup(getGroup());
    }
    writeUser(m_user);
    if (isNewUser()) {
      if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(getGroup())) {
        getCms().addUserToGroup(m_user.getName(),getGroup());
      }
    }
    CmsUserSettings settings=new CmsUserSettings(m_user);
    settings.setLocale(CmsLocaleManager.getLocale(getLanguage()));
    settings.setStartSite(getSite());
    if (isNewUser()) {
      try {
        String prj=getCms().readProject(getParamOufqn() + OpenCms.getWorkplaceManager().getDefaultUserSettings().getStartProject()).getName();
        settings.setStartProject(prj);
      }
 catch (      CmsException e) {
        settings.setStartProject(OpenCms.getWorkplaceManager().getDefaultUserSettings().getStartProject());
      }
    }
    settings.save(getCms());
    Map objects=(Map)getSettings().getListObject();
    if (objects != null) {
      objects.remove(getListClass());
    }
  }
 catch (  Throwable t) {
    errors.add(t);
  }
  if (errors.isEmpty() && isNewUser()) {
    if ((getParamCloseLink() != null) && (getParamCloseLink().indexOf("path=" + getListRootPath()) > -1)) {
      Map argMap=new HashMap();
      argMap.put(PARAM_USERID,m_user.getId());
      argMap.put("oufqn",m_paramOufqn);
      setParamCloseLink(CmsToolManager.linkForToolPath(getJsp(),getListRootPath() + "/edit",argMap));
    }
  }
  setCommitErrors(errors);
}

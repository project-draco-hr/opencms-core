{
  System.out.println("Testing resource categories reparation after deleting/adding a centralized category.");
  CmsObject cms=getCmsObject();
  List cats=CmsCategoryService.getInstance().readCategories(cms,null,true,"index.html");
  assertEquals(3,cats.size());
  CmsCategory catA=(CmsCategory)cats.get(0);
  CmsCategory catAA=(CmsCategory)cats.get(1);
  CmsCategory catB2=(CmsCategory)cats.get(2);
  assertEquals(CmsCategoryService.CENTRALIZED_REPOSITORY + "a/",catA.getRootPath());
  assertEquals(CmsCategoryService.CENTRALIZED_REPOSITORY + "a/aa/",catAA.getRootPath());
  assertEquals(CmsCategoryService.CENTRALIZED_REPOSITORY + "b/",catB2.getRootPath());
  cats=CmsCategoryService.getInstance().readResourceCategories(cms,"index.html");
  assertEquals(2,cats.size());
  assertEquals(catA,cats.get(0));
  assertEquals(catB2,cats.get(1));
  List resources=CmsCategoryService.getInstance().readCategoryResources(cms,catA.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catAA.getPath(),true,"index.html").isEmpty());
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catB2.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  cms.deleteResource(catB2.getRootPath(),CmsResource.DELETE_PRESERVE_SIBLINGS);
  cats=CmsCategoryService.getInstance().readCategories(cms,null,true,"index.html");
  assertEquals(3,cats.size());
  CmsCategory catB=(CmsCategory)cats.get(2);
  assertEquals(catA.getRootPath(),((CmsCategory)cats.get(0)).getRootPath());
  assertEquals(catAA.getRootPath(),((CmsCategory)cats.get(1)).getRootPath());
  assertEquals(cms.getRequestContext().getSiteRoot() + CmsCategoryService.getInstance().getRepositoryBaseFolderName(cms) + "b/",catB.getRootPath());
  OpenCmsTestLogAppender.setBreakOnError(false);
  echo("next error stack trace is expected.");
  cats=CmsCategoryService.getInstance().readResourceCategories(cms,"index.html");
  OpenCmsTestLogAppender.setBreakOnError(true);
  assertEquals(1,cats.size());
  assertEquals(catA,cats.get(0));
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catA.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catAA.getPath(),true,"index.html").isEmpty());
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catB.getPath(),true,"index.html").isEmpty());
  CmsCategoryService.getInstance().repairRelations(cms,"index.html");
  cats=CmsCategoryService.getInstance().readResourceCategories(cms,"index.html");
  assertEquals(2,cats.size());
  assertEquals(catA,cats.get(0));
  assertEquals(catB,cats.get(1));
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catA.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catAA.getPath(),true,"index.html").isEmpty());
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catB.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  CmsCategory catB2bis=CmsCategoryService.getInstance().createCategory(cms,null,"b","B2","B2 test",null);
  assertEquals(catB2.getRootPath(),catB2bis.getRootPath());
  cats=CmsCategoryService.getInstance().readCategories(cms,null,true,"index.html");
  assertEquals(3,cats.size());
  assertEquals(catA.getRootPath(),((CmsCategory)cats.get(0)).getRootPath());
  assertEquals(catAA.getRootPath(),((CmsCategory)cats.get(1)).getRootPath());
  assertEquals(catB2.getRootPath(),((CmsCategory)cats.get(2)).getRootPath());
  cats=CmsCategoryService.getInstance().readResourceCategories(cms,"index.html");
  assertEquals(2,cats.size());
  assertEquals(catA.getRootPath(),((CmsCategory)cats.get(0)).getRootPath());
  assertEquals(catB.getRootPath(),((CmsCategory)cats.get(1)).getRootPath());
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catA.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catAA.getPath(),true,"index.html").isEmpty());
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catB2.getPath(),true,"index.html").isEmpty());
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catB.getPath(),true,"index.html").isEmpty());
  CmsCategoryService.getInstance().repairRelations(cms,"index.html");
  cats=CmsCategoryService.getInstance().readResourceCategories(cms,"index.html");
  assertEquals(2,cats.size());
  assertEquals(catA.getRootPath(),((CmsCategory)cats.get(0)).getRootPath());
  assertEquals(catB2.getRootPath(),((CmsCategory)cats.get(1)).getRootPath());
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catA.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
  assertTrue(CmsCategoryService.getInstance().readCategoryResources(cms,catAA.getPath(),true,"index.html").isEmpty());
  resources=CmsCategoryService.getInstance().readCategoryResources(cms,catB2.getPath(),true,"index.html");
  assertEquals(1,resources.size());
  assertEquals(cms.readResource("index.html"),resources.get(0));
}

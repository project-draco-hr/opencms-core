{
  CmsXmlTemplateFile templateFile=(CmsXmlTemplateFile)doc;
  boolean isAnonymousUser=cms.getRequestContext().currentUser().isGuestUser();
  Hashtable parameterHashtable=(Hashtable)((Hashtable)userObject).clone();
  String templateClass=getTemplateClassName(tagcontent,templateFile,parameterHashtable);
  String templateFilename=CmsLinkManager.getAbsoluteUri(getTemplateFileName(tagcontent,templateFile,parameterHashtable),doc.getAbsoluteFilename());
  String templateSelector=getTemplateSelector(tagcontent,templateFile,parameterHashtable);
  byte[] result=null;
  Object loadedObject=null;
  I_CmsTemplate subTemplate=null;
  Object subTemplateKey=null;
  try {
    loadedObject=CmsTemplateClassManager.getClassInstance(templateClass);
  }
 catch (  CmsException e) {
    templateFile.removeFromFileCache();
    if (isAnonymousUser) {
      return C_ERRORTEXT;
    }
 else {
      throw e;
    }
  }
  if (!(loadedObject instanceof I_CmsTemplate)) {
    String errorMessage="Class " + templateClass + " is no OpenCms template class.";
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error(errorMessage);
    }
    throw new CmsLegacyException(errorMessage,CmsLegacyException.C_XML_NO_TEMPLATE_CLASS);
  }
  subTemplate=(I_CmsTemplate)loadedObject;
  Vector parameterTags=null;
  parameterTags=templateFile.getParameterNames(tagcontent);
  if (parameterTags != null) {
    int numParameterTags=parameterTags.size();
    for (int i=0; i < numParameterTags; i++) {
      String paramName=(String)parameterTags.elementAt(i);
      String paramValue=templateFile.getParameter(tagcontent,paramName);
      if (!parameterHashtable.containsKey(paramName)) {
        parameterHashtable.put(tagcontent + "." + paramName,paramValue);
      }
    }
  }
  parameterHashtable.put(C_ELEMENT,tagcontent);
  if (subTemplate.collectCacheDirectives(cms,templateFilename,tagcontent,parameterHashtable,null).isInternalCacheable()) {
    subTemplateKey=subTemplate.getKey(cms,templateFilename,parameterHashtable,null);
    if (m_cache != null && m_cache.has(subTemplateKey) && (!subTemplate.shouldReload(cms,templateFilename,tagcontent,parameterHashtable,null))) {
      result=m_cache.get(subTemplateKey);
    }
  }
  if (result == null) {
    try {
      result=subTemplate.getContent(cms,templateFilename,tagcontent,parameterHashtable,templateSelector);
    }
 catch (    Exception e) {
      if (OpenCms.getLog(this).isErrorEnabled()) {
        OpenCms.getLog(this).error("Could not generate output for template file \"" + templateFilename + "\" included as element \""+ tagcontent+ "\"",e);
      }
      if (isAnonymousUser) {
        return C_ERRORTEXT;
      }
 else {
        if (e instanceof CmsException) {
          throw (CmsException)e;
        }
 else {
          throw new CmsLegacyException("Error while executing getContent for subtemplate \"" + tagcontent + "\". "+ e);
        }
      }
    }
    if (subTemplate.collectCacheDirectives(cms,templateFilename,tagcontent,parameterHashtable,null).isInternalCacheable() && m_cache != null) {
      m_cache.put(subTemplateKey,result);
    }
  }
  return new CmsProcessedString(result,cms.getRequestContext().getEncoding());
}

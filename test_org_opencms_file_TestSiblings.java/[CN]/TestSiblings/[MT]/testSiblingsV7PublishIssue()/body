{
  echo("Tests OpenCms v7 publish issue with siblings");
  CmsObject cms=getCmsObject();
  CmsProject offlineProject=cms.getRequestContext().getCurrentProject();
  CmsProject onlineProject=cms.readProject(CmsProject.ONLINE_PROJECT_ID);
  String folder="/publish_v7issue/";
  cms.createResource(folder,CmsResourceTypeFolder.getStaticTypeId());
  String firstContent="This is the first content";
  byte[] firstContentBytes=firstContent.getBytes();
  CmsProperty firstTitleProperty=new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,"The first title",null);
  List firstProperties=new ArrayList();
  firstProperties.add(firstTitleProperty);
  String source=folder + "test_en.txt";
  cms.createResource(source,CmsResourceTypePlain.getStaticTypeId(),firstContentBytes,firstProperties);
  assertState(cms,folder,CmsResourceState.STATE_NEW);
  assertState(cms,source,CmsResourceState.STATE_NEW);
  OpenCms.getPublishManager().publishResource(cms,folder);
  OpenCms.getPublishManager().waitWhileRunning();
  cms.getRequestContext().setCurrentProject(onlineProject);
  assertState(cms,folder,CmsResourceState.STATE_UNCHANGED);
  assertState(cms,source,CmsResourceState.STATE_UNCHANGED);
  assertContent(cms,source,firstContentBytes);
  cms.getRequestContext().setCurrentProject(offlineProject);
  assertState(cms,folder,CmsResourceState.STATE_UNCHANGED);
  assertState(cms,source,CmsResourceState.STATE_UNCHANGED);
  assertContent(cms,source,firstContentBytes);
  String sibling=folder + "test_de.txt";
  copyResourceAsSibling(this,cms,source,sibling);
  assertState(cms,sibling,CmsResourceState.STATE_NEW);
  assertContent(cms,sibling,firstContentBytes);
  String secondContent="++++++++ This is the SECOND content ++++++++++";
  byte[] secondContentBytes=secondContent.getBytes();
  CmsFile sourceFile=cms.readFile(source);
  sourceFile.setContents(secondContentBytes);
  cms.writeFile(sourceFile);
  assertState(cms,sibling,CmsResourceState.STATE_NEW);
  assertState(cms,source,CmsResourceState.STATE_CHANGED);
  assertContent(cms,sibling,secondContentBytes);
  assertContent(cms,source,secondContentBytes);
  CmsProperty secondTitleProperty=new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,"The SECOND title",null);
  cms.writePropertyObject(source,secondTitleProperty);
  OpenCms.getPublishManager().publishResource(cms,folder);
  OpenCms.getPublishManager().waitWhileRunning();
  cms.getRequestContext().setCurrentProject(onlineProject);
  String contentOnline=new String(cms.readFile(source).getContents());
  cms.getRequestContext().setCurrentProject(offlineProject);
  String contentOffline=new String(cms.readFile(source).getContents());
  echo("Online Content:\n" + contentOnline);
  echo("Offline Content:\n" + contentOffline);
  cms.getRequestContext().setCurrentProject(offlineProject);
  assertState(cms,folder,CmsResourceState.STATE_UNCHANGED);
  assertState(cms,source,CmsResourceState.STATE_UNCHANGED);
  assertContent(cms,sibling,secondContentBytes);
  assertContent(cms,source,secondContentBytes);
  cms.getRequestContext().setCurrentProject(onlineProject);
  assertState(cms,folder,CmsResourceState.STATE_UNCHANGED);
  assertState(cms,source,CmsResourceState.STATE_UNCHANGED);
  assertContent(cms,sibling,secondContentBytes);
  assertContent(cms,source,secondContentBytes);
}

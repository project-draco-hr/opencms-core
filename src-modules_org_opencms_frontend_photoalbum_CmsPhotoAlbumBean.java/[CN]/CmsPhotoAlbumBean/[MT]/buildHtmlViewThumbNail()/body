{
  StringBuffer result=new StringBuffer(4096);
  int startIndex=(getCurrentPage() - 1) * getPhotosPerPage();
  int endIndex=0;
  int rowCount=getConfiguration().getThumbRows();
  if (getConfiguration().showPageNavigation()) {
    endIndex=(getCurrentPage() * getPhotosPerPage()) - 1;
    if (endIndex > (getAlbumPhotos().size() - 1)) {
      endIndex=getAlbumPhotos().size() - 1;
    }
  }
 else {
    endIndex=getAlbumPhotos().size() - 1;
  }
  int photoCount=endIndex - startIndex + 1;
  rowCount=photoCount / getConfiguration().getThumbCols();
  if ((photoCount % getConfiguration().getThumbCols()) > 0) {
    rowCount+=1;
  }
  result.append(buildHtmlAlbumTitle());
  result.append("<table border=\"0\"");
  result.append(getStyle().getClassThumbTable());
  result.append(" width=\"");
  result.append(getConfiguration().getThumbCols() * getConfiguration().getThumbNailScaler().getWidth());
  result.append("\">\n");
  result.append(buildHtmlPageNavigation(CmsPhotoAlbumConfiguration.NAVPOS_TOP_ABOVE));
  result.append(buildHtmlThumbTextRow(getConfiguration().getThumbTextTop()));
  result.append(buildHtmlPageNavigation(CmsPhotoAlbumConfiguration.NAVPOS_TOP_BELOW));
  String styleAttr=getConfiguration().getStyleAlignAttribute(getConfiguration().getThumbAlignTitle());
  int photoIndex=startIndex;
  for (int i=1; i <= rowCount; i++) {
    result.append("<tr>\n");
    for (int k=1; k <= getConfiguration().getThumbCols(); k++) {
      result.append("\t<td width=\"");
      result.append(getConfiguration().getThumbNailScaler().getWidth());
      result.append("\"");
      result.append(getStyle().getClassThumbImageTitle());
      result.append(styleAttr);
      result.append(">");
      if (photoIndex <= endIndex) {
        CmsResource photo=(CmsResource)getAlbumPhotos().get(photoIndex);
        String resourceName=getCmsObject().getSitePath(photo);
        String title="";
        if (getConfiguration().showResourceNameAsTitle()) {
          title=CmsResource.getName(resourceName);
        }
        title=property(CmsPropertyDefinition.PROPERTY_TITLE,resourceName,title);
        title=CmsEncoder.escapeXml(title);
        result.append("<a href=\"");
        StringBuffer link=new StringBuffer(256);
        link.append(getRequestContext().getUri());
        link.append("?");
        link.append(PARAM_ACTION).append("=").append(VALUE_ACTION_DETAIL);
        link.append("&").append(PARAM_IMAGE).append("=").append(photoIndex);
        result.append(link(link.toString()));
        result.append("\">");
        result.append("<img src=\"");
        link=new StringBuffer(256);
        link.append(resourceName);
        link.append(getConfiguration().getThumbNailScaler().toRequestParam());
        result.append(link(link.toString()));
        result.append("\" border=\"0\" width=\"");
        result.append(getConfiguration().getThumbNailScaler().getWidth());
        result.append("\" height=\"");
        result.append(getConfiguration().getThumbNailScaler().getHeight());
        result.append("\" alt=\"");
        result.append(title);
        result.append("\" title=\"");
        result.append(title);
        result.append("\">");
        result.append("</a>");
        if (getConfiguration().showThumbTitle() && CmsStringUtil.isNotEmptyOrWhitespaceOnly(title)) {
          result.append("<br clear=\"all\"><span");
          result.append(getStyle().getClassThumbImageTitle());
          result.append(">");
          result.append(title);
          result.append("</span>");
        }
        photoIndex++;
      }
      result.append("</td>\n");
    }
    result.append("</tr>\n");
  }
  result.append(buildHtmlPageNavigation(CmsPhotoAlbumConfiguration.NAVPOS_BOTTOM_ABOVE));
  result.append(buildHtmlThumbTextRow(getConfiguration().getThumbTextBottom()));
  result.append(buildHtmlPageNavigation(CmsPhotoAlbumConfiguration.NAVPOS_BOTTOM_BELOW));
  result.append("</table>");
  return result.toString();
}

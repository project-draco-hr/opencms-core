{
  PropertiesImpl result=new PropertiesImpl();
  Set<String> addedProps=new HashSet<String>();
  if ((properties == null) || (properties.getProperties() == null)) {
    throw new CmisConstraintException("No properties!");
  }
  TypeDefinition type=types.getType(typeId);
  if (type == null) {
    throw new CmisObjectNotFoundException("Type '" + typeId + "' is unknown!");
  }
  for (  PropertyData<?> prop : properties.getProperties().values()) {
    PropertyDefinition<?> propType=type.getPropertyDefinitions().get(prop.getId());
    if (propType == null) {
      throw new CmisConstraintException("Property '" + prop.getId() + "' is unknown!");
    }
    if ((propType.getUpdatability() == Updatability.READONLY)) {
      throw new CmisConstraintException("Property '" + prop.getId() + "' is readonly!");
    }
    if (isEmptyProperty(prop)) {
      throw new CmisConstraintException("Property '" + prop.getId() + "' must not be empty!");
    }
    result.addProperty(prop);
    addedProps.add(prop.getId());
  }
  for (  PropertyDefinition<?> propDef : type.getPropertyDefinitions().values()) {
    if (!addedProps.contains(propDef.getId()) && (propDef.getUpdatability() != Updatability.READONLY)) {
      if (!addPropertyDefault(result,propDef) && propDef.isRequired()) {
        throw new CmisConstraintException("Property '" + propDef.getId() + "' is required!");
      }
    }
  }
  addPropertyId(result,typeId,null,PropertyIds.OBJECT_TYPE_ID,typeId);
  addPropertyString(result,typeId,null,PropertyIds.CREATED_BY,creator);
  addPropertyDateTime(result,typeId,null,PropertyIds.CREATION_DATE,creationDate);
  addPropertyString(result,typeId,null,PropertyIds.LAST_MODIFIED_BY,modifier);
  return result;
}

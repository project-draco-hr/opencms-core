{
  String template=null;
  HttpSession session=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getSession(true);
  String step=(String)parameters.get("STEP");
  String currentFolder=(String)session.getValue(C_PARA_FILELIST);
  String title=(String)parameters.get(C_PARA_TITLE);
  String newname=(String)parameters.get(C_PARA_NAME);
  String filename=null;
  byte[] filecontent=new byte[0];
  Enumeration files=cms.getRequestContext().getRequest().getFileNames();
  while (files.hasMoreElements()) {
    filename=(String)files.nextElement();
  }
  if (filename != null) {
    session.putValue(C_PARA_FILE,filename);
  }
  filename=(String)session.getValue(C_PARA_FILE);
  if (filename != null) {
    filecontent=cms.getRequestContext().getRequest().getFile(filename);
  }
  if (filecontent != null) {
    session.putValue(C_PARA_FILECONTENT,filecontent);
  }
  filecontent=(byte[])session.getValue(C_PARA_FILECONTENT);
  String newtype=(String)parameters.get(C_PARA_NEWTYPE);
  if (newtype != null) {
    session.putValue(C_PARA_NEWTYPE,newtype);
  }
  newtype=(String)session.getValue(C_PARA_NEWTYPE);
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  if (step != null) {
    if (step.equals("1")) {
      if (filename != null) {
        template="step1";
      }
    }
 else     if (step.equals("2")) {
      A_CmsResourceType type=cms.getResourceType(newtype);
      if (newtype.equals(C_TYPE_IMAGE_NAME)) {
        template="image";
        xmlTemplateDocument.setXmlData("MIME",filename);
        xmlTemplateDocument.setXmlData("SIZE","Not yet available");
        xmlTemplateDocument.setXmlData("FILESIZE",new Integer(filecontent.length).toString() + " Bytes");
      }
 else {
        cms.createFile(currentFolder,filename,filecontent,type.getResourceName());
        session.removeValue(C_PARA_FILE);
        session.removeValue(C_PARA_FILECONTENT);
        session.removeValue(C_PARA_NEWTYPE);
        try {
          cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + C_WP_EXPLORER_FILELIST);
        }
 catch (        Exception ex) {
          throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + C_WP_EXPLORER_FILELIST,CmsException.C_UNKNOWN_EXCEPTION,ex);
        }
      }
    }
 else     if (step.equals("3")) {
      if (newname != null) {
        filename=newname;
      }
      A_CmsResourceType type=cms.getResourceType(newtype);
      CmsFile file=cms.createFile(currentFolder,filename,filecontent,type.getResourceName());
      if (title != null) {
        cms.lockResource(file.getAbsolutePath());
        cms.writeProperty(file.getAbsolutePath(),C_PROPERTY_TITLE,title);
        cms.unlockResource(file.getAbsolutePath());
      }
      session.removeValue(C_PARA_FILE);
      session.removeValue(C_PARA_FILECONTENT);
      session.removeValue(C_PARA_NEWTYPE);
      try {
        cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + C_WP_EXPLORER_FILELIST);
      }
 catch (      Exception ex) {
        throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + C_WP_EXPLORER_FILELIST,CmsException.C_UNKNOWN_EXCEPTION,ex);
      }
    }
  }
  if (filename != null) {
    xmlTemplateDocument.setXmlData("FILENAME",filename);
  }
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

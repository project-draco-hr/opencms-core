{
  if (m_solr instanceof EmbeddedSolrServer) {
    SolrCore core=((EmbeddedSolrServer)m_solr).getCoreContainer().getCore(getName());
    SolrQueryResponse queryResponse=new SolrQueryResponse();
    queryResponse.setAllValues(result.getQueryResponse().getResponse());
    long executionTime=System.currentTimeMillis() - result.getStartTime();
    long endTime=result.getStartTime() + executionTime;
    queryResponse.setEndTime(endTime);
    SolrQueryRequest queryRequest=new LocalSolrQueryRequest(core,queryResponse.getResponseHeader());
    queryRequest.setParams(result.getQuery());
    int paramsIndex=queryResponse.getResponseHeader().indexOf(HEADER_PARAMS_NAME,0);
    Object o=queryResponse.getResponseHeader().getVal(paramsIndex);
    if (o instanceof NamedList) {
      NamedList header=(NamedList)o;
      header.setVal(header.indexOf(CommonParams.ROWS,0),result.getRows());
      header.setVal(header.indexOf(CommonParams.START,0),result.getStart());
    }
    QueryResponseWriter responseWriter=core.getQueryResponseWriter(queryRequest);
    final String ct=responseWriter.getContentType(queryRequest,queryResponse);
    if (null != ct) {
      response.setContentType(ct);
    }
    if (responseWriter instanceof BinaryQueryResponseWriter) {
      BinaryQueryResponseWriter binWriter=(BinaryQueryResponseWriter)responseWriter;
      binWriter.write(response.getOutputStream(),queryRequest,queryResponse);
    }
 else {
      String charset=ContentStreamBase.getCharsetFromContentType(ct);
      Writer out=((charset == null) || charset.equalsIgnoreCase(UTF8.toString())) ? new OutputStreamWriter(response.getOutputStream(),UTF8) : new OutputStreamWriter(response.getOutputStream(),charset);
      out=new FastWriter(out);
      responseWriter.write(out,queryRequest,queryResponse);
      out.flush();
    }
  }
 else {
    throw new UnsupportedOperationException();
  }
}

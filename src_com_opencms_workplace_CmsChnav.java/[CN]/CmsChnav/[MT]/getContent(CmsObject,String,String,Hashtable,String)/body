{
  String template=null;
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String navtext="";
  String initial=(String)parameters.get("initial");
  if (initial != null) {
    clearSession(session);
  }
  String lasturl=getLastUrl(cms,parameters);
  String filename=(String)parameters.get(C_PARA_FILE);
  if (filename == null || "".equals(filename)) {
    filename=(String)session.getValue(C_SESSIONHEADER + C_PARA_FILE);
  }
  if (filename != null) {
    session.putValue(C_SESSIONHEADER + C_PARA_FILE,filename);
  }
  CmsResource resource=(CmsResource)cms.readFileHeader(filename);
  String navpos=(String)parameters.get(C_PARA_NAVPOS);
  navtext=(String)parameters.get(C_PARA_NAVTEXT);
  if ((navtext == null) || ("".equals(navtext))) {
    navtext=cms.readProperty(cms.readAbsolutePath(resource),I_CmsConstants.C_PROPERTY_NAVTEXT);
  }
  String action=(String)parameters.get("action");
  if (action != null) {
    if ("save".equals(action)) {
      try {
        updateNavPos(cms,resource,navpos);
        if (navtext != null) {
          cms.writeProperty(cms.readAbsolutePath(resource),I_CmsConstants.C_PROPERTY_NAVTEXT,navtext);
        }
        clearSession(session);
      }
 catch (      CmsException ex) {
        session.putValue(C_SESSIONHEADER + C_PARA_NAVPOS,navpos);
        session.putValue(C_SESSIONHEADER + C_PARA_NAVTEXT,navtext);
        xmlTemplateDocument.setData("details",Utils.getStackTrace(ex));
        xmlTemplateDocument.setData("lasturl",lasturl);
        return startProcessing(cms,xmlTemplateDocument,"",parameters,"error_system");
      }
      try {
        if (lasturl == null || "".equals(lasturl)) {
          cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(cms));
        }
 else {
          cms.getRequestContext().getResponse().sendRedirect(lasturl);
        }
      }
 catch (      Exception e) {
        throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(cms),CmsException.C_UNKNOWN_EXCEPTION,e);
      }
      return null;
    }
 else     if ("fromerror".equalsIgnoreCase(action)) {
      template=null;
      xmlTemplateDocument.setData(C_PARA_NAVPOS,(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVPOS));
      navtext=(String)session.getValue(C_SESSIONHEADER + C_PARA_NAVTEXT);
      session.removeValue(C_SESSIONHEADER + C_PARA_NAVPOS);
      session.removeValue(C_SESSIONHEADER + C_PARA_NAVTEXT);
    }
  }
  xmlTemplateDocument.setData("frametitle",resource.getResourceName());
  xmlTemplateDocument.setData(C_PARA_NAVTEXT,Encoder.escapeXml(navtext));
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

{
  if (m_entities.containsKey(entity.getId())) {
    throw new IllegalArgumentException("Entity " + entity.getId() + " is already registered");
  }
  if (!m_types.containsKey(entity.getTypeName())) {
    throw new IllegalArgumentException("Type " + entity.getTypeName() + " is not registered yet");
  }
  for (  EntityAttribute attr : entity.getAttributes()) {
    if (attr.isComplexValue()) {
      for (      Entity child : attr.getComplexValues()) {
        registerEntity(child);
      }
    }
  }
  entity.ensureChangeHandlers();
  m_entities.put(entity.getId(),entity);
  return entity;
}

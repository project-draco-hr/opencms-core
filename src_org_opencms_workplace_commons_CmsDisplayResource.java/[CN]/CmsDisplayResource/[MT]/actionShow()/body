{
  if (CmsStringUtil.isNotEmpty(getParamVersionid())) {
    byte[] result=getBackupResourceContent(getCms(),getParamResource(),getParamVersionid());
    if (result != null) {
      String contentType=OpenCms.getResourceManager().getMimeType(getParamResource(),getCms().getRequestContext().getEncoding());
      HttpServletResponse res=getJsp().getResponse();
      HttpServletRequest req=getJsp().getRequest();
      res.setHeader(CmsRequestUtil.HEADER_CONTENT_DISPOSITION,new StringBuffer("attachment; filename=\"").append(getParamResource()).append("\"").toString());
      res.setContentLength(result.length);
      CmsFlexController controller=CmsFlexController.getController(req);
      res=controller.getTopResponse();
      res.setContentType(contentType);
      try {
        res.getOutputStream().write(result);
        res.getOutputStream().flush();
      }
 catch (      IOException e) {
        if (LOG.isInfoEnabled()) {
          LOG.info(e.getLocalizedMessage());
        }
        return;
      }
    }
  }
 else {
    if (getCms().existsResource(getParamResource(),CmsResourceFilter.DEFAULT)) {
      String url=getJsp().link(getParamResource());
      if (url.indexOf("://") < 0 && getCms().getRequestContext().currentProject().isOnlineProject()) {
        String site=getCms().getRequestContext().getSiteRoot();
        if (CmsStringUtil.isEmptyOrWhitespaceOnly(site)) {
          site=OpenCms.getSiteManager().getDefaultUri();
          if (CmsStringUtil.isEmptyOrWhitespaceOnly(site)) {
            url=OpenCms.getSiteManager().getWorkplaceServer() + url;
          }
 else           if (CmsSiteManager.getSite(site) == null) {
            url=OpenCms.getSiteManager().getWorkplaceServer() + url;
          }
 else {
            url=CmsSiteManager.getSite(site).getUrl() + url;
          }
        }
 else {
          url=CmsSiteManager.getSite(site).getUrl() + url;
        }
        try {
          CmsStaticExportManager manager=OpenCms.getStaticExportManager();
          HttpURLConnection.setFollowRedirects(false);
          URL exportUrl=new URL(manager.getExportUrl() + manager.getRfsName(getCms(),getParamResource()));
          HttpURLConnection urlcon=(HttpURLConnection)exportUrl.openConnection();
          urlcon.setRequestMethod("GET");
          urlcon.setRequestProperty(CmsRequestUtil.HEADER_OPENCMS_EXPORT,Boolean.TRUE.toString());
          if (manager.getAcceptLanguageHeader() != null) {
            urlcon.setRequestProperty(CmsRequestUtil.HEADER_ACCEPT_LANGUAGE,manager.getAcceptLanguageHeader());
          }
 else {
            urlcon.setRequestProperty(CmsRequestUtil.HEADER_ACCEPT_LANGUAGE,manager.getDefaultAcceptLanguageHeader());
          }
          if (manager.getAcceptCharsetHeader() != null) {
            urlcon.setRequestProperty(CmsRequestUtil.HEADER_ACCEPT_CHARSET,manager.getAcceptCharsetHeader());
          }
 else {
            urlcon.setRequestProperty(CmsRequestUtil.HEADER_ACCEPT_CHARSET,manager.getDefaultAcceptCharsetHeader());
          }
          urlcon.connect();
          urlcon.getResponseCode();
          urlcon.disconnect();
        }
 catch (        Exception e) {
        }
      }
      getJsp().getResponse().sendRedirect(url);
    }
 else {
      if (getCms().existsResource(getParamResource(),CmsResourceFilter.ALL)) {
        if (getCms().existsResource(getParamResource(),CmsResourceFilter.IGNORE_EXPIRATION)) {
          throw new CmsVfsResourceNotFoundException(Messages.get().container(Messages.ERR_RESOURCE_OUTSIDE_TIMEWINDOW_1,getParamResource()));
        }
 else {
          throw new CmsVfsResourceNotFoundException(Messages.get().container(Messages.ERR_RESOURCE_DELETED_2,getParamResource(),getCms().getRequestContext().currentProject().getName()));
        }
      }
      throw new CmsVfsResourceNotFoundException(Messages.get().container(Messages.ERR_RESOURCE_DOES_NOT_EXIST_3,getParamResource(),getCms().getRequestContext().currentProject().getName(),getCms().getRequestContext().getSiteRoot()));
    }
  }
}

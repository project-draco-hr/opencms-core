{
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  Hashtable parameters=(Hashtable)userObj;
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)doc;
  StringBuffer result=new StringBuffer();
  String pageText=(String)parameters.get(CmsWorkplaceDefault.C_PARA_PAGE);
  Vector filteredLinks=(Vector)parameters.get("_HTMLLIST_");
  int numLinks=filteredLinks.size();
  int page=new Integer(pageText).intValue();
  int from=(page - 1) * CmsWorkplaceDefault.C_PICBROWSER_MAXIMAGES;
  int to=((from + CmsWorkplaceDefault.C_PICBROWSER_MAXIMAGES) > numLinks) ? numLinks : (from + CmsWorkplaceDefault.C_PICBROWSER_MAXIMAGES);
  String folder=(String)parameters.get(CmsWorkplaceDefault.C_PARA_FOLDER);
  if (folder == null) {
    folder=(String)session.getValue(CmsWorkplaceDefault.C_PARA_FOLDER);
  }
  if (folder == null || "".equals(folder)) {
    folder=getConfigFile(cms).getHtmlGalleryPath();
    parameters.put(CmsWorkplaceDefault.C_PARA_FOLDER,folder);
  }
  String linkUrl=CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getServletUrl() + folder;
  for (int i=from; i < to; i++) {
    CmsFile file=cms.readFile(cms.getSitePath((CmsFile)filteredLinks.elementAt(i)));
    String filename=file.getName();
    String title=cms.readProperty(cms.getSitePath(file),CmsPropertyDefinition.PROPERTY_TITLE);
    int dotIndex=filename.lastIndexOf(".");
    if (title == null) {
      if (dotIndex > 0) {
        title=filename.substring(0,dotIndex);
      }
 else {
        title=filename;
      }
    }
    xmlTemplateDocument.setData("linksource",linkUrl + file.getName());
    xmlTemplateDocument.setData("filename",cms.getSitePath(file));
    xmlTemplateDocument.setData("title",filename);
    xmlTemplateDocument.setData("linktext",filename);
    xmlTemplateDocument.setData("snippetid","" + i);
    xmlTemplateDocument.setData("filecontent",new String(file.getContents()));
    try {
      xmlTemplateDocument.setData("filecontent_escaped",CmsEncoder.escape(new String(file.getContents(),cms.getRequestContext().getEncoding()),cms.getRequestContext().getEncoding()));
    }
 catch (    UnsupportedEncodingException e) {
      xmlTemplateDocument.setData("filecontent_escaped",CmsEncoder.escape(new String(file.getContents()),cms.getRequestContext().getEncoding()));
    }
    String paraSetOnClick=(String)session.getValue("htmlBrowser_for_ext_nav");
    String setOnClick="";
    if ("true".equals(paraSetOnClick)) {
      setOnClick=xmlTemplateDocument.getProcessedDataValue("clickentry");
    }
    xmlTemplateDocument.setData("toclickornot",setOnClick);
    result.append(xmlTemplateDocument.getProcessedDataValue("htmllistentry",this,userObj));
  }
  return result.toString();
}

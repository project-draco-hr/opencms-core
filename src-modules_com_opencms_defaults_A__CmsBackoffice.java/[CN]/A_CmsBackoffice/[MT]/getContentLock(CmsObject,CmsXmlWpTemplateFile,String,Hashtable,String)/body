{
  byte[] processResult=null;
  CmsUserSettings settings=new CmsUserSettings(cms.getRequestContext().currentUser());
  if (!settings.getDialogShowLock()) {
    parameters.put("action","go");
  }
  CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  Class cdClass=getContentDefinitionClass();
  CmsUUID actUserId=cms.getRequestContext().currentUser().getId();
  String id=(String)parameters.get("id");
  if (id == null)   id="";
  parameters.put("idlock",id);
  String action=(String)parameters.get("action");
  if (action == null || action.equals("")) {
    templateSelector="lock";
    CmsUUID contentId=new CmsUUID(id);
    CmsUUID lockedByUserId=CmsUUID.getNullUUID();
    Object o=null;
    if (contentId != null) {
      o=getContentDefinition(cms,cdClass,contentId);
      try {
        lockedByUserId=((A_CmsContentDefinition)o).getLockstate();
      }
 catch (      Exception e) {
        if (CmsLog.getLog(this).isWarnEnabled()) {
          CmsLog.getLog(this).warn(e.getMessage());
        }
      }
    }
 else {
      o=getContentDefinition(cms,cdClass,id);
      try {
        lockedByUserId=((A_CmsContentDefinition)o).getLockstate();
      }
 catch (      Exception e) {
        if (CmsLog.getLog(this).isWarnEnabled()) {
          CmsLog.getLog(this).warn(e.getMessage());
        }
      }
    }
    String moduleName="";
    moduleName=getClass().toString();
    moduleName=moduleName.substring(5);
    moduleName=moduleName.trim();
    moduleName=moduleName.replace('.','_');
    CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
    if (!lockedByUserId.isNullUUID() && !lockedByUserId.equals(actUserId)) {
      template.setData("locktitle",lang.getLanguageValue("messagebox.title.lockchange"));
      template.setData("lockstate",lang.getLanguageValue("messagebox.message1.lockchange"));
    }
    if (lockedByUserId.isNullUUID()) {
      template.setData("locktitle",lang.getLanguageValue("messagebox.title.lock"));
      template.setData("lockstate",lang.getLanguageValue("messagebox.message1.lock"));
    }
    if (lockedByUserId.equals(actUserId)) {
      template.setData("locktitle",lang.getLanguageValue("messagebox.title.unlock"));
      template.setData("lockstate",lang.getLanguageValue("messagebox.message1.unlock"));
    }
    template.setData("newsentry",id);
    template.setData("setaction","default");
    parameters.put("action","done");
  }
 else {
    templateSelector="done";
    CmsUUID contentId=new CmsUUID(id);
    CmsUUID lockedByUserId=CmsUUID.getNullUUID();
    Object o=null;
    o=getContentDefinition(cms,cdClass,contentId);
    try {
      lockedByUserId=((A_CmsContentDefinition)o).getLockstate();
    }
 catch (    Exception e) {
      if (CmsLog.getLog(this).isWarnEnabled()) {
        CmsLog.getLog(this).warn(e.getMessage());
      }
    }
    try {
      lockedByUserId=((A_CmsContentDefinition)o).getLockstate();
    }
 catch (    Exception e) {
      if (CmsLog.getLog(this).isWarnEnabled()) {
        CmsLog.getLog(this).warn("Method getLockstate caused an exception",e);
      }
    }
    if (lockedByUserId.equals(actUserId)) {
      if (isExtendedList()) {
        int curProjectId=cms.getRequestContext().currentProject().getId();
        int lockedInProject=-1;
        try {
          lockedInProject=((I_CmsExtendedContentDefinition)o).getLockedInProject();
        }
 catch (        Exception e) {
          if (CmsLog.getLog(this).isWarnEnabled()) {
            CmsLog.getLog(this).warn("Method getLockstate caused an exception",e);
          }
        }
        if (curProjectId == lockedInProject) {
          try {
            ((A_CmsContentDefinition)o).setLockstate(CmsUUID.getNullUUID());
          }
 catch (          Exception e) {
            if (CmsLog.getLog(this).isWarnEnabled()) {
              CmsLog.getLog(this).warn("Method setLockstate caused an exception",e);
            }
          }
        }
 else {
          try {
            ((A_CmsContentDefinition)o).setLockstate(actUserId);
          }
 catch (          Exception e) {
            if (CmsLog.getLog(this).isWarnEnabled()) {
              CmsLog.getLog(this).warn("Method setLockstate caused an exception",e);
            }
          }
        }
      }
 else {
        try {
          ((A_CmsContentDefinition)o).setLockstate(CmsUUID.getNullUUID());
        }
 catch (        Exception e) {
          if (CmsLog.getLog(this).isWarnEnabled()) {
            CmsLog.getLog(this).warn("Method setLockstate caused an exception",e);
          }
        }
      }
      try {
        ((A_CmsContentDefinition)o).write(cms);
      }
 catch (      Exception e) {
        if (CmsLog.getLog(this).isWarnEnabled()) {
          CmsLog.getLog(this).warn("Method write caused an exception",e);
        }
      }
      templateSelector="done";
    }
 else {
      if ((!lockedByUserId.isNullUUID()) && (!lockedByUserId.equals(actUserId))) {
        try {
          ((A_CmsContentDefinition)o).setLockstate(actUserId);
        }
 catch (        Exception e) {
          if (CmsLog.getLog(this).isWarnEnabled()) {
            CmsLog.getLog(this).warn("Could not set lockstate",e);
          }
        }
        try {
          ((A_CmsContentDefinition)o).write(cms);
        }
 catch (        Exception e) {
          if (CmsLog.getLog(this).isWarnEnabled()) {
            CmsLog.getLog(this).warn("Could not set lockstate",e);
          }
        }
        templateSelector="done";
      }
 else {
        try {
          ((A_CmsContentDefinition)o).setLockstate(actUserId);
        }
 catch (        Exception e) {
          if (CmsLog.getLog(this).isWarnEnabled()) {
            CmsLog.getLog(this).warn("Could not set lockstate",e);
          }
        }
        try {
          ((A_CmsContentDefinition)o).write(cms);
        }
 catch (        Exception e) {
          if (CmsLog.getLog(this).isWarnEnabled()) {
            CmsLog.getLog(this).warn("Could not write to content definition",e);
          }
        }
      }
    }
  }
  processResult=startProcessing(cms,template,elementName,parameters,templateSelector);
  return processResult;
}

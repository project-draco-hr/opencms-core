{
  Map sites=OpenCms.getSiteManager().getSiteList();
  List siteroots=new ArrayList(sites.size() + 1);
  Map siteServers=new HashMap(sites.size() + 1);
  List result=new ArrayList(sites.size() + 1);
  Iterator i;
  i=sites.keySet().iterator();
  while (i.hasNext()) {
    CmsSite site=(CmsSite)sites.get(i.next());
    String folder=site.getSiteRoot() + "/";
    if (!siteroots.contains(folder)) {
      siteroots.add(folder);
      siteServers.put(folder,site.getSiteMatcher());
    }
  }
  if (workplaceMode && OpenCms.getSiteManager().getDefaultSite() != null) {
    String folder=OpenCms.getSiteManager().getDefaultSite().getSiteRoot() + "/";
    if (!siteroots.contains(folder)) {
      siteroots.add(folder);
    }
  }
  String currentRoot=cms.getRequestContext().getSiteRoot();
  cms.getRequestContext().saveSiteRoot();
  try {
    cms.getRequestContext().setSiteRoot("/");
    if (workplaceMode && cms.isAdmin()) {
      if (!siteroots.contains("/")) {
        siteroots.add("/");
      }
      if (!siteroots.contains(currentRoot + "/")) {
        siteroots.add(currentRoot + "/");
      }
    }
    Collections.sort(siteroots);
    i=siteroots.iterator();
    while (i.hasNext()) {
      String folder=(String)i.next();
      try {
        CmsResource res=cms.readFileHeader(folder);
        if (!workplaceMode || cms.hasPermissions(res,I_CmsConstants.C_VIEW_ACCESS)) {
          String title=cms.readPropertyObject(folder,I_CmsConstants.C_PROPERTY_TITLE,false).getValue();
          if (title == null) {
            title=folder;
          }
          result.add(new CmsSite(folder,res.getStructureId(),title,(CmsSiteMatcher)siteServers.get(folder)));
        }
      }
 catch (      CmsException e) {
      }
    }
  }
 catch (  Throwable t) {
    if (OpenCms.getLog(CmsSiteManager.class).isErrorEnabled()) {
      OpenCms.getLog(CmsSiteManager.class).error("Error reading site properties",t);
    }
  }
 finally {
    cms.getRequestContext().restoreSiteRoot();
  }
  return result;
}

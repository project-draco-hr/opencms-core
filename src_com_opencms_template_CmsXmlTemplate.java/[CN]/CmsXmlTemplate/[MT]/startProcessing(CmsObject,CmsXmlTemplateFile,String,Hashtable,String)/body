{
  System.err.println("*** startProcessing called for " + getClass().getName() + "/"+ xmlTemplateDocument.getAbsoluteFilename());
  byte[] result=null;
  if (cms.getRequestContext().isStaging()) {
    System.err.println("*** staging mode");
    CmsElementVariant variant=new CmsElementVariant();
    xmlTemplateDocument.generateStagingVariant(this,parameters,elementName,templateSelector,variant);
    System.err.println("*** variantXXX " + variant);
    CmsStaging staging=OpenCms.getStaticStaging();
    CmsElementDescriptor elKey=new CmsElementDescriptor(getClass().getName(),xmlTemplateDocument.getAbsoluteFilename());
    A_CmsElement currElem=staging.getElementLocator().get(cms,elKey,parameters);
    if (currElem.collectCacheDirectives().isInternalCacheable()) {
      currElem.addVariant(getKey(cms,xmlTemplateDocument.getAbsoluteFilename(),parameters,templateSelector),variant);
    }
    result=((CmsElementXml)currElem).resolveVariant(cms,variant,staging,parameters);
    return result;
  }
 else {
    try {
      result=xmlTemplateDocument.getProcessedTemplateContent(this,parameters,templateSelector).getBytes();
    }
 catch (    Throwable e) {
      xmlTemplateDocument.removeFromFileCache();
      if (isCacheable(cms,xmlTemplateDocument.getAbsoluteFilename(),elementName,parameters,templateSelector)) {
        m_cache.clearCache(getKey(cms,xmlTemplateDocument.getAbsoluteFilename(),parameters,templateSelector));
      }
      if (e instanceof CmsException) {
        throw (CmsException)e;
      }
 else {
        String errorMessage="Exception while getting content for (sub)template " + elementName + ". "+ e;
        if (A_OpenCms.isLogging()) {
          A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + errorMessage);
        }
        throw new CmsException(errorMessage);
      }
    }
  }
  return result;
}

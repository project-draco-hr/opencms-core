{
  byte[] result=null;
  if (cms.getRequestContext().isElementCacheEnabled()) {
    CmsElementDefinitionCollection mergedElDefs=(CmsElementDefinitionCollection)parameters.get("_ELDEFS_");
    CmsElementVariant variant=xmlTemplateDocument.generateElementCacheVariant(this,parameters,elementName,templateSelector);
    CmsElementCache elementCache=cms.getRequestContext().getElementCache();
    CmsElementDescriptor elKey=new CmsElementDescriptor(getClass().getName(),xmlTemplateDocument.getAbsoluteFilename());
    A_CmsElement currElem=elementCache.getElementLocator().get(cms,elKey,parameters);
    if (currElem.getCacheDirectives().isInternalCacheable()) {
      Vector removedVar=currElem.addVariant(currElem.getCacheDirectives().getCacheKey(cms,parameters),variant);
      if ((removedVar != null) && currElem.hasDependenciesVariants()) {
        String key=(String)removedVar.firstElement();
        CmsElementVariant oldVar=(CmsElementVariant)removedVar.lastElement();
        Vector oldVarDeps=oldVar.getDependencies();
        if (oldVarDeps != null) {
          String oldVariantEntry=getClass().getName() + "|" + xmlTemplateDocument.getAbsoluteFilename()+ "|"+ key;
          for (int i=0; i < oldVarDeps.size(); i++) {
            Vector externEntrys=(Vector)cms.getVariantDependencies().get(oldVarDeps.elementAt(i));
            if (externEntrys != null) {
              externEntrys.removeElement(oldVariantEntry);
            }
          }
        }
      }
    }
    result=((CmsElementXml)currElem).resolveVariant(cms,variant,elementCache,mergedElDefs,elementName,parameters);
  }
 else {
    try {
      result=xmlTemplateDocument.getProcessedTemplateContent(this,parameters,templateSelector).getBytes();
    }
 catch (    Throwable e) {
      xmlTemplateDocument.removeFromFileCache();
      if (isCacheable(cms,xmlTemplateDocument.getAbsoluteFilename(),elementName,parameters,templateSelector)) {
        m_cache.clearCache(getKey(cms,xmlTemplateDocument.getAbsoluteFilename(),parameters,templateSelector));
      }
      if (e instanceof CmsException) {
        throw (CmsException)e;
      }
 else {
        String errorMessage="Exception while getting content for (sub)template " + elementName + ". "+ e;
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + errorMessage);
        }
        throw new CmsException(errorMessage);
      }
    }
  }
  if (templateSelector != null) {
    parameters.put(elementName + "._TEMPLATESELECTOR_",templateSelector);
  }
  return result;
}

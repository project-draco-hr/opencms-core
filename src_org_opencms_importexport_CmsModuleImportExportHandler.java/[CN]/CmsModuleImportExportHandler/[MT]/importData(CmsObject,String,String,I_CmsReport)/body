{
  CmsProject importProject=null;
  CmsProject previousProject=null;
  String moduleZipName=null;
  String modulePackageName=null;
  int underscore=-1;
  Map moduleInfo=null;
  CmsRegistry registry=null;
  String moduleType=null;
  Vector conflictFiles=null;
  try {
    previousProject=cms.getRequestContext().currentProject();
    try {
      cms.getRequestContext().saveSiteRoot();
      cms.getRequestContext().setSiteRoot("/");
      importProject=cms.createProject("ImportModule","A System generated project to import the module " + getModuleName(),OpenCms.getDefaultUsers().getGroupAdministrators(),OpenCms.getDefaultUsers().getGroupAdministrators(),I_CmsConstants.C_PROJECT_TYPE_TEMPORARY);
      cms.getRequestContext().setCurrentProject(importProject);
      cms.copyResourceToProject("/");
    }
  finally {
      cms.getRequestContext().restoreSiteRoot();
    }
    registry=cms.getRegistry();
    importFile=importFile.replace('\\','/');
    moduleZipName=importFile.substring(importFile.lastIndexOf('/') + 1);
    if (moduleZipName.toLowerCase().endsWith(".zip")) {
      modulePackageName=moduleZipName.substring(0,moduleZipName.lastIndexOf('.'));
      if ((underscore=modulePackageName.indexOf('_')) > 0) {
        modulePackageName=modulePackageName.substring(0,underscore);
      }
    }
 else {
      modulePackageName=moduleZipName;
    }
    moduleInfo=registry.importGetModuleInfo(importFile);
    moduleType=(String)moduleInfo.get("type");
    if (!CmsRegistry.C_MODULE_TYPE_SIMPLE.equals(moduleType)) {
      conflictFiles=registry.importGetConflictingFileNames(importFile);
      if (!conflictFiles.isEmpty()) {
        throw new CmsException("Import of " + modulePackageName + " has conflicts with existing resources: "+ conflictFiles.toString());
      }
    }
 else {
      conflictFiles=new Vector();
    }
    report.print(report.key("report.import_module_begin"),I_CmsReport.C_FORMAT_HEADLINE);
    if (report instanceof CmsHtmlReport) {
      report.println(" <i>" + modulePackageName + "</i>",I_CmsReport.C_FORMAT_HEADLINE);
    }
 else {
      report.println(" " + modulePackageName,I_CmsReport.C_FORMAT_HEADLINE);
    }
    registry.importModule(importFile,conflictFiles,report);
    report.println(report.key("report.publish_project_begin"),I_CmsReport.C_FORMAT_HEADLINE);
    cms.unlockProject(importProject.getId());
    cms.publishProject(report);
    report.println(report.key("report.publish_project_end"),I_CmsReport.C_FORMAT_HEADLINE);
    report.println(report.key("report.import_module_end"),I_CmsReport.C_FORMAT_HEADLINE);
  }
  finally {
    cms.getRequestContext().setCurrentProject(previousProject);
  }
}

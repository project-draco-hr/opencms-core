{
  String cmsframe=((((Hashtable)userObject).get("cmsframe")).equals("plain") ? "?cmsframe=plain" : "");
  String requestedUri=cms.getRequestContext().getUri();
  String currentFolder=cms.getRequestContext().currentFolder().getAbsolutePath();
  String servletPath=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getServletPath();
  CmsXmlTemplateFile xmlDataBlock=(CmsXmlTemplateFile)doc;
  StringBuffer result=new StringBuffer();
  int size=resources.size();
  String navLink[]=new String[size];
  String navText[]=new String[size];
  float navPos[]=new float[size];
  int max=extractNav(cms,resources,navLink,navText,navPos);
  if (xmlDataBlock.hasData("navEntry")) {
    if (!xmlDataBlock.hasData("navCurrent")) {
      xmlDataBlock.setData("navCurrent",xmlDataBlock.getDataValue("navEntry"));
    }
    for (int i=0; i < max; i++) {
      xmlDataBlock.setData("navText",navText[i]);
      xmlDataBlock.setData("count",new Integer(i + 1).toString());
      if (navLink[i].endsWith("/")) {
        String navIndex=cms.readProperty(navLink[i],C_PROPERTY_NAVINDEX);
        if (navIndex == null) {
          navIndex=C_NAVINDEX;
        }
        try {
          cms.readFile(navLink[i] + navIndex);
          xmlDataBlock.setData("navLink",servletPath + navLink[i] + navIndex+ cmsframe);
        }
 catch (        CmsException e) {
          xmlDataBlock.setData("navLink",servletPath + requestedUri);
        }
      }
 else {
        try {
          cms.readFile(navLink[i]);
          xmlDataBlock.setData("navLink",servletPath + navLink[i] + cmsframe);
        }
 catch (        CmsException e) {
          xmlDataBlock.setData("navLink",servletPath + requestedUri);
        }
      }
      if (navLink[i].equals(currentFolder) || navLink[i].equals(requestedUri)) {
        result.append(xmlDataBlock.getProcessedDataValue("navCurrent"));
      }
 else {
        result.append(xmlDataBlock.getProcessedDataValue("navEntry"));
      }
    }
  }
  return result.toString();
}

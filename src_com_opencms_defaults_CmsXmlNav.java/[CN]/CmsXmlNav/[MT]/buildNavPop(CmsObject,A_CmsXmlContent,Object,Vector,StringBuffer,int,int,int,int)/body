{
  String requestedUri=cms.getRequestContext().getUri();
  String currentFolder=cms.getRequestContext().currentFolder().getAbsolutePath();
  String servletPath=cms.getRequestContext().getRequest().getServletUrl();
  CmsXmlTemplateFile xmlDataBlock=(CmsXmlTemplateFile)doc;
  StringBuffer result=null;
  if (result2 == null) {
    result=new StringBuffer();
  }
 else {
    result=result2;
  }
  int size=resources.size();
  String navLink[]=new String[size];
  String navText[]=new String[size];
  float navPos[]=new float[size];
  int max=extractNav(cms,resources,navLink,navText,navPos);
  if (xmlDataBlock.hasData("navEntry")) {
    if (!xmlDataBlock.hasData("navCurrent")) {
      xmlDataBlock.setData("navCurrent",xmlDataBlock.getData("navEntry"));
    }
    xmlDataBlock.setData("menueLevel",iDirLevel + "");
    xmlDataBlock.setData("Level1Pos",lPos + 1 + "");
    xmlDataBlock.setData("Level2Pos",lPos2 + 1 + "");
    result.append(xmlDataBlock.getProcessedDataValue("navStart" + iDirLevel,this,userObject));
    boolean bHasSubFiles=false;
    for (int i=0; i < max; i++) {
      bHasSubFiles=false;
      if (navLink[i].endsWith("/") || navLink[i].endsWith("\\")) {
        Vector resources2=cms.getSubFolders(navLink[i]);
        Vector allFile2=cms.getFilesInFolder(navLink[i]);
        resources2.ensureCapacity(resources2.size() + allFile2.size());
        Enumeration e2=allFile2.elements();
        while (e2.hasMoreElements()) {
          resources2.addElement(e2.nextElement());
        }
        int size2=resources2.size();
        String navLink2[]=new String[size2];
        String navText2[]=new String[size2];
        float navPos2[]=new float[size2];
        if (extractNav(cms,resources2,navLink2,navText2,navPos2) > 0) {
          bHasSubFiles=true;
        }
      }
      xmlDataBlock.setData("navText",navText[i]);
      xmlDataBlock.setData("count",new Integer(i + 1).toString());
      xmlDataBlock.setData("level",new Integer(extractLevel(cms,navLink[i])).toString());
      if (navLink[i].endsWith("/")) {
        String navIndex=cms.readProperty(navLink[i],C_PROPERTY_NAVINDEX);
        if (navIndex == null) {
          navIndex=C_NAVINDEX;
        }
        try {
          cms.readFile(navLink[i] + navIndex);
          xmlDataBlock.setData("navLink",servletPath + navLink[i] + navIndex);
        }
 catch (        CmsException e) {
          xmlDataBlock.setData("navLink",servletPath + requestedUri);
        }
      }
 else {
        try {
          cms.readFile(navLink[i]);
          xmlDataBlock.setData("navLink",servletPath + navLink[i]);
        }
 catch (        CmsException e) {
          xmlDataBlock.setData("navLink",servletPath + requestedUri);
        }
      }
      xmlDataBlock.setData("data1",navLink[i]);
      xmlDataBlock.setData("data2",requestedUri);
      xmlDataBlock.setData("data3",currentFolder);
      String sFolder="";
      String sFolder2="";
      sFolder=navLink[i];
      if (currentFolder.length() >= sFolder.length()) {
        if (currentFolder.length() > sFolder.length()) {
          sFolder2=currentFolder.substring(0,sFolder.length());
        }
 else {
          sFolder2=currentFolder.substring(0);
        }
      }
      String sSubExten="";
      if (bHasSubFiles && iDirLevel < iMaxDeep) {
        sSubExten="ws";
      }
      if (sFolder2.equals(sFolder) || navLink[i].equals(currentFolder) || navLink[i].equals(requestedUri)) {
        result.append(xmlDataBlock.getProcessedDataValue("navCurrent" + iDirLevel + sSubExten,this,userObject));
      }
 else {
        result.append(xmlDataBlock.getProcessedDataValue("navEntry" + iDirLevel + sSubExten,this,userObject));
      }
    }
    result.append(xmlDataBlock.getProcessedDataValue("navEnd" + iDirLevel,this,userObject));
  }
  return result;
}

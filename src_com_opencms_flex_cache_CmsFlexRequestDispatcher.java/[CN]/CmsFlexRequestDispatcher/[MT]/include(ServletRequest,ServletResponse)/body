{
  if (DEBUG > 0)   System.err.println("FlexDispatcher: Include called with target=" + m_vfs_target + " (ext_target="+ m_ext_target+ ")");
  CmsFlexController controller=(CmsFlexController)req.getAttribute(CmsFlexController.ATTRIBUTE_NAME);
  CmsObject cms=controller.getCmsObject();
  if ((m_ext_target == null) && (controller != null)) {
    try {
      cms.readFileHeader(m_vfs_target);
    }
 catch (    CmsException e) {
      if (e.getType() == CmsException.C_NOT_FOUND) {
        m_ext_target=m_vfs_target;
      }
    }
  }
  if ((m_ext_target != null) || (controller == null)) {
    if (DEBUG > 0)     System.err.println("FlexDispatcher: Dispatching to external target " + m_ext_target);
    m_rd.include(req,res);
    return;
  }
  CmsFlexCache cache=controller.getCmsCache();
  CmsFlexRequest f_req=controller.getCurrentRequest();
  CmsFlexResponse f_res=controller.getCurrentResponse();
  if (f_req.containsIncludeCall(m_vfs_target)) {
    throw new ServletException("FlexDispatcher: Dectected inclusion loop for target " + m_vfs_target);
  }
 else {
    f_req.addInlucdeCall(m_vfs_target);
  }
  if (f_res.isSuspended())   return;
  f_res.setCmsIncludeMode(true);
  CmsFlexRequest w_req=new CmsFlexRequest((HttpServletRequest)req,controller,m_vfs_target);
  CmsFlexResponse w_res=new CmsFlexResponse((HttpServletResponse)res,controller);
  controller.pushRequest(w_req);
  controller.pushResponse(w_res);
  CmsFlexCacheEntry entry=null;
  if (f_req.isCacheable()) {
    entry=cache.get(w_req.getCmsCacheKey());
    if (entry != null) {
      try {
        if (DEBUG > 0)         System.err.println("FlexDispatcher: Loading file from cache for " + m_vfs_target);
        entry.service(w_req,w_res);
      }
 catch (      com.opencms.core.CmsException e) {
        throw new ServletException("FlexDispatcher: Error while loading file from cache for " + m_vfs_target + "\n"+ e,e);
      }
    }
 else {
      CmsFlexCacheKey res_key=cache.getKey(CmsFlexCacheKey.getKeyName(m_vfs_target,w_req.isOnline()));
      if (res_key != null) {
        w_res.setCmsCacheKey(res_key);
      }
 else {
        String cacheProperty=null;
        try {
          cacheProperty=cms.readProperty(m_vfs_target,com.opencms.flex.I_CmsResourceLoader.C_LOADER_CACHEPROPERTY);
          cache.putKey(w_res.setCmsCacheKey(m_vfs_target,cacheProperty,f_req.isOnline()));
        }
 catch (        com.opencms.core.CmsException e) {
          if (e.getType() == CmsException.C_FLEX_CACHE) {
            if (I_CmsLogChannels.C_LOGGING && A_OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INFO))             A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[FlexCache] Invalid cache key for external resource \"" + m_vfs_target + "\": "+ cacheProperty);
            cache.putKey(w_res.getCmsCacheKey());
          }
 else {
            throw new ServletException("FlexDispatcher: Error while loading cache properties for " + m_vfs_target + "\n"+ e,e);
          }
        }
        if (DEBUG > 1)         System.err.println("FlexDispatcher: Cache properties for file " + m_vfs_target + " are: "+ cacheProperty);
      }
    }
  }
  if (entry == null) {
    com.opencms.launcher.CmsLauncherManager manager=cms.getLauncherManager();
    com.opencms.flex.I_CmsResourceLoader loader=null;
    String variation=null;
    if (w_req.isCacheable())     variation=w_res.getCmsCacheKey().matchRequestKey(w_req.getCmsCacheKey());
    w_res.setCmsCachingRequired(variation != null);
    com.opencms.file.CmsResource resource=null;
    try {
      resource=cms.readFileHeader(m_vfs_target);
      int type=resource.getLauncherType();
      if (DEBUG > 0)       System.err.println("FlexDispatcher: Loading resource type " + type);
      loader=(com.opencms.flex.I_CmsResourceLoader)manager.getLauncher(type);
    }
 catch (    java.lang.ClassCastException e) {
      throw new ServletException("FlexDispatcher: CmsResourceLoader interface not implemented for cms resource " + m_vfs_target + "\n"+ e,e);
    }
catch (    com.opencms.core.CmsException e) {
      throw new ServletException("FlexDispatcher: Error while reading header for cms resource " + m_vfs_target + "\n"+ e,e);
    }
    if (DEBUG > 0)     System.err.println("FlexDispatcher: Internal call, loading file using loader.service() for " + m_vfs_target);
    loader.service(cms,resource,w_req,w_res);
    entry=w_res.processCacheEntry();
    if ((entry != null) && (variation != null) && w_req.isCacheable()) {
      cache.put(w_res.getCmsCacheKey(),entry,variation);
    }
  }
  if (f_res.hasIncludeList()) {
    java.util.Map headers=w_res.getHeaders();
    byte[] result=w_res.getWriterBytes();
    if (DEBUG > 3)     System.err.println("Non-display include call - Result of include is:\n" + new String(result));
    CmsFlexResponse.processHeaders(headers,f_res);
    f_res.addToIncludeResults(result);
  }
  f_res.setCmsIncludeMode(false);
  f_req.removeIncludeCall(m_vfs_target);
  controller.popRequest();
  controller.popResponse();
}

{
  HttpSession session;
  String user=null;
  String group=null;
  Integer project=null;
  String loginParameter;
  HttpServletRequest req=(HttpServletRequest)cmsReq.getOriginalRequest();
  HttpServletResponse res=(HttpServletResponse)cmsRes.getOriginalResponse();
  CmsObject cms=new CmsObject();
  try {
    cms.init(cmsReq,cmsRes,C_USER_GUEST,C_GROUP_GUEST,C_PROJECT_ONLINE_ID);
    loginParameter=cmsReq.getParameter("opencms");
    if (loginParameter != null) {
      if (req.getHeader("Authorization") == null) {
        if (loginParameter.equals("login")) {
          requestAuthorization(req,res);
        }
      }
    }
    session=req.getSession(false);
    if (session != null) {
      user=m_sessionStorage.getUserName(session.getId());
      if (user != null) {
        group=m_sessionStorage.getCurrentGroup(session.getId());
        project=m_sessionStorage.getCurrentProject(session.getId());
        cms.init(cmsReq,cmsRes,user,group,project.intValue());
      }
    }
 else {
      String auth=req.getHeader("Authorization");
      if (auth != null) {
        if (auth.toUpperCase().startsWith("BASIC ")) {
          String userpassEncoded=auth.substring(6);
          sun.misc.BASE64Decoder dec=new sun.misc.BASE64Decoder();
          String userstr=new String(dec.decodeBuffer(userpassEncoded));
          String username=null;
          String password=null;
          StringTokenizer st=new StringTokenizer(userstr,":");
          if (st.hasMoreTokens()) {
            username=st.nextToken();
          }
          if (st.hasMoreTokens()) {
            password=st.nextToken();
          }
          try {
            user=cms.loginUser(username,password);
            session=req.getSession(true);
            OpenCmsServletNotify notify=new OpenCmsServletNotify(session.getId(),m_sessionStorage);
            session.putValue("NOTIFY",notify);
          }
 catch (          CmsException e) {
            if (e.getType() == CmsException.C_NO_ACCESS) {
              requestAuthorization(req,res);
            }
 else {
              throw e;
            }
          }
        }
      }
    }
  }
 catch (  CmsException e) {
    errorHandling(cms,cmsReq,cmsRes,e);
  }
  return cms;
}

{
  CmsFlexController controller=(CmsFlexController)req.getAttribute(CmsFlexController.ATTRIBUTE_NAME);
  CmsFlexController oldController=null;
  if (controller != null) {
    oldController=controller;
  }
  byte[] result=null;
  try {
    controller=new CmsFlexController(cms,file,m_cache,req,res);
    req.setAttribute(CmsFlexController.ATTRIBUTE_NAME,controller);
    CmsFlexRequest f_req=new CmsFlexRequest(req,controller);
    CmsFlexResponse f_res=new CmsFlexResponse(res,controller,false,false);
    controller.pushRequest(f_req);
    controller.pushResponse(f_res);
    try {
      f_req.getRequestDispatcher(cms.readAbsolutePath(file)).include(f_req,f_res);
    }
 catch (    java.net.SocketException e) {
    }
    if (!f_res.isSuspended()) {
      if (!res.isCommitted() || m_errorPagesAreNotCommited) {
        result=f_res.getWriterBytes();
        result=CmsEncoder.changeEncoding(result,OpenCms.getSystemInfo().getDefaultEncoding(),cms.getRequestContext().getEncoding());
      }
    }
    req.removeAttribute(CmsFlexController.ATTRIBUTE_NAME);
  }
  finally {
    if (oldController != null) {
      try {
        oldController.updateDateLastModified(controller.getDateLastModified());
      }
 catch (      Throwable t) {
        OpenCms.getLog(this).error("Could not access modification date from controller",t);
      }
      req.setAttribute(CmsFlexController.ATTRIBUTE_NAME,oldController);
    }
  }
  return result;
}

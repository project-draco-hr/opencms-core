{
  CmsObject cms=controller.getCmsObject();
  String oldSiteRoot=cms.getRequestContext().getSiteRoot();
  try {
    cms.getRequestContext().setSiteRoot("");
    String jspVfsName=cms.getSitePath(resource);
    String extension;
    boolean isHardInclude;
    if ((resource.getLoaderId() == CmsJspLoader.C_RESOURCE_LOADER_ID) && (!jspVfsName.endsWith(C_JSP_EXTENSION))) {
      extension=C_JSP_EXTENSION;
      isHardInclude=false;
    }
 else {
      extension="";
      isHardInclude=(resource.getLoaderId() != CmsJspLoader.C_RESOURCE_LOADER_ID);
    }
    String jspTargetName=getJspUri(m_jspWebAppRepository,jspVfsName + extension,controller.getCurrentRequest().isOnline());
    if (updates.contains(jspTargetName)) {
      return jspTargetName;
    }
    updates.add(jspTargetName);
    String jspPath=getJspUri(m_jspRepository,jspVfsName + extension,controller.getCurrentRequest().isOnline());
    File d=new File(jspPath).getParentFile();
    if ((d == null) || (d.exists() && !(d.isDirectory() && d.canRead()))) {
      if (OpenCms.getLog(this).isErrorEnabled()) {
        OpenCms.getLog(this).error("Could not access directory for " + jspPath);
      }
      throw new ServletException("JspLoader: Could not access directory for " + jspPath);
    }
    if (!d.exists()) {
      d.mkdirs();
    }
    boolean mustUpdate=false;
    File f=new File(jspPath);
    if (!f.exists()) {
      mustUpdate=true;
    }
 else     if (f.lastModified() <= resource.getDateLastModified()) {
      mustUpdate=true;
    }
 else     if (controller.getCurrentRequest().isDoRecompile()) {
      mustUpdate=true;
    }
    if (mustUpdate) {
      if (OpenCms.getLog(this).isDebugEnabled()) {
        OpenCms.getLog(this).debug("JspLoader: Writing JSP file '" + jspTargetName + "'");
      }
      byte[] contents;
      String encoding;
      try {
        contents=CmsFile.upgrade(resource,cms).getContents();
        encoding=cms.readPropertyObject(jspVfsName,I_CmsConstants.C_PROPERTY_CONTENT_ENCODING,false).getValue(C_DEFAULT_JSP_ENCODING);
        encoding=CmsEncoder.lookupEncoding(encoding.trim(),encoding);
      }
 catch (      CmsException e) {
        controller.setThrowable(e,jspVfsName);
        throw new ServletException("JspLoader: Could not access JSP file '" + jspVfsName + "'",e);
      }
      try {
        contents=parseJsp(contents,encoding,controller,updates,isHardInclude);
        FileOutputStream fs=new FileOutputStream(f);
        fs.write(contents);
        fs.close();
        contents=null;
        if (OpenCms.getLog(this).isInfoEnabled()) {
          OpenCms.getLog(this).info("Updated JSP file \"" + jspTargetName + "\" for resource \""+ cms.getSitePath(resource)+ "\"");
        }
      }
 catch (      FileNotFoundException e) {
        throw new ServletException("JspLoader: Could not write to file '" + f.getName() + "'\n"+ e,e);
      }
    }
    controller.updateDates(f.lastModified(),CmsResource.DATE_EXPIRED_DEFAULT);
    return jspTargetName;
  }
  finally {
    cms.getRequestContext().setSiteRoot(oldSiteRoot);
  }
}

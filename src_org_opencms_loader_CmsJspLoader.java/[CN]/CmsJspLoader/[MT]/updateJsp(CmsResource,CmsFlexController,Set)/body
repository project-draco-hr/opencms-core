{
  CmsObject cms=controller.getCmsObject();
  String oldSiteRoot=cms.getRequestContext().getSiteRoot();
  try {
    cms.getRequestContext().setSiteRoot("");
    String jspVfsName=cms.getSitePath(resource);
    String extension;
    boolean isHardInclude;
    int loaderId=OpenCms.getResourceManager().getResourceType(resource.getTypeId()).getLoaderId();
    if ((loaderId == CmsJspLoader.C_RESOURCE_LOADER_ID) && (!jspVfsName.endsWith(C_JSP_EXTENSION))) {
      extension=C_JSP_EXTENSION;
      isHardInclude=false;
    }
 else {
      extension="";
      isHardInclude=(loaderId != CmsJspLoader.C_RESOURCE_LOADER_ID);
    }
    String jspTargetName=getJspUri(m_jspWebAppRepository,jspVfsName + extension,controller.getCurrentRequest().isOnline());
    if (updates.contains(jspTargetName)) {
      return jspTargetName;
    }
    updates.add(jspTargetName);
    String jspPath=getJspUri(m_jspRepository,jspVfsName + extension,controller.getCurrentRequest().isOnline());
    File d=new File(jspPath).getParentFile();
    if ((d == null) || (d.exists() && !(d.isDirectory() && d.canRead()))) {
      CmsMessageContainer message=Messages.get().container(Messages.LOG_ACCESS_DENIED_1,jspPath);
      LOG.error(message.key());
      throw new ServletException(message.key());
    }
    if (!d.exists()) {
      d.mkdirs();
    }
    boolean mustUpdate=false;
    File f=new File(jspPath);
    if (!f.exists()) {
      mustUpdate=true;
    }
 else     if (f.lastModified() <= resource.getDateLastModified()) {
      mustUpdate=true;
    }
 else     if (controller.getCurrentRequest().isDoRecompile()) {
      mustUpdate=true;
    }
    if (mustUpdate) {
      if (LOG.isDebugEnabled()) {
        LOG.debug(Messages.get().key(Messages.LOG_WRITING_JSP_1,jspTargetName));
      }
      byte[] contents;
      String encoding;
      try {
        contents=CmsFile.upgrade(resource,cms).getContents();
        encoding=cms.readPropertyObject(resource,CmsPropertyDefinition.PROPERTY_CONTENT_ENCODING,true).getValue();
        if (encoding == null) {
          encoding=OpenCms.getSystemInfo().getDefaultEncoding();
        }
 else {
          encoding=CmsEncoder.lookupEncoding(encoding.trim(),encoding);
        }
      }
 catch (      CmsException e) {
        controller.setThrowable(e,jspVfsName);
        throw new ServletException(Messages.get().key(Messages.ERR_LOADER_JSP_ACCESS_1,jspVfsName),e);
      }
      try {
        contents=parseJsp(contents,encoding,controller,updates,isHardInclude);
        FileOutputStream fs=new FileOutputStream(f);
        fs.write(contents);
        fs.close();
        contents=null;
        if (LOG.isInfoEnabled()) {
          LOG.info(Messages.get().key(Messages.LOG_UPDATED_JSP_2,jspTargetName,cms.getSitePath(resource)));
        }
      }
 catch (      FileNotFoundException e) {
        throw new ServletException(Messages.get().key(Messages.ERR_LOADER_JSP_WRITE_1,f.getName()),e);
      }
    }
    controller.updateDates(f.lastModified(),CmsResource.DATE_EXPIRED_DEFAULT);
    return jspTargetName;
  }
  finally {
    cms.getRequestContext().setSiteRoot(oldSiteRoot);
  }
}

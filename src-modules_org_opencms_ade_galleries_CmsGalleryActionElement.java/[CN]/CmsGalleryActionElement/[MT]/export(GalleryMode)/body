{
  CmsGalleryService galleryService=CmsGalleryService.newInstance(getRequest(),galleryMode);
  CmsGalleryDataBean data=galleryService.getInitialSettings();
  CmsGallerySearchBean search=null;
  if (GalleryTabId.cms_tab_results.equals(data.getStartTab())) {
    search=galleryService.getSearch(data);
  }
  StringBuffer sb=new StringBuffer();
  sb.append(ClientMessages.get().export(getRequest()));
  sb.append(CmsGalleryDataBean.DICT_NAME).append("='");
  sb.append(serialize(I_CmsGalleryService.class.getMethod("getInitialSettings"),data));
  sb.append("';");
  sb.append(CmsGallerySearchBean.DICT_NAME).append("='").append(serialize(I_CmsGalleryService.class.getMethod("getSearch",CmsGalleryDataBean.class),search));
  sb.append("';");
  wrapScript(sb);
  if (galleryMode == GalleryMode.editor) {
    sb.append(SCRIPT_TAG_OPEN).append(link("/system/workplace/resources/editors/fckeditor/editor/dialog/common/fck_dialog_common.js"));
    sb.append(SCRIPT_TAG_CLOSE);
  }
  for (  I_CmsPreviewProvider provider : galleryService.getPreviewProvider()) {
    sb.append(provider.getPreviewInclude(getCmsObject(),getRequest(),getResponse()));
  }
  return sb.toString();
}

{
  String errorMsgSuffix="";
  String newResname="";
  try {
    if (CmsStringUtil.isNotEmpty(getParamCsvContent())) {
      newResname="csvcontent.html";
      setParamNewResourceName("");
    }
 else {
      try {
        setParamCsvContent(new String(getFileContentFromUpload(),CHARSET));
        newResname=getCms().getRequestContext().getFileTranslator().translateResource(CmsResource.getName(getParamResource().replace('\\','/')));
        newResname=CmsStringUtil.changeFileNameSuffixTo(newResname,"html");
        setParamNewResourceName(newResname);
      }
 catch (      UnsupportedEncodingException e) {
      }
catch (      CmsException e) {
        errorMsgSuffix="size";
        throw e;
      }
catch (      FileNotFoundException e) {
        throw new CmsException(e.getMessage());
      }
    }
    setParamResource(newResname);
    setParamResource(computeFullResourceName());
    int resTypeId=OpenCms.getResourceManager().getDefaultTypeForName(newResname).getTypeId();
    String xmlContent="";
    CmsProperty styleProp=CmsProperty.getNullProperty();
    if (TABULATOR.equals(getParamDelimiter())) {
      setParamDelimiter("\t");
    }
 else     if (BEST_DELIMITER.equals(getParamDelimiter())) {
      setParamDelimiter(getPreferredDelimiter(getParamCsvContent()));
    }
    xmlContent=convertCsvToXml(getParamCsvContent(),getParamDelimiter());
    if (CmsStringUtil.isNotEmpty(getParamXsltFile())) {
      xmlContent=applyXslTransformation(getParamXsltFile(),xmlContent);
      styleProp=getCms().readPropertyObject(getParamXsltFile(),I_CmsConstants.C_PROPERTY_STYLESHEET,true);
    }
    byte[] content=xmlContent.getBytes();
    try {
      getCms().createResource(getParamResource(),resTypeId,content,Collections.EMPTY_LIST);
    }
 catch (    CmsException e) {
      getCms().lockResource(getParamResource());
      getCms().replaceResource(getParamResource(),resTypeId,content,null);
    }
    if (!styleProp.isNullProperty()) {
      getCms().writePropertyObject(getParamResource(),styleProp);
    }
  }
 catch (  Exception e) {
    setAction(ACTION_SHOWERROR);
    getJsp().getRequest().setAttribute(C_SESSION_WORKPLACE_CLASS,this);
    setParamErrorstack(CmsException.getStackTraceAsString(e));
    setParamMessage(key("error.message.upload"));
    setParamReasonSuggestion(key("error.reason.upload" + errorMsgSuffix) + "<br>\n" + key("error.suggestion.upload" + errorMsgSuffix)+ "\n");
    getJsp().include(C_FILE_DIALOG_SCREEN_ERROR);
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error(e);
    }
  }
}

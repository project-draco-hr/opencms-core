{
  if (isOnlineProject(cms)) {
    throw new CmsSecurityException("Can't delete from the online project",CmsSecurityException.C_SECURITY_NO_MODIFY_IN_ONLINE_PROJECT);
  }
  if (dataset.m_versionId != I_CmsConstants.C_UNKNOWN_ID) {
    throw new CmsSecurityException("Can't delete a backup cd",CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
  readLockstate(dataset,content.getSubId());
  if ((!dataset.m_lockedBy.equals(cms.getRequestContext().currentUser().getId()))) {
    throw new CmsSecurityException("Not locked by this user",CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
  if (dataset.m_lockedInProject != dataset.m_projectId) {
    throw new CmsSecurityException("Not locked in this project",CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
  if (!content.isWriteable()) {
    throw new CmsSecurityException("Not writeable",CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
  if (dataset.m_state == I_CmsConstants.C_STATE_NEW) {
    String statement_key="delete_offline";
    PreparedStatement stmt=null;
    Connection conn=null;
    try {
      conn=m_sqlManager.getConnection();
      stmt=m_sqlManager.getPreparedStatement(conn,statement_key);
      stmt.setString(1,dataset.m_masterId.toString());
      stmt.setInt(2,content.getSubId());
      if (stmt.executeUpdate() != 1) {
        throw new CmsException("Row not found: " + dataset.m_masterId + " "+ content.getSubId(),CmsException.C_NOT_FOUND);
      }
      deleteAllMedia(dataset.m_masterId);
      deleteAllChannels(dataset.m_masterId);
    }
 catch (    SQLException exc) {
      throw new CmsException(CmsException.C_SQL_ERROR,exc);
    }
 finally {
      m_sqlManager.closeAll(conn,stmt,null);
    }
  }
 else {
    dataset.m_state=I_CmsConstants.C_STATE_DELETED;
    dataset.m_lockedBy=CmsUUID.getNullUUID();
    PreparedStatement stmt=null;
    Connection conn=null;
    try {
      conn=m_sqlManager.getConnection();
      stmt=m_sqlManager.getPreparedStatement(conn,"update_offline");
      int rowcounter=sqlFillValues(stmt,content.getSubId(),dataset);
      stmt.setString(rowcounter++,dataset.m_masterId.toString());
      stmt.setInt(rowcounter++,content.getSubId());
      stmt.executeUpdate();
    }
 catch (    SQLException exc) {
      throw new CmsException(CmsException.C_SQL_ERROR,exc);
    }
 finally {
      m_sqlManager.closeAll(conn,stmt,null);
    }
  }
}

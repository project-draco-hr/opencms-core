{
  Vector propertyDef=getPropertyDefinitions();
  boolean useTempfileProject="true".equals(getParamUsetempfileproject());
  try {
    if (useTempfileProject) {
      switchToTempProject();
    }
    Map activeProperties=getPropertyMap(getCms().readPropertyObjects(getParamResource(),false));
    int activeTab=getActiveTab();
    List propertiesToWrite=new ArrayList();
    for (int i=0; i < propertyDef.size(); i++) {
      CmsPropertydefinition curPropDef=(CmsPropertydefinition)propertyDef.elementAt(i);
      String propName=CmsEncoder.escapeXml(curPropDef.getName());
      String valueStructure=null;
      String valueResource=null;
      if (activeTab == 1) {
        valueStructure=request.getParameter(PREFIX_VALUE + propName);
        valueResource=request.getParameter(PREFIX_RESOURCE + propName);
        if (valueStructure != null && !"".equals(valueStructure.trim()) && valueStructure.equals(valueResource)) {
          valueStructure="";
        }
      }
 else {
        valueStructure=request.getParameter(PREFIX_STRUCTURE + propName);
        valueResource=request.getParameter(PREFIX_VALUE + propName);
      }
      if (valueStructure != null) {
        valueStructure=valueStructure.trim();
      }
      if (valueResource != null) {
        valueResource=valueResource.trim();
      }
      CmsProperty newProperty=new CmsProperty();
      newProperty.setKey(curPropDef.getName());
      newProperty.setStructureValue(valueStructure);
      newProperty.setResourceValue(valueResource);
      CmsProperty oldProperty=(CmsProperty)activeProperties.get(curPropDef.getName());
      if (oldProperty == null) {
        oldProperty=new CmsProperty();
        oldProperty.setKey(curPropDef.getName());
      }
      boolean writeStructureValue=false;
      boolean writeResourceValue=false;
      String oldValue=oldProperty.getStructureValue();
      String newValue=newProperty.getStructureValue().trim();
      writeStructureValue=(oldValue != null && newProperty.deleteStructureValue());
      writeStructureValue|=!newValue.equals(oldValue) && !"".equalsIgnoreCase(newValue) && !CmsProperty.C_DELETE_VALUE.equalsIgnoreCase(newValue);
      if (!writeStructureValue) {
        newProperty.setStructureValue(null);
      }
      oldValue=oldProperty.getResourceValue();
      newValue=newProperty.getResourceValue().trim();
      writeResourceValue=(oldValue != null && newProperty.deleteStructureValue());
      writeResourceValue|=!newValue.equals(oldValue) && !"".equalsIgnoreCase(newValue) && !CmsProperty.C_DELETE_VALUE.equalsIgnoreCase(newValue);
      if (!writeResourceValue) {
        newProperty.setResourceValue(null);
      }
      if (writeStructureValue || writeResourceValue) {
        propertiesToWrite.add(newProperty);
      }
    }
    if (propertiesToWrite.size() > 0) {
      checkLock(getParamResource());
      CmsResource resource=getCms().readFileHeader(getParamResource());
      if (resource.isFolder() && !getParamResource().endsWith("/")) {
        setParamResource(getParamResource() + "/");
      }
      getCms().writePropertyObjects(getParamResource(),propertiesToWrite);
    }
  }
  finally {
    if (useTempfileProject) {
      switchToCurrentProject();
    }
  }
  return true;
}

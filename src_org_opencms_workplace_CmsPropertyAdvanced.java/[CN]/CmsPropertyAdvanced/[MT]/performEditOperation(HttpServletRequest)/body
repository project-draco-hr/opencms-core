{
  Vector propertyDef=getPropertyDefinitions();
  boolean useTempfileProject="true".equals(getParamUsetempfileproject());
  try {
    if (useTempfileProject) {
      switchToTempProject();
    }
    Map activeProperties=getPropertyMap(getCms().readPropertyObjects(getParamResource(),false));
    int activeTab=getActiveTab();
    List propertiesToWrite=new ArrayList();
    for (int i=0; i < propertyDef.size(); i++) {
      CmsPropertydefinition curPropDef=(CmsPropertydefinition)propertyDef.elementAt(i);
      String propName=CmsEncoder.escapeXml(curPropDef.getName());
      String valueStructure="";
      String valueResource="";
      if (activeTab == 1) {
        valueStructure=request.getParameter(PREFIX_VALUE + propName);
        valueResource=request.getParameter(PREFIX_RESOURCE + propName);
        if (valueStructure != null && !"".equals(valueStructure.trim()) && valueStructure.equals(valueResource)) {
          valueStructure="";
        }
      }
 else {
        valueStructure=request.getParameter(PREFIX_STRUCTURE + propName);
        valueResource=request.getParameter(PREFIX_VALUE + propName);
      }
      if (valueStructure != null) {
        valueStructure=valueStructure.trim();
      }
 else {
        valueStructure="";
      }
      if (valueResource != null) {
        valueResource=valueResource.trim();
      }
 else {
        valueResource="";
      }
      CmsProperty newProperty=new CmsProperty();
      newProperty.setKey(curPropDef.getName());
      newProperty.setStructureValue(valueStructure);
      newProperty.setResourceValue(valueResource);
      CmsProperty oldProperty=(CmsProperty)activeProperties.get(curPropDef.getName());
      if (oldProperty == null) {
        oldProperty=new CmsProperty();
        oldProperty.setKey(curPropDef.getName());
      }
      if (oldProperty.getStructureValue() == null) {
        oldProperty.setStructureValue("");
      }
      if (oldProperty.getResourceValue() == null) {
        oldProperty.setResourceValue("");
      }
      if (!newProperty.equals(oldProperty)) {
        propertiesToWrite.add(newProperty);
      }
    }
    if (propertiesToWrite.size() > 0) {
      checkLock(getParamResource());
      CmsResource resource=getCms().readFileHeader(getParamResource());
      if (resource.isFolder() && !getParamResource().endsWith("/")) {
        setParamResource(getParamResource() + "/");
      }
      getCms().writePropertyObjects(getParamResource(),propertiesToWrite);
    }
  }
  finally {
    if (useTempfileProject) {
      switchToCurrentProject();
    }
  }
  return true;
}

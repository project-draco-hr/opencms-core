{
  long timer1=0;
  if (DEBUG > 0) {
    timer1=System.currentTimeMillis();
    System.err.println("========== JspLoader loading: " + file.getAbsolutePath());
  }
  boolean streaming=false;
  boolean bypass=false;
  try {
    String stream=cms.readProperty(file.getAbsolutePath(),I_CmsResourceLoader.C_LOADER_STREAMPROPERTY);
    if (stream != null) {
      if ("yes".equalsIgnoreCase(stream) || "true".equalsIgnoreCase(stream)) {
        streaming=true;
      }
 else       if ("bypass".equalsIgnoreCase(stream) || "bypasscache".equalsIgnoreCase(stream)) {
        bypass=true;
      }
    }
  }
 catch (  CmsException e) {
    throw new CmsException("FlexJspLoader: Error while loading stream properties for " + file.getAbsolutePath() + "\n"+ e,e);
  }
  if (DEBUG > 1)   System.err.println("========== JspLoader stream=" + streaming + " bypass="+ bypass);
  CmsFlexRequest w_req;
  CmsFlexResponse w_res;
  if (req instanceof CmsFlexRequest) {
    w_req=(CmsFlexRequest)req;
  }
 else {
    w_req=new CmsFlexRequest(req,file,m_cache,cms);
  }
  if (res instanceof CmsFlexResponse) {
    w_res=(CmsFlexResponse)res;
  }
 else {
    w_res=new CmsFlexResponse(res,streaming);
  }
  if (bypass) {
    if (DEBUG > 1)     System.err.println("JspLoader.load() bypassing cache for file " + file.getAbsolutePath());
    String target=updateJsp(cms,file,w_req,new HashSet(11));
    try {
      req.getRequestDispatcher(target).forward(w_req,res);
    }
 catch (    Exception e) {
      System.err.println("Error in CmsJspLoader.load(): " + e.toString());
      System.err.println(com.opencms.util.Utils.getStackTrace(e));
      throw new CmsException("Error in CmsJspLoader.load() with bypasscache:\n" + e,CmsException.C_FLEX_LOADER,e);
    }
  }
  if (!bypass) {
    try {
      w_req.getCmsRequestDispatcher(file.getAbsolutePath()).include(w_req,w_res);
    }
 catch (    java.net.SocketException e) {
      if (DEBUG > 1)       System.err.println("JspLoader.load() ignoring SocketException " + e);
    }
catch (    Exception e) {
      System.err.println("Error in CmsJspLoader.load() while loading: " + e.toString());
      System.err.println(com.opencms.util.Utils.getStackTrace(e));
      throw new CmsException("Error in CmsJspLoader.load() while loading " + file.getAbsolutePath() + "\n"+ e,CmsException.C_LAUNCH_ERROR,e);
    }
    if (!streaming && !w_res.isSuspended()) {
      try {
        if (!res.isCommitted()) {
          byte[] result=w_res.getWriterBytes();
          res.setContentLength(result.length);
          w_res.processHeaders(w_res.getHeaders(),res);
          res.getOutputStream().write(result);
          res.getOutputStream().flush();
        }
      }
 catch (      IllegalStateException e) {
        if (DEBUG > 1)         System.err.println("JspLoader.load() ignoring IllegalStateException " + e);
      }
catch (      java.net.SocketException e) {
        if (DEBUG > 1)         System.err.println("JspLoader.load() ignoring SocketException " + e);
      }
catch (      Exception e) {
        System.err.println("Error in CmsJspLoader.load() while writing buffer to final stream: " + e.toString());
        System.err.println(com.opencms.util.Utils.getStackTrace(e));
        throw new CmsException("Error in CmsJspLoader.load() while writing buffer to final stream for " + file.getAbsolutePath() + "\n"+ e,CmsException.C_LAUNCH_ERROR,e);
      }
    }
  }
 else {
    if (DEBUG > 1)     System.err.println("JspLoader.load() cache was bypassed!");
  }
  if (DEBUG > 0) {
    long timer2=System.currentTimeMillis() - timer1;
    System.err.println("========== JspLoader time delivering JSP for " + file.getAbsolutePath() + ": "+ timer2+ "ms");
  }
}

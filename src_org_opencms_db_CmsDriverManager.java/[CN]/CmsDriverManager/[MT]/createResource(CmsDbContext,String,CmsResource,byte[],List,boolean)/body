{
  CmsResource newResource=null;
  try {
    boolean useLostAndFound=importCase && !OpenCms.getImportExportManager().overwriteCollidingResources();
    CmsResource currentResource=null;
    try {
      currentResource=readResource(dbc,resourcePath,CmsResourceFilter.ALL);
    }
 catch (    CmsVfsResourceNotFoundException e) {
    }
    CmsResource parentFolder;
    String parentFolderName;
    String createdResourceName=resourcePath;
    int contentLength;
    if (currentResource != null) {
      if (currentResource.getState() == I_CmsConstants.C_STATE_DELETED) {
        if (!currentResource.isFolder()) {
          currentResource=null;
        }
      }
 else {
        if (!importCase) {
          throw new CmsVfsException("Resource '" + dbc.removeSiteRoot(resourcePath) + "' already exists",CmsVfsException.C_VFS_RESOURCE_ALREADY_EXISTS);
        }
        if (!resource.isFolder() && useLostAndFound && (!currentResource.getResourceId().equals(resource.getResourceId()))) {
          createdResourceName=moveToLostAndFound(dbc,resourcePath,false);
          currentResource=null;
        }
      }
    }
    parentFolderName=CmsResource.getParentFolder(createdResourceName);
    parentFolder=readFolder(dbc,parentFolderName,CmsResourceFilter.IGNORE_EXPIRATION);
    if (currentResource == null) {
      m_securityManager.checkPermissions(dbc,parentFolder,CmsPermissionSet.ACCESS_WRITE,false,CmsResourceFilter.IGNORE_EXPIRATION);
    }
 else {
      m_securityManager.checkPermissions(dbc,currentResource,CmsPermissionSet.ACCESS_WRITE,!importCase,CmsResourceFilter.ALL);
    }
    String targetName=CmsResource.getName(createdResourceName);
    if (resource.isFolder()) {
      contentLength=-1;
      if (targetName.charAt(targetName.length() - 1) == '/') {
        targetName=targetName.substring(0,targetName.length() - 1);
      }
    }
 else {
      if (content != null) {
        contentLength=content.length;
      }
 else       if (currentResource != null) {
        contentLength=currentResource.getLength();
      }
 else {
        contentLength=resource.getLength();
      }
    }
    validFilename(targetName);
    CmsUUID structureId;
    CmsUUID resourceId;
    if (currentResource != null) {
      structureId=currentResource.getStructureId();
      resourceId=currentResource.getResourceId();
    }
 else {
      structureId=new CmsUUID();
      if (!resource.getResourceId().isNullUUID()) {
        resourceId=resource.getResourceId();
      }
 else {
        resourceId=new CmsUUID();
      }
    }
    newResource=new CmsResource(structureId,resourceId,createdResourceName,resource.getTypeId(),resource.isFolder(),resource.getFlags(),dbc.currentProject().getId(),resource.getState(),resource.getDateCreated(),resource.getUserCreated(),resource.getDateLastModified(),resource.getUserLastModified(),resource.getDateReleased(),resource.getDateExpired(),1,contentLength);
    if (resource.isTouched()) {
      newResource.setDateLastModified(resource.getDateLastModified());
    }
    if (resource.isFile()) {
      if (labelResource(dbc,resource,resourcePath,2)) {
        int flags=resource.getFlags();
        flags|=I_CmsConstants.C_RESOURCEFLAG_LABELLINK;
        resource.setFlags(flags);
      }
      if (content == null) {
        newResource.setState(I_CmsConstants.C_STATE_KEEP);
      }
    }
    if (currentResource == null) {
      newResource=m_vfsDriver.createResource(dbc,dbc.currentProject(),newResource,content);
    }
 else {
      int updateStates=(currentResource.getState() == I_CmsConstants.C_STATE_NEW) ? CmsDriverManager.C_NOTHING_CHANGED : CmsDriverManager.C_UPDATE_ALL;
      m_vfsDriver.writeResource(dbc,dbc.currentProject(),newResource,updateStates);
      if ((content != null) && resource.isFile()) {
        m_vfsDriver.writeContent(dbc,dbc.currentProject(),currentResource.getResourceId(),content);
      }
    }
    writePropertyObjects(dbc,newResource,properties);
    lockResource(dbc,newResource,CmsLock.C_MODE_COMMON);
  }
  finally {
    clearAccessControlListCache();
    m_propertyCache.clear();
    if (newResource != null) {
      OpenCms.fireCmsEvent(new CmsEvent(I_CmsEventListener.EVENT_RESOURCE_CREATED,Collections.singletonMap("resource",newResource)));
    }
  }
  return newResource;
}

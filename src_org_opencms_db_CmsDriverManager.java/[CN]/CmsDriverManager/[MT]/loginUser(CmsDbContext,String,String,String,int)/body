{
  CmsUser newUser;
  try {
    newUser=m_userDriver.readUser(dbc,username,password,remoteAddress,userType);
  }
 catch (  Throwable t) {
    throw new CmsSecurityException(Messages.get().container(org.opencms.security.Messages.ERR_SECURITY_LOGIN_FAILED_1,username),t);
  }
  if (newUser.getFlags() != I_CmsConstants.C_FLAG_ENABLED) {
    throw new CmsAuthentificationException(Messages.get().container(Messages.ERR_LOGIN_USER_DISABLED_1,username));
  }
  newUser.setLastlogin(System.currentTimeMillis());
  try {
    m_userDriver.writeUser(dbc,newUser);
  }
 catch (  Throwable t) {
    throw new CmsSecurityException(CmsSecurityException.C_SECURITY_LOGIN_FAILED,t);
  }
  putUserInCache(newUser);
  m_accessControlListCache.clear();
  m_groupCache.clear();
  m_userGroupsCache.clear();
  m_resourceListCache.clear();
  m_securityManager.clearPermissionCache();
  return newUser;
}

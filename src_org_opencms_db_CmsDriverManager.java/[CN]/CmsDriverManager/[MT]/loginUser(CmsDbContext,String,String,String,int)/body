{
  CmsUser newUser;
  try {
    newUser=m_userDriver.readUser(dbc,userName,password,remoteAddress,userType);
  }
 catch (  CmsDbEntryNotFoundException e) {
    boolean userExists=true;
    try {
      readUser(dbc,userName,userType);
    }
 catch (    CmsDataAccessException e2) {
      userExists=false;
    }
    if (userExists) {
      if (dbc.currentUser().isGuestUser()) {
        m_invalidLoginStorage.addInvalidLogin(userName,userType,remoteAddress);
      }
      throw new CmsAuthentificationException(org.opencms.security.Messages.get().container(org.opencms.security.Messages.ERR_LOGIN_FAILED_3,userName,new Integer(userType),remoteAddress),e);
    }
 else {
      throw new CmsAuthentificationException(org.opencms.security.Messages.get().container(org.opencms.security.Messages.ERR_LOGIN_FAILED_NO_USER_3,userName,new Integer(userType),remoteAddress),e);
    }
  }
  if (newUser.getFlags() != I_CmsConstants.C_FLAG_ENABLED) {
    throw new CmsAuthentificationException(org.opencms.security.Messages.get().container(org.opencms.security.Messages.ERR_LOGIN_FAILED_DISABLED_3,userName,new Integer(userType),remoteAddress));
  }
  if (dbc.currentUser().isGuestUser()) {
    m_invalidLoginStorage.checkInvalidLogins(userName,userType,remoteAddress);
    m_invalidLoginStorage.removeInvalidLogins(userName,userType,remoteAddress);
  }
  newUser.setLastlogin(System.currentTimeMillis());
  m_userDriver.writeUser(dbc,newUser);
  putUserInCache(newUser);
  m_accessControlListCache.clear();
  m_groupCache.clear();
  m_userGroupsCache.clear();
  m_resourceListCache.clear();
  m_securityManager.clearPermissionCache();
  return newUser;
}

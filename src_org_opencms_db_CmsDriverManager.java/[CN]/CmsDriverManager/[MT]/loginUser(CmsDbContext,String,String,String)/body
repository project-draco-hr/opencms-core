{
  if (CmsStringUtil.isEmptyOrWhitespaceOnly(password)) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_USER_1,userName));
  }
  CmsUser newUser;
  try {
    newUser=m_userDriver.readUser(dbc,userName,password,remoteAddress);
  }
 catch (  CmsDbEntryNotFoundException e) {
    CmsUser user=null;
    try {
      user=readUser(dbc,userName);
    }
 catch (    CmsDataAccessException e2) {
    }
    if (user != null) {
      if (dbc.currentUser().isGuestUser()) {
        OpenCms.getLoginManager().addInvalidLogin(userName,remoteAddress);
      }
      log(dbc,new CmsLogEntry(user.getId(),System.currentTimeMillis(),null,CmsLogEntryType.USER_LOGIN_FAILED,new String[]{user.getName(),remoteAddress}),false);
      OpenCms.getLoginManager().checkInvalidLogins(userName,remoteAddress);
      throw new CmsAuthentificationException(org.opencms.security.Messages.get().container(org.opencms.security.Messages.ERR_LOGIN_FAILED_2,userName,remoteAddress),e);
    }
 else {
      String userOu=CmsOrganizationalUnit.getParentFqn(userName);
      if (userOu != null) {
        String parentOu=CmsOrganizationalUnit.getParentFqn(userOu);
        if (parentOu != null) {
          String uName=CmsOrganizationalUnit.getSimpleName(userName);
          return loginUser(dbc,parentOu + uName,password,remoteAddress);
        }
      }
      log(dbc,new CmsLogEntry(CmsUUID.getNullUUID(),System.currentTimeMillis(),null,CmsLogEntryType.USER_LOGIN_FAILED,new String[]{userName,remoteAddress}),false);
      throw new CmsAuthentificationException(org.opencms.security.Messages.get().container(org.opencms.security.Messages.ERR_LOGIN_FAILED_NO_USER_2,userName,remoteAddress),e);
    }
  }
  if (!newUser.isEnabled()) {
    log(dbc,new CmsLogEntry(newUser.getId(),System.currentTimeMillis(),null,CmsLogEntryType.USER_LOGIN_FAILED,new String[]{newUser.getName(),remoteAddress}),false);
    throw new CmsAuthentificationException(org.opencms.security.Messages.get().container(org.opencms.security.Messages.ERR_LOGIN_FAILED_DISABLED_2,userName,remoteAddress));
  }
  if (dbc.currentUser().isGuestUser()) {
    OpenCms.getLoginManager().checkInvalidLogins(userName,remoteAddress);
    OpenCms.getLoginManager().removeInvalidLogins(userName,remoteAddress);
  }
  if (!m_securityManager.hasRole(dbc,newUser,CmsRole.ADMINISTRATOR.forOrgUnit(dbc.getRequestContext().getOuFqn()))) {
    OpenCms.getLoginManager().checkLoginAllowed();
  }
  newUser.setLastlogin(System.currentTimeMillis());
  m_userDriver.writeUser(dbc,newUser);
  log(dbc,new CmsLogEntry(newUser.getId(),System.currentTimeMillis(),null,CmsLogEntryType.USER_LOGIN_SUCCESSFUL,new String[]{newUser.getName(),remoteAddress}),false);
  m_monitor.cacheUser(newUser);
  m_monitor.flushCache(CmsMemoryMonitor.CacheType.ACL,CmsMemoryMonitor.CacheType.GROUP,CmsMemoryMonitor.CacheType.ORG_UNIT,CmsMemoryMonitor.CacheType.USERGROUPS,CmsMemoryMonitor.CacheType.USER_LIST,CmsMemoryMonitor.CacheType.PERMISSION,CmsMemoryMonitor.CacheType.RESOURCE_LIST);
  return newUser;
}

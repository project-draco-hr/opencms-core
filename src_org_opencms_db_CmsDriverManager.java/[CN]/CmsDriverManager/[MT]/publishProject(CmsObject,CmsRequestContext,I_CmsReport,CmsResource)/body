{
  CmsPublishedResources allChanged=new CmsPublishedResources(context.currentProject());
  Vector changedResources=new Vector();
  Vector changedModuleMasters=new Vector();
  int publishProjectId=context.currentProject().getId();
  boolean backupEnabled=isHistoryEnabled(cms);
  int tagId=0;
  if ((isAdmin(context) || isManagerOfProject(context)) && (context.currentProject().getFlags() == I_CmsConstants.C_PROJECT_STATE_UNLOCKED) && (publishProjectId != I_CmsConstants.C_PROJECT_ONLINE_ID)) {
    try {
      if (backupEnabled) {
        tagId=getBackupTagId();
      }
 else {
        tagId=0;
      }
      int maxVersions=cms.getRegistry().getMaximumBackupVersions();
      if (directPublishResource != null) {
        try {
          checkParentsPublished(cms,context,directPublishResource);
        }
 catch (        CmsException e) {
          allChanged.setChangedCosResources(new Vector());
          allChanged.setChangedVfsResources(new Vector());
          report.println(e.getMessage(),I_CmsReport.C_FORMAT_WARNING);
          return null;
        }
      }
      changedResources=m_projectDriver.publishProject(context,readProject(I_CmsConstants.C_PROJECT_ONLINE_ID),isHistoryEnabled(cms),tagId,report,m_registry.getExportpoints(),directPublishResource,maxVersions);
      Vector publishModules=new Vector();
      cms.getRegistry().getModulePublishables(publishModules,null);
      long publishDate=System.currentTimeMillis();
      if (backupEnabled) {
        try {
          publishDate=m_backupDriver.readBackupProject(tagId).getPublishingDate();
        }
 catch (        CmsException e) {
        }
        if (publishDate == 0) {
          publishDate=System.currentTimeMillis();
        }
      }
      for (int i=0; i < publishModules.size(); i++) {
        try {
          Class.forName((String)publishModules.elementAt(i)).getMethod("publishProject",new Class[]{CmsObject.class,Boolean.class,Integer.class,Integer.class,Long.class,Vector.class,Vector.class}).invoke(null,new Object[]{cms,new Boolean(isHistoryEnabled(cms)),new Integer(publishProjectId),new Integer(tagId),new Long(publishDate),changedResources,changedModuleMasters});
        }
 catch (        ClassNotFoundException ec) {
          report.println(report.key("report.publish_class_for_module_does_not_exist_1") + (String)publishModules.elementAt(i) + report.key("report.publish_class_for_module_does_not_exist_2"),I_CmsReport.C_FORMAT_WARNING);
          if (OpenCms.isLogging(CmsLog.CHANNEL_MAIN,CmsLog.LEVEL_INFO)) {
            OpenCms.log(CmsLog.CHANNEL_MAIN,CmsLog.LEVEL_INFO,"Error calling publish class of module " + (String)publishModules.elementAt(i) + "!: "+ ec.getMessage());
          }
        }
catch (        Exception ex) {
          report.println(ex);
          if (OpenCms.isLogging(CmsLog.CHANNEL_MAIN,CmsLog.LEVEL_INFO)) {
            OpenCms.log(CmsLog.CHANNEL_MAIN,CmsLog.LEVEL_INFO,"Error when publish data of module " + (String)publishModules.elementAt(i) + "!: "+ ex.getMessage());
          }
        }
      }
    }
 catch (    CmsException e) {
      throw e;
    }
 finally {
      this.clearResourceCache();
      if (context.currentProject().getType() == I_CmsConstants.C_PROJECT_TYPE_TEMPORARY) {
        m_projectDriver.deleteProject(context.currentProject());
        try {
          m_projectCache.remove(new Integer(publishProjectId));
        }
 catch (        Exception e) {
          if (OpenCms.isLogging(CmsLog.CHANNEL_TEMPLATE_XML,CmsLog.LEVEL_WARN)) {
            OpenCms.log(CmsLog.CHANNEL_TEMPLATE_XML,CmsLog.LEVEL_WARN,"Could not remove project " + publishProjectId + " from cache");
          }
        }
        if (publishProjectId == context.currentProject().getId()) {
          cms.getRequestContext().setCurrentProject(I_CmsConstants.C_PROJECT_ONLINE_ID);
        }
      }
      if (m_refresh.length() > 0) {
        try {
          URL url=new URL(m_refresh);
          URLConnection con=url.openConnection();
          con.connect();
          InputStream in=con.getInputStream();
          in.close();
        }
 catch (        Exception ex) {
          throw new CmsException(0,ex);
        }
      }
    }
  }
 else   if (publishProjectId == I_CmsConstants.C_PROJECT_ONLINE_ID) {
    throw new CmsSecurityException("[" + getClass().getName() + "] could not publish project "+ publishProjectId,CmsSecurityException.C_SECURITY_NO_MODIFY_IN_ONLINE_PROJECT);
  }
 else   if (!isAdmin(context) && !isManagerOfProject(context)) {
    throw new CmsSecurityException("[" + getClass().getName() + "] could not publish project "+ publishProjectId,CmsSecurityException.C_SECURITY_PROJECTMANAGER_PRIVILEGES_REQUIRED);
  }
 else {
    throw new CmsSecurityException("[" + getClass().getName() + "] could not publish project "+ publishProjectId,CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
  allChanged.setChangedVfsResources(changedResources);
  allChanged.setChangedCosResources(changedModuleMasters);
  return allChanged;
}

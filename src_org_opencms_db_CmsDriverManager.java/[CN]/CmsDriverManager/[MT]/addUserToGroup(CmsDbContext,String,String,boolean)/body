{
  CmsGroup group=readGroup(dbc,groupname);
  if (group == null) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_GROUP_1,groupname));
  }
  if (group.isVirtual() && !readRoles) {
    addUserToGroup(dbc,username,CmsRole.valueOf(group).getGroupName(),true);
    return;
  }
  if (group.isVirtual()) {
    readRoles=false;
  }
  if ((readRoles && !group.isRole()) || (!readRoles && group.isRole())) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_GROUP_1,groupname));
  }
  if (userInGroup(dbc,username,groupname,readRoles)) {
    return;
  }
  CmsUser user=readUser(dbc,username);
  if (user == null) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_USER_1,username));
  }
  if (readRoles) {
    CmsRole role=CmsRole.valueOf(group);
    m_securityManager.checkRole(dbc,role);
    if (m_securityManager.hasRole(dbc,user,role)) {
      return;
    }
    List children=role.getChildren(true);
    Iterator itUserGroups=getGroupsOfUser(dbc,username,group.getOuFqn(),true,true,true,dbc.getRequestContext().getRemoteAddress()).iterator();
    while (itUserGroups.hasNext()) {
      CmsGroup roleGroup=(CmsGroup)itUserGroups.next();
      if (children.contains(CmsRole.valueOf(roleGroup))) {
        removeUserFromGroup(dbc,username,roleGroup.getName(),true);
      }
    }
    Iterator it=getVirtualGroupsForRole(dbc,role).iterator();
    while (it.hasNext()) {
      CmsGroup virtualGroup=(CmsGroup)it.next();
      addUserToGroup(dbc,username,virtualGroup.getName(),true);
    }
    CmsRole wpUser=CmsRole.WORKPLACE_USER.forOrgUnit(group.getOuFqn());
    if (!role.equals(wpUser) && !role.getChildren(true).contains(wpUser) && !userInGroup(dbc,username,wpUser.getGroupName(),true)) {
      addUserToGroup(dbc,username,wpUser.getGroupName(),true);
    }
  }
  m_userDriver.createUserInGroup(dbc,user.getId(),group.getId());
  if (readRoles) {
    OpenCms.getMemoryMonitor().flushRoles();
    OpenCms.getMemoryMonitor().flushRoleLists();
  }
  OpenCms.getMemoryMonitor().flushUserGroups();
}

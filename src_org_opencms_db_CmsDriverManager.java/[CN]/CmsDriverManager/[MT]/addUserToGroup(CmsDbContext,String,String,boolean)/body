{
  CmsGroup group=readGroup(dbc,groupname);
  if (group == null) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_GROUP_1,groupname));
  }
  if (group.isVirtual() && !readRoles) {
    addUserToGroup(dbc,username,CmsRole.valueOf(group).getGroupName(),true);
    return;
  }
  if (group.isVirtual()) {
    readRoles=false;
  }
  if ((readRoles && !group.isRole()) || (!readRoles && group.isRole())) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_GROUP_1,groupname));
  }
  if (userInGroup(dbc,username,groupname,readRoles)) {
    return;
  }
  CmsUser user=readUser(dbc,username);
  if (user == null) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_USER_1,username));
  }
  if (readRoles) {
    CmsRole role=CmsRole.valueOf(group);
    m_securityManager.checkRole(dbc,role);
    if (m_securityManager.hasRole(dbc,user,role)) {
      return;
    }
    List<CmsRole> children=role.getChildren(true);
    Iterator<CmsGroup> itUserGroups=getGroupsOfUser(dbc,username,group.getOuFqn(),true,true,true,dbc.getRequestContext().getRemoteAddress()).iterator();
    while (itUserGroups.hasNext()) {
      CmsGroup roleGroup=itUserGroups.next();
      if (children.contains(CmsRole.valueOf(roleGroup))) {
        removeUserFromGroup(dbc,username,roleGroup.getName(),true);
      }
    }
    Iterator<CmsGroup> it=getVirtualGroupsForRole(dbc,role).iterator();
    while (it.hasNext()) {
      CmsGroup virtualGroup=it.next();
      addUserToGroup(dbc,username,virtualGroup.getName(),true);
    }
    CmsRole wpUser=CmsRole.WORKPLACE_USER.forOrgUnit(group.getOuFqn());
    if (!role.equals(wpUser) && !role.getChildren(true).contains(wpUser) && !m_securityManager.hasRole(dbc,user,wpUser)) {
      addUserToGroup(dbc,username,wpUser.getGroupName(),true);
    }
  }
  m_userDriver.createUserInGroup(dbc,user.getId(),group.getId());
  if (readRoles) {
    m_monitor.flushRoles();
    m_monitor.flushRoleLists();
  }
  m_monitor.flushUserGroups();
  Map eventData=new HashMap();
  eventData.put(I_CmsEventListener.KEY_ID,user.getId().toString());
  eventData.put(I_CmsEventListener.KEY_USER_NAME,user.getName());
  eventData.put(I_CmsEventListener.KEY_GROUP_NAME,group.getName());
  eventData.put(I_CmsEventListener.KEY_USER_ACTION,I_CmsEventListener.VALUE_USER_MODIFIED_ACTION_ADD_USER_TO_GROUP);
  OpenCms.fireCmsEvent(new CmsEvent(I_CmsEventListener.EVENT_USER_MODIFIED,eventData));
}

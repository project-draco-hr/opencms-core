{
  long dateLastModified=0;
  long dateCreated=0;
  CmsUUID userLastModified=null;
  CmsUUID userCreated=null;
  CmsResource newResource=null;
  String destinationFoldername=null;
  String destinationResourceName=null;
  validFilename(destination.replace('/','a'));
  destinationFoldername=destination.substring(0,destination.substring(0,destination.length() - 1).lastIndexOf("/") + 1);
  destinationResourceName=destination.substring(destinationFoldername.length());
  if (CmsResource.isFolder(destinationResourceName)) {
    destinationResourceName=destinationResourceName.substring(0,destinationResourceName.length() - 1);
  }
  CmsFolder destinationFolder=readFolder(context,destinationFoldername);
  CmsFolder sourceFolder=readFolder(context,source);
  checkPermissions(context,destinationFolder,I_CmsConstants.C_WRITE_ACCESS,CmsResourceFilter.ALL);
  if (preserveTimestamps) {
    dateLastModified=sourceFolder.getDateLastModified();
    dateCreated=sourceFolder.getDateCreated();
    userLastModified=sourceFolder.getUserLastModified();
    userCreated=sourceFolder.getUserCreated();
  }
 else {
    dateLastModified=System.currentTimeMillis();
    dateCreated=System.currentTimeMillis();
    userLastModified=context.currentUser().getId();
    userCreated=context.currentUser().getId();
  }
  CmsFolder copyFolder=new CmsFolder(new CmsUUID(),new CmsUUID(),destinationFolder.getStructureId(),CmsUUID.getNullUUID(),destinationResourceName,CmsResourceTypeFolder.C_RESOURCE_TYPE_ID,sourceFolder.getFlags(),context.currentProject().getId(),org.opencms.main.I_CmsConstants.C_STATE_NEW,dateCreated,userCreated,dateLastModified,userLastModified,1,sourceFolder.getDateReleased(),sourceFolder.getDateExpired());
  newResource=m_vfsDriver.createFolder(context.currentProject(),copyFolder,destinationFolder.getStructureId());
  newResource.setFullResourceName(destination);
  clearResourceCache();
  List properties=readPropertyObjects(context,source,null,false);
  m_vfsDriver.writePropertyObjects(context.currentProject(),newResource,properties);
  m_propertyCache.clear();
  if (preserveTimestamps) {
    touch(context,destination,dateLastModified,userLastModified);
  }
  ListIterator aceList=getAccessControlEntries(context,sourceFolder,false).listIterator();
  while (aceList.hasNext()) {
    CmsAccessControlEntry ace=(CmsAccessControlEntry)aceList.next();
    m_userDriver.createAccessControlEntry(context.currentProject(),newResource.getResourceId(),ace.getPrincipal(),ace.getPermissions().getAllowedPermissions(),ace.getPermissions().getDeniedPermissions(),ace.getFlags());
  }
  if (lockCopy) {
    lockResource(context,destination);
  }
  clearAccessControlListCache();
  m_resourceListCache.clear();
  List modifiedResources=new ArrayList();
  modifiedResources.add(sourceFolder);
  modifiedResources.add(newResource);
  modifiedResources.add(destinationFolder);
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_COPIED,Collections.singletonMap("resources",modifiedResources)));
}

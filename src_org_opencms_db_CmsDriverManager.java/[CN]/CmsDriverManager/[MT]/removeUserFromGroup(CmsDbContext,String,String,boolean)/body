{
  CmsGroup group=readGroup(dbc,groupname);
  if (group == null) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_GROUP_1,groupname));
  }
  if (group.isVirtual() && !readRoles) {
    removeUserFromGroup(dbc,username,CmsRole.valueOf(group).getGroupName(),true);
    return;
  }
  if (group.isVirtual()) {
    readRoles=false;
  }
  if ((readRoles && !group.isRole()) || (!readRoles && group.isRole())) {
    throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_UNKNOWN_GROUP_1,groupname));
  }
  if (!userInGroup(dbc,username,groupname,readRoles)) {
    throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_USER_NOT_IN_GROUP_2,username,groupname));
  }
  CmsUser user=readUser(dbc,username);
  if (user == null) {
    throw new CmsIllegalArgumentException(Messages.get().container(Messages.ERR_USER_NOT_IN_GROUP_2,username,groupname));
  }
  if (readRoles) {
    CmsRole role=CmsRole.valueOf(group);
    if (role.equals(CmsRole.WORKPLACE_USER.forOrgUnit(role.getOuFqn()))) {
      if (getGroupsOfUser(dbc,username,role.getOuFqn(),false,true,true,dbc.getRequestContext().getRemoteAddress()).size() > 1) {
        return;
      }
    }
    Iterator<CmsGroup> it=getVirtualGroupsForRole(dbc,role).iterator();
    while (it.hasNext()) {
      CmsGroup virtualGroup=it.next();
      if (userInGroup(dbc,username,virtualGroup.getName(),false)) {
        removeUserFromGroup(dbc,username,virtualGroup.getName(),true);
      }
    }
  }
  m_userDriver.deleteUserInGroup(dbc,user.getId(),group.getId());
  if (readRoles) {
    m_monitor.flushRoles();
    m_monitor.flushRoleLists();
  }
  m_monitor.flushUserGroups();
}

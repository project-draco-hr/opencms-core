{
  Hashtable exportPoints=null;
  CmsExportPointDriver discAccess=null;
  List publishedResources=null;
  CmsPublishedResource currentPublishedResource=null;
  String currentExportKey=null;
  boolean printReportHeader=false;
  try {
    publishedResources=getProjectDriver().readPublishedResources(context.currentProject().getId(),publishHistoryId);
    exportPoints=m_registry.getExportpoints();
    discAccess=new CmsExportPointDriver(exportPoints);
    if (exportPoints.size() == 0) {
      if (OpenCms.getLog(this).isWarnEnabled()) {
        OpenCms.getLog(this).warn("No export points configured at all. Pls. check registry.xml for configured 'module' XML-nodes if this is correct.");
      }
      return;
    }
    Iterator i=publishedResources.iterator();
    while (i.hasNext()) {
      currentPublishedResource=(CmsPublishedResource)i.next();
      currentExportKey=checkExportPoint(currentPublishedResource.getRootPath(),exportPoints);
      if (currentExportKey != null) {
        if (!printReportHeader && report != null) {
          printReportHeader=true;
          report.println(report.key("report.export_points_write_begin"),I_CmsReport.C_FORMAT_HEADLINE);
        }
        if (currentPublishedResource.getType() == CmsResourceTypeFolder.C_RESOURCE_TYPE_ID) {
          if (currentPublishedResource.getState() == I_CmsConstants.C_STATE_DELETED) {
            discAccess.removeResource(currentPublishedResource.getRootPath(),currentExportKey);
          }
 else {
            discAccess.createFolder(currentPublishedResource.getRootPath(),currentExportKey);
          }
        }
 else {
          if (currentPublishedResource.getState() == I_CmsConstants.C_STATE_DELETED) {
            discAccess.removeResource(currentPublishedResource.getRootPath(),currentExportKey);
          }
 else {
            writeExportPoint(context,discAccess,currentExportKey,currentPublishedResource);
          }
        }
        if (report != null) {
          if (currentPublishedResource.getState() == I_CmsConstants.C_STATE_DELETED) {
            report.print(report.key("report.export_points_delete"),I_CmsReport.C_FORMAT_NOTE);
            report.print(currentPublishedResource.getRootPath());
            report.print(report.key("report.dots"));
            report.println(report.key("report.ok"),I_CmsReport.C_FORMAT_OK);
          }
 else {
            report.print(report.key("report.export_points_write"),I_CmsReport.C_FORMAT_NOTE);
            report.print(currentPublishedResource.getRootPath());
            report.print(report.key("report.dots"));
            report.println(report.key("report.ok"),I_CmsReport.C_FORMAT_OK);
          }
        }
 else         if (OpenCms.getLog(this).isDebugEnabled()) {
          if (currentPublishedResource.getState() == I_CmsConstants.C_STATE_DELETED) {
            OpenCms.getLog(this).debug("deleting export point " + currentPublishedResource.getRootPath());
          }
 else {
            OpenCms.getLog(this).debug("writing export point " + currentPublishedResource.getRootPath());
          }
        }
      }
    }
  }
 catch (  CmsException e) {
    if (OpenCms.getLog(this).isErrorEnabled()) {
      OpenCms.getLog(this).error("Error writing export points",e);
    }
  }
 finally {
    if (printReportHeader && report != null) {
      report.println(report.key("report.export_points_write_end"),I_CmsReport.C_FORMAT_HEADLINE);
    }
  }
}

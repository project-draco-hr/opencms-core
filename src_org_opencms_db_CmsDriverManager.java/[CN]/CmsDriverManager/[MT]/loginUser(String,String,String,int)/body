{
  CmsUser newUser;
  try {
    newUser=m_userDriver.readUser(username,password,remoteAddress,userType);
  }
 catch (  Throwable t) {
    throw new CmsSecurityException(CmsSecurityException.C_SECURITY_LOGIN_FAILED,t);
  }
  if (newUser.getFlags() != I_CmsConstants.C_FLAG_ENABLED) {
    throw new CmsSecurityException(CmsSecurityException.C_SECURITY_LOGIN_FAILED);
  }
  newUser.setLastlogin(System.currentTimeMillis());
  try {
    m_userDriver.writeUser(null,newUser);
  }
 catch (  Throwable t) {
    throw new CmsSecurityException(CmsSecurityException.C_SECURITY_LOGIN_FAILED,t);
  }
  putUserInCache(newUser);
  m_accessControlListCache.clear();
  m_groupCache.clear();
  m_userGroupsCache.clear();
  m_resourceListCache.clear();
  m_securityManager.clearPermissionCache();
  return newUser;
}

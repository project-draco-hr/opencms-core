{
  CmsUser user=readUser(dbc,username);
  CmsUser replacementUser=null;
  if (replacementUsername != null) {
    replacementUser=readUser(dbc,replacementUsername);
  }
  CmsProject onlineProject=readProject(dbc,CmsProject.ONLINE_PROJECT_ID);
  boolean withACEs=true;
  if (replacementUser == null) {
    withACEs=false;
    replacementUser=readUser(dbc,OpenCms.getDefaultUsers().getUserDeletedResource());
  }
  Iterator itGroups=getGroupsOfUser(dbc,username).iterator();
  while (itGroups.hasNext()) {
    CmsGroup group=(CmsGroup)itGroups.next();
    if (!userInGroup(dbc,replacementUser.getName(),group.getName())) {
      addUserToGroup(dbc,replacementUser.getName(),group.getName());
    }
    if (userInGroup(dbc,username,group.getName())) {
      removeUserFromGroup(dbc,username,group.getName());
    }
  }
  transferPrincipalResources(dbc,project,user.getId(),replacementUser.getId(),withACEs);
  transferPrincipalResources(dbc,onlineProject,user.getId(),replacementUser.getId(),withACEs);
  m_userDriver.removeAccessControlEntriesForPrincipal(dbc,project,onlineProject,user.getId());
  m_userDriver.deleteUser(dbc,username);
  clearUserCache(user);
}

{
  CmsRequestContext context=cms.getRequestContext();
  int publishProjectId=context.currentProject().getId();
  boolean temporaryProject=(context.currentProject().getType() == I_CmsConstants.C_PROJECT_TYPE_TEMPORARY);
  boolean backupEnabled=OpenCms.getSystemInfo().isVersionHistoryEnabled();
  int tagId=0;
  CmsResource directPublishResource=null;
  boolean hasPublishPermissions=false;
  hasPublishPermissions|=isAdmin(context);
  hasPublishPermissions|=isManagerOfProject(context);
  if (publishList.isDirectPublish()) {
    directPublishResource=publishList.getDirectPublishResource();
    hasPublishPermissions|=(PERM_ALLOWED == hasPermissions(context,directPublishResource,CmsPermissionSet.ACCESS_DIRECT_PUBLISH,true,CmsResourceFilter.ALL));
  }
  hasPublishPermissions&=(publishProjectId != I_CmsConstants.C_PROJECT_ONLINE_ID);
  hasPublishPermissions&=(context.currentProject().getFlags() == I_CmsConstants.C_PROJECT_STATE_UNLOCKED);
  if (hasPublishPermissions) {
    try {
      if (backupEnabled) {
        tagId=getBackupTagId();
      }
 else {
        tagId=0;
      }
      int maxVersions=OpenCms.getSystemInfo().getVersionHistoryMaxCount();
      if (publishList.isDirectPublish()) {
        try {
          getVfsDriver().readFolder(I_CmsConstants.C_PROJECT_ONLINE_ID,CmsResource.getParentFolder(publishList.getDirectPublishResource().getRootPath()));
        }
 catch (        CmsException e) {
          report.println("Parent folder not published for resource " + publishList.getDirectPublishResource().getRootPath(),I_CmsReport.C_FORMAT_ERROR);
          return;
        }
      }
      clearcache();
      m_projectDriver.publishProject(context,report,readProject(I_CmsConstants.C_PROJECT_ONLINE_ID),publishList,OpenCms.getSystemInfo().isVersionHistoryEnabled(),tagId,maxVersions);
      Iterator i=OpenCms.getModuleManager().getActionInstances();
      while (i.hasNext()) {
        I_CmsModuleAction moduleActionInstance=(I_CmsModuleAction)i.next();
        moduleActionInstance.publishProject(cms,publishList,tagId,report);
      }
      if (temporaryProject) {
        try {
          m_projectDriver.deleteProject(context.currentProject());
        }
 catch (        CmsException e) {
          OpenCms.getLog(this).error("Could not delete temporary project " + publishProjectId);
        }
        cms.getRequestContext().setCurrentProject(readProject(I_CmsConstants.C_PROJECT_ONLINE_ID));
      }
    }
  finally {
      clearcache();
      Map eventData=new HashMap();
      eventData.put(I_CmsEventListener.KEY_REPORT,report);
      eventData.put(I_CmsEventListener.KEY_PUBLISHID,publishList.getPublishHistoryId().toString());
      eventData.put(I_CmsEventListener.KEY_PROJECTID,new Integer(publishProjectId));
      CmsEvent exportPointEvent=new CmsEvent(I_CmsEventListener.EVENT_PUBLISH_PROJECT,eventData);
      OpenCms.fireCmsEvent(exportPointEvent);
    }
  }
 else   if (publishProjectId == I_CmsConstants.C_PROJECT_ONLINE_ID) {
    throw new CmsSecurityException("[" + getClass().getName() + "] could not publish project "+ publishProjectId,CmsSecurityException.C_SECURITY_NO_MODIFY_IN_ONLINE_PROJECT);
  }
 else   if (!isAdmin(context) && !isManagerOfProject(context)) {
    throw new CmsSecurityException("[" + getClass().getName() + "] could not publish project "+ publishProjectId,CmsSecurityException.C_SECURITY_PROJECTMANAGER_PRIVILEGES_REQUIRED);
  }
 else {
    throw new CmsSecurityException("[" + getClass().getName() + "] could not publish project "+ publishProjectId,CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
}

{
  CmsResource targetResource=null;
  CmsResource linkResource=null;
  String parentFolderName=null;
  CmsFolder parentFolder=null;
  String resourceName=null;
  parentFolderName=linkName.substring(0,linkName.lastIndexOf(I_CmsConstants.C_FOLDER_SEPARATOR) + 1);
  resourceName=linkName.substring(linkName.lastIndexOf(I_CmsConstants.C_FOLDER_SEPARATOR) + 1,linkName.length());
  targetResource=this.readFileHeader(context,targetName);
  if (targetResource.isFolder()) {
    throw new CmsException("Setting links on folders is not supported");
  }
  parentFolder=this.readFolder(context,parentFolderName,false);
  checkPermissions(context,parentFolder,I_CmsConstants.C_WRITE_ACCESS);
  linkResource=new CmsResource(new CmsUUID(),targetResource.getResourceId(),parentFolder.getId(),CmsUUID.getNullUUID(),resourceName,CmsResourceTypePointer.C_RESOURCE_TYPE_ID,targetResource.getFlags(),context.currentProject().getId(),com.opencms.core.I_CmsConstants.C_STATE_NEW,targetResource.getLoaderId(),System.currentTimeMillis(),context.currentUser().getId(),System.currentTimeMillis(),context.currentUser().getId(),0,targetResource.getLinkCount() + 1);
  if (!targetResource.isLabeled()) {
    List markedSites=(List)OpenCms.getRuntimeProperty("site.labeled.folders");
    Iterator i=markedSites.iterator();
    while (i.hasNext()) {
      String curSite=(String)i.next();
      if (linkName.startsWith(curSite) || targetResource.getFullResourceName().startsWith(curSite)) {
        int flags=linkResource.getFlags();
        linkResource.setFlags(flags|=I_CmsConstants.C_RESOURCEFLAG_LABELLINK);
        break;
      }
    }
  }
  linkResource=m_vfsDriver.createVfsLink(context.currentProject(),linkResource,context.currentUser().getId(),parentFolder.getId(),resourceName);
  linkResource.setFullResourceName(linkName);
  if (linkProperties == null) {
    linkProperties=Collections.EMPTY_MAP;
  }
  m_vfsDriver.writeProperties(linkProperties,context.currentProject().getId(),linkResource,linkResource.getType());
  if (lockResource) {
    lockResource(context,linkName);
  }
  clearResourceCache();
  m_propertyCache.clear();
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_PROPERTY_MAP_MODIFIED,Collections.singletonMap("resource",parentFolder)));
  return linkResource;
}

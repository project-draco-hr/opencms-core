{
  CmsFile sourceFile=readFile(context,source,CmsResourceFilter.IGNORE_EXPIRATION);
  boolean copyAsSibling=false;
  if (siblingMode == I_CmsConstants.C_COPY_AS_SIBLING) {
    copyAsSibling=true;
  }
  if (siblingMode == I_CmsConstants.C_COPY_PRESERVE_SIBLING) {
    if (sourceFile.getSiblingCount() > 1) {
      copyAsSibling=true;
    }
  }
  List properties=readPropertyObjects(context,source,null,false);
  if (copyAsSibling) {
    createSibling(context,destination,source,properties,true);
    return;
  }
  String destinationFileName=null;
  String destinationFolderName=null;
  CmsResource newResource=null;
  destinationFolderName=CmsResource.getFolderPath(destination);
  destinationFileName=CmsResource.getName(destination);
  validFilename(CmsResource.getName(destinationFileName));
  CmsFolder destinationFolder=readFolder(context,destinationFolderName,CmsResourceFilter.IGNORE_EXPIRATION);
  if (!isAdmin(context) && (sourceFile.getTypeId() == CmsResourceTypeJsp.C_RESOURCE_TYPE_ID)) {
    throw new CmsSecurityException("[" + this.getClass().getName() + "] copyFile() "+ source,CmsSecurityException.C_SECURITY_NO_PERMISSIONS);
  }
  checkPermissions(context,destinationFolder,I_CmsConstants.C_WRITE_ACCESS,CmsResourceFilter.ALL,-1);
  int flags=sourceFile.getFlags();
  if (sourceFile.isLabeled()) {
    flags&=~I_CmsConstants.C_RESOURCEFLAG_LABELLINK;
  }
  newResource=m_vfsDriver.createFile(context.currentUser(),context.currentProject(),destinationFileName,flags,destinationFolder,sourceFile.getContents(),OpenCms.getLoaderManager().getResourceType(sourceFile.getTypeId()),sourceFile.getDateReleased(),sourceFile.getDateExpired());
  newResource.setFullResourceName(destination);
  m_vfsDriver.writePropertyObjects(context.currentProject(),newResource,properties);
  m_propertyCache.clear();
  ListIterator aceList=m_userDriver.readAccessControlEntries(context.currentProject(),sourceFile.getResourceId(),false).listIterator();
  while (aceList.hasNext()) {
    CmsAccessControlEntry ace=(CmsAccessControlEntry)aceList.next();
    m_userDriver.createAccessControlEntry(context.currentProject(),newResource.getResourceId(),ace.getPrincipal(),ace.getPermissions().getAllowedPermissions(),ace.getPermissions().getDeniedPermissions(),ace.getFlags());
  }
  m_vfsDriver.writeResourceState(context.currentProject(),newResource,C_UPDATE_ALL);
  touch(context,destination,sourceFile.getDateLastModified(),I_CmsConstants.C_DATE_UNCHANGED,I_CmsConstants.C_DATE_UNCHANGED,sourceFile.getUserLastModified());
  lockResource(context,destination);
  clearAccessControlListCache();
  m_propertyCache.clear();
  List modifiedResources=new ArrayList();
  modifiedResources.add(sourceFile);
  modifiedResources.add(newResource);
  modifiedResources.add(destinationFolder);
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_COPIED,Collections.singletonMap("resources",modifiedResources)));
}

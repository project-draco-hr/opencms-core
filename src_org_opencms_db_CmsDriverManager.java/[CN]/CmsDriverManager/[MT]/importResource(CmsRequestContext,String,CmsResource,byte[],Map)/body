{
  String folderName=null;
  String resourceName=null;
  if (resource.isFolder()) {
    if (!newResourceName.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR))     newResourceName+=I_CmsConstants.C_FOLDER_SEPARATOR;
    folderName=newResourceName.substring(0,newResourceName.lastIndexOf(I_CmsConstants.C_FOLDER_SEPARATOR,newResourceName.length() - 2) + 1);
    resourceName=newResourceName.substring(folderName.length(),newResourceName.length() - 1);
  }
 else {
    folderName=newResourceName.substring(0,newResourceName.lastIndexOf(I_CmsConstants.C_FOLDER_SEPARATOR,newResourceName.length()) + 1);
    resourceName=newResourceName.substring(folderName.length(),newResourceName.length());
    List markedSites=(List)OpenCms.getRuntimeProperty("site.labeled.folders");
    List vfsLinkList=m_vfsDriver.getAllVfsSoftLinks(context.currentProject(),resource);
    Iterator i=vfsLinkList.iterator();
    boolean markedFound=false;
    while (!markedFound && i.hasNext()) {
      CmsResource currentResource=(CmsResource)i.next();
      readPath(context,currentResource,true);
      String curPath=currentResource.getRootPath();
      for (int k=0; k < markedSites.size(); k++) {
        if (curPath.startsWith((String)markedSites.get(k))) {
          int flags=resource.getFlags();
          resource.setFlags(flags|=I_CmsConstants.C_RESOURCEFLAG_LABELLINK);
          markedFound=true;
        }
      }
    }
  }
  validFilename(resourceName);
  CmsFolder parentFolder=readFolder(context,folderName);
  checkPermissions(context,parentFolder,I_CmsConstants.C_WRITE_ACCESS);
  if (filecontent == null) {
    filecontent=new byte[0];
  }
  resource.setParentId(parentFolder.getStructureId());
  CmsResource newResource=m_vfsDriver.importResource(context.currentProject(),parentFolder.getStructureId(),resource,filecontent,context.currentUser().getId(),resource.isFolder());
  newResource.setFullResourceName(newResourceName);
  clearResourceCache();
  m_vfsDriver.writeProperties(propertyinfos,context.currentProject().getId(),newResource,newResource.getType(),true);
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_LIST_MODIFIED,Collections.singletonMap("resource",parentFolder)));
  return newResource;
}

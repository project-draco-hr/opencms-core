{
  List resources=(List)new ArrayList();
  CmsResource currentResource=null;
  CmsLock currentLock=null;
  CmsResource resource=null;
  Iterator i=null;
  boolean existsOnline=false;
  resource=readFileHeader(context,filename,false);
  currentLock=getLock(context,filename);
  if (currentLock.getType() == CmsLock.C_TYPE_INHERITED) {
    lockResource(context,filename);
  }
  resources.add(resource);
  if (deleteOption == I_CmsConstants.C_DELETE_OPTION_DELETE_VFS_LINKS) {
    resources.addAll(getAllVfsSoftLinks(context,filename));
  }
  i=resources.iterator();
  while (i.hasNext()) {
    currentResource=(CmsResource)i.next();
    currentLock=getLock(context,currentResource);
    if (!currentLock.equals(CmsLock.getNullLock()) && !currentLock.getUserId().equals(context.currentUser().getId())) {
      int exceptionType=currentLock.getUserId().equals(context.currentUser().getId()) ? CmsLockException.C_RESOURCE_LOCKED_BY_CURRENT_USER : CmsLockException.C_RESOURCE_LOCKED_BY_OTHER_USER;
      throw new CmsLockException("VFS link " + currentResource.getRootPath() + " pointing to "+ filename+ " is locked by another user!",exceptionType);
    }
  }
  i=resources.iterator();
  while (i.hasNext()) {
    existsOnline=false;
    currentResource=(CmsResource)i.next();
    if (hasPermissions(context,currentResource,I_CmsConstants.C_WRITE_ACCESS,false)) {
      try {
        readFileHeaderInProject(context,I_CmsConstants.C_PROJECT_ONLINE_ID,currentResource.getRootPath(),false);
        existsOnline=true;
      }
 catch (      CmsException exc) {
        existsOnline=false;
      }
      m_lockDispatcher.removeResource(this,context,currentResource.getRootPath(),true);
      if (!existsOnline) {
        deleteAllProperties(context,currentResource.getRootPath());
        m_userDriver.removeAccessControlEntries(context.currentProject(),currentResource.getResourceId());
        if (currentResource.isLabeled() && !hasLabeledLinks(context,context.currentProject(),currentResource)) {
          int flags=currentResource.getFlags();
          flags&=~I_CmsConstants.C_RESOURCEFLAG_LABELLINK;
          currentResource.setFlags(flags);
        }
        m_vfsDriver.removeFile(context.currentProject(),currentResource);
      }
 else {
        deleteAllAccessControlEntries(context,currentResource);
        currentResource.setState(I_CmsConstants.C_STATE_DELETED);
        m_vfsDriver.updateResourceState(context.currentProject(),currentResource,C_UPDATE_STRUCTURE_STATE);
        m_vfsDriver.writeProperty(I_CmsConstants.C_PROPERTY_INTERNAL,context.currentProject().getId(),"" + context.currentProject().getId(),currentResource,currentResource.getType(),false);
        m_vfsDriver.updateProjectId(context.currentProject(),context.currentProject().getId(),currentResource);
      }
    }
  }
  clearAccessControlListCache();
  clearResourceCache();
  m_accessCache.clear();
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCES_MODIFIED,Collections.singletonMap("resources",resources)));
}

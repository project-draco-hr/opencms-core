{
  CmsFile onlineFile=null;
  byte[] contents=null;
  List properties=null;
  CmsFile newFile=null;
  CmsFolder newFolder=null;
  CmsResource newResource=null;
  CmsFolder parentFolder=null;
  CmsFolder onlineFolder=null;
  CmsProject oldProject=null;
  try {
    parentFolder=readFolder(context,CmsResource.getFolderPath(resourcename));
    oldProject=context.currentProject();
    context.setCurrentProject(readProject(I_CmsConstants.C_PROJECT_ONLINE_ID));
    if (!resourcename.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
      onlineFile=readFile(context,resourcename);
      contents=onlineFile.getContents();
      properties=readPropertyObjects(context,resourcename,context.getAdjustedSiteRoot(resourcename),false);
    }
 else {
      onlineFolder=readFolder(context,resourcename);
      contents=new byte[0];
      properties=readPropertyObjects(context,resourcename,context.getAdjustedSiteRoot(resourcename),false);
    }
    context.setCurrentProject(oldProject);
    if (!resourcename.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
      newFile=new CmsFile(onlineFile.getStructureId(),onlineFile.getResourceId(),parentFolder.getStructureId(),onlineFile.getFileId(),CmsResource.getName(resourcename),onlineFile.getType(),onlineFile.getFlags(),0,org.opencms.main.I_CmsConstants.C_STATE_UNCHANGED,onlineFile.getLoaderId(),onlineFile.getDateCreated(),onlineFile.getUserCreated(),onlineFile.getDateLastModified(),onlineFile.getUserLastModified(),onlineFile.getDateReleased(),onlineFile.getDateExpired(),1,contents.length,contents);
      newResource=m_vfsDriver.createFile(context.currentProject(),newFile,context.currentUser().getId(),parentFolder.getStructureId(),CmsResource.getName(resourcename));
    }
 else {
      newFolder=new CmsFolder(onlineFolder.getStructureId(),onlineFolder.getResourceId(),parentFolder.getStructureId(),CmsUUID.getNullUUID(),CmsResource.getName(resourcename),CmsResourceTypeFolder.C_RESOURCE_TYPE_ID,onlineFolder.getFlags(),0,org.opencms.main.I_CmsConstants.C_STATE_UNCHANGED,onlineFolder.getDateCreated(),onlineFolder.getUserCreated(),onlineFolder.getDateLastModified(),onlineFolder.getUserLastModified(),1,onlineFolder.getDateReleased(),onlineFolder.getDateExpired());
      newResource=m_vfsDriver.createFolder(context.currentProject(),newFolder,parentFolder.getStructureId());
    }
    writePropertyObjects(context,resourcename,properties);
    newResource.setState(I_CmsConstants.C_STATE_UNCHANGED);
    m_vfsDriver.writeResourceState(context.currentProject(),newResource,C_UPDATE_ALL);
  }
 catch (  CmsException e) {
    throw e;
  }
 finally {
    context.setCurrentProject(oldProject);
    clearResourceCache();
  }
  newResource.setFullResourceName(resourcename);
  contents=null;
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_MODIFIED,Collections.singletonMap("resource",newResource)));
  return newResource;
}

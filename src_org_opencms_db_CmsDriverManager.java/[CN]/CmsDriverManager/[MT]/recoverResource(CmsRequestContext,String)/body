{
  CmsFile onlineFile=null;
  byte[] contents=null;
  Map properties=null;
  CmsFile newFile=null;
  CmsFolder newFolder=null;
  CmsResource newResource=null;
  CmsFolder parentFolder=null;
  CmsFolder onlineFolder=null;
  CmsProject oldProject=null;
  try {
    parentFolder=readFolder(context,CmsResource.getFolderPath(resourcename));
    oldProject=context.currentProject();
    context.setCurrentProject(I_CmsConstants.C_PROJECT_ONLINE_ID);
    if (!resourcename.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
      onlineFile=readFile(context,resourcename);
      contents=onlineFile.getContents();
      properties=readProperties(context,resourcename,context.getAdjustedSiteRoot(resourcename),false);
    }
 else {
      onlineFolder=readFolder(context,resourcename);
      contents=new byte[0];
      properties=readProperties(context,resourcename,context.getAdjustedSiteRoot(resourcename),false);
    }
    context.setCurrentProject(oldProject.getId());
    if (!resourcename.endsWith(I_CmsConstants.C_FOLDER_SEPARATOR)) {
      newFile=new CmsFile(onlineFile.getStructureId(),onlineFile.getResourceId(),parentFolder.getStructureId(),onlineFile.getFileId(),CmsResource.getName(resourcename),onlineFile.getType(),onlineFile.getFlags(),0,org.opencms.main.I_CmsConstants.C_STATE_UNCHANGED,getResourceType(onlineFile.getType()).getLoaderId(),0,context.currentUser().getId(),0,context.currentUser().getId(),contents.length,1,contents);
      newResource=m_vfsDriver.createFile(context.currentProject(),newFile,context.currentUser().getId(),parentFolder.getStructureId(),CmsResource.getName(resourcename));
    }
 else {
      newFolder=new CmsFolder(onlineFolder.getStructureId(),onlineFolder.getResourceId(),parentFolder.getStructureId(),CmsUUID.getNullUUID(),CmsResource.getName(resourcename),CmsResourceTypeFolder.C_RESOURCE_TYPE_ID,onlineFolder.getFlags(),0,org.opencms.main.I_CmsConstants.C_STATE_UNCHANGED,0,context.currentUser().getId(),0,context.currentUser().getId(),1);
      newResource=m_vfsDriver.createFolder(context.currentProject(),newFolder,parentFolder.getStructureId());
    }
    writeProperties(context,resourcename,properties);
    newResource.setState(I_CmsConstants.C_STATE_UNCHANGED);
    m_vfsDriver.writeResourceState(context.currentProject(),newResource,C_UPDATE_ALL);
  }
 catch (  CmsException e) {
    throw e;
  }
 finally {
    context.setCurrentProject(oldProject.getId());
    clearResourceCache();
  }
  newResource.setFullResourceName(resourcename);
  contents=null;
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_MODIFIED,Collections.singletonMap("resource",newResource)));
  return newResource;
}

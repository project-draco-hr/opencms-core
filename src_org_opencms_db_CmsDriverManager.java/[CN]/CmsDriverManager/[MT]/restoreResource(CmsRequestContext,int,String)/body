{
  if (context.currentProject().isOnlineProject()) {
    throw new CmsSecurityException("Can't write to the online project",CmsSecurityException.C_SECURITY_NO_MODIFY_IN_ONLINE_PROJECT);
  }
  CmsFile offlineFile=readFile(context,filename);
  checkPermissions(context,offlineFile,I_CmsConstants.C_WRITE_ACCESS);
  int state=I_CmsConstants.C_STATE_CHANGED;
  CmsBackupResource backupFile=readBackupFile(context,versionId,filename);
  if (offlineFile.getState() == I_CmsConstants.C_STATE_NEW) {
    state=I_CmsConstants.C_STATE_NEW;
  }
  if (backupFile != null && offlineFile != null) {
    CmsFile newFile=new CmsFile(offlineFile.getId(),offlineFile.getResourceId(),offlineFile.getParentId(),offlineFile.getFileId(),offlineFile.getResourceName(),backupFile.getType(),backupFile.getFlags(),context.currentProject().getId(),state,backupFile.getLoaderId(),offlineFile.getDateCreated(),backupFile.getUserCreated(),offlineFile.getDateLastModified(),context.currentUser().getId(),backupFile.getContents(),backupFile.getLength(),backupFile.getLinkCount());
    writeFile(context,newFile);
    clearResourceCache();
  }
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_MODIFIED,Collections.singletonMap("resource",offlineFile)));
}

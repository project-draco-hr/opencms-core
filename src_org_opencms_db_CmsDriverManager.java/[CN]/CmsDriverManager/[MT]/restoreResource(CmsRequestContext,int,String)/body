{
  if (context.currentProject().isOnlineProject()) {
    throw new CmsSecurityException("Can't write to the online project",CmsSecurityException.C_SECURITY_NO_MODIFY_IN_ONLINE_PROJECT);
  }
  CmsFile offlineFile=readFile(context,filename,CmsResourceFilter.IGNORE_EXPIRATION);
  checkPermissions(context,offlineFile,I_CmsConstants.C_WRITE_ACCESS,CmsResourceFilter.ALL);
  int state=I_CmsConstants.C_STATE_CHANGED;
  CmsBackupResource backupFile=readBackupFile(context,tagId,filename);
  if (offlineFile.getState() == I_CmsConstants.C_STATE_NEW) {
    state=I_CmsConstants.C_STATE_NEW;
  }
  if (backupFile != null && offlineFile != null) {
    int flags=backupFile.getFlags();
    if (offlineFile.isLabeled()) {
      flags|=I_CmsConstants.C_RESOURCEFLAG_LABELLINK;
    }
    CmsFile newFile=new CmsFile(offlineFile.getStructureId(),offlineFile.getResourceId(),offlineFile.getParentStructureId(),offlineFile.getFileId(),offlineFile.getName(),backupFile.getType(),flags,context.currentProject().getId(),state,backupFile.getLoaderId(),offlineFile.getDateCreated(),backupFile.getUserCreated(),offlineFile.getDateLastModified(),context.currentUser().getId(),backupFile.getDateReleased(),backupFile.getDateExpired(),backupFile.getLinkCount(),backupFile.getLength(),backupFile.getContents());
    newFile.setFullResourceName(filename);
    writeFile(context,newFile);
    List backupProperties=m_backupDriver.readBackupProperties(backupFile);
    deleteAllProperties(context,newFile.getRootPath());
    writePropertyObjects(context,filename,backupProperties);
    clearResourceCache();
  }
  OpenCms.fireCmsEvent(new CmsEvent(new CmsObject(),I_CmsEventListener.EVENT_RESOURCE_MODIFIED,Collections.singletonMap("resource",offlineFile)));
}

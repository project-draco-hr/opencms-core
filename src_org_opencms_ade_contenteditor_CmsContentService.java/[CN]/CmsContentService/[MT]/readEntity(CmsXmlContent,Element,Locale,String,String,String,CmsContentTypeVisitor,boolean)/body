{
  String newEntityId=entityId + (CmsStringUtil.isNotEmptyOrWhitespaceOnly(parentPath) ? "/" + parentPath : "");
  Entity newEntity=new Entity(newEntityId,typeName);
  Entity result=newEntity;
  List<Element> elements=element.elements();
  I_Type type=visitor.getTypes().get(typeName);
  boolean isChoice=type.isChoice();
  String choiceTypeName=null;
  Map<String,Integer> attributeCounter=null;
  if (isChoice) {
    choiceTypeName=type.getAttributeTypeName(Type.CHOICE_ATTRIBUTE_NAME);
    type=visitor.getTypes().get(type.getAttributeTypeName(Type.CHOICE_ATTRIBUTE_NAME));
    attributeCounter=new HashMap<String,Integer>();
  }
  int counter=0;
  CmsObject cms=getCmsObject();
  String previousName=null;
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(parentPath)) {
    parentPath+="/";
  }
  for (  Element child : elements) {
    String attributeName=getAttributeName(child.getName(),typeName);
    String subTypeName=type.getAttributeTypeName(attributeName);
    if (visitor.getTypes().get(subTypeName) == null) {
      continue;
    }
    if (!includeInvisible && !visitor.getAttributeConfigurations().get(attributeName).isVisible()) {
      continue;
    }
    if (isChoice && (attributeCounter != null)) {
      if (!attributeName.equals(previousName)) {
        if (attributeCounter.get(attributeName) != null) {
          counter=attributeCounter.get(attributeName).intValue();
        }
 else {
          counter=0;
        }
        previousName=attributeName;
      }
      attributeCounter.put(attributeName,Integer.valueOf(counter + 1));
    }
 else     if (!attributeName.equals(previousName)) {
      counter=0;
      previousName=attributeName;
    }
    if (isChoice) {
      result=new Entity(newEntityId + "/" + Type.CHOICE_ATTRIBUTE_NAME+ "_"+ child.getName()+ "["+ counter+ "]",choiceTypeName);
      newEntity.addAttributeValue(Type.CHOICE_ATTRIBUTE_NAME,result);
    }
    String path=parentPath + child.getName();
    if (visitor.getTypes().get(subTypeName).isSimpleType()) {
      I_CmsXmlContentValue value=content.getValue(path,locale,counter);
      result.addAttributeValue(attributeName,value.getStringValue(cms));
    }
 else {
      Entity subEntity=readEntity(content,child,locale,entityId,path + "[" + (counter + 1)+ "]",subTypeName,visitor,includeInvisible);
      result.addAttributeValue(attributeName,subEntity);
    }
    counter++;
  }
  return newEntity;
}

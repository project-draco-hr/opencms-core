{
  String content=getParamContent();
  int indexBodyStart=content.toLowerCase().indexOf("<body>");
  boolean isBrowserNS=BROWSER_NS.equals(getBrowserType());
  if ("edit".equals(getParamEditormode()) || isBrowserNS || save) {
    if (indexBodyStart != -1) {
      content=content.substring(indexBodyStart + 6);
      content=content.substring(0,content.toLowerCase().indexOf("</body>"));
    }
    content=filterAnchors(content);
  }
 else {
    String currentTemplate=null;
    String stylesheet="";
    try {
      currentTemplate=getCms().readProperty(getParamResource(),I_CmsConstants.C_PROPERTY_TEMPLATE,true);
    }
 catch (    CmsException e) {
    }
    if (currentTemplate != null) {
      stylesheet=getJsp().property(I_CmsConstants.C_PROPERTY_TEMPLATE,currentTemplate,"");
    }
    if (indexBodyStart != -1) {
      content=content.substring(indexBodyStart + 6);
      content=content.substring(0,content.toLowerCase().indexOf("</body>"));
    }
    content=filterAnchors(content);
    String server=getJsp().getRequest().getScheme() + "://" + getJsp().getRequest().getServerName()+ ":"+ getJsp().getRequest().getServerPort();
    StringBuffer head=new StringBuffer(content.length() + 1024);
    head.append("<html><head>");
    if (!"".equals(stylesheet)) {
      stylesheet=getJsp().link(stylesheet);
      head.append("<link href=\"" + server + stylesheet+ "\" rel=\"stylesheet\" type=\"text/css\">");
    }
    head.append("<base href=\"" + server + OpenCms.getOpenCmsContext()+ "\"></base></head><body>");
    content=head + content + "</body></html>";
  }
  if (!save) {
    setParamContent(content);
  }
 else {
    content=CmsEncoder.escapeNonAscii(content);
  }
  return content.trim();
}

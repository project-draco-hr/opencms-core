{
  if (jsp != null) {
    HttpSession session=jsp.getRequest().getSession();
    CmsWorkplaceSettings settings=(CmsWorkplaceSettings)session.getAttribute(C_SESSION_WORKPLACE_SETTINGS);
    if (CmsStringUtil.isEmpty(galleryTypeName)) {
      galleryTypeName=settings.getGalleryType();
    }
 else {
      settings.setGalleryType(galleryTypeName);
    }
  }
  String className=OpenCms.getWorkplaceManager().getGalleryClassName(galleryTypeName);
  if (className == null) {
    String message="Unknown gallery type '" + galleryTypeName + "' requested"+ (jsp != null ? " on JSP " + jsp.info("opencms.request.element.uri") : "");
    OpenCms.getLog(CmsGallery.class).error(message);
    throw new RuntimeException(message);
  }
  try {
    Class galleryClass=Class.forName(className);
    CmsGallery galleryInstance=(CmsGallery)galleryClass.newInstance();
    galleryInstance.m_galleryTypeName=galleryTypeName;
    galleryInstance.m_galleryTypeId=OpenCms.getResourceManager().getResourceType(galleryTypeName).getTypeId();
    galleryInstance.initWorkplaceMembers(jsp);
    return galleryInstance;
  }
 catch (  Exception e) {
    String message="Unable to create class instance '" + className + "' for gallery type '"+ galleryTypeName+ "'"+ (jsp != null ? " on JSP " + jsp.info("opencms.request.element.uri") : "");
    OpenCms.getLog(CmsGallery.class).error(message);
    throw new RuntimeException(message,e);
  }
}

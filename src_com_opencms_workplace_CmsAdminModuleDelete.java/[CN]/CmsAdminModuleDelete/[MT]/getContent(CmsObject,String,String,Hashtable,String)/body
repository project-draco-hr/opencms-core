{
  if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging() && C_DEBUG) {
    A_OpenCms.log(C_OPENCMS_DEBUG,this.getClassName() + "getting content of element " + ((elementName == null) ? "<root>" : elementName));
    A_OpenCms.log(C_OPENCMS_DEBUG,this.getClassName() + "template file is: " + templateFile);
    A_OpenCms.log(C_OPENCMS_DEBUG,this.getClassName() + "selected template section is: " + ((templateSelector == null) ? "<default>" : templateSelector));
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  CmsRequestContext reqCont=cms.getRequestContext();
  I_CmsRegistry reg=cms.getRegistry();
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String step=(String)parameters.get(C_STEP);
  String moduleName=(String)parameters.get(C_MODULE);
  if (step == null) {
    xmlTemplateDocument.setData("name",moduleName);
    xmlTemplateDocument.setData("version","" + reg.getModuleVersion(moduleName));
  }
 else   if ("showResult".equals(step)) {
    CmsAdminModuleDeleteThread doTheWork=(CmsAdminModuleDeleteThread)session.getValue(C_MODULE_THREAD);
    if (doTheWork.isAlive()) {
      xmlTemplateDocument.setData("endMethod","");
      xmlTemplateDocument.setData("text","");
    }
 else {
      xmlTemplateDocument.setData("endMethod",xmlTemplateDocument.getDataValue("endMethod"));
      xmlTemplateDocument.setData("autoUpdate","");
      xmlTemplateDocument.setData("text",xmlTemplateDocument.getLanguageFile().getLanguageValue("module.lable.deleteend"));
      session.removeValue(C_MODULE_THREAD);
    }
    xmlTemplateDocument.setData("data",doTheWork.getReportUpdate());
    return startProcessing(cms,xmlTemplateDocument,elementName,parameters,"updateReport");
  }
 else   if (C_DELETE.equals(step)) {
    Vector otherModules=reg.deleteCheckDependencies(moduleName);
    if (!otherModules.isEmpty()) {
      xmlTemplateDocument.setData("name",moduleName);
      xmlTemplateDocument.setData("version","" + reg.getModuleVersion(moduleName));
      String depModules="";
      for (int i=0; i < otherModules.size(); i++) {
        depModules+=(String)otherModules.elementAt(i) + "\n";
      }
      xmlTemplateDocument.setData("precondition",depModules);
      templateSelector=C_ERROR;
    }
 else {
      Vector filesWithProperty=new Vector();
      Vector missingFiles=new Vector();
      Vector wrongChecksum=new Vector();
      Vector filesInUse=new Vector();
      Vector resourcesForProject=new Vector();
      reqCont.setCurrentProject(cms.onlineProject().getId());
      reg.deleteGetConflictingFileNames(moduleName,filesWithProperty,missingFiles,wrongChecksum,filesInUse,resourcesForProject);
      session.putValue(C_SESSION_MODULENAME,moduleName);
      session.putValue(C_SESSION_MODULE_PROJECTFILES,resourcesForProject);
      if (filesWithProperty.isEmpty() && missingFiles.isEmpty() && wrongChecksum.isEmpty()&& filesInUse.isEmpty()) {
        step="fromerrorpage";
      }
 else {
        session.putValue(C_SESSION_MODULE_DELETE_STEP,"0");
        session.putValue(C_SESSION_MODULE_CHECKSUM,wrongChecksum);
        session.putValue(C_SESSION_MODULE_PROPFILES,filesWithProperty);
        session.putValue(C_SESSION_MODULE_INUSE,filesInUse);
        session.putValue(C_SESSION_MODULE_MISSFILES,missingFiles);
        templateSelector=C_WARNING;
      }
    }
  }
  if ("fromerrorpage".equals(step)) {
    moduleName=(String)session.getValue(C_SESSION_MODULENAME);
    Vector conflictFiles=(Vector)session.getValue(C_SESSION_MODULE_EXCLUSION);
    if (conflictFiles == null) {
      conflictFiles=new Vector();
    }
    Vector projectFiles=new Vector();
    projectFiles.add("/");
    Thread doDelete=new CmsAdminModuleDeleteThread(cms,reg,moduleName,conflictFiles,projectFiles);
    doDelete.start();
    session.putValue(C_MODULE_THREAD,doDelete);
    xmlTemplateDocument.setData("time","5");
    templateSelector="showresult";
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

{
  Hashtable country_map=new Hashtable();
  Hashtable category_map=new Hashtable();
  Hashtable siteinfo=null;
  String country_key=null, country_place=null, category_place=null, lsname=null, csname=null;
  StringBuffer lines=null, nodes=null;
  CmsCategory category=null;
  int country_count=0;
  CmsXmlTemplateFile xmlTemplateDocument=getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  Vector sites=cms.getSiteMatrixInfo();
  Vector categories=cms.getAllCategories();
  lines=new StringBuffer();
  for (int i=0; i < categories.size(); i++) {
    category=(CmsCategory)categories.elementAt(i);
    category_place="" + i;
    category_map.put(new Integer(category.getId()),category_place);
    xmlTemplateDocument.setData("y",category_place);
    xmlTemplateDocument.setData("name",category.getName());
    lines.append(xmlTemplateDocument.getProcessedDataValue("category"));
  }
  xmlTemplateDocument.setData("categories",lines.toString());
  lines=new StringBuffer();
  nodes=new StringBuffer();
  country_count=0;
  for (int i=0; i < sites.size(); i++) {
    siteinfo=(Hashtable)sites.elementAt(i);
    country_key=siteinfo.get("countryid").toString() + "x" + siteinfo.get("langid").toString();
    if (!country_map.containsKey(country_key)) {
      country_place="" + country_count++;
      country_map.put(country_key,country_place);
      xmlTemplateDocument.setData("x",country_place);
      csname=(String)siteinfo.get("country_sname");
      if (csname == null)       csname=(String)siteinfo.get("country_name");
      lsname=(String)siteinfo.get("lang_sname");
      if (lsname == null)       lsname=(String)siteinfo.get("lang_name");
      xmlTemplateDocument.setData("shortname",csname + " (" + lsname+ ")");
      xmlTemplateDocument.setData("name",(String)siteinfo.get("country_name") + " (" + (String)siteinfo.get("lang_name")+ ")");
      lines.append(xmlTemplateDocument.getProcessedDataValue("domain"));
    }
 else {
      country_place=(String)country_map.get(country_key);
    }
    category_place=(String)category_map.get(siteinfo.get("categoryid"));
    xmlTemplateDocument.setData("x",country_place);
    xmlTemplateDocument.setData("y",category_place);
    xmlTemplateDocument.setData("id","" + ((Integer)siteinfo.get("siteid")).intValue());
    xmlTemplateDocument.setData("name",(String)siteinfo.get("sitename"));
    nodes.append(xmlTemplateDocument.getProcessedDataValue("sitenode"));
  }
  xmlTemplateDocument.setData("domains",lines.toString());
  xmlTemplateDocument.setData("sites",nodes.toString());
  xmlTemplateDocument.setData("isadmin",cms.isAdmin() ? "true" : "false");
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

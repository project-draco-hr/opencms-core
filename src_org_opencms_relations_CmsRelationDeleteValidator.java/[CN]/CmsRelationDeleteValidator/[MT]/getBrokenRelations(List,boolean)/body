{
  Map brokenRelations=new HashMap();
  Set resources=new HashSet();
  String site=m_cms.getRequestContext().getSiteRoot();
  String oldSite=site;
  try {
    m_cms.getRequestContext().setSiteRoot("/");
    List resourceList=new ArrayList();
    Iterator itResources=resourceNames.iterator();
    while (itResources.hasNext()) {
      String resName=m_cms.getRequestContext().addSiteRoot(site,(String)itResources.next());
      try {
        CmsResource resource=m_cms.readResource(resName);
        resourceList.add(resource);
        if (resource.isFolder()) {
          resourceList.addAll(m_cms.readResources(resName,CmsResourceFilter.IGNORE_EXPIRATION,true));
        }
      }
 catch (      CmsException e) {
        if (LOG.isDebugEnabled()) {
          LOG.debug(e.getLocalizedMessage(),e);
        }
      }
    }
    itResources=resourceList.iterator();
    while (itResources.hasNext()) {
      CmsResource resource=(CmsResource)itResources.next();
      resources.add(resource.getRootPath());
    }
    if (Boolean.valueOf(includeSiblings).booleanValue()) {
      itResources=new ArrayList(resourceList).iterator();
      while (itResources.hasNext()) {
        CmsResource resource=(CmsResource)itResources.next();
        try {
          if (!resource.isFolder() && (resource.getSiblingCount() > 1)) {
            Iterator itSiblings=m_cms.readSiblings(resource.getRootPath(),CmsResourceFilter.IGNORE_EXPIRATION).iterator();
            while (itSiblings.hasNext()) {
              CmsResource sibling=(CmsResource)itSiblings.next();
              if (!resources.contains(sibling.getRootPath())) {
                resources.add(sibling.getRootPath());
                resourceList.add(sibling);
              }
            }
          }
        }
 catch (        CmsException e) {
          if (LOG.isErrorEnabled()) {
            LOG.error(e.getLocalizedMessage(),e);
          }
        }
      }
    }
    itResources=resourceList.iterator();
    while (itResources.hasNext()) {
      CmsResource resource=(CmsResource)itResources.next();
      String resourceName=resource.getRootPath();
      try {
        Iterator it=m_cms.getRelationsForResource(resourceName,CmsRelationFilter.SOURCES).iterator();
        while (it.hasNext()) {
          CmsRelation relation=(CmsRelation)it.next();
          String relationName=relation.getSourcePath();
          if (!resources.contains(relationName)) {
            List broken=(List)brokenRelations.get(resourceName);
            if (broken == null) {
              broken=new ArrayList();
              brokenRelations.put(resourceName,broken);
            }
            broken.add(relation);
          }
        }
      }
 catch (      CmsException e) {
        if (LOG.isErrorEnabled()) {
          LOG.error(e.getLocalizedMessage(),e);
        }
      }
    }
  }
  finally {
    m_cms.getRequestContext().setSiteRoot(oldSite);
  }
  return brokenRelations;
}

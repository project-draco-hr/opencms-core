{
  if ((OpenCms.getSiteManager().getSites().size() > 1) && !OpenCms.getSiteManager().isWorkplaceRequest(getRequest())) {
    StringBuffer loginLink=new StringBuffer(256);
    loginLink.append(OpenCms.getSiteManager().getWorkplaceSiteMatcher().toString());
    loginLink.append(getFormLink());
    getResponse().sendRedirect(loginLink.toString());
    return null;
  }
  CmsObject cms=getCmsObject();
  m_message=null;
  if (cms.getRequestContext().getCurrentUser().isGuestUser()) {
    m_action=ACTION_DISPLAY;
    m_username=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_USERNAME);
    if (m_username != null) {
      m_username=m_username.trim();
    }
    m_password=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_PASSWORD);
    m_actionLogin=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_ACTION_LOGIN);
    m_oufqn=getRequest().getParameter(PARAM_OUFQN);
    if (m_oufqn == null) {
      m_oufqn=getPreDefOuFqn();
    }
    if (OpenCms.getLoginManager().isEnableSecurity()) {
      m_pcType=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_PCTYPE);
    }
 else {
      m_pcType=PCTYPE_PRIVATE;
    }
    getCookieData();
    if (m_pcType == null) {
      m_pcType=PCTYPE_PUBLIC;
    }
  }
 else {
    m_oufqn=cms.getRequestContext().getOuFqn();
    m_action=ACTION_LOGIN;
    m_actionLogout=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_ACTION_LOGOUT);
  }
  if (m_oufqn == null) {
    m_oufqn=CmsOrganizationalUnit.SEPARATOR;
  }
  String actionGetOus=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_ACTION_GETOULIST);
  if (Boolean.TRUE.toString().equals(actionGetOus)) {
    return getJsonOrgUnitList();
  }
  m_ou=null;
  try {
    m_ou=OpenCms.getOrgUnitManager().readOrganizationalUnit(getCmsObject(),m_oufqn);
  }
 catch (  CmsException e) {
    m_oufqn=CmsOrganizationalUnit.SEPARATOR;
    try {
      m_ou=OpenCms.getOrgUnitManager().readOrganizationalUnit(getCmsObject(),m_oufqn);
    }
 catch (    CmsException exc) {
      LOG.error(exc.getLocalizedMessage(),exc);
    }
  }
  m_requestedResource=CmsRequestUtil.getNotEmptyParameter(getRequest(),CmsWorkplaceManager.PARAM_LOGIN_REQUESTED_RESOURCE);
  if (m_requestedResource == null) {
    m_requestedResource=CmsFrameset.JSP_WORKPLACE_URI;
  }
  if (Boolean.valueOf(m_actionLogin).booleanValue()) {
    if ((m_username == null) && (m_password == null)) {
      m_message=Messages.get().container(Messages.GUI_LOGIN_NO_DATA_0);
    }
 else     if (m_username == null) {
      m_message=Messages.get().container(Messages.GUI_LOGIN_NO_NAME_0);
    }
 else     if (m_password == null) {
      m_message=Messages.get().container(Messages.GUI_LOGIN_NO_PASSWORD_0);
    }
 else     if ((m_username != null) && (m_password != null)) {
      login((m_oufqn == null ? CmsOrganizationalUnit.SEPARATOR : m_oufqn) + m_username,m_password);
      if (getLoginException() == null) {
        m_action=ACTION_LOGIN;
        CmsWorkplaceSettings workplaceSettings=CmsWorkplace.initWorkplaceSettings(cms,null,false);
        String startSite=CmsWorkplace.getStartSiteRoot(cms,workplaceSettings);
        workplaceSettings.setSite(startSite);
        cms.getRequestContext().setSiteRoot(startSite);
        getRequest().getSession().setAttribute(CmsWorkplaceManager.SESSION_WORKPLACE_SETTINGS,workplaceSettings);
        CmsUserSettings settings=workplaceSettings.getUserSettings();
        m_directEditPath=getDirectEditPath(settings);
        try {
          CmsProject project=cms.readProject(settings.getStartProject());
          if (OpenCms.getOrgUnitManager().getAllAccessibleProjects(cms,project.getOuFqn(),false).contains(project)) {
            workplaceSettings.setProject(project.getUuid());
            cms.getRequestContext().setCurrentProject(project);
          }
        }
 catch (        CmsException e) {
          LOG.warn(Messages.get().getBundle().key(Messages.LOG_LOGIN_NO_STARTUP_PROJECT_2,m_username,settings.getStartProject()),e);
        }
      }
 else {
        if (org.opencms.security.Messages.ERR_LOGIN_FAILED_DISABLED_2 == getLoginException().getMessageContainer().getKey()) {
          m_message=Messages.get().container(Messages.GUI_LOGIN_FAILED_DISABLED_0);
        }
 else         if (org.opencms.security.Messages.ERR_LOGIN_FAILED_TEMP_DISABLED_4 == getLoginException().getMessageContainer().getKey()) {
          m_message=Messages.get().container(Messages.GUI_LOGIN_FAILED_TEMP_DISABLED_0);
        }
 else         if (org.opencms.security.Messages.ERR_LOGIN_FAILED_WITH_MESSAGE_1 == getLoginException().getMessageContainer().getKey()) {
          CmsLoginMessage loginMessage=OpenCms.getLoginManager().getLoginMessage();
          if (loginMessage != null) {
            m_message=Messages.get().container(Messages.GUI_LOGIN_FAILED_WITH_MESSAGE_1,loginMessage.getMessage());
          }
        }
        if (m_message == null) {
          CmsException loginException=getLoginException();
          if (loginException instanceof CmsCustomLoginException) {
            m_message=loginException.getMessageContainer();
          }
 else {
            m_message=Messages.get().container(Messages.GUI_LOGIN_FAILED_0);
          }
        }
      }
    }
  }
 else   if (Boolean.valueOf(m_actionLogout).booleanValue()) {
    m_action=ACTION_LOGOUT;
    Cookie wpDataCookie=getCookie(COOKIE_WP_DATA);
    String wpData=CmsRequestUtil.getNotEmptyParameter(getRequest(),PARAM_WPDATA);
    if (wpData != null) {
      wpData=CmsEncoder.escapeXml(wpData);
      wpDataCookie.setValue(wpData);
      setCookie(wpDataCookie,false);
    }
    logout();
    return null;
  }
  if (m_action == ACTION_LOGIN) {
    m_message=null;
    CmsUriSplitter splitter=new CmsUriSplitter(m_requestedResource,true);
    String resource=splitter.getPrefix();
    if (!splitter.isErrorFree()) {
      if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(resource) && CmsUriSplitter.isValidUri(resource)) {
        m_requestedResource=resource;
      }
 else {
        m_requestedResource=null;
      }
    }
    if (CmsStringUtil.isEmptyOrWhitespaceOnly(resource)) {
      resource=CmsFrameset.JSP_WORKPLACE_URI;
    }
    if (CmsStringUtil.isEmptyOrWhitespaceOnly(m_directEditPath) && !getCmsObject().existsResource(resource,CmsResourceFilter.ONLY_VISIBLE_NO_DELETED)) {
      if (CmsFrameset.JSP_WORKPLACE_URI.equals(resource)) {
        m_message=Messages.get().container(Messages.GUI_LOGIN_FAILED_NO_WORKPLACE_PERMISSIONS_0);
        m_action=ACTION_DISPLAY;
      }
 else       if (getCmsObject().existsResource(CmsFrameset.JSP_WORKPLACE_URI)) {
        m_message=Messages.get().container(Messages.GUI_LOGIN_UNKNOWN_RESOURCE_1,m_requestedResource);
        m_requestedResource=CmsFrameset.JSP_WORKPLACE_URI;
      }
 else {
        m_message=Messages.get().container(Messages.GUI_LOGIN_FAILED_NO_TARGET_PERMISSIONS_1,m_requestedResource);
        m_action=ACTION_DISPLAY;
      }
    }
    if (m_action == ACTION_DISPLAY) {
      m_requestedResource=null;
      HttpSession session=getRequest().getSession(false);
      if (session != null) {
        session.invalidate();
      }
      setCookieData();
    }
 else {
      setCookieData();
    }
  }
  return displayLoginForm();
}

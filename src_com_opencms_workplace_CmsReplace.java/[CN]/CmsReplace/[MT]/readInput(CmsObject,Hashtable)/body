{
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  m_OldResourceName=null;
  m_OldResourceType=null;
  m_UploadResourceName=null;
  m_UploadResourceContent=null;
  m_UploadResourceType=null;
  m_NextStep=null;
  if (theParameters.get(I_CmsWpConstants.C_PARA_INITIAL) != null) {
    this.clearSessionValues(session);
  }
  m_OldResourceName=(String)theParameters.get(I_CmsWpConstants.C_PARA_RESOURCE);
  if (m_OldResourceName != null) {
    session.putValue(I_CmsWpConstants.C_PARA_RESOURCE,m_OldResourceName);
    Map fileExtensions=OpenCms.getResourceManager().getExtensionMapping();
    String uploadFilenameExtension=m_OldResourceName.substring(m_OldResourceName.lastIndexOf('.') + 1).toLowerCase();
    if (fileExtensions != null) {
      m_OldResourceType=(String)fileExtensions.get(uploadFilenameExtension);
    }
    if (m_OldResourceType == null) {
      m_OldResourceType="";
    }
    session.putValue("OLD_TYPE",m_OldResourceType);
  }
 else {
    m_OldResourceName=(String)session.getValue(I_CmsWpConstants.C_PARA_RESOURCE);
    m_OldResourceType=(String)session.getValue("OLD_TYPE");
  }
  m_NextStep=(String)theParameters.get(CmsReplace.C_PARA_NEXT_STEP);
  Enumeration allUploadedFilenames=CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getFileNames();
  while (allUploadedFilenames.hasMoreElements()) {
    m_UploadResourceName=(String)allUploadedFilenames.nextElement();
  }
  if (m_UploadResourceName != null) {
    session.putValue("NEW_RESOURCE",m_UploadResourceName);
    m_UploadResourceContent=CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getFile(m_UploadResourceName);
    session.putValue(I_CmsWpConstants.C_PARA_FILECONTENT,m_UploadResourceContent);
  }
 else {
    m_UploadResourceName=(String)session.getValue("NEW_RESOURCE");
    m_UploadResourceContent=(byte[])session.getValue(I_CmsWpConstants.C_PARA_FILECONTENT);
  }
  m_XmlTemplateDocument.setData("NEW_RESOURCE",m_UploadResourceName);
  m_UploadResourceType=(String)theParameters.get(I_CmsWpConstants.C_PARA_NEWTYPE);
  if (m_UploadResourceType != null) {
    session.putValue(I_CmsWpConstants.C_PARA_NEWTYPE,m_UploadResourceType);
  }
 else {
    m_UploadResourceType=(String)session.getValue(I_CmsWpConstants.C_PARA_NEWTYPE);
  }
  if (DEBUG > 0) {
    System.out.println("\nnext step: " + m_NextStep);
    System.out.println("old resource: " + m_OldResourceName);
    System.out.println("old type: " + m_OldResourceType);
    System.out.println("new resource: " + m_UploadResourceName);
    System.out.println("new type: " + m_UploadResourceType);
  }
}

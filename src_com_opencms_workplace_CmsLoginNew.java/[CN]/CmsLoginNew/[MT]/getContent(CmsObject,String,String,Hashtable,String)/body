{
  if (DEBUG > 1)   System.err.println("\nCmsLoginNew: Login process started");
  CmsXmlLanguageFile langFile=new CmsXmlLanguageFile(cms);
  m_messages=langFile.getMessages();
  cms.getRequestContext().setEncoding(langFile.getEncoding());
  boolean logout=(null != (String)parameters.get("logout"));
  I_CmsSession session=cms.getRequestContext().getSession(false);
  if (session != null) {
    if (logout) {
      session.invalidate();
      if (DEBUG > 2)       System.err.println("CmsLoginNew: logout, trashed old session");
    }
 else {
      if (DEBUG > 2)       System.err.println("CmsLoginNew: kept old session, no logout parameter found");
    }
  }
 else {
    if (DEBUG > 2)     System.err.println("CmsLoginNew: no current active session");
  }
  CmsXmlTemplateFile xmlTemplateDocument=new CmsXmlTemplateFile(cms,templateFile);
  String username=null;
  CmsUser user;
  String name=(String)parameters.get("OPENCMSUSERNAME");
  String password=(String)parameters.get("OPENCMSPASSWORD");
  String startTaskId=(String)parameters.get(I_CmsWpConstants.C_PARA_STARTTASKID);
  String startProjectId=(String)parameters.get(I_CmsWpConstants.C_PARA_STARTPROJECTID);
  if (DEBUG > 1)   System.err.println("CmsLoginNew: name=" + name + " password="+ password+ " task="+ startTaskId+ " project="+ startProjectId);
  if ((name != null) && (password != null)) {
    if (DEBUG > 1)     System.err.println("CmsLoginNew: trying to log in");
    boolean validLogin;
    try {
      username=cms.loginUser(name,password);
      validLogin=true;
      if (DEBUG > 1)       System.err.println("CmsLoginNew: cms.loginUser() successfull");
    }
 catch (    CmsException e) {
      validLogin=false;
      if (DEBUG > 1)       System.err.println("CmsLoginNew: cms.loginUser() failed");
    }
    if ((username != null) && (username.equals(OpenCms.getDefaultUsers().getUserGuest()))) {
      validLogin=false;
      if (DEBUG > 1)       System.err.println("CmsLoginNew: user was guest user");
    }
 else     if ((username != null) && (!cms.userInGroup(username,OpenCms.getDefaultUsers().getGroupUsers())) && (!cms.userInGroup(username,OpenCms.getDefaultUsers().getGroupProjectmanagers()))&& (!cms.userInGroup(username,OpenCms.getDefaultUsers().getGroupAdministrators()))) {
      validLogin=false;
      if (DEBUG > 1)       System.err.println("CmsLoginNew: user was not in default groups");
    }
    if (!validLogin) {
      throw new CmsException("[OpenCms login failed]",CmsException.C_NO_USER);
    }
    if (DEBUG > 0)     System.err.println("CmsLoginNew: user " + username + " logged in");
    session=cms.getRequestContext().getSession(true);
    if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INFO)) {
      OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsLogin] Login user " + username);
    }
    user=cms.readUser(username);
    setStartProjectId(cms,session,startProjectId);
    setStartTaskId(cms,session,startTaskId);
    Hashtable preferences=(Hashtable)user.getAdditionalInfo(I_CmsConstants.C_ADDITIONAL_INFO_PREFERENCES);
    if (preferences == null) {
      preferences=getDefaultPreferences();
    }
    session.removeValue(I_CmsConstants.C_START_LANGUAGE);
    String language=CmsXmlLanguageFile.getCurrentUserLanguage(cms);
    if (DEBUG > 1)     System.err.println("CmsLoginNew: language: " + language);
    preferences.put(I_CmsConstants.C_START_LANGUAGE,language);
    session.putValue(I_CmsConstants.C_ADDITIONAL_INFO_PREFERENCES,preferences);
    langFile=new CmsXmlLanguageFile(cms,language);
    if (DEBUG > 1)     System.err.println("CmsLoginNew: encoding: " + langFile.getEncoding());
    cms.getRequestContext().setEncoding(langFile.getEncoding(),true);
    xmlTemplateDocument.setData("onload","onload='login();'");
  }
 else   if ((!logout) && ((cms.getRequestContext().currentUser()) != null) && (!OpenCms.getDefaultUsers().getUserGuest().equals(cms.getRequestContext().currentUser().getName()))&& ((cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupUsers())) || (cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupProjectmanagers())) || (cms.userInGroup(cms.getRequestContext().currentUser().getName(),OpenCms.getDefaultUsers().getGroupAdministrators())))) {
    if (DEBUG > 1)     System.err.println("CmsLoginNew: re-using old login");
    xmlTemplateDocument.setData("onload","onload='login();'");
  }
 else {
    if (DEBUG > 1)     System.err.println("CmsLoginNew: no login or logout, displaying template");
    xmlTemplateDocument.setData("onload","onload='init();'");
  }
  long id=System.currentTimeMillis();
  xmlTemplateDocument.setData("windowId",new Long(id).toString());
  xmlTemplateDocument.setData("startTaskId",startTaskId);
  xmlTemplateDocument.setData("startProjectId",startProjectId);
  if (DEBUG > 1)   System.err.println("CmsLoginNew: Login process finished");
  return startProcessing(cms,xmlTemplateDocument,"",parameters,templateSelector);
}

{
  CmsI18nInfo i18nInfo;
  if (resource.startsWith(I_CmsWpConstants.C_VFS_PATH_WORKPLACE) || resource.startsWith(I_CmsWpConstants.C_VFS_PATH_LOGIN)) {
    i18nInfo=OpenCms.getWorkplaceManager().getI18nInfo(req,user,project,resource);
  }
 else {
    i18nInfo=m_localeHandler.getI18nInfo(req,user,project,resource);
  }
  Locale locale=null;
  String encoding=null;
  if (req != null) {
    String localeParam;
    if ((localeParam=req.getParameter(I_CmsConstants.C_PARAMETER_LOCALE)) != null) {
      locale=CmsLocaleManager.getLocale(localeParam);
    }
    encoding=req.getParameter(I_CmsConstants.C_PARAMETER_ENCODING);
  }
  if (locale == null) {
    locale=i18nInfo.getLocale();
  }
  if (encoding == null) {
    encoding=i18nInfo.getEncoding();
  }
  if (locale == null) {
    locale=getDefaultLocale();
    if (OpenCms.getLog(this).isDebugEnabled()) {
      OpenCms.getLog(this).debug("No locale found - using default: " + locale);
    }
  }
  if (encoding == null) {
    encoding=OpenCms.getSystemInfo().getDefaultEncoding();
    if (OpenCms.getLog(this).isDebugEnabled()) {
      OpenCms.getLog(this).debug("No encoding found - using default: " + encoding);
    }
  }
  return new CmsI18nInfo(locale,encoding);
}

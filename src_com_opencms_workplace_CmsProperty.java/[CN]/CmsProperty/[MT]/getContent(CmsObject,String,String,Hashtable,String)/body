{
  CmsSession session=cms.getRequestContext().getSession(true);
  String template=null;
  String initial=(String)parameters.get(C_PARA_INITIAL);
  if (initial != null) {
    session.removeValue(C_PARA_FILE);
    session.removeValue(C_PARA_PROPERTYDEF);
    session.removeValue("lasturl");
  }
  String lasturl=getLastUrl(cms,parameters);
  String filename=(String)parameters.get(C_PARA_FILE);
  if (filename != null) {
    session.putValue(C_PARA_FILE,filename);
  }
  String propertydef=(String)parameters.get("selectproperty");
  if (propertydef != null) {
    session.putValue(C_PARA_PROPERTYDEF,propertydef);
  }
  filename=(String)session.getValue(C_PARA_FILE);
  propertydef=(String)session.getValue(C_PARA_PROPERTYDEF);
  CmsResource file=(CmsResource)cms.readFileHeader(filename);
  String edit=(String)parameters.get("EDIT");
  String delete=(String)parameters.get("DELETE");
  String newproperty=(String)parameters.get("NEWPROPERTY");
  String newpropertydef=(String)parameters.get("ORGANIZE");
  if (file.isLockedBy() == cms.getRequestContext().currentUser().getId()) {
    if (edit != null) {
      template="editproperty";
    }
 else     if (delete != null) {
      template="deleteproperty";
    }
 else     if (newproperty != null) {
      template="newproperty";
    }
 else     if (newpropertydef != null) {
      template="newpropertydef";
    }
 else {
      template="ownlocked";
    }
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  if (edit != null) {
    if (propertydef != null) {
      xmlTemplateDocument.setData("PROPERTYDEF",propertydef);
      String newValue=(String)parameters.get("EDITEDPROPERTY");
      if (newValue != null) {
        cms.writeProperty(filename,propertydef,newValue);
        template="ownlocked";
      }
    }
 else {
      template="ownlocked";
    }
  }
  if (delete != null) {
    if (delete.equals("true")) {
      if (propertydef != null) {
        cms.deleteProperty(filename,propertydef);
        template="ownlocked";
      }
    }
  }
  if (newproperty != null) {
    if (newproperty.equals("true")) {
      String newValue=(String)parameters.get("NEWPROPERTYVALUE");
      if ((newValue != null) && (propertydef != null)) {
        String testValue=cms.readProperty(filename,propertydef);
        if (testValue == null) {
          cms.writeProperty(filename,propertydef,newValue);
          template="ownlocked";
        }
 else {
        }
      }
 else {
        template="ownlocked";
      }
    }
  }
  if (newpropertydef != null) {
    if (newpropertydef.equals("true")) {
      String newValue=(String)parameters.get("NEWPROPERTYDEF");
      if (newValue != null) {
        String testValue=cms.readProperty(filename,propertydef);
        if (testValue == null) {
          CmsResourceType type=cms.getResourceType(file.getType());
          CmsPropertydefinition def=cms.createPropertydefinition(newValue,type.getResourceName(),C_PROPERTYDEF_TYPE_NORMAL);
          cms.writePropertydefinition(def);
          template="ownlocked";
        }
 else {
        }
      }
 else {
        template="ownlocked";
      }
    }
  }
  String title=cms.readProperty(file.getAbsolutePath(),C_PROPERTY_TITLE);
  if (title == null) {
    title="";
  }
  CmsUser owner=cms.readOwner(file);
  xmlTemplateDocument.setData("TITLE",title);
  xmlTemplateDocument.setData("STATE",getState(cms,file,new CmsXmlLanguageFile(cms)));
  xmlTemplateDocument.setData("OWNER",owner.getFirstname() + " " + owner.getLastname()+ "("+ owner.getName()+ ")");
  xmlTemplateDocument.setData("GROUP",cms.readGroup(file).getName());
  xmlTemplateDocument.setData("FILENAME",file.getName());
  xmlTemplateDocument.setData("lasturl",lasturl);
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

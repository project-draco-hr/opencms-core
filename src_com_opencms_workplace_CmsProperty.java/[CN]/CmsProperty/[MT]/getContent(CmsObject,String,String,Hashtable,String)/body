{
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String template=null;
  String initial=(String)parameters.get(C_PARA_INITIAL);
  if (initial != null) {
    session.removeValue(C_PARA_RESOURCE);
    session.removeValue(C_PARA_PROPERTYDEF);
    session.removeValue("lasturl");
  }
  String lasturl=getLastUrl(cms,parameters);
  String filename=(String)parameters.get(C_PARA_RESOURCE);
  if (filename != null) {
    session.putValue(C_PARA_RESOURCE,filename);
  }
  String propertydef=(String)parameters.get("selectproperty");
  if (propertydef != null) {
    session.putValue(C_PARA_PROPERTYDEF,propertydef);
  }
  filename=(String)session.getValue(C_PARA_RESOURCE);
  propertydef=(String)session.getValue(C_PARA_PROPERTYDEF);
  CmsResource file=cms.readFileHeader(filename);
  String edit=(String)parameters.get("EDIT");
  String delete=(String)parameters.get("DELETE");
  String newproperty=(String)parameters.get("NEWPROPERTY");
  String newpropertydef=(String)parameters.get("ORGANIZE");
  if (cms.getLock(file).getUserId().equals(cms.getRequestContext().currentUser().getId())) {
    if (edit != null) {
      template="editproperty";
    }
 else {
      if (delete != null) {
        template="deleteproperty";
      }
 else {
        if (newproperty != null) {
          template="newproperty";
        }
 else {
          if (newpropertydef != null) {
            template="newpropertydef";
          }
 else {
            template="ownlocked";
          }
        }
      }
    }
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  CmsXmlLanguageFile lang=xmlTemplateDocument.getLanguageFile();
  if (edit != null) {
    if (propertydef != null) {
      xmlTemplateDocument.setData("PROPERTYDEF",propertydef);
      String newValue=(String)parameters.get("EDITEDPROPERTY");
      if (newValue != null) {
        cms.writeProperty(filename,propertydef,newValue);
        template="ownlocked";
      }
    }
 else {
      template="ownlocked";
    }
  }
  if (delete != null) {
    if (delete.equals("true")) {
      if (propertydef != null) {
        cms.deleteProperty(filename,propertydef);
        template="ownlocked";
      }
    }
  }
  if (newproperty != null) {
    if (newproperty.equals("true")) {
      String newValue=(String)parameters.get("NEWPROPERTYVALUE");
      if ((newValue != null) && (propertydef != null)) {
        String testValue=cms.readProperty(filename,propertydef);
        if (testValue == null) {
          cms.writeProperty(filename,propertydef,newValue);
          template="ownlocked";
        }
 else {
        }
      }
 else {
        template="ownlocked";
      }
    }
  }
  if (newpropertydef != null) {
    if (newpropertydef.equals("true")) {
      String newValue=(String)parameters.get("NEWPROPERTYDEF");
      if (newValue != null) {
        try {
          cms.createPropertydefinition(newValue,file.getType());
          template="ownlocked";
        }
 catch (        CmsException e) {
          StringBuffer errmesg=new StringBuffer();
          errmesg.append(lang.getLanguageValue("error.reason.newprop1") + " '" + newValue+ "' "+ lang.getLanguageValue("error.reason.newprop2")+ " '"+ file.getType()+ "' "+ lang.getLanguageValue("error.reason.newprop3")+ "\n\n");
          errmesg.append(CmsException.getStackTraceAsString(e));
          xmlTemplateDocument.setData("NEWDETAILS",errmesg.toString());
          template="newerror";
        }
      }
 else {
        template="ownlocked";
      }
    }
  }
  String title=cms.readProperty(cms.readAbsolutePath(file),C_PROPERTY_TITLE);
  if (title == null) {
    title="";
  }
  xmlTemplateDocument.setData("TITLE",CmsEncoder.escapeXml(title));
  xmlTemplateDocument.setData("STATE",getState(cms,file,lang));
  xmlTemplateDocument.setData("OWNER","");
  xmlTemplateDocument.setData("GROUP","");
  xmlTemplateDocument.setData("FILENAME",file.getName());
  xmlTemplateDocument.setData("lasturl",lasturl);
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

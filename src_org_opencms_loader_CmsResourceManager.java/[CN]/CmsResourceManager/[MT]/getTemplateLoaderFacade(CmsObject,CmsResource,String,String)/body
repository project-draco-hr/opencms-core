{
  String templateProp=null;
  if (originalUri != null) {
    String context=OpenCms.getSystemInfo().getOpenCmsContext();
    if (originalUri.startsWith(context)) {
      originalUri=originalUri.substring(context.length());
    }
    CmsSitemapEntry entry=OpenCms.getSitemapManager().getEntryForUri(cms,originalUri);
    templateProp=entry.getTemplate(null);
  }
  if (templateProp == null) {
    templateProp=cms.readPropertyObject(resource,templateProperty,true).getValue();
  }
  if (templateProp == null) {
    templateProp=DEFAULT_TEMPLATE;
    if (!cms.existsResource(templateProp,CmsResourceFilter.IGNORE_EXPIRATION)) {
      throw new CmsLoaderException(Messages.get().container(Messages.ERR_NONDEF_PROP_2,templateProperty,cms.getSitePath(resource)));
    }
  }
 else   if (!cms.existsResource(templateProp,CmsResourceFilter.IGNORE_EXPIRATION)) {
    if (cms.existsResource(DEFAULT_TEMPLATE,CmsResourceFilter.IGNORE_EXPIRATION)) {
      templateProp=DEFAULT_TEMPLATE;
    }
  }
  CmsResource template=cms.readFile(templateProp,CmsResourceFilter.IGNORE_EXPIRATION);
  return new CmsTemplateLoaderFacade(getLoader(template),resource,template);
}

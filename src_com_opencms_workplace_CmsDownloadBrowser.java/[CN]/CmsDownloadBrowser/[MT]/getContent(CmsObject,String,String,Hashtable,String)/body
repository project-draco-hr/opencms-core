{
  if (OpenCms.getLog(this).isDebugEnabled() && C_DEBUG) {
    OpenCms.getLog(this).debug("Getting content of element " + ((elementName == null) ? "<root>" : elementName));
    OpenCms.getLog(this).debug("Template file is: " + templateFile);
    OpenCms.getLog(this).debug("Selected template section is: " + ((templateSelector == null) ? "<default>" : templateSelector));
  }
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  try {
    cms.readFileHeader(getConfigFile(cms).getDownGalleryPath());
  }
 catch (  CmsException e) {
    xmlTemplateDocument.setData("ERRORDETAILS",CmsException.getStackTraceAsString(e));
    templateSelector="error";
  }
  if (!"error".equals(templateSelector)) {
    if (parameters.get(C_PARA_INITIAL) != null) {
      session.removeValue(C_PARA_FOLDER);
      session.removeValue(C_PARA_PAGE);
      session.removeValue("_DOWNLIST_");
      session.removeValue(C_PARA_FILTER);
      session.removeValue("numfiles");
      session.removeValue("lasturl");
    }
    String folder=(String)parameters.get(C_PARA_FOLDER);
    if (folder != null) {
      session.putValue(C_PARA_FOLDER,folder);
    }
    folder=(String)session.getValue(C_PARA_FOLDER);
    if (folder == null || "".equals(folder)) {
      folder=getConfigFile(cms).getDownGalleryPath();
      List galleries=cms.getSubFolders(folder);
      if (galleries.size() > 0) {
        folder=cms.readAbsolutePath((CmsResource)galleries.get(0));
        session.putValue(C_PARA_FOLDER,folder);
      }
 else {
        templateSelector="error_no_gallery";
      }
    }
    if (!"error_no_gallery".equals(templateSelector)) {
      String pageText=(String)parameters.get(C_PARA_PAGE);
      String filter=(String)parameters.get(C_PARA_FILTER);
      String deleteAction=(String)parameters.get("action");
      if ("delete".equals(deleteAction)) {
        String deleteResource=(String)parameters.get("resource");
        if (deleteResource != null && !"".equals(deleteResource)) {
          try {
            CmsResource res=cms.readFileHeader(deleteResource);
            if (cms.getLock(res).isNullLock()) {
              cms.lockResource(deleteResource);
            }
            cms.deleteResource(deleteResource,I_CmsConstants.C_DELETE_OPTION_PRESERVE_SIBLINGS);
          }
 catch (          CmsException e) {
            xmlTemplateDocument.setData("ERRORDETAILS",CmsException.getStackTraceAsString(e));
            templateSelector="error";
            return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
          }
        }
      }
      if (pageText == null || "".equals(pageText)) {
        pageText="1";
        parameters.put(C_PARA_PAGE,pageText);
      }
      session.putValue(C_PARA_PAGE,pageText);
      if (filter == null) {
        filter="";
        session.putValue(C_PARA_FILTER,filter);
        parameters.put(C_PARA_FILTER,filter);
      }
      Vector filteredFiles=getFilteredDownList(cms,folder,filter);
      int maxpage=((filteredFiles.size() - 1) / C_DOWNBROWSER_MAXENTRIES) + 1;
      xmlTemplateDocument.setData(C_PARA_FOLDER,CmsEncoder.escape(folder,cms.getRequestContext().getEncoding()));
      xmlTemplateDocument.setData(C_PARA_PAGE,pageText);
      xmlTemplateDocument.setData(C_PARA_FILTER,filter);
      xmlTemplateDocument.setData(C_PARA_MAXPAGE,"" + maxpage);
      session.putValue("_DOWNLIST_",filteredFiles);
      session.putValue("numfiles",new Integer(filteredFiles.size()));
    }
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

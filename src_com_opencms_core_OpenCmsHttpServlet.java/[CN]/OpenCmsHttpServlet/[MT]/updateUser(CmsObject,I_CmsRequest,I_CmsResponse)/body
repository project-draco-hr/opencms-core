{
  HttpSession session=null;
  HttpServletRequest req=(HttpServletRequest)cmsReq.getOriginalRequest();
  session=req.getSession(false);
  if ((session != null)) {
    if (!cms.getRequestContext().currentUser().getName().equals(C_USER_GUEST)) {
      Hashtable sessionData=new Hashtable(4);
      sessionData.put(C_SESSION_USERNAME,cms.getRequestContext().currentUser().getName());
      sessionData.put(C_SESSION_CURRENTGROUP,cms.getRequestContext().currentGroup().getName());
      sessionData.put(C_SESSION_PROJECT,new Integer(cms.getRequestContext().currentProject().getId()));
      Hashtable oldData=(Hashtable)session.getValue(C_SESSION_DATA);
      if (oldData == null) {
        oldData=new Hashtable();
      }
      sessionData.put(C_SESSION_DATA,oldData);
      boolean dirty=false;
      dirty=dirty || (!sessionData.get(C_SESSION_USERNAME).equals(m_sessionStorage.getUserName(session.getId())));
      dirty=dirty || (!sessionData.get(C_SESSION_CURRENTGROUP).equals(m_sessionStorage.getCurrentGroup(session.getId())));
      dirty=dirty || (!sessionData.get(C_SESSION_PROJECT).equals(m_sessionStorage.getCurrentProject(session.getId())));
      m_sessionStorage.putUser(session.getId(),sessionData);
      if ((session.getValue(C_SESSION_IS_DIRTY) != null) || dirty) {
        session.removeValue(C_SESSION_IS_DIRTY);
        try {
          m_opencms.storeSession(session.getId(),sessionData);
        }
 catch (        CmsException exc) {
          if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
            A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[OpenCmsServlet] cannot store session: " + com.opencms.util.Utils.getStackTrace(exc));
          }
        }
      }
      OpenCmsServletNotify notify=null;
      Object sessionValue=session.getValue("NOTIFY");
      if (sessionValue instanceof OpenCmsServletNotify) {
        notify=(OpenCmsServletNotify)sessionValue;
        if (notify == null) {
          notify=new OpenCmsServletNotify(session.getId(),m_sessionStorage);
          session.putValue("NOTIFY",notify);
        }
      }
 else {
        notify=new OpenCmsServletNotify(session.getId(),m_sessionStorage);
        session.putValue("NOTIFY",notify);
      }
    }
  }
}

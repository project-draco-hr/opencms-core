{
  CmsObject cms=new CmsObject();
  HttpSession session=req.getSession(false);
  String user=null;
  if (session != null) {
    user=m_sessionStorage.getUserName(session.getId());
  }
  if (user != null) {
    String group=m_sessionStorage.getCurrentGroup(session.getId());
    Integer project=m_sessionStorage.getCurrentProject(session.getId());
    String siteroot=m_sessionStorage.getCurrentSite(session.getId());
    if (siteroot == null) {
      CmsSite site=A_OpenCms.getSiteManager().matchRequest(req);
      siteroot=site.getSiteRoot();
    }
    m_opencms.initUser(cms,cmsReq,cmsRes,user,group,siteroot,project.intValue(),m_sessionStorage);
  }
 else {
    CmsSite site=A_OpenCms.getSiteManager().matchRequest(req);
    m_opencms.initUser(cms,cmsReq,cmsRes,C_USER_GUEST,C_GROUP_GUEST,site.getSiteRoot(),C_PROJECT_ONLINE_ID,m_sessionStorage);
    if (m_useBasicAuthentication) {
      checkBasicAuthorization(cms,req,res);
    }
  }
  return cms;
}

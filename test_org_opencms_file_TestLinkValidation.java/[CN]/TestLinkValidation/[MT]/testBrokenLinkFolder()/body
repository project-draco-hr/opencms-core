{
  echo("Testing broken link issue with folder");
  CmsObject cms=getCmsObject();
  String resName="testBrokenLinkFile2.html";
  String folderName="testBrokenLinkFolder/";
  String folderName2="testBrokenLinkFolder2/";
  String imgName="testBrokenLinkFile2.gif";
  CmsResource res=cms.createResource(resName,CmsResourceTypeXmlPage.getStaticTypeId());
  List relations=cms.getRelationsForResource(resName,CmsRelationFilter.ALL);
  assertTrue(relations.isEmpty());
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.SOURCES);
  assertTrue(relations.isEmpty());
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.TARGETS);
  assertTrue(relations.isEmpty());
  setContent(cms,resName,"<img src='" + folderName + imgName+ "' >");
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.ALL);
  assertEquals(1,relations.size());
  CmsRelation expected=new CmsRelation(res.getStructureId(),res.getRootPath(),CmsUUID.getNullUUID(),cms.getRequestContext().addSiteRoot(folderName + imgName),CmsRelationType.EMBEDDED_IMAGE);
  assertRelation(expected,(CmsRelation)relations.get(0));
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.SOURCES);
  assertEquals(0,relations.size());
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.TARGETS);
  assertEquals(1,relations.size());
  assertRelation(expected,(CmsRelation)relations.get(0));
  cms.createResource(folderName2,CmsResourceTypeFolder.RESOURCE_TYPE_ID);
  cms.createResource(folderName2 + imgName,CmsResourceTypeImage.getStaticTypeId());
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.ALL);
  assertEquals(1,relations.size());
  assertRelation(expected,(CmsRelation)relations.get(0));
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.SOURCES);
  assertEquals(0,relations.size());
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.TARGETS);
  assertEquals(1,relations.size());
  assertRelation(expected,(CmsRelation)relations.get(0));
  cms.moveResource(folderName2,folderName);
  CmsResource img=cms.readResource(folderName + imgName);
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.ALL);
  assertEquals(1,relations.size());
  expected=new CmsRelation(res.getStructureId(),res.getRootPath(),img.getStructureId(),img.getRootPath(),CmsRelationType.EMBEDDED_IMAGE);
  assertRelation(expected,(CmsRelation)relations.get(0));
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.SOURCES);
  assertEquals(0,relations.size());
  relations=cms.getRelationsForResource(resName,CmsRelationFilter.TARGETS);
  assertEquals(1,relations.size());
  assertRelation(expected,(CmsRelation)relations.get(0));
}

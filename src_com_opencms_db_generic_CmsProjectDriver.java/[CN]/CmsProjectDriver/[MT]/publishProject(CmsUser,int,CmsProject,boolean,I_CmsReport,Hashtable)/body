{
  CmsExportPointDriver discAccess=new CmsExportPointDriver(exportpoints);
  CmsFolder currentFolder=null;
  CmsFile currentFile=null;
  CmsFolder newFolder=null;
  CmsFile newFile=null;
  Vector offlineFolders;
  Vector offlineFiles;
  Vector deletedFolders=new Vector();
  Vector changedResources=new Vector();
  Map folderIdIndex=(Map)new HashMap();
  CmsProject currentProject=readProject(projectId);
  int versionId=1;
  long publishDate=System.currentTimeMillis();
  if (enableHistory) {
    versionId=getBackupVersionId();
    backupProject(currentProject,versionId,publishDate,user);
  }
  offlineFolders=m_driverManager.getVfsAccess().readFolders(projectId,false,true);
  for (int i=0; i < offlineFolders.size(); i++) {
    currentFolder=((CmsFolder)offlineFolders.elementAt(i));
    report.print(report.key("report.publishing"),I_CmsReport.C_FORMAT_NOTE);
    report.println(currentFolder.getAbsolutePath());
    if (currentFolder.isLocked()) {
    }
 else     if (currentFolder.getState() == C_STATE_DELETED) {
      deletedFolders.addElement(currentFolder);
      changedResources.addElement(currentFolder.getResourceName());
    }
 else     if (currentFolder.getState() == C_STATE_NEW) {
      changedResources.addElement(currentFolder.getResourceName());
      String exportKey=checkExport(currentFolder.getAbsolutePath(),exportpoints);
      if (exportKey != null) {
        discAccess.createFolder(currentFolder.getAbsolutePath(),exportKey);
      }
      CmsUUID parentId=(CmsUUID)folderIdIndex.get(currentFolder.getParentId());
      if (parentId == null) {
        CmsFolder currentOnlineParent=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFolder.getRootName() + currentFolder.getParent());
        parentId=currentOnlineParent.getResourceId();
        folderIdIndex.put(currentFolder.getParentId(),parentId);
      }
      try {
        newFolder=m_driverManager.getVfsAccess().createFolder(user,onlineProject,onlineProject,currentFolder,parentId,currentFolder.getResourceName());
        newFolder.setState(C_STATE_UNCHANGED);
        updateResourcestate(newFolder);
      }
 catch (      CmsException e) {
        if (e.getType() == CmsException.C_FILE_EXISTS) {
          CmsFolder onlineFolder=null;
          try {
            onlineFolder=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFolder.getResourceName());
          }
 catch (          CmsException exc) {
            throw exc;
          }
          PreparedStatement stmt=null;
          Connection conn=null;
          try {
            conn=m_sqlManager.getConnection(I_CmsConstants.C_PROJECT_ONLINE_ID);
            stmt=m_sqlManager.getPreparedStatement(conn,"C_RESOURCES_UPDATE_ONLINE");
            stmt.setInt(1,currentFolder.getType());
            stmt.setInt(2,currentFolder.getFlags());
            stmt.setString(3,currentFolder.getOwnerId().toString());
            stmt.setString(4,currentFolder.getGroupId().toString());
            stmt.setInt(5,onlineFolder.getProjectId());
            stmt.setInt(6,currentFolder.getAccessFlags());
            stmt.setInt(7,C_STATE_UNCHANGED);
            stmt.setString(8,currentFolder.isLockedBy().toString());
            stmt.setInt(9,currentFolder.getLauncherType());
            stmt.setString(10,currentFolder.getLauncherClassname());
            stmt.setTimestamp(11,new Timestamp(currentFolder.getDateLastModified()));
            stmt.setString(12,currentFolder.getResourceLastModifiedBy().toString());
            stmt.setInt(13,0);
            stmt.setString(14,onlineFolder.getFileId().toString());
            stmt.setString(15,onlineFolder.getResourceId().toString());
            stmt.executeUpdate();
            newFolder=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFolder.getResourceName());
          }
 catch (          SQLException exc) {
            throw m_sqlManager.getCmsException(this,null,CmsException.C_SQL_ERROR,exc);
          }
 finally {
            m_sqlManager.closeAll(conn,stmt,null);
          }
        }
 else {
          throw e;
        }
      }
      folderIdIndex.put(currentFolder.getResourceId(),newFolder.getResourceId());
      Map props=new HashMap();
      try {
        props=m_driverManager.getVfsAccess().readProperties(projectId,currentFolder,currentFolder.getType());
        m_driverManager.getVfsAccess().writeProperties(props,onlineProject.getId(),newFolder,newFolder.getType());
      }
 catch (      CmsException exc) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, copy properties for " + newFolder.toString() + " Message= "+ exc.getMessage());
        }
      }
      if (enableHistory) {
        backupResource(projectId,currentFolder,new byte[0],props,versionId,publishDate);
      }
      currentFolder.setState(C_STATE_UNCHANGED);
      updateResourcestate(currentFolder);
    }
 else     if (currentFolder.getState() == C_STATE_CHANGED) {
      changedResources.addElement(currentFolder.getResourceName());
      String exportKey=checkExport(currentFolder.getAbsolutePath(),exportpoints);
      if (exportKey != null) {
        discAccess.createFolder(currentFolder.getAbsolutePath(),exportKey);
      }
      CmsFolder onlineFolder=null;
      try {
        onlineFolder=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFolder.getResourceName());
      }
 catch (      CmsException exc) {
        if (exc.getType() == CmsException.C_NOT_FOUND) {
          CmsUUID parentId=(CmsUUID)folderIdIndex.get(currentFolder.getParentId());
          if (parentId == null) {
            CmsFolder currentOnlineParent=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFolder.getRootName() + currentFolder.getParent());
            parentId=currentOnlineParent.getResourceId();
            folderIdIndex.put(currentFolder.getParentId(),parentId);
          }
          onlineFolder=m_driverManager.getVfsAccess().createFolder(user,onlineProject,onlineProject,currentFolder,parentId,currentFolder.getResourceName());
          onlineFolder.setState(C_STATE_UNCHANGED);
          updateResourcestate(onlineFolder);
        }
 else {
          throw exc;
        }
      }
      Connection conn=null;
      PreparedStatement stmt=null;
      try {
        conn=m_sqlManager.getConnection(I_CmsConstants.C_PROJECT_ONLINE_ID);
        stmt=m_sqlManager.getPreparedStatement(conn,"C_RESOURCES_UPDATE_ONLINE");
        stmt.setInt(1,currentFolder.getType());
        stmt.setInt(2,currentFolder.getFlags());
        stmt.setString(3,currentFolder.getOwnerId().toString());
        stmt.setString(4,currentFolder.getGroupId().toString());
        stmt.setInt(5,onlineFolder.getProjectId());
        stmt.setInt(6,currentFolder.getAccessFlags());
        stmt.setInt(7,C_STATE_UNCHANGED);
        stmt.setString(8,currentFolder.isLockedBy().toString());
        stmt.setInt(9,currentFolder.getLauncherType());
        stmt.setString(10,currentFolder.getLauncherClassname());
        stmt.setTimestamp(11,new Timestamp(currentFolder.getDateLastModified()));
        stmt.setString(12,currentFolder.getResourceLastModifiedBy().toString());
        stmt.setInt(13,0);
        stmt.setString(14,onlineFolder.getFileId().toString());
        stmt.setString(15,onlineFolder.getResourceId().toString());
        stmt.executeUpdate();
      }
 catch (      SQLException e) {
        throw m_sqlManager.getCmsException(this,null,CmsException.C_SQL_ERROR,e);
      }
 finally {
        m_sqlManager.closeAll(conn,stmt,null);
      }
      folderIdIndex.put(currentFolder.getResourceId(),onlineFolder.getResourceId());
      Map props=new HashMap();
      try {
        deleteAllProperties(onlineProject.getId(),onlineFolder);
        props=m_driverManager.getVfsAccess().readProperties(projectId,currentFolder,currentFolder.getType());
        m_driverManager.getVfsAccess().writeProperties(props,onlineProject.getId(),onlineFolder,currentFolder.getType());
      }
 catch (      CmsException exc) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, deleting properties for " + onlineFolder.toString() + " Message= "+ exc.getMessage());
        }
      }
      if (enableHistory) {
        backupResource(projectId,currentFolder,new byte[0],props,versionId,publishDate);
      }
      currentFolder.setState(C_STATE_UNCHANGED);
      updateResourcestate(currentFolder);
    }
  }
  offlineFiles=m_driverManager.getVfsAccess().readFiles(projectId,false,true);
  for (int i=0; i < offlineFiles.size(); i++) {
    currentFile=((CmsFile)offlineFiles.elementAt(i));
    report.print(report.key("report.publishing"),I_CmsReport.C_FORMAT_NOTE);
    report.println(currentFile.getAbsolutePath());
    if (!currentFile.isLocked()) {
      removeTemporaryFile(currentFile);
    }
    if (currentFile.isLocked()) {
    }
 else     if (currentFile.getName().startsWith(C_TEMP_PREFIX)) {
      deleteAllProperties(projectId,currentFile);
      removeFile(projectId,currentFile.getResourceName());
    }
 else     if (currentFile.getState() == C_STATE_DELETED) {
      changedResources.addElement(currentFile.getResourceName());
      String exportKey=checkExport(currentFile.getAbsolutePath(),exportpoints);
      if (exportKey != null) {
        try {
          discAccess.removeResource(currentFile.getAbsolutePath(),exportKey);
        }
 catch (        Exception ex) {
        }
      }
      CmsFile currentOnlineFile=m_driverManager.getVfsAccess().readFile(onlineProject.getId(),onlineProject.getId(),currentFile.getResourceName());
      if (enableHistory) {
        Map props=m_driverManager.getVfsAccess().readProperties(projectId,currentFile,currentFile.getType());
        backupResource(projectId,currentFile,currentFile.getContents(),props,versionId,publishDate);
      }
      try {
        deleteAllProperties(onlineProject.getId(),currentOnlineFile);
        deleteAllProperties(projectId,currentFile);
      }
 catch (      CmsException exc) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, deleting properties for " + currentOnlineFile.toString() + " Message= "+ exc.getMessage());
        }
      }
      try {
        m_driverManager.getVfsAccess().deleteResource(currentOnlineFile);
        m_driverManager.getVfsAccess().deleteResource(currentFile);
      }
 catch (      CmsException exc) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, deleting resource for " + currentOnlineFile.toString() + " Message= "+ exc.getMessage());
        }
      }
    }
 else     if (currentFile.getState() == C_STATE_CHANGED) {
      changedResources.addElement(currentFile.getResourceName());
      String exportKey=checkExport(currentFile.getAbsolutePath(),exportpoints);
      if (exportKey != null) {
        byte[] contents=currentFile.getContents();
        String encoding=m_driverManager.getVfsAccess().readProperty(I_CmsConstants.C_PROPERTY_CONTENT_ENCODING,projectId,currentFile,currentFile.getType());
        if (encoding != null) {
          try {
            contents=(new String(contents,encoding)).getBytes();
          }
 catch (          UnsupportedEncodingException uex) {
          }
        }
        discAccess.writeFile(currentFile.getAbsolutePath(),exportKey,contents);
      }
      CmsFile onlineFile=null;
      try {
        onlineFile=m_driverManager.getVfsAccess().readFileHeader(onlineProject.getId(),currentFile.getResourceName(),false);
      }
 catch (      CmsException exc) {
        if (exc.getType() == CmsException.C_NOT_FOUND) {
          CmsUUID parentId=(CmsUUID)folderIdIndex.get(currentFile.getParentId());
          if (parentId == null) {
            CmsFolder currentOnlineParent=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFile.getRootName() + currentFile.getParent());
            parentId=currentOnlineParent.getResourceId();
            folderIdIndex.put(currentFile.getParentId(),parentId);
          }
          currentFile.setState(C_STATE_UNCHANGED);
          onlineFile=m_driverManager.getVfsAccess().createFile(onlineProject,onlineProject,currentFile,user.getId(),parentId,currentFile.getResourceName());
        }
      }
      Connection conn=null;
      PreparedStatement stmt=null;
      try {
        conn=m_sqlManager.getConnection(I_CmsConstants.C_PROJECT_ONLINE_ID);
        stmt=m_sqlManager.getPreparedStatement(conn,"C_RESOURCES_UPDATE_ONLINE");
        stmt.setInt(1,currentFile.getType());
        stmt.setInt(2,currentFile.getFlags());
        stmt.setString(3,currentFile.getOwnerId().toString());
        stmt.setString(4,currentFile.getGroupId().toString());
        stmt.setInt(5,onlineFile.getProjectId());
        stmt.setInt(6,currentFile.getAccessFlags());
        stmt.setInt(7,C_STATE_UNCHANGED);
        stmt.setString(8,currentFile.isLockedBy().toString());
        stmt.setInt(9,currentFile.getLauncherType());
        stmt.setString(10,currentFile.getLauncherClassname());
        stmt.setTimestamp(11,new Timestamp(currentFile.getDateLastModified()));
        stmt.setString(12,currentFile.getResourceLastModifiedBy().toString());
        stmt.setInt(13,currentFile.getLength());
        stmt.setString(14,onlineFile.getFileId().toString());
        stmt.setString(15,onlineFile.getResourceId().toString());
        stmt.executeUpdate();
        stmt.close();
        m_driverManager.getVfsAccess().writeFileContent(onlineFile.getFileId(),currentFile.getContents(),I_CmsConstants.C_PROJECT_ONLINE_ID,false);
      }
 catch (      SQLException e) {
        throw m_sqlManager.getCmsException(this,null,CmsException.C_SQL_ERROR,e);
      }
 finally {
        m_sqlManager.closeAll(conn,stmt,null);
      }
      Map props=new HashMap();
      try {
        deleteAllProperties(onlineProject.getId(),onlineFile);
        props=m_driverManager.getVfsAccess().readProperties(projectId,currentFile,currentFile.getType());
        m_driverManager.getVfsAccess().writeProperties(props,onlineProject.getId(),onlineFile,currentFile.getType());
      }
 catch (      CmsException exc) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, deleting properties for " + onlineFile.toString() + " Message= "+ exc.getMessage());
        }
      }
      if (enableHistory) {
        backupResource(projectId,currentFile,currentFile.getContents(),props,versionId,publishDate);
      }
      currentFile.setState(C_STATE_UNCHANGED);
      updateResourcestate(currentFile);
    }
 else     if (currentFile.getState() == C_STATE_NEW) {
      changedResources.addElement(currentFile.getResourceName());
      String exportKey=checkExport(currentFile.getAbsolutePath(),exportpoints);
      if (exportKey != null) {
        byte[] contents=currentFile.getContents();
        String encoding=m_driverManager.getVfsAccess().readProperty(I_CmsConstants.C_PROPERTY_CONTENT_ENCODING,projectId,currentFile,currentFile.getType());
        if (encoding != null) {
          try {
            contents=(new String(contents,encoding)).getBytes();
          }
 catch (          UnsupportedEncodingException uex) {
          }
        }
        discAccess.writeFile(currentFile.getAbsolutePath(),exportKey,contents);
      }
      CmsUUID parentId=(CmsUUID)folderIdIndex.get(currentFile.getParentId());
      if (parentId == null) {
        CmsFolder currentOnlineParent=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFile.getRootName() + currentFile.getParent());
        parentId=currentOnlineParent.getResourceId();
        folderIdIndex.put(currentFile.getParentId(),parentId);
      }
      try {
        newFile=m_driverManager.getVfsAccess().createFile(onlineProject,onlineProject,currentFile,user.getId(),parentId,currentFile.getResourceName());
        newFile.setState(C_STATE_UNCHANGED);
        updateResourcestate(newFile);
      }
 catch (      CmsException e) {
        if (e.getType() == CmsException.C_FILE_EXISTS) {
          CmsFile onlineFile=null;
          try {
            onlineFile=m_driverManager.getVfsAccess().readFileHeader(onlineProject.getId(),currentFile.getResourceName(),false);
          }
 catch (          CmsException exc) {
            throw exc;
          }
          Connection conn=null;
          PreparedStatement stmt=null;
          try {
            conn=m_sqlManager.getConnection(I_CmsConstants.C_PROJECT_ONLINE_ID);
            stmt=m_sqlManager.getPreparedStatement(conn,"C_RESOURCES_UPDATE_ONLINE");
            stmt.setInt(1,currentFile.getType());
            stmt.setInt(2,currentFile.getFlags());
            stmt.setString(3,currentFile.getOwnerId().toString());
            stmt.setString(4,currentFile.getGroupId().toString());
            stmt.setInt(5,onlineFile.getProjectId());
            stmt.setInt(6,currentFile.getAccessFlags());
            stmt.setInt(7,C_STATE_UNCHANGED);
            stmt.setString(8,currentFile.isLockedBy().toString());
            stmt.setInt(9,currentFile.getLauncherType());
            stmt.setString(10,currentFile.getLauncherClassname());
            stmt.setTimestamp(11,new Timestamp(currentFile.getDateLastModified()));
            stmt.setString(12,currentFile.getResourceLastModifiedBy().toString());
            stmt.setInt(13,currentFile.getLength());
            stmt.setString(14,onlineFile.getFileId().toString());
            stmt.setString(15,onlineFile.getResourceId().toString());
            stmt.executeUpdate();
            m_driverManager.getVfsAccess().writeFileContent(onlineFile.getFileId(),currentFile.getContents(),I_CmsConstants.C_PROJECT_ONLINE_ID,false);
            newFile=m_driverManager.getVfsAccess().readFile(onlineProject.getId(),onlineProject.getId(),currentFile.getResourceName());
          }
 catch (          SQLException exc) {
            throw m_sqlManager.getCmsException(this,null,CmsException.C_SQL_ERROR,exc);
          }
 finally {
            m_sqlManager.closeAll(conn,stmt,null);
          }
        }
 else {
          throw e;
        }
      }
      Map props=new HashMap();
      try {
        props=m_driverManager.getVfsAccess().readProperties(projectId,currentFile,currentFile.getType());
        m_driverManager.getVfsAccess().writeProperties(props,onlineProject.getId(),newFile,newFile.getType());
      }
 catch (      CmsException exc) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, copy properties for " + newFile.toString() + " Message= "+ exc.getMessage());
        }
      }
      if (enableHistory) {
        backupResource(projectId,currentFile,currentFile.getContents(),props,versionId,publishDate);
      }
      currentFile.setState(C_STATE_UNCHANGED);
      updateResourcestate(currentFile);
    }
  }
  for (int i=deletedFolders.size() - 1; i > -1; i--) {
    currentFolder=((CmsFolder)deletedFolders.elementAt(i));
    report.print(report.key("report.deleting"),I_CmsReport.C_FORMAT_NOTE);
    report.println(currentFolder.getAbsolutePath());
    String exportKey=checkExport(currentFolder.getAbsolutePath(),exportpoints);
    if (exportKey != null) {
      discAccess.removeResource(currentFolder.getAbsolutePath(),exportKey);
    }
    if (enableHistory) {
      Map props=m_driverManager.getVfsAccess().readProperties(projectId,currentFolder,currentFolder.getType());
      backupResource(projectId,currentFolder,new byte[0],props,versionId,publishDate);
    }
    CmsResource delOnlineFolder=m_driverManager.getVfsAccess().readFolder(onlineProject.getId(),currentFolder.getResourceName());
    try {
      deleteAllProperties(onlineProject.getId(),delOnlineFolder);
      deleteAllProperties(projectId,currentFolder);
    }
 catch (    CmsException exc) {
      if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,"[CmsProjectDriver] error publishing, deleting properties for " + currentFolder.toString() + " Message= "+ exc.getMessage());
      }
    }
    removeFolderForPublish(onlineProject.getId(),currentFolder.getResourceName());
    removeFolderForPublish(projectId,currentFolder.getResourceName());
  }
  return changedResources;
}

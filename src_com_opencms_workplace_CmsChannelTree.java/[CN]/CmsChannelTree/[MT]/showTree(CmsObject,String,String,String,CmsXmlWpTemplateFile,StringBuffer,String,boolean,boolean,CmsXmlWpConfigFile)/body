{
  String newtab=new String();
  String folderimg=new String();
  String treeswitch=new String();
  CmsResource lastFolder=null;
  Vector subfolders=new Vector();
  Vector list=new Vector();
  List untestedSubfolders=(List)new ArrayList();
  List untestedSubfiles=(List)new ArrayList();
  cms.getRequestContext().saveSiteRoot();
  cms.getRequestContext().setSiteRoot(I_CmsConstants.VFS_FOLDER_COS);
  List untestedlist=cms.getSubFolders(curfolder);
  for (int i=0; i < untestedlist.size(); i++) {
    CmsFolder subfolder=(CmsFolder)untestedlist.get(i);
    if (checkAccess(cms,subfolder)) {
      list.addElement(subfolder);
    }
  }
  if (displayFiles) {
    List untestedfileslist=cms.getFilesInFolder(curfolder);
    for (int i=0; i < untestedfileslist.size(); i++) {
      CmsFile file=(CmsFile)untestedfileslist.get(i);
      if (checkAccess(cms,file)) {
        list.addElement(file);
      }
    }
  }
  Enumeration en=list.elements();
  if (list.size() > 0) {
    lastFolder=(CmsResource)list.lastElement();
  }
 else {
    lastFolder=null;
  }
  while (en.hasMoreElements()) {
    CmsResource res=(CmsResource)en.nextElement();
    if (checkAccess(cms,res)) {
      subfolders=new Vector();
      if (res.isFolder()) {
        untestedSubfolders=cms.getSubFolders(cms.getSitePath(res));
        for (int i=0; i < untestedSubfolders.size(); i++) {
          CmsFolder subfolder=(CmsFolder)untestedSubfolders.get(i);
          if (checkAccess(cms,subfolder)) {
            subfolders.addElement(subfolder);
          }
        }
        if (displayFiles) {
          untestedSubfiles=cms.getFilesInFolder(cms.getSitePath(res));
          for (int i=0; i < untestedSubfiles.size(); i++) {
            CmsFile subfile=(CmsFile)untestedSubfiles.get(i);
            if (checkAccess(cms,subfile)) {
              subfolders.addElement(subfile);
            }
          }
        }
      }
      if (res.isFolder()) {
        if (cms.getSitePath(res).equals(filelist)) {
          folderimg=template.getProcessedDataValue(C_TREEIMG_FOLDEROPEN,this);
        }
 else {
          folderimg=template.getProcessedDataValue(C_TREEIMG_FOLDERCLOSE,this);
        }
      }
 else {
        I_CmsResourceType type=OpenCms.getResourceManager().getResourceType(res.getTypeId());
        String icon=getIcon(cms,type,configFile);
        template.setData("icon",CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getServletUrl() + configFile.getWpPicturePath() + icon);
        folderimg=template.getProcessedDataValue("TREEIMG_FILE",this);
      }
      if (cms.getSitePath(res).equals(cms.getSitePath(lastFolder))) {
        if (subfolders.size() > 0) {
          if (endfolder.startsWith(cms.getSitePath(res))) {
            template.setData(C_TREELINK,C_WP_CHANNEL_TREE + "?" + C_PARA_FOLDERTREE+ "="+ CmsEncoder.escape(curfolder,cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_MEND,this);
          }
 else {
            template.setData(C_TREELINK,C_WP_CHANNEL_TREE + "?" + C_PARA_FOLDERTREE+ "="+ CmsEncoder.escape(cms.getSitePath(res),cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_PEND,this);
          }
        }
 else {
          treeswitch=template.getProcessedDataValue(C_TREEIMG_END,this);
        }
      }
 else {
        if (subfolders.size() > 0) {
          if (endfolder.startsWith(cms.getSitePath(res))) {
            template.setData(C_TREELINK,C_WP_CHANNEL_TREE + "?" + C_PARA_FOLDERTREE+ "="+ CmsEncoder.escape(curfolder,cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_MCROSS,this);
          }
 else {
            template.setData(C_TREELINK,C_WP_CHANNEL_TREE + "?" + C_PARA_FOLDERTREE+ "="+ CmsEncoder.escape(cms.getSitePath(res),cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_PCROSS,this);
          }
        }
 else {
          treeswitch=template.getProcessedDataValue(C_TREEIMG_CROSS,this);
        }
      }
      if (cms.getSitePath(res).equals(cms.getSitePath(lastFolder))) {
        newtab=tab + template.getProcessedDataValue(C_TREEIMG_EMPTY,this);
      }
 else {
        newtab=tab + template.getProcessedDataValue(C_TREEIMG_VERT,this);
      }
      if (cms.isInsideCurrentProject(res)) {
        template.setData(C_TREESTYLE,C_FILE_INPROJECT);
      }
 else {
        template.setData(C_TREESTYLE,C_FILE_NOTINPROJECT);
      }
      template.setData(C_FILELIST,CmsWorkplaceAction.getExplorerFileUri(CmsXmlTemplateLoader.getRequest(cms.getRequestContext()).getOriginalRequest()) + "?" + C_PARA_FILELIST+ "="+ cms.getSitePath(res));
      template.setData(C_TREELIST,C_WP_EXPLORER_TREE + "?" + C_PARA_FILELIST+ "="+ cms.getSitePath(res));
      template.setData(C_TREEENTRY,res.getName());
      template.setData(C_TREEVAR,cms.getSitePath(res));
      template.setData(C_TREETAB,tab);
      template.setData(C_TREEFOLDER,folderimg);
      template.setData(C_TREESWITCH,treeswitch);
      if (cms.isInsideCurrentProject(res)) {
        template.setData(C_TREESTYLE,C_FILE_INPROJECT);
        output.append(template.getProcessedDataValue(C_TREELINE,this));
      }
 else {
        template.setData(C_TREESTYLE,C_FILE_NOTINPROJECT);
        output.append(template.getProcessedDataValue(C_TREELINEDISABLED,this));
      }
      if ((endfolder.startsWith(cms.getSitePath(res))) && (endfolder.endsWith("/"))) {
        showTree(cms,cms.getSitePath(res),endfolder,filelist,template,output,newtab,displayFiles,offselect,configFile);
      }
    }
  }
  cms.getRequestContext().restoreSiteRoot();
}

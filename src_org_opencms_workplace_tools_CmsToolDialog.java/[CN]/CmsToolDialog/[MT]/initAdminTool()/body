{
  Map params=new HashMap(getJsp().getRequest().getParameterMap());
  getToolManager().initParams(this,getParamPath(),getParamRoot());
  if (!useNewStyle()) {
    params.put(PARAM_STYLE,"new");
    setParamStyle("new");
  }
  try {
    CmsDialog wp=(CmsDialog)this;
    if (CmsStringUtil.isEmptyOrWhitespaceOnly(wp.getParamCloseLink())) {
      if (!getToolManager().getRootToolPath(this).equals(getToolManager().getCurrentToolPath(this))) {
        Map argMap=new HashMap();
        String toolParams=getToolManager().resolveAdminTool(getParamPath()).getHandler().getParameters();
        if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(toolParams)) {
          toolParams=wp.resolveMacros(toolParams);
          Iterator itArgs=CmsStringUtil.splitAsList(toolParams,"&").iterator();
          while (itArgs.hasNext()) {
            String arg=(String)itArgs.next();
            int pos=arg.indexOf("=");
            argMap.put(arg.substring(0,pos),arg.substring(pos + 1));
          }
        }
        wp.setParamCloseLink(getToolManager().linkForPath(getJsp(),getParentPath(),argMap));
        params.put(CmsDialog.PARAM_CLOSELINK,wp.getParamCloseLink());
      }
    }
  }
 catch (  Exception e) {
  }
  return params;
}

{
  try {
    String fullResourceName=computeFullResourceName();
    String newResourceParam=fullResourceName;
    String targetName=getParamLinkTarget();
    if (targetName == null) {
      targetName="";
    }
    boolean restoreSiteRoot=false;
    try {
      if (CmsSiteManager.getSiteRoot(targetName) != null) {
        String siteRootFolder=getCms().getRequestContext().getSiteRoot();
        if (siteRootFolder.endsWith("/")) {
          siteRootFolder=siteRootFolder.substring(0,siteRootFolder.length() - 1);
        }
        fullResourceName=siteRootFolder + fullResourceName;
        getCms().getRequestContext().saveSiteRoot();
        getCms().getRequestContext().setSiteRoot("/");
        restoreSiteRoot=true;
      }
      boolean isFolder=false;
      CmsResource targetRes=getCms().readResource(targetName);
      isFolder=targetRes.isFolder();
      if (isFolder) {
        if (targetName.endsWith("/")) {
          targetName=targetName.substring(0,targetName.length() - 1);
        }
        getCms().copyResource(targetName,fullResourceName,CmsResource.COPY_AS_SIBLING);
      }
 else {
        List targetProperties=null;
        boolean keepProperties=Boolean.valueOf(getParamKeepProperties()).booleanValue();
        if (keepProperties) {
          try {
            targetProperties=getCms().readPropertyObjects(targetName,false);
          }
 catch (          Exception e) {
            LOG.error(e);
          }
        }
        getCms().createSibling(targetName,fullResourceName,targetProperties);
      }
    }
  finally {
      if (restoreSiteRoot) {
        getCms().getRequestContext().restoreSiteRoot();
      }
    }
    setParamResource(newResourceParam);
    setResourceCreated(true);
  }
 catch (  Throwable e) {
    setParamMessage(Messages.get().getBundle(getLocale()).key(Messages.ERR_CREATE_LINK_0));
    includeErrorpage(this,e);
  }
}

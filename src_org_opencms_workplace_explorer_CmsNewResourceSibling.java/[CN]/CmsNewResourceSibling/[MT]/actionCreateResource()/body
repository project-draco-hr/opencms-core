{
  try {
    String fullResourceName=computeFullResourceName();
    String newResourceParam=fullResourceName;
    String targetName=getParamLinkTarget();
    if (targetName == null) {
      targetName="";
    }
    boolean restoreSiteRoot=false;
    try {
      if (CmsSiteManager.getSiteRoot(targetName) != null) {
        String siteRootFolder=getCms().getRequestContext().getSiteRoot();
        if (siteRootFolder.endsWith("/")) {
          siteRootFolder=siteRootFolder.substring(0,siteRootFolder.length() - 1);
        }
        fullResourceName=siteRootFolder + fullResourceName;
        getCms().getRequestContext().saveSiteRoot();
        getCms().getRequestContext().setSiteRoot("/");
        restoreSiteRoot=true;
      }
      boolean isFolder=false;
      CmsResource targetRes=getCms().readResource(targetName);
      isFolder=targetRes.isFolder();
      if (isFolder) {
        if (targetName.endsWith("/")) {
          targetName=targetName.substring(0,targetName.length() - 1);
        }
        getCms().copyResource(targetName,fullResourceName,I_CmsConstants.C_COPY_AS_SIBLING);
      }
 else {
        List targetProperties=null;
        boolean keepProperties=Boolean.valueOf(getParamKeepProperties()).booleanValue();
        if (keepProperties) {
          try {
            targetProperties=getCms().readPropertyObjects(targetName,false);
          }
 catch (          Exception e) {
            OpenCms.getLog(this).error("Error reading properties of " + targetName,e);
          }
        }
        getCms().createSibling(targetName,fullResourceName,targetProperties);
      }
    }
  finally {
      if (restoreSiteRoot) {
        getCms().getRequestContext().restoreSiteRoot();
      }
    }
    setParamResource(newResourceParam);
  }
 catch (  CmsException e) {
    getJsp().getRequest().setAttribute(C_SESSION_WORKPLACE_CLASS,this);
    setParamErrorstack(e.getStackTraceAsString());
    setParamMessage(key("error.message.newlink"));
    setParamReasonSuggestion(key("error.reason.newlink") + "<br>\n" + key("error.suggestion.newlink")+ "\n");
    getJsp().include(C_FILE_DIALOG_SCREEN_ERROR);
  }
}

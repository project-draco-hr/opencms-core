{
  m_mode=action;
  setActionFlags();
  setCommonParameters();
  m_checkinBean.clearModules();
  for (  String moduleName : getSelectedModules()) {
    m_checkinBean.addModuleToExport(moduleName);
  }
  int result=m_checkinBean.checkIn();
  String log=m_checkinBean.getLogText();
  String message=null;
  boolean error=false;
switch (action) {
case checkIn:
    String messageToSave=m_checkinBean.getCommitMessage();
  String emailToSave=m_checkinBean.getGitUserEmail();
String userToSave=m_checkinBean.getGitUserName();
CmsObject cms=m_checkinBean.getCmsObject();
CmsUser user=cms.getRequestContext().getCurrentUser();
setUserInfo(user,ADDINFO_USER,userToSave);
setUserInfo(user,ADDINFO_EMAIL,emailToSave);
setUserInfo(user,ADDINFO_MESSAGE,messageToSave);
try {
cms.writeUser(user);
}
 catch (CmsException e) {
LOG.error(e.getLocalizedMessage(),e);
}
List<Button> resetButtons=new ArrayList<Button>();
Button resetHead=new Button("Reset head");
resetHead.setDescription("Reset local repository to HEAD. You lose uncommitted changes but get a clean repository.");
resetHead.addClickListener(new ClickListener(){
private static final long serialVersionUID=1L;
public void buttonClick(ClickEvent event){
runAction(ActionType.resetHead);
}
}
);
Button resetRemoteHead=new Button("Reset remote head");
resetRemoteHead.setDescription("Reset local repository to the head of the remote branch for conflict resolving. You lose all local changes, even committed, but unpushed ones.");
resetRemoteHead.addClickListener(new ClickListener(){
private static final long serialVersionUID=1L;
public void buttonClick(ClickEvent event){
runAction(ActionType.resetRemoteHead);
}
}
);
if (result == 0) {
message="Modules exported and checked in successfully.";
}
 else if (result == 10) {
message="Export and check in failed because of an unclean repository. Please consult the log file.";
error=true;
resetButtons.add(resetRemoteHead);
resetButtons.add(resetHead);
}
 else {
message="Export and check in failed. Please consult the log file.";
error=true;
resetButtons.add(resetRemoteHead);
}
CmsGitActionResultPanel panel=new CmsGitActionResultPanel(message,log,error,resetButtons);
addAsWindow(panel);
break;
case checkOut:
if (result == 0) {
message="Checkout successful.";
}
 else {
message="Checkout failed, please see the log file for details.";
}
CmsGitActionResultPanel checkoutResult=new CmsGitActionResultPanel(message,log,error,new ArrayList<Button>());
addAsWindow(checkoutResult);
break;
case resetHead:
if (result == 0) {
message="The repository was reset. You can repeat your commit with the \"Pull first\" option (WARNING: Be aware that you may overwrite changes from the remote repository.)";
}
 else {
error=true;
message="Reset failed. You may have an incorrect configuration or you have to manually resolve a Git conflict.";
}
CmsGitActionResultPanel resetResult=new CmsGitActionResultPanel(message,log,error,new ArrayList<Button>());
addAsWindow(resetResult);
break;
case resetRemoteHead:
if (result == 0) {
message="The repository was reset. You can repeat your commit. Maybe you need the \"Pull first\" option to avoid conflicts.";
}
 else {
error=true;
message="Reset failed. You may have an incorrect configuration or you have to manually resolve a GIT conflict. ";
}
CmsGitActionResultPanel resetRemoteResult=new CmsGitActionResultPanel(message,log,error,new ArrayList<Button>());
addAsWindow(resetRemoteResult);
break;
default :
}
}

{
  if (in instanceof ByteArrayInputStream) {
    return readFully(in,in.available());
  }
  int xferSize=in.available();
  byte[] xfer=new byte[xferSize == 0 ? 2048 : xferSize];
  ByteArrayOutputStream out=new ByteArrayOutputStream(xfer.length);
  for (int bytesRead=in.read(xfer,0,xfer.length); bytesRead >= 0; bytesRead=in.read(xfer,0,xfer.length)) {
    if (bytesRead > 0) {
      out.write(xfer,0,bytesRead);
    }
  }
  in.close();
  out.close();
  return out.toByteArray();
}

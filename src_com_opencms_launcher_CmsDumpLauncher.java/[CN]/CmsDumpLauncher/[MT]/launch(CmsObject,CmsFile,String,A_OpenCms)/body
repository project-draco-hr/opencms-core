{
  byte[] result=null;
  CmsElementCache elementCache=null;
  boolean elementCacheEnabled=cms.getRequestContext().isElementCacheEnabled();
  String uri=cms.getRequestContext().getUri();
  String templateClass=startTemplateClass;
  if (templateClass == null || "".equals(templateClass) || (startTemplateClass.equals(C_UNKNOWN_LAUNCHER))) {
    templateClass="com.opencms.template.CmsDumpTemplate";
  }
  if (elementCacheEnabled) {
    elementCache=cms.getRequestContext().getElementCache();
    CmsUriDescriptor uriDesc=new CmsUriDescriptor(uri);
    CmsUriLocator uriLoc=elementCache.getUriLocator();
    CmsUri cmsUri=uriLoc.get(uriDesc);
    if (cmsUri == null) {
      CmsElementDescriptor elemDesc=new CmsElementDescriptor(templateClass,file.getAbsolutePath());
      cmsUri=new CmsUri(elemDesc,null,(CmsElementDefinitionCollection)null);
      elementCache.getUriLocator().put(uriDesc,cmsUri);
    }
  }
  Hashtable newParameters=new Hashtable();
  I_CmsRequest req=cms.getRequestContext().getRequest();
  String datafor=req.getParameter("datafor");
  if (datafor == null) {
    datafor="";
  }
 else {
    if (!"".equals(datafor)) {
      datafor=datafor + ".";
    }
  }
  Enumeration urlParameterNames=req.getParameterNames();
  while (urlParameterNames.hasMoreElements()) {
    String pname=(String)urlParameterNames.nextElement();
    String paramValue=req.getParameter(pname);
    if (paramValue != null) {
      if ((!"datafor".equals(pname)) && (!"_clearcache".equals(pname))) {
        newParameters.put(datafor + pname,paramValue);
      }
    }
 else {
      if ((A_OpenCms.isLogging() && I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING)) {
        A_OpenCms.log(C_OPENCMS_INFO,getClassName() + "Empty URL parameter \"" + pname+ "\" found.");
      }
    }
  }
  if (elementCacheEnabled) {
    result=elementCache.callCanonicalRoot(cms,newParameters);
  }
 else {
    Object tmpl=getTemplateClass(cms,templateClass);
    if (!(tmpl instanceof com.opencms.template.I_CmsDumpTemplate)) {
      String errorMessage="Error in " + file.getAbsolutePath() + ": "+ templateClass+ " is not a Cms dump template class.";
      if ((A_OpenCms.isLogging() && I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING)) {
        A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + errorMessage);
      }
      throw new CmsException(errorMessage,CmsException.C_XML_WRONG_TEMPLATE_CLASS);
    }
    try {
      result=this.callCanonicalRoot(cms,(com.opencms.template.I_CmsTemplate)tmpl,file,newParameters);
    }
 catch (    CmsException e) {
      if ((A_OpenCms.isLogging() && I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING)) {
        A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + "There were errors while building output for template file \"" + file.getAbsolutePath()+ "\" and template class \""+ templateClass+ "\". See above for details.");
      }
      throw e;
    }
  }
  if (result != null) {
    writeBytesToResponse(cms,result);
  }
}

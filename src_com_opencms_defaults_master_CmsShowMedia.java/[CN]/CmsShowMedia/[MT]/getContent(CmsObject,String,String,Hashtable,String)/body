{
  CmsRequestContext req=cms.getRequestContext();
  byte[] picture=new byte[0];
  CmsMasterContent cd=null;
  CmsMasterMedia media=null;
  String sId=(String)parameters.get("id");
  String sPos=(String)parameters.get("pos");
  String refCD=(String)parameters.get("cd");
  int id=-1;
  int pos=-1;
  try {
    id=Integer.parseInt(sId);
    pos=Integer.parseInt(sPos);
  }
 catch (  NumberFormatException e) {
  }
  try {
    Class c=Class.forName(refCD);
    Object o=getContentDefinition(cms,c,new Integer(id));
    cd=(CmsMasterContent)o;
  }
 catch (  ClassNotFoundException e) {
  }
  Vector cosDeps=new Vector();
  cosDeps.add(cd);
  registerVariantDeps(cms,templateFile,null,null,parameters,null,cosDeps,null);
  if (cd != null) {
    Vector vec=cd.getMedia();
    if (pos == -1 && vec.size() > 0) {
      media=(CmsMasterMedia)vec.firstElement();
      picture=media.getMedia();
      String mType=media.getMimetype();
      if (mType == null || mType.equals("")) {
        mType="application/octet-stream";
      }
      req.getResponse().setContentType(mType);
      req.getResponse().setHeader("Content-disposition","filename=" + media.getName());
    }
 else {
      for (int i=0; i < vec.size(); i++) {
        if (((CmsMasterMedia)vec.elementAt(i)).getPosition() == pos) {
          media=(CmsMasterMedia)vec.elementAt(i);
          picture=media.getMedia();
          String mType=media.getMimetype();
          if (mType == null || mType.equals("")) {
            mType="application/octet-stream";
          }
          req.getResponse().setContentType(mType);
          req.getResponse().setHeader("Content-disposition","filename=" + media.getName());
          break;
        }
      }
    }
    if (picture == null) {
      picture=emptyGIF;
      req.getResponse().setContentType("images/gif");
    }
  }
 else {
    picture=emptyGIF;
    req.getResponse().setContentType("images/gif");
  }
  return picture;
}

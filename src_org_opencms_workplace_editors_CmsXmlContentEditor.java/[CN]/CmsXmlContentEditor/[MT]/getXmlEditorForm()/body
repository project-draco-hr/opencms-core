{
  StringBuffer result=new StringBuffer(64);
  try {
    getCms().getRequestContext().setAttribute(CmsRequestContext.ATTRIBUTE_EDITOR,new Boolean(true));
    Locale locale=getElementLocale();
    result.append("<table class=\"xmlTable\">\n");
    if (getErrorHandler().hasErrors()) {
      result.append("<tr><td colspan=\"5\">&nbsp;</td></tr>\n");
      result.append("<tr><td colspan=\"2\">&nbsp;</td>");
      result.append("<td class=\"xmlTdError\">");
      result.append(key("editor.xmlcontent.validation.error"));
      result.append("</td><td colspan=\"2\">&nbsp;");
      result.append("</td></tr>\n");
    }
    List typeSequence=m_content.getContentDefinition().getTypeSequence();
    Iterator i=typeSequence.iterator();
    while (i.hasNext()) {
      I_CmsXmlSchemaType type=(I_CmsXmlSchemaType)i.next();
      String name=type.getElementName();
      CmsXmlContentValueSequence elementSequence=m_content.getValueSequence(name,locale);
      int elementCount=elementSequence.getElementCount();
      boolean addValue=false;
      if (elementCount < type.getMaxOccurs()) {
        addValue=true;
      }
      boolean removeValue=false;
      if (elementCount > type.getMinOccurs()) {
        removeValue=true;
      }
      boolean disabledElement=false;
      if (elementCount < 1) {
        elementCount=1;
        elementSequence.addValue(0);
        disabledElement=true;
      }
      for (int j=0; j < elementCount; j++) {
        I_CmsXmlContentValue value=elementSequence.getValue(j);
        I_CmsXmlWidget widget=m_content.getContentDefinition().getContentHandler().getEditorWidget(value);
        result.append("<tr>");
        result.append("<td class=\"xmlLabel");
        if (disabledElement) {
          result.append("Disabled");
        }
        result.append("\">");
        result.append(A_CmsXmlWidget.getMessage(this,value.getDocument().getContentDefinition(),name));
        result.append(": </td>");
        if (value.getIndex() == 0) {
          result.append(A_CmsXmlWidget.getHelpBubble(getCms(),this,value.getDocument().getContentDefinition(),name));
        }
 else {
          result.append("<td></td>");
        }
        if (!disabledElement) {
          result.append(widget.getDialogWidget(getCms(),this,value));
        }
 else {
          result.append("<td class=\"xmlTdDisabled\">");
          result.append(key("editor.xmlcontent.optionalelement"));
          result.append("</td>");
        }
        result.append(buildAddElement(name,value.getIndex(),addValue));
        result.append(buildRemoveElement(name,value.getIndex(),removeValue));
        result.append("</tr>\n");
        if (getErrorHandler().hasErrors() || getErrorHandler().hasWarnings()) {
          String key=value.getElementName() + "_" + j;
          if (getErrorHandler().getErrors().containsKey(key)) {
            result.append("<tr><td></td><td><img src=\"");
            result.append(getEditorResourceUri());
            result.append("error.gif");
            result.append("\" border=\"0\" alt=\"\"></td><td class=\"xmlTdError\">");
            result.append(getErrorHandler().getErrors().get(key));
            result.append("</td><td colspan=\"2\"></td></tr>\n");
          }
 else           if (getErrorHandler().getWarnings().containsKey(key)) {
            result.append("<tr><td></td><td><img src=\"");
            result.append(getEditorResourceUri());
            result.append("warning.gif");
            result.append("\" border=\"0\" alt=\"\"></td><td class=\"xmlTdWarning\">");
            result.append(getErrorHandler().getWarnings().get(key));
            result.append("</td><td colspan=\"2\"></td></tr>\n");
          }
        }
      }
    }
    result.append("</table>\n");
  }
 catch (  Throwable t) {
    OpenCms.getLog(this).error("Error in XML editor",t);
  }
  return result.toString();
}

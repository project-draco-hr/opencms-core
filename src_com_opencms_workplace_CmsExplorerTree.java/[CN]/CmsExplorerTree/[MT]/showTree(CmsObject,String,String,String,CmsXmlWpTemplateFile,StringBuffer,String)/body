{
  String newtab=new String();
  String folderimg=new String();
  String treeswitch=new String();
  CmsFolder lastFolder=null;
  Vector subfolders=new Vector();
  Vector list=new Vector();
  Vector untestedSubfolders=new Vector();
  Vector untestedlist=cms.getSubFolders(curfolder);
  for (int i=0; i < untestedlist.size(); i++) {
    CmsFolder subfolder=(CmsFolder)untestedlist.elementAt(i);
    if (checkAccess(cms,subfolder)) {
      list.addElement(subfolder);
    }
  }
  Enumeration enum=list.elements();
  if (list.size() > 0) {
    lastFolder=(CmsFolder)list.lastElement();
  }
 else {
    lastFolder=null;
  }
  while (enum.hasMoreElements()) {
    CmsFolder folder=(CmsFolder)enum.nextElement();
    if (checkAccess(cms,folder)) {
      untestedSubfolders=cms.getSubFolders(folder.getAbsolutePath());
      subfolders=new Vector();
      for (int i=0; i < untestedSubfolders.size(); i++) {
        CmsFolder subfolder=(CmsFolder)untestedSubfolders.elementAt(i);
        if (checkAccess(cms,subfolder)) {
          subfolders.addElement(subfolder);
        }
      }
      if (folder.getAbsolutePath().equals(filelist)) {
        folderimg=template.getProcessedDataValue(C_TREEIMG_FOLDEROPEN,this);
      }
 else {
        folderimg=template.getProcessedDataValue(C_TREEIMG_FOLDERCLOSE,this);
      }
      if (folder.getAbsolutePath().equals(lastFolder.getAbsolutePath())) {
        if (subfolders.size() > 0) {
          if (endfolder.startsWith(folder.getAbsolutePath())) {
            template.setData(C_TREELINK,C_WP_EXPLORER_TREE + "?" + C_PARA_FOLDER+ "="+ Encoder.escape(curfolder,cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_MEND,this);
          }
 else {
            template.setData(C_TREELINK,C_WP_EXPLORER_TREE + "?" + C_PARA_FOLDER+ "="+ Encoder.escape(folder.getAbsolutePath(),cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_PEND,this);
          }
        }
 else {
          treeswitch=template.getProcessedDataValue(C_TREEIMG_END,this);
        }
      }
 else {
        if (subfolders.size() > 0) {
          if (endfolder.startsWith(folder.getAbsolutePath())) {
            template.setData(C_TREELINK,C_WP_EXPLORER_TREE + "?" + C_PARA_FOLDER+ "="+ Encoder.escape(curfolder,cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_MCROSS,this);
          }
 else {
            template.setData(C_TREELINK,C_WP_EXPLORER_TREE + "?" + C_PARA_FOLDER+ "="+ Encoder.escape(folder.getAbsolutePath(),cms.getRequestContext().getEncoding()));
            treeswitch=template.getProcessedDataValue(C_TREEIMG_PCROSS,this);
          }
        }
 else {
          treeswitch=template.getProcessedDataValue(C_TREEIMG_CROSS,this);
        }
      }
      if (folder.getAbsolutePath().equals(lastFolder.getAbsolutePath())) {
        newtab=tab + template.getProcessedDataValue(C_TREEIMG_EMPTY,this);
      }
 else {
        newtab=tab + template.getProcessedDataValue(C_TREEIMG_VERT,this);
      }
      if (folder.inProject(cms.getRequestContext().currentProject())) {
        template.setData(C_TREESTYLE,C_FILE_INPROJECT);
      }
 else {
        template.setData(C_TREESTYLE,C_FILE_NOTINPROJECT);
      }
      template.setData(C_FILELIST,C_WP_EXPLORER_FILELIST + "?" + C_PARA_FILELIST+ "="+ folder.getAbsolutePath());
      template.setData(C_TREELIST,C_WP_EXPLORER_TREE + "?" + C_PARA_FILELIST+ "="+ folder.getAbsolutePath());
      template.setData(C_TREEENTRY,folder.getName());
      template.setData(C_TREETAB,tab);
      template.setData(C_TREEFOLDER,folderimg);
      template.setData(C_TREESWITCH,treeswitch);
      output.append(template.getProcessedDataValue(C_TREELINE,this));
      if (endfolder.startsWith(folder.getAbsolutePath())) {
        showTree(cms,folder.getAbsolutePath(),endfolder,filelist,template,output,newtab);
      }
    }
  }
}

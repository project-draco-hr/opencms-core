{
  if (resource.getState() == I_CmsConstants.C_STATE_UNCHANGED) {
    CmsTemplateLoaderFacade loaderFacade=OpenCms.getLoaderManager().getTemplateLoaderFacade(cms,resource);
    req.setAttribute(C_LOADER_FACADE_ATTR,loaderFacade);
    long templateLastModified=loaderFacade.getLoader().getDateLastModified(cms,loaderFacade.getLoaderStartResource(),req,res);
    return templateLastModified < resource.getDateLastModified() ? templateLastModified : resource.getDateLastModified();
  }
 else {
    return Long.MIN_VALUE;
  }
}

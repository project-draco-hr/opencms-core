{
  CmsObject cms=getCmsObject();
  String filename="/dummy1.txt";
  CmsProject offlineProject=cms.getRequestContext().currentProject();
  int counter=5;
  try {
    cms.getRequestContext().saveSiteRoot();
    cms.getRequestContext().setSiteRoot("/sites/default/");
    cms.getRequestContext().setCurrentProject(offlineProject);
    for (int i=1; i <= counter; i++) {
      String contentStr="content version " + i;
      cms.createResource(filename,CmsResourceTypePlain.getStaticTypeId(),contentStr.getBytes(),null);
      cms.unlockResource(filename);
      cms.publishResource(filename);
      cms.lockResource(filename);
      cms.deleteResource(filename,CmsResource.DELETE_PRESERVE_SIBLINGS);
      cms.unlockResource(filename);
      cms.publishResource(filename);
    }
    cms.createResource(filename,CmsResourceTypePlain.getStaticTypeId(),null,null);
    List backupResources=cms.readAllBackupFileHeaders(filename);
    assertEquals(counter,backupResources.size());
    for (int i=0; i < counter; i++) {
      int version=counter - i;
      String contentStr="content version " + version;
      CmsBackupResource backupResource=(CmsBackupResource)backupResources.get(i);
      assertEquals(version,backupResource.getVersionId());
      cms.restoreResourceBackup(filename,backupResource.getTagId());
      CmsFile file=cms.readFile(filename);
      String restoredContent=getContentString(cms,file.getContents());
      assertEquals(contentStr,restoredContent);
    }
  }
  finally {
    cms.getRequestContext().restoreSiteRoot();
  }
}

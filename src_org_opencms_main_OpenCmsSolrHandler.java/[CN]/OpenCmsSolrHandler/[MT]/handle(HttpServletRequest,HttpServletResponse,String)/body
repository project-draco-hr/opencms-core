{
  try {
    CmsObject cms=OpenCmsCore.getInstance().initCmsObjectFromSession(req);
    if (cms == null) {
      cms=OpenCmsCore.getInstance().initCmsObject(OpenCms.getDefaultUsers().getUserGuest());
      String siteRoot=OpenCmsCore.getInstance().getSiteManager().matchRequest(req).getSiteRoot();
      cms.getRequestContext().setSiteRoot(siteRoot);
    }
    String baseUri=getRequestUri(req,cms);
    if (baseUri != null) {
      cms.getRequestContext().setUri(baseUri);
    }
    Map<String,String[]> params=CmsRequestUtil.createParameterMap(req.getParameterMap());
    String indexName=params.get(PARAM_CORE) != null ? params.get(PARAM_CORE)[0] : (params.get(PARAM_INDEX) != null ? params.get(PARAM_INDEX)[0] : null);
    OpenCms.getSearchManager();
    CmsSolrIndex index=CmsSearchManager.getIndexSolr(cms,params);
    if (index != null) {
      CmsSolrQuery query=new CmsSolrQuery(cms,CmsRequestUtil.createParameterMap(req.getParameterMap()));
      index.writeResponse(res,index.search(cms,query));
    }
 else {
      res.setStatus(HttpServletResponse.SC_EXPECTATION_FAILED);
      String message=Messages.get().getBundle().key(Messages.GUI_SOLR_INDEX_NOT_FOUND_1,indexName);
      res.getWriter().println(Messages.get().getBundle().key(Messages.GUI_SOLR_ERROR_HTML_1,message));
    }
  }
 catch (  Exception e) {
    res.setStatus(HttpServletResponse.SC_EXPECTATION_FAILED);
    String message=Messages.get().getBundle().key(Messages.GUI_SOLR_UNEXPECTED_ERROR_0);
    String formattedException=CmsException.getStackTraceAsString(e).replace("\n","<br/>");
    res.getWriter().println(Messages.get().getBundle().key(Messages.GUI_SOLR_ERROR_HTML_1,message + formattedException));
  }
}

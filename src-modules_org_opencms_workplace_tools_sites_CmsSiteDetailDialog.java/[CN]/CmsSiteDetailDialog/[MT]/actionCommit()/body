{
  try {
    validateDialog();
    CmsObject cms=OpenCms.initCmsObject(getCms());
    cms.getRequestContext().setSiteRoot("");
    String siteRoot="/sites".concat(m_sitename);
    m_site.setSiteRoot(siteRoot);
    CmsResource siteRootResource=null;
    try {
      siteRootResource=cms.readResource(siteRoot);
    }
 catch (    CmsVfsResourceNotFoundException e) {
      int typeId=OpenCms.getResourceManager().getResourceType(CmsResourceTypeFolderSubSitemap.TYPE_SUBSITEMAP).getTypeId();
      siteRootResource=cms.createResource(siteRoot,typeId);
      String sitePath=cms.getSitePath(siteRootResource);
      String contentFolder=CmsStringUtil.joinPaths(sitePath,CmsADEManager.CONTENT_FOLDER_NAME + "/");
      CmsResource config=createSitemapContentFolder(cms,siteRootResource);
      if (config != null) {
        CmsResource newFolder=cms.createResource(contentFolder + NEW,CmsResourceTypeFolder.RESOURCE_TYPE_ID);
        int containerId=OpenCms.getResourceManager().getResourceType(org.opencms.file.types.CmsResourceTypeXmlContainerPage.RESOURCE_TYPE_NAME).getTypeId();
        CmsResource modelPage=cms.createResource(newFolder.getRootPath() + BLANK_HTML,containerId);
        String defTitle=Messages.get().container(Messages.GUI_DEFAULT_MODEL_TITLE_1,m_site.getTitle()).getKey();
        String defDes=Messages.get().container(Messages.GUI_DEFAULT_MODEL_DESCRIPTION_1,m_site.getTitle()).getKey();
        CmsProperty prop=new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,defTitle,defTitle);
        cms.writePropertyObject(modelPage.getRootPath(),prop);
        prop=new CmsProperty(CmsPropertyDefinition.PROPERTY_DESCRIPTION,defDes,defDes);
        cms.writePropertyObject(modelPage.getRootPath(),prop);
        CmsFile file=cms.readFile(config);
        CmsXmlContent con=CmsXmlContentFactory.unmarshal(cms,file);
        con.addValue(cms,MODEL_PAGE,Locale.ENGLISH,0);
        I_CmsXmlContentValue val=con.getValue(MODEL_PAGE_PAGE,Locale.ENGLISH);
        val.setStringValue(cms,modelPage.getRootPath());
        file.setContents(con.marshal());
        cms.writeFile(file);
      }
      if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(getTemplate())) {
        CmsProperty prop=new CmsProperty(CmsPropertyDefinition.PROPERTY_TEMPLATE,getTemplate(),getTemplate());
        cms.writePropertyObject(siteRoot,prop);
      }
      OpenCms.getPublishManager().publishResource(cms,siteRoot,false,new CmsLogReport(cms.getRequestContext().getLocale(),getClass()));
      if (m_createou) {
        OpenCms.getOrgUnitManager().createOrganizationalUnit(cms,"/" + siteRootResource.getName(),m_ouDescription.replace("%(site)",m_site.getTitle() + " [" + m_site.getSiteRoot()+ "]"),0,siteRootResource.getRootPath());
      }
    }
    CmsSite newSite=m_site.toCmsSite();
    OpenCms.getSiteManager().updateSite(getCms(),m_site.getOriginalSite(),newSite);
    if ((m_site.getOriginalSite() != null) && m_site.getOriginalSite().getUrl().equals(OpenCms.getSiteManager().getWorkplaceServer())) {
      OpenCms.getSiteManager().updateGeneralSettings(getCms(),OpenCms.getSiteManager().getDefaultUri(),newSite.getUrl(),OpenCms.getSiteManager().getSharedFolder());
    }
    OpenCms.writeConfiguration(CmsSystemConfiguration.class);
    Map<?,?> objects=(Map<?,?>)getSettings().getListObject();
    if (objects != null) {
      objects.remove(CmsSitesOverviewList.class.getName());
    }
  }
 catch (  Exception e) {
    addCommitError(e);
  }
}

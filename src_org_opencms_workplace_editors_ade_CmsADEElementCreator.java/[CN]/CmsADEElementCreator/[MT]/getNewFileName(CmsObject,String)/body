{
  pattern=cms.getRequestContext().removeSiteRoot(pattern);
  PrintfFormat format=new PrintfFormat(FILE_NUMBER_FORMAT);
  String folderName=CmsResource.getFolderPath(pattern);
  List resources=cms.readResources(folderName,CmsResourceFilter.ALL,false);
  Set<String> result=new HashSet<String>();
  for (int i=0; i < resources.size(); i++) {
    CmsResource resource=(CmsResource)resources.get(i);
    result.add(cms.getSitePath(resource));
  }
  String checkFileName, checkTempFileName, number;
  CmsMacroResolver resolver=CmsMacroResolver.newInstance();
  int j=0;
  do {
    number=format.sprintf(++j);
    resolver.addMacro(MACRO_NUMBER,number);
    checkFileName=resolver.resolveMacros(pattern);
    checkTempFileName=CmsWorkplace.getTemporaryFileName(checkFileName);
  }
 while (result.contains(checkFileName) || result.contains(checkTempFileName));
  return checkFileName;
}

{
  String foldername=(String)parameters.get(CmsWorkplaceDefault.C_PARA_FOLDER);
  String galleryPath=getGalleryPath();
  if (foldername != null) {
    try {
      CmsFolder fold=cms.readFolder(foldername);
      String parent=CmsResource.getParentFolder(cms.getSitePath(fold));
      if (!(parent.equals(galleryPath))) {
        foldername=galleryPath;
      }
      if (fold.getState() == CmsResource.STATE_DELETED) {
        foldername=galleryPath;
      }
    }
 catch (    CmsException exc) {
      foldername=galleryPath;
    }
    session.putValue("lastgallery",foldername);
    parameters.put(CmsWorkplaceDefault.C_PARA_FOLDER,foldername);
  }
 else {
    foldername=(String)session.getValue(CmsWorkplaceDefault.C_PARA_FOLDER);
    String tmpFolder=(String)session.getValue("lastgallery");
    if (foldername == null) {
      if (tmpFolder != null) {
        try {
          cms.readFolder(tmpFolder);
          foldername=tmpFolder;
        }
 catch (        CmsException e) {
          foldername=galleryPath;
        }
      }
 else {
        foldername=galleryPath;
      }
    }
  }
  session.putValue(CmsWorkplaceDefault.C_PARA_FOLDER,foldername);
  return foldername;
}

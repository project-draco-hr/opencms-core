{
  if (CmsStringUtil.isEmpty(link)) {
    return "";
  }
  String absoluteLink=CmsLinkManager.getAbsoluteUri(link,cms.getRequestContext().getUri());
  String vfsName;
  String parameters;
  int pos=absoluteLink.indexOf('?');
  if (pos >= 0) {
    vfsName=absoluteLink.substring(0,pos);
    parameters=absoluteLink.substring(pos);
  }
 else {
    vfsName=absoluteLink;
    parameters=null;
  }
  String anchor=null;
  pos=vfsName.indexOf('#');
  if (pos >= 0) {
    anchor=vfsName.substring(pos);
    vfsName=vfsName.substring(0,pos);
  }
  String resultLink=null;
  String uriBaseName=null;
  boolean useRelativeLinks=false;
  CmsSite currentSite=OpenCms.getSiteManager().getCurrentSite(cms);
  CmsSite targetSite=null;
  if (CmsStringUtil.isNotEmpty(siteRoot)) {
    targetSite=OpenCms.getSiteManager().getSiteForSiteRoot(siteRoot);
  }
  if (targetSite == null) {
    targetSite=currentSite;
  }
  String targetSiteRoot=targetSite.getSiteRoot();
  String originalVfsName=vfsName;
  String detailPage=null;
  try {
    String rootVfsName;
    if (!vfsName.startsWith(targetSiteRoot) && !vfsName.startsWith(CmsResource.VFS_FOLDER_SYSTEM + "/") && !OpenCms.getSiteManager().startsWithShared(vfsName)) {
      rootVfsName=CmsStringUtil.joinPaths(targetSiteRoot,vfsName);
    }
 else {
      rootVfsName=vfsName;
    }
    I_CmsDetailPageFinder finder=OpenCms.getADEManager().getDetailPageFinder();
    detailPage=finder.getDetailPage(cms,rootVfsName,cms.getRequestContext().getUri());
    if (detailPage != null) {
      if (detailPage.startsWith(targetSiteRoot)) {
        detailPage=detailPage.substring(targetSiteRoot.length());
        if (!detailPage.startsWith("/")) {
          detailPage="/" + detailPage;
        }
      }
      try {
        CmsResource element=cms.readResource(vfsName);
        Locale locale=cms.getRequestContext().getLocale();
        List<Locale> defaultLocales=OpenCms.getLocaleManager().getDefaultLocales();
        vfsName=CmsStringUtil.joinPaths(detailPage,cms.getDetailName(element,locale,defaultLocales),"/");
      }
 catch (      CmsVfsException e) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
  }
 catch (  CmsVfsResourceNotFoundException e) {
    LOG.info(e.getLocalizedMessage(),e);
  }
catch (  CmsException e) {
    LOG.error(e.getLocalizedMessage(),e);
  }
  String serverPrefix;
  if (targetSite != currentSite) {
    serverPrefix=targetSite.getUrl();
  }
 else {
    serverPrefix="";
  }
  if (cms.getRequestContext().getCurrentProject().isOnlineProject()) {
    CmsStaticExportManager exportManager=OpenCms.getStaticExportManager();
    String oriUri=cms.getRequestContext().getUri();
    if (exportManager.relativeLinksInExport(cms.getRequestContext().getSiteRoot() + oriUri)) {
      String cacheKey=exportManager.getCacheKey(targetSiteRoot,oriUri);
      uriBaseName=exportManager.getCachedOnlineLink(cacheKey);
      if (uriBaseName == null) {
        if (exportManager.isExportLink(cms,oriUri)) {
          uriBaseName=exportManager.getRfsName(cms,oriUri);
        }
 else {
          uriBaseName=exportManager.getVfsPrefix() + oriUri;
        }
        exportManager.cacheOnlineLink(cacheKey,uriBaseName);
      }
      useRelativeLinks=uriBaseName.startsWith(OpenCms.getStaticExportManager().getRfsPrefix(cms.getRequestContext().getSiteRoot() + oriUri));
    }
    String detailPagePart=detailPage == null ? "" : detailPage + ":";
    String cacheKey=cms.getRequestContext().getSiteRoot() + ":" + targetSiteRoot+ ":"+ detailPagePart+ absoluteLink;
    resultLink=exportManager.getCachedOnlineLink(cacheKey);
    if (resultLink == null) {
      String storedSiteRoot=cms.getRequestContext().getSiteRoot();
      try {
        cms.getRequestContext().setSiteRoot(targetSite.getSiteRoot());
        if (exportManager.isExportLink(cms,vfsName)) {
          resultLink=exportManager.getRfsName(cms,vfsName,parameters);
          parameters=null;
        }
 else {
          resultLink=exportManager.getVfsPrefix().concat(vfsName);
          if (parameters != null) {
            resultLink=resultLink.concat(parameters);
          }
        }
      }
  finally {
        cms.getRequestContext().setSiteRoot(storedSiteRoot);
      }
      exportManager.cacheOnlineLink(cacheKey,resultLink);
    }
    if (targetSite.hasSecureServer() || currentSite.hasSecureServer()) {
      if (!vfsName.startsWith(CmsWorkplace.VFS_PATH_SYSTEM)) {
        int linkType=-1;
        try {
          linkType=cms.readResource(originalVfsName).getTypeId();
        }
 catch (        CmsException e) {
          if (LOG.isInfoEnabled()) {
            String message=Messages.get().getBundle().key(Messages.LOG_RESOURCE_ACESS_ERROR_3,vfsName,cms.getRequestContext().getCurrentUser().getName(),cms.getRequestContext().getSiteRoot());
            if (LOG.isDebugEnabled()) {
              LOG.debug(message,e);
            }
 else {
              LOG.info(message);
            }
          }
        }
        int imageId;
        try {
          imageId=OpenCms.getResourceManager().getResourceType(CmsResourceTypeImage.getStaticTypeName()).getTypeId();
        }
 catch (        CmsLoaderException e1) {
          LOG.warn(e1.getLocalizedMessage(),e1);
          imageId=CmsResourceTypeImage.getStaticTypeId();
        }
        if (linkType != imageId) {
          boolean secureRequest=exportManager.isSecureLink(cms,oriUri);
          boolean secureLink=exportManager.isSecureLink(cms,vfsName,targetSite.getSiteRoot(),secureRequest);
          if (secureLink && (forceSecure || !secureRequest)) {
            serverPrefix=targetSite.getSecureUrl();
          }
 else           if (!secureLink && secureRequest) {
            serverPrefix=targetSite.getUrl();
          }
        }
      }
    }
    if (useRelativeLinks && CmsStringUtil.isEmpty(serverPrefix)) {
      resultLink=CmsLinkManager.getRelativeUri(uriBaseName,resultLink);
    }
  }
 else {
    if (OpenCms.getRunLevel() >= OpenCms.RUNLEVEL_3_SHELL_ACCESS) {
      resultLink=OpenCms.getStaticExportManager().getVfsPrefix().concat(vfsName);
    }
    if ((parameters != null) && (resultLink != null)) {
      resultLink=resultLink.concat(parameters);
    }
  }
  if ((anchor != null) && (resultLink != null)) {
    resultLink=resultLink.concat(anchor);
  }
  return serverPrefix.concat(resultLink);
}

{
  Document contentXml=null;
  CmsFile bodyfile=null;
  String mastertemplate="";
  String bodyname="";
  String bodyclass="";
  Map bodyparams=null;
  CmsFile pagefile=m_cms.readFile(resname);
  contentXml=CmsImport.getXmlDocument(pagefile.getContents());
  List masterTemplateNode=contentXml.selectNodes("//masterTemplate");
  if (masterTemplateNode.size() == 1) {
    mastertemplate=((Element)masterTemplateNode.get(0)).getTextTrim();
  }
  List bodyNode=contentXml.selectNodes("//ELEMENTDEF");
  if (bodyNode.size() == 1) {
    Element bodyElement=(Element)bodyNode.get(0);
    List nodes=bodyElement.elements();
    int i;
    Node node=null;
    for (i=0; i < nodes.size(); i++) {
      node=(Node)nodes.get(i);
      if ("CLASS".equals(node.getName())) {
        bodyclass=((Element)node).getTextTrim();
        break;
      }
    }
    for (i=0; i < nodes.size(); i++) {
      node=(Node)nodes.get(i);
      if ("TEMPLATE".equals(node.getName())) {
        bodyname=((Element)node).getTextTrim();
        if (!bodyname.startsWith("/")) {
          bodyname=CmsResource.getFolderPath(resname) + bodyname;
        }
        break;
      }
    }
    for (i=0; i < nodes.size(); i++) {
      node=(Node)nodes.get(i);
      if ("PARAMETER".equals(node.getName())) {
        Element paramElement=(Element)node;
        if (bodyparams == null) {
          bodyparams=new HashMap();
        }
        bodyparams.put((paramElement.attribute("name")).getText(),paramElement.getTextTrim());
      }
    }
    m_cms.lockResource(resname);
    List properties=m_cms.readPropertyObjects(resname,false);
    bodyfile=m_cms.readFile(bodyname);
    String encoding=null;
    encoding=CmsProperty.get(I_CmsConstants.C_PROPERTY_CONTENT_ENCODING,properties).getValue();
    if (encoding == null) {
      encoding=OpenCms.getSystemInfo().getDefaultEncoding();
    }
    if (m_convertToXmlPage) {
      CmsXmlPage xmlPage=CmsXmlPageConverter.convertToXmlPage(m_cms,new String(bodyfile.getContents(),encoding),"body",getLocale(resname,properties),encoding);
      if (xmlPage != null) {
        xmlPage.write(pagefile);
        pagefile.setType(CmsResourceTypeXmlPage.C_RESOURCE_TYPE_ID);
        pagefile.setLoaderId(CmsXmlPageLoader.C_RESOURCE_LOADER_ID);
      }
    }
    m_cms.writeFile(pagefile);
    m_cms.writePropertyObject(resname,new CmsProperty(I_CmsConstants.C_PROPERTY_TEMPLATE,mastertemplate,null));
    if (bodyclass != null && !"".equals(bodyclass)) {
      m_cms.writePropertyObject(resname,new CmsProperty(I_CmsConstants.C_PROPERTY_BODY_CLASS,bodyclass,null));
    }
    if (bodyparams != null) {
      for (Iterator p=bodyparams.keySet().iterator(); p.hasNext(); ) {
        String key=(String)p.next();
        m_cms.writePropertyObject(resname,new CmsProperty(key,(String)bodyparams.get(key),null));
      }
    }
    CmsProperty.setAutoCreatePropertyDefinitions(properties,true);
    m_cms.writePropertyObjects(resname,properties);
    m_cms.touch(resname,pagefile.getDateLastModified(),false,pagefile.getUserLastModified());
    m_cms.unlockResource(resname,false);
    m_cms.lockResource(bodyname);
    m_cms.deleteResource(bodyname,I_CmsConstants.C_DELETE_OPTION_IGNORE_SIBLINGS);
    m_report.println(" " + m_report.key("report.ok"),I_CmsReport.C_FORMAT_OK);
  }
 else {
    m_cms.lockResource(resname);
    pagefile.setType(CmsResourceTypePlain.C_RESOURCE_TYPE_ID);
    m_cms.writeFile(pagefile);
    m_cms.unlockResource(resname,false);
    m_report.println(" " + m_report.key("report.notconverted"),I_CmsReport.C_FORMAT_OK);
  }
}

{
  String mastertemplate="";
  String bodyname="";
  String bodyclass="";
  HashMap bodyparams=null;
  CmsFile pagefile=m_cms.readFile(resname);
  InputStream in=new ByteArrayInputStream(pagefile.getContents());
  Document contentXml;
  CmsFile bodyfile;
  contentXml=A_CmsXmlContent.getXmlParser().parse(in);
  NodeList masterTemplateNode=contentXml.getElementsByTagName("masterTemplate");
  if (masterTemplateNode.getLength() == 1) {
    mastertemplate=masterTemplateNode.item(0).getFirstChild().getNodeValue();
  }
  NodeList bodyNode=contentXml.getElementsByTagName("ELEMENTDEF");
  if (bodyNode.getLength() == 1) {
    Node bodyElement=bodyNode.item(0);
    NodeList nodes=bodyElement.getChildNodes();
    int i;
    for (i=0; i < nodes.getLength(); i++) {
      if ("CLASS".equals(nodes.item(i).getNodeName())) {
        bodyclass=nodes.item(i).getFirstChild().getNodeValue();
        break;
      }
    }
    for (i=0; i < nodes.getLength(); i++) {
      if ("TEMPLATE".equals(nodes.item(i).getNodeName())) {
        bodyname=nodes.item(i).getFirstChild().getNodeValue();
        if (!bodyname.startsWith("/")) {
          bodyname=CmsResource.getFolderPath(resname) + bodyname;
        }
        break;
      }
    }
    for (i=0; i < nodes.getLength(); i++) {
      if ("PARAMETER".equals(nodes.item(i).getNodeName())) {
        Node paramElement=nodes.item(i);
        if (bodyparams == null) {
          bodyparams=new HashMap();
        }
        bodyparams.put(paramElement.getAttributes().getNamedItem("name").getNodeValue(),paramElement.getFirstChild().getNodeValue());
      }
    }
    m_cms.lockResource(resname);
    Map properties=m_cms.readProperties(resname);
    bodyfile=m_cms.readFile(bodyname);
    if (m_convertToXmlPage) {
      String localeName=OpenCms.getLocaleManager().getDefaultLocaleNames(m_cms,CmsResource.getParentFolder(resname))[0];
      CmsXmlPage xmlPage=CmsXmlPageConverter.convertToXmlPage(m_cms,new String(bodyfile.getContents()),"body",localeName);
      if (xmlPage != null) {
        xmlPage.write(pagefile);
        pagefile.setType(CmsResourceTypeXmlPage.C_RESOURCE_TYPE_ID);
        pagefile.setLoaderId(CmsXmlPageLoader.C_RESOURCE_LOADER_ID);
      }
    }
 else {
      pagefile.setContents(bodyfile.getContents());
      pagefile.setType(CmsResourceTypeNewPage.C_RESOURCE_TYPE_ID);
      pagefile.setLoaderId(CmsPageLoader.C_RESOURCE_LOADER_ID);
    }
    m_cms.writeFile(pagefile);
    m_cms.writeProperty(resname,I_CmsConstants.C_PROPERTY_TEMPLATE,mastertemplate,true);
    if (bodyclass != null && !"".equals(bodyclass)) {
      m_cms.writeProperty(resname,I_CmsConstants.C_PROPERTY_BODY_CLASS,bodyclass,true);
    }
    if (bodyparams != null) {
      for (Iterator p=bodyparams.keySet().iterator(); p.hasNext(); ) {
        String key=(String)p.next();
        m_cms.writeProperty(resname,key,(String)bodyparams.get(key),true);
      }
    }
    m_cms.writeProperties(resname,properties,true);
    m_cms.touch(resname,pagefile.getDateLastModified(),false,pagefile.getUserLastModified());
    m_cms.unlockResource(resname,false);
    m_cms.lockResource(bodyname);
    m_cms.deleteResource(bodyname,I_CmsConstants.C_DELETE_OPTION_IGNORE_VFS_LINKS);
    m_report.println(" " + m_report.key("report.ok"),I_CmsReport.C_FORMAT_OK);
  }
 else {
    m_cms.lockResource(resname);
    pagefile.setType(CmsResourceTypePlain.C_RESOURCE_TYPE_ID);
    m_cms.writeFile(pagefile);
    m_cms.unlockResource(resname,false);
    m_report.println(" " + m_report.key("report.notconverted"),I_CmsReport.C_FORMAT_OK);
  }
}

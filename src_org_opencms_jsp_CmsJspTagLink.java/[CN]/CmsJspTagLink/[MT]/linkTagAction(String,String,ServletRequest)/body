{
  CmsFlexController controller=CmsFlexController.getController(req);
  String absoluteLink=CmsLinkManager.getAbsoluteUri(target,controller.getCurrentRequest().getElementUri());
  int pos=absoluteLink.length();
  int anchorPos=absoluteLink.lastIndexOf('#');
  if ((anchorPos != -1) && (anchorPos < pos)) {
    pos=anchorPos;
  }
  int paramPos=absoluteLink.lastIndexOf('?');
  if ((paramPos != -1) && (paramPos < pos)) {
    pos=paramPos;
  }
  String uri=absoluteLink.substring(0,pos);
  String linkInfo=(pos == absoluteLink.length()) ? "" : absoluteLink.substring(pos);
  CmsObject cms=controller.getCmsObject();
  try {
    CmsResource res=cms.readResource(uri);
    I_CmsDetailPageFinder finder=OpenCms.getSitemapManager().getDetailPageFinder();
    String detailPage=finder.getDetailPage(cms,res,cms.getRequestContext().getOriginalUri());
    if (detailPage != null) {
      uri=CmsStringUtil.joinPaths(detailPage,cms.getDetailName(res),"/");
    }
  }
 catch (  CmsException e) {
    LOG.debug(e.getLocalizedMessage(),e);
  }
  uri+=linkInfo;
  return OpenCms.getLinkManager().substituteLinkForUnknownTarget(cms,uri);
}

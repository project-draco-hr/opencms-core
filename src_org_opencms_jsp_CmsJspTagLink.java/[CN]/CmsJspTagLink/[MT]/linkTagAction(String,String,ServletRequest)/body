{
  CmsFlexController controller=CmsFlexController.getController(req);
  String absoluteLink=CmsLinkManager.getAbsoluteUri(target,controller.getCurrentRequest().getElementUri());
  int pos=absoluteLink.length();
  int anchorPos=absoluteLink.lastIndexOf('#');
  if ((anchorPos != -1) && (anchorPos < pos)) {
    pos=anchorPos;
  }
  int paramPos=absoluteLink.lastIndexOf('?');
  if ((paramPos != -1) && (paramPos < pos)) {
    pos=paramPos;
  }
  String uri=absoluteLink.substring(0,pos);
  String linkInfo=(pos == absoluteLink.length()) ? "" : absoluteLink.substring(pos);
  CmsObject cms=controller.getCmsObject();
  try {
    CmsResource res=cms.readResource(uri);
    String detailViewProp=detailView;
    if (CmsStringUtil.isEmptyOrWhitespaceOnly(detailViewProp)) {
      detailViewProp=cms.readPropertyObject(res,CmsPropertyDefinition.PROPERTY_ADE_SITEMAP_DETAILVIEW,true).getValue("");
    }
    if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(detailViewProp)) {
      uri=detailViewProp;
      if (!uri.endsWith("/")) {
        uri+="/";
      }
      String detailName=cms.readNewestUrlNameForId(res.getStructureId());
      if (detailName == null) {
        detailName=res.getStructureId().toString();
      }
      uri+=detailName;
      uri+="/";
    }
  }
 catch (  CmsException e) {
    LOG.debug(e.getLocalizedMessage(),e);
  }
  uri+=linkInfo;
  return OpenCms.getLinkManager().substituteLinkForUnknownTarget(cms,uri);
}

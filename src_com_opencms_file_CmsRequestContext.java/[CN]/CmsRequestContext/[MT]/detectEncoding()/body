{
  m_encoding=null;
  String requestedResource=null;
  try {
    try {
      requestedResource=m_req.getRequestedResource();
      String resName=getSiteRoot(requestedResource);
      while (resName != null) {
        try {
          m_encoding=m_rb.readProperty(m_user,m_currentProject,resName,C_PROPERTY_CONTENT_ENCODING);
        }
 catch (        CmsException ce) {
        }
        if (m_encoding != null) {
          break;
        }
        CmsResource res=m_rb.getParentResource(m_user,m_currentProject,resName);
        if (res == null) {
          break;
        }
        resName=getSiteRoot(res.getAbsolutePath());
      }
    }
 catch (    Throwable t) {
      ;
    }
    if ((m_encoding == null) || "".equals(m_encoding.trim())) {
      A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_DEBUG,"[" + getClass().getName() + "] can't get encoding property "+ C_PROPERTY_CONTENT_ENCODING+ " or original XML encoding for resource "+ requestedResource+ ", try to get it from session");
      I_CmsSession session=getSession(false);
      if (session != null) {
        m_encoding=(String)session.getValue(I_CmsConstants.C_SESSION_CONTENT_ENCODING);
      }
    }
    if (m_encoding == null) {
      A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_DEBUG,"no encoding found - use default one");
      m_encoding=OpenCms.getEncoding();
    }
  }
 catch (  Throwable t) {
    A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_DEBUG,"an error [" + t + "] has occured while determining content encoding - use default one");
    m_encoding=OpenCms.getEncoding();
  }
  A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_DEBUG,"[" + getClass().getName() + "] resource="+ requestedResource+ ",  encoding="+ m_encoding);
}

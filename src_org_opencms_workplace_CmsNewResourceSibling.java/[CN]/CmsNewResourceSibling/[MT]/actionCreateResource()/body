{
  try {
    String fullResourceName=computeFullResourceName();
    String newResourceParam=fullResourceName;
    String linkTarget=getParamLinkTarget();
    if (linkTarget == null) {
      linkTarget="";
    }
    boolean restoreSiteRoot=false;
    try {
      if (CmsSiteManager.getSiteRoot(linkTarget) != null) {
        String siteRootFolder=getCms().getRequestContext().getSiteRoot();
        if (siteRootFolder.endsWith("/")) {
          siteRootFolder=siteRootFolder.substring(0,siteRootFolder.length() - 1);
        }
        fullResourceName=siteRootFolder + fullResourceName;
        getCms().getRequestContext().saveSiteRoot();
        getCms().getRequestContext().setSiteRoot("/");
        restoreSiteRoot=true;
      }
      boolean isFolder=false;
      CmsResource targetRes=getCms().readFileHeader(linkTarget);
      isFolder=targetRes.isFolder();
      if (isFolder) {
        if (linkTarget.endsWith("/")) {
          linkTarget=linkTarget.substring(0,linkTarget.length() - 1);
        }
        getCms().copyResource(linkTarget,fullResourceName,false,true,I_CmsConstants.C_COPY_AS_SIBLING);
      }
 else {
        Map targetProperties=null;
        boolean keepProperties=Boolean.valueOf(getParamKeepProperties()).booleanValue();
        if (keepProperties) {
          try {
            targetProperties=getCms().readProperties(linkTarget);
          }
 catch (          Exception e) {
          }
        }
        getCms().createSibling(fullResourceName,linkTarget,targetProperties);
      }
    }
  finally {
      if (restoreSiteRoot) {
        getCms().getRequestContext().restoreSiteRoot();
      }
    }
    setParamResource(newResourceParam);
  }
 catch (  CmsException e) {
    getJsp().getRequest().setAttribute(C_SESSION_WORKPLACE_CLASS,this);
    setParamErrorstack(e.getStackTraceAsString());
    setParamMessage(key("error.message.newlink"));
    setParamReasonSuggestion(key("error.reason.newlink") + "<br>\n" + key("error.suggestion.newlink")+ "\n");
    getJsp().include(C_FILE_DIALOG_SCREEN_ERROR);
  }
}

{
  CmsRequestContext req=cms.getRequestContext();
  byte[] picture=new byte[0];
  CmsMasterContent cd=null;
  CmsMasterMedia media=null;
  String mType=null;
  String sId=(String)parameters.get("id");
  String sPos=(String)parameters.get("pos");
  String refCD=(String)parameters.get("cd");
  String smId=(String)parameters.get("mid");
  CmsUUID id=CmsUUID.getNullUUID();
  int pos=-1;
  int mid=-1;
  try {
    id=new CmsUUID(sId);
    if (sPos != null) {
      pos=Integer.parseInt(sPos);
    }
    if (smId != null) {
      mid=Integer.parseInt(smId);
    }
  }
 catch (  NumberFormatException e) {
  }
  try {
    Class c=Class.forName(refCD);
    Object o=getContentDefinition(cms,c,id);
    cd=(CmsMasterContent)o;
  }
 catch (  ClassNotFoundException e) {
  }
  Vector cosDeps=new Vector();
  cosDeps.add(cd);
  registerVariantDeps(cms,templateFile,null,null,parameters,null,cosDeps,null);
  if (cd != null) {
    Vector vec=cd.getMedia();
    if (mid != -1) {
      for (int i=0; i < vec.size(); i++) {
        media=(CmsMasterMedia)vec.get(i);
        if (mid == media.getId()) {
          picture=media.getMedia();
          mType=media.getMimetype();
          break;
        }
      }
    }
 else     if (pos == -1 && vec.size() > 0) {
      media=(CmsMasterMedia)vec.firstElement();
      picture=media.getMedia();
      mType=media.getMimetype();
    }
 else {
      for (int i=0; i < vec.size(); i++) {
        if (((CmsMasterMedia)vec.elementAt(i)).getPosition() == pos) {
          media=(CmsMasterMedia)vec.elementAt(i);
          picture=media.getMedia();
          mType=media.getMimetype();
          break;
        }
      }
    }
    if (picture == null) {
      picture=emptyGIF;
      CmsXmlTemplateLoader.getResponse(req).setContentType("images/gif");
    }
 else {
      if (mType == null || mType.equals("")) {
        mType="application/octet-stream";
      }
      CmsXmlTemplateLoader.getResponse(req).setContentType(mType);
      CmsXmlTemplateLoader.getResponse(req).setHeader("Content-disposition","filename=" + media.getName());
    }
  }
 else {
    picture=emptyGIF;
    CmsXmlTemplateLoader.getResponse(req).setContentType("images/gif");
  }
  return picture;
}

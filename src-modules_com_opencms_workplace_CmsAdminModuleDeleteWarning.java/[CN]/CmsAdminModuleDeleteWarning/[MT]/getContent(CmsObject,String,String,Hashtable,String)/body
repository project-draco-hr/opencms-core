{
  if (OpenCms.getLog(this).isDebugEnabled() && C_DEBUG) {
    OpenCms.getLog(this).debug("Getting content of element " + ((elementName == null) ? "<root>" : elementName));
    OpenCms.getLog(this).debug("Template file is: " + templateFile);
    OpenCms.getLog(this).debug("Selected template section is: " + ((templateSelector == null) ? "<default>" : templateSelector));
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  CmsXmlLanguageFile lang=xmlTemplateDocument.getLanguageFile();
  I_CmsSession session=CmsXmlTemplateLoader.getSession(cms.getRequestContext(),true);
  String step=(String)session.getValue(C_SESSION_MODULE_DELETE_STEP);
  if (step != null) {
    if (C_STEP_0.equals(step)) {
      Vector files=(Vector)session.getValue(C_SESSION_MODULE_CHECKSUM);
      if (files.isEmpty()) {
        step=C_STEP_PROPFILES_1;
      }
 else {
        xmlTemplateDocument.setData(C_W_TITLE,lang.getLanguageValue("module.error.deletetitle"));
        xmlTemplateDocument.setData(C_W_TEXT,lang.getLanguageValue("module.error.deletetext1"));
        String output="";
        for (int i=0; i < files.size(); i++) {
          xmlTemplateDocument.setData(C_FILENAME,(String)files.elementAt(i));
          output+=xmlTemplateDocument.getProcessedDataValue(C_CBENTRY);
        }
        xmlTemplateDocument.setData(C_WINCONTENT,output);
        session.putValue(C_SESSION_MODULE_DELETE_STEP,C_STEP_CHECKSUM_2);
      }
    }
    if (C_STEP_CHECKSUM_2.equals(step)) {
      Vector files=(Vector)session.getValue(C_SESSION_MODULE_CHECKSUM);
      Vector outFiles=new Vector();
      for (int i=0; i < files.size(); i++) {
        String file=(String)files.elementAt(i);
        String test=(String)parameters.get(file);
        if (test == null) {
          outFiles.addElement(file);
        }
      }
      session.putValue(C_SESSION_MODULE_EXCLUSION,outFiles);
      step=C_STEP_PROPFILES_1;
    }
    if (C_STEP_PROPFILES_1.equals(step)) {
      Vector files=(Vector)session.getValue(C_SESSION_MODULE_PROPFILES);
      if (files.isEmpty()) {
        step=C_STEP_INUSE;
      }
 else {
        xmlTemplateDocument.setData(C_W_TITLE,lang.getLanguageValue("module.error.deletetitle"));
        xmlTemplateDocument.setData(C_W_TEXT,lang.getLanguageValue("module.error.deletetext2"));
        String output="";
        for (int i=0; i < files.size(); i++) {
          xmlTemplateDocument.setData(C_FILENAME,(String)files.elementAt(i));
          output+=xmlTemplateDocument.getProcessedDataValue(C_CBENTRY);
        }
        xmlTemplateDocument.setData(C_WINCONTENT,output);
        session.putValue(C_SESSION_MODULE_DELETE_STEP,C_STEP_PROPFILES_2);
      }
    }
    if (C_STEP_PROPFILES_2.equals(step)) {
      Vector files=(Vector)session.getValue(C_SESSION_MODULE_PROPFILES);
      Vector outFiles=(Vector)session.getValue(C_SESSION_MODULE_EXCLUSION);
      if (outFiles == null) {
        outFiles=new Vector();
      }
      for (int i=0; i < files.size(); i++) {
        String file=(String)files.elementAt(i);
        String test=(String)parameters.get(file);
        if (test == null) {
          outFiles.addElement(file);
        }
      }
      session.putValue(C_SESSION_MODULE_EXCLUSION,outFiles);
      step=C_STEP_INUSE;
    }
    if (C_STEP_INUSE.equals(step)) {
      Vector files=(Vector)session.getValue(C_SESSION_MODULE_INUSE);
      if (files.isEmpty()) {
        step=C_STEP_MISSFILES;
      }
 else {
        xmlTemplateDocument.setData(C_W_TITLE,lang.getLanguageValue("module.error.deletetitle"));
        xmlTemplateDocument.setData(C_W_TEXT,lang.getLanguageValue("module.error.deletetext3"));
        String output="";
        for (int i=0; i < files.size(); i++) {
          xmlTemplateDocument.setData(C_FILENAME,(String)files.elementAt(i));
          output+=xmlTemplateDocument.getProcessedDataValue(C_FILELISTENTRY);
        }
        xmlTemplateDocument.setData(C_WINCONTENT,output);
        session.putValue(C_SESSION_MODULE_DELETE_STEP,C_STEP_MISSFILES);
      }
    }
    if (C_STEP_MISSFILES.equals(step)) {
      Vector files=(Vector)session.getValue(C_SESSION_MODULE_MISSFILES);
      if (files.isEmpty()) {
        templateSelector=C_READY;
      }
 else {
        xmlTemplateDocument.setData(C_W_TITLE,lang.getLanguageValue("module.error.deletetitle"));
        xmlTemplateDocument.setData(C_W_TEXT,lang.getLanguageValue("module.error.deletetext4"));
        String output="";
        for (int i=0; i < files.size(); i++) {
          xmlTemplateDocument.setData(C_FILENAME,(String)files.elementAt(i));
          output+=xmlTemplateDocument.getProcessedDataValue(C_FILELISTENTRY);
        }
        xmlTemplateDocument.setData(C_WINCONTENT,output);
        session.putValue(C_SESSION_MODULE_DELETE_STEP,C_READY);
      }
    }
    if (C_READY.equals(step)) {
      templateSelector=C_READY;
    }
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

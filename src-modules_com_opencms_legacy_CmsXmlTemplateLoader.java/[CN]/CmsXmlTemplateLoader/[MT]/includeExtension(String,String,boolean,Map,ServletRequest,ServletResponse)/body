{
  CmsFlexController controller=CmsFlexController.getController(req);
  if (controller == null) {
    return target;
  }
  if (element != null) {
    if (!("body".equals(element) || "(default)".equals(element))) {
      CmsJspTagInclude.addParameter(parameterMap,CmsXmlTemplate.C_FRAME_SELECTOR,element,true);
    }
  }
  boolean isPageTarget;
  try {
    CmsResource targetResource=controller.getCmsObject().readResource(target);
    isPageTarget=((CmsResourceTypePage.getStaticTypeId() == targetResource.getTypeId()));
  }
 catch (  CmsException e) {
    controller.setThrowable(e,target);
    throw new CmsLegacyException("File not found: " + target,e);
  }
  String bodyAttribute=(String)controller.getCmsObject().getRequestContext().getAttribute(I_CmsConstants.C_XML_BODY_ELEMENT);
  if (bodyAttribute == null) {
    if (isPageTarget) {
      if (!target.startsWith(I_CmsWpConstants.C_VFS_PATH_BODIES)) {
        target=I_CmsWpConstants.C_VFS_PATH_BODIES + target.substring(1);
      }
      CmsJspTagInclude.addParameter(parameterMap,CmsXmlTemplateLoader.C_ELEMENT_REPLACE,"body:" + target,true);
      target=C_BODYLOADER_URI;
    }
  }
 else {
    if (target.equals(controller.getCmsObject().getRequestContext().getUri())) {
      CmsJspTagInclude.addParameter(parameterMap,CmsXmlTemplateLoader.C_ELEMENT_REPLACE,"body:" + bodyAttribute,true);
      target=C_BODYLOADER_URI;
    }
 else {
      if (isPageTarget) {
        if (isPageTarget && !target.startsWith(I_CmsWpConstants.C_VFS_PATH_BODIES)) {
          target=I_CmsWpConstants.C_VFS_PATH_BODIES + target.substring(1);
        }
        CmsJspTagInclude.addParameter(parameterMap,CmsXmlTemplateLoader.C_ELEMENT_REPLACE,"body:" + target,true);
        target=C_BODYLOADER_URI;
      }
    }
  }
  return target;
}

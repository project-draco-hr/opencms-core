{
  String masterTemplate=(String)properties.get(C_XML_CONTROL_TEMPLATE_PROPERTY);
  if ((masterTemplate == null) || !C_SIMPLE_PAGE) {
    masterTemplate="";
    List allMasterTemplates=cms.getFilesInFolder(I_CmsWpConstants.C_VFS_PATH_DEFAULT_TEMPLATES);
    if (allMasterTemplates.size() > 0) {
      masterTemplate=cms.readAbsolutePath((CmsFile)allMasterTemplates.get(0));
    }
  }
  CmsFile file=null;
  if (C_SIMPLE_PAGE) {
    Hashtable props=new Hashtable();
    props.putAll(properties);
    props.put(C_XML_CONTROL_TEMPLATE_PROPERTY,masterTemplate);
    if (contents == null) {
      contents=(getDefaultBodyStart() + new String(contents) + getDefaultBodyEnd()).getBytes();
    }
    file=cms.doCreateFile(resourcename,contents,I_CmsConstants.C_TYPE_PAGE_NAME,props);
    cms.doLockResource(resourcename,true);
  }
 else {
    String folderName=resourcename.substring(0,resourcename.lastIndexOf(C_FOLDER_SEPARATOR,resourcename.length()) + 1);
    String pageName=resourcename.substring(folderName.length(),resourcename.length());
    String bodyFolder=(I_CmsWpConstants.C_VFS_PATH_BODIES.substring(0,I_CmsWpConstants.C_VFS_PATH_BODIES.lastIndexOf("/"))) + folderName;
    file=cms.doCreateFile(resourcename,"".getBytes(),m_resourceTypeName,properties);
    cms.doLockResource(resourcename,true);
    CmsXmlControlFile pageXml=new CmsXmlControlFile(cms,file);
    pageXml.setTemplateClass(C_XML_CONTROL_DEFAULT_CLASS);
    pageXml.setMasterTemplate(masterTemplate);
    pageXml.setElementClass("body",C_XML_CONTROL_DEFAULT_CLASS);
    pageXml.setElementTemplate("body",bodyFolder + pageName);
    pageXml.write();
    checkFolders(cms,folderName);
    CmsFile bodyFile=cms.doCreateFile(bodyFolder + pageName,(getDefaultBodyStart() + new String(contents) + getDefaultBodyEnd()).getBytes(),I_CmsConstants.C_TYPE_PLAIN_NAME,new Hashtable());
    cms.doLockResource(bodyFolder + pageName,true);
  }
  if (contents.length > 1) {
    CmsPageLinks linkObject=cms.getPageLinks(resourcename);
    cms.createLinkEntrys(linkObject.getResourceId(),linkObject.getLinkTargets());
  }
  return file;
}

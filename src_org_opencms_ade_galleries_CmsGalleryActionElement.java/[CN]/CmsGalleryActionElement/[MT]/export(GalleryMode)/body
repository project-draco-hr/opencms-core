{
  CmsGalleryService galleryService=CmsGalleryService.newInstance(getRequest());
  CmsGalleryConfiguration conf=new CmsGalleryConfiguration();
  conf.setGalleryMode(galleryMode);
  conf.setReferencePath(getRequest().getParameter(I_CmsGalleryProviderConstants.CONFIG_REFERENCE_PATH));
  conf.setGalleryPath(getRequest().getParameter(I_CmsGalleryProviderConstants.CONFIG_GALLERY_PATH));
  conf.setCurrentElement(getRequest().getParameter(I_CmsGalleryProviderConstants.CONFIG_CURRENT_ELEMENT));
  String resourceTypes=getRequest().getParameter(I_CmsGalleryProviderConstants.CONFIG_RESOURCE_TYPES);
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(resourceTypes)) {
    conf.setResourceTypes(Arrays.asList(resourceTypes.split(",")));
  }
  String galleryTypes=getRequest().getParameter(I_CmsGalleryProviderConstants.CONFIG_GALLERY_TYPES);
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(galleryTypes)) {
    conf.setGalleryTypes(galleryTypes.split(","));
  }
  CmsGalleryDataBean data=galleryService.getInitialSettings(conf);
  CmsGallerySearchBean search=null;
  if (GalleryTabId.cms_tab_results.equals(data.getStartTab())) {
    search=galleryService.getSearch(data);
  }
  if ((search != null) && (search.getScope() != null) && (search.getScope() != data.getScope())) {
    data.setScope(search.getScope());
  }
 else   if ((search != null) && (search.getScope() == null)) {
    data.setScope(CmsGallerySearchScope.everything);
  }
  StringBuffer sb=new StringBuffer();
  sb.append(ClientMessages.get().export(getRequest()));
  sb.append(exportDictionary(CmsGalleryDataBean.DICT_NAME,I_CmsGalleryService.class.getMethod("getInitialSettings",CmsGalleryConfiguration.class),data));
  sb.append(exportDictionary(CmsGallerySearchBean.DICT_NAME,I_CmsGalleryService.class.getMethod("getSearch",CmsGalleryDataBean.class),search));
  return sb.toString();
}

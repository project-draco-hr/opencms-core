{
  String newResname=getNewResourceName(getCmsObject(),fileName,targetFolder);
  CmsResource createdResource=null;
  String title=fileName;
  if (title.lastIndexOf('.') != -1) {
    title=title.substring(0,title.lastIndexOf('.'));
  }
  int backslashIndex=title.lastIndexOf('\\');
  if (backslashIndex != -1) {
    title=title.substring(backslashIndex + 1);
  }
  int slashIndex=title.lastIndexOf('/');
  if (slashIndex != -1) {
    title=title.substring(slashIndex + 1);
  }
  List<CmsProperty> properties=new ArrayList<CmsProperty>(1);
  CmsProperty titleProp=new CmsProperty();
  titleProp.setName(CmsPropertyDefinition.PROPERTY_TITLE);
  if (OpenCms.getWorkplaceManager().isDefaultPropertiesOnStructure()) {
    titleProp.setStructureValue(title);
  }
 else {
    titleProp.setResourceValue(title);
  }
  properties.add(titleProp);
  int plainId=OpenCms.getResourceManager().getResourceType(CmsResourceTypePlain.getStaticTypeName()).getTypeId();
  if (!getCmsObject().existsResource(newResname,CmsResourceFilter.IGNORE_EXPIRATION)) {
    try {
      int resTypeId=OpenCms.getResourceManager().getDefaultTypeForName(newResname).getTypeId();
      createdResource=getCmsObject().createResource(newResname,resTypeId,content,properties);
      getCmsObject().unlockResource(newResname);
    }
 catch (    CmsSecurityException e) {
      createdResource=getCmsObject().createResource(newResname,plainId,content,properties);
      getCmsObject().unlockResource(newResname);
    }
catch (    CmsDbSqlException sqlExc) {
      getCmsObject().lockResource(newResname);
      getCmsObject().deleteResource(newResname,CmsResource.DELETE_PRESERVE_SIBLINGS);
      throw sqlExc;
    }
catch (    OutOfMemoryError e) {
      content=null;
      getCmsObject().lockResource(newResname);
      getCmsObject().deleteResource(newResname,CmsResource.DELETE_PRESERVE_SIBLINGS);
      throw e;
    }
  }
 else {
    CmsResource res=getCmsObject().readResource(newResname,CmsResourceFilter.ALL);
    boolean wasLocked=false;
    try {
      if (!getCmsObject().getLock(res).isOwnedBy(getCmsObject().getRequestContext().getCurrentUser())) {
        getCmsObject().lockResource(res);
        wasLocked=true;
      }
      CmsFile file=getCmsObject().readFile(res);
      byte[] contents=file.getContents();
      try {
        getCmsObject().replaceResource(newResname,res.getTypeId(),content,null);
        createdResource=res;
      }
 catch (      CmsDbSqlException sqlExc) {
        file.setContents(contents);
        getCmsObject().writeFile(file);
        throw sqlExc;
      }
catch (      OutOfMemoryError e) {
        content=null;
        file.setContents(contents);
        getCmsObject().writeFile(file);
        throw e;
      }
    }
  finally {
      if (wasLocked) {
        getCmsObject().unlockResource(res);
      }
    }
  }
  return createdResource;
}

{
  I_CmsSession session=cms.getRequestContext().getSession(true);
  Hashtable parameters=(Hashtable)userObj;
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)doc;
  CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
  StringBuffer result=new StringBuffer();
  String pageText=(String)parameters.get(C_PARA_PAGE);
  Vector filteredPics=(Vector)parameters.get("_PICLIST_");
  int numPics=filteredPics.size();
  int page=new Integer(pageText).intValue();
  int from=(page - 1) * C_PICBROWSER_MAXIMAGES;
  int to=((from + C_PICBROWSER_MAXIMAGES) > numPics) ? numPics : (from + C_PICBROWSER_MAXIMAGES);
  String folder=(String)parameters.get(C_PARA_FOLDER);
  if (folder == null) {
    folder=(String)session.getValue(C_PARA_FOLDER);
  }
  if (folder == null || "".equals(folder)) {
    folder=getConfigFile(cms).getPicGalleryPath();
    parameters.put(C_PARA_FOLDER,folder);
  }
  HttpServletRequest req=(HttpServletRequest)(cms.getRequestContext().getRequest().getOriginalRequest());
  String hostName=req.getScheme() + "://" + req.getHeader("HOST");
  String picsUrl=cms.getRequestContext().getRequest().getServletUrl() + folder;
  for (int i=from; i < to; i++) {
    CmsFile file=(CmsFile)filteredPics.elementAt(i);
    String filename=file.getName();
    String title=cms.readProperty(file.getAbsolutePath(),C_PROPERTY_TITLE);
    int dotIndex=filename.lastIndexOf(".");
    if (title == null) {
      if (dotIndex > 0) {
        title=filename.substring(0,dotIndex);
      }
 else {
        title=filename;
      }
    }
    String type;
    if (dotIndex > 0) {
      type=filename.substring(filename.lastIndexOf(".") + 1).toUpperCase() + "-Bild";
    }
 else {
      type=lang.getDataValue("input.unknown");
    }
    xmlTemplateDocument.setData("picsource",hostName + picsUrl + file.getName());
    xmlTemplateDocument.setData("filepath",file.getAbsolutePath());
    xmlTemplateDocument.setData("title",title);
    xmlTemplateDocument.setData("filename",filename);
    xmlTemplateDocument.setData("size",file.getLength() + " Byte");
    xmlTemplateDocument.setData("type",type);
    result.append(xmlTemplateDocument.getProcessedDataValue("piclistentry",this,userObj));
    if (i < (to - 1)) {
      result.append(xmlTemplateDocument.getProcessedDataValue("part",this,userObj));
    }
  }
  return result.toString();
}

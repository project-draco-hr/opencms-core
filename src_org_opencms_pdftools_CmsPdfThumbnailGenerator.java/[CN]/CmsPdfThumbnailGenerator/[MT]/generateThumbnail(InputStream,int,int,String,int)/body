{
  try {
    PDDocument doc=PDDocument.load(pdfInputStream);
    List<?> pages=doc.getDocumentCatalog().getAllPages();
    if (pageIndex >= pages.size()) {
      pageIndex=pages.size() - 1;
    }
 else     if (pageIndex < 0) {
      pageIndex=0;
    }
    PDPage page=(PDPage)pages.get(pageIndex);
    BufferedImage pageThumbnail=generateThumbnailForPage(page,boxWidth,boxHeight);
    ByteArrayOutputStream out=new ByteArrayOutputStream();
    ImageIOUtil.writeImage(pageThumbnail,format,out);
    byte[] imageData=out.toByteArray();
    return imageData;
  }
  finally {
    pdfInputStream.close();
  }
}

{
  HttpSession session=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getSession(true);
  CmsFolder folder=null;
  CmsFile file=null;
  Hashtable storage=new Hashtable();
  int max=0;
  String currentFilelist=(String)session.getValue(C_PARA_FILELIST);
  if (currentFilelist == null) {
    currentFilelist=cms.rootFolder().getAbsolutePath();
  }
  Vector files=cms.getFilesInFolder(currentFilelist);
  Vector folders=cms.getSubFolders(currentFilelist);
  Vector filefolders=new Vector();
  Enumeration enum=folders.elements();
  while (enum.hasMoreElements()) {
    folder=(CmsFolder)enum.nextElement();
    filefolders.addElement(folder);
  }
  enum=files.elements();
  while (enum.hasMoreElements()) {
    file=(CmsFile)enum.nextElement();
    filefolders.addElement(file);
  }
  enum=filefolders.elements();
  while (enum.hasMoreElements()) {
    CmsResource res=(CmsResource)enum.nextElement();
    if (res.getState() != C_STATE_DELETED) {
      String navpos=cms.readMetainformation(res.getAbsolutePath(),C_METAINFO_NAVPOS);
      if (navpos != null) {
        int pos=new Integer(navpos).intValue();
        System.err.println("pos " + pos);
        if (pos > max) {
          max=pos;
        }
        storage.put(new Integer(pos).toString(),res.getAbsolutePath());
      }
    }
  }
  if (newpos > max + 1) {
    newpos=max + 1;
  }
  for (int i=0; i <= max + 2; i++) {
    String name=(String)storage.get(new Integer(i).toString());
    int pos=i;
    if (i == newpos + 1) {
      cms.writeMetainformation(newfile.getAbsolutePath(),C_METAINFO_NAVPOS,new Integer(newpos + 1).toString());
    }
    if (i > newpos) {
      pos=i + 1;
    }
    if (name != null) {
      cms.writeMetainformation(name,C_METAINFO_NAVPOS,new Integer(pos).toString());
    }
  }
}

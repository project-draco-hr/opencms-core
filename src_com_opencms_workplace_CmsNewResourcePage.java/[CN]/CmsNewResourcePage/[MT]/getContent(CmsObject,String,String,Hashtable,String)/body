{
  String template=null;
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String currentFilelist=CmsWorkplaceAction.getCurrentFolder(cms);
  if (currentFilelist == null) {
    currentFilelist=cms.readAbsolutePath(cms.rootFolder());
  }
  String newFile=(String)parameters.get(C_PARA_NEWFILE);
  String title=Encoder.redecodeUriComponent((String)parameters.get(C_PARA_TITLE));
  String keywords=Encoder.redecodeUriComponent((String)parameters.get(C_PARA_KEYWORDS));
  String description=Encoder.redecodeUriComponent((String)parameters.get(C_PARA_DESCRIPTION));
  String fromFolder=(String)parameters.get("fromFolder");
  if ((fromFolder != null) && ("true".equals(fromFolder))) {
    xmlTemplateDocument.setData("name","index.html");
    xmlTemplateDocument.setData("doOnload","checkInTheBox();");
  }
 else {
    xmlTemplateDocument.setData("name","");
    xmlTemplateDocument.setData("doOnload","");
  }
  String templatefile=(String)parameters.get(C_PARA_TEMPLATE);
  String navtitle=Encoder.redecodeUriComponent((String)parameters.get(C_PARA_NAVTEXT));
  String navpos=(String)parameters.get(C_PARA_NAVPOS);
  String layoutFilePath=(String)parameters.get(C_PARA_LAYOUT);
  String step=cms.getRequestContext().getRequest().getParameter("step");
  if (step != null) {
    if (step.equals("1")) {
      if (newFile.indexOf(".") == -1) {
        newFile+=".html";
      }
      try {
        Hashtable prop=new Hashtable();
        if (title != null && !title.equals("")) {
          prop.put(C_PROPERTY_TITLE,title);
        }
        if (keywords != null && !keywords.equals("")) {
          prop.put(C_PROPERTY_KEYWORDS,keywords);
        }
        if (description != null && !description.equals("")) {
          prop.put(C_PROPERTY_DESCRIPTION,description);
        }
        byte[] bodyBytes=null;
        boolean layoutFileDefined=false;
        if (layoutFilePath == null || layoutFilePath.equals("")) {
          bodyBytes=(CmsResourceTypeNewPage.getDefaultBodyStart() + CmsResourceTypeNewPage.getDefaultBodyEnd()).getBytes();
        }
 else {
          bodyBytes=ensureBodyEncoding(cms,layoutFilePath);
          layoutFileDefined=true;
        }
        byte[] content=null;
        if (C_SIMPLE_PAGE) {
          content=bodyBytes;
        }
 else {
          content="".getBytes();
        }
        CmsResource file=null;
        if (!currentFilelist.endsWith(C_FOLDER_SEPARATOR))         currentFilelist+=C_FOLDER_SEPARATOR;
        file=((CmsResourceTypeNewPage)cms.getResourceType(CmsResourceTypeNewPage.C_RESOURCE_TYPE_ID)).createResourceForTemplate(cms,currentFilelist + newFile,prop,content,templatefile);
        if (!C_SIMPLE_PAGE) {
          CmsFile bodyFile=cms.readFile(C_VFS_PATH_BODIES + currentFilelist.substring(1,currentFilelist.length()),newFile);
          bodyFile.setContents(bodyBytes);
          cms.writeFile(bodyFile);
        }
        if (layoutFileDefined) {
          CmsPageLinks linkObject=cms.getPageLinks(currentFilelist + newFile);
          cms.createLinkEntrys(linkObject.getResourceId(),linkObject.getLinkTargets());
        }
        if (navtitle != null) {
          cms.writeProperty(cms.readAbsolutePath(file),C_PROPERTY_NAVTEXT,navtitle);
          if (navpos != null) {
            updateNavPos(cms,file,navpos);
          }
        }
      }
 catch (      CmsException ex) {
        throw new CmsException("Error while creating new Page" + ex.getMessage(),ex.getType(),ex);
      }
      try {
        cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(cms));
      }
 catch (      Exception e) {
        throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + CmsWorkplaceAction.getExplorerFileUri(cms),CmsException.C_UNKNOWN_EXCEPTION,e);
      }
      return null;
    }
  }
 else {
    String putValue=(String)parameters.get("root.pagetype");
    if (putValue != null) {
      session.putValue("resourctype_for_new_page",parameters.get("root.pagetype"));
    }
 else {
      session.removeValue("resourctype_for_new_page");
    }
    session.removeValue(C_PARA_RESOURCE);
  }
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

{
  CmsObject cms=getCmsObject();
  echo("Testing XML page link replacement");
  String filename="/folder1/subfolder11/test1.html";
  String content=CmsXmlPageFactory.createDocument(Locale.ENGLISH,UTF8);
  List<CmsProperty> properties=new ArrayList<CmsProperty>();
  properties.add(new CmsProperty(CmsPropertyDefinition.PROPERTY_CONTENT_ENCODING,UTF8,null));
  properties.add(new CmsProperty(CmsPropertyDefinition.PROPERTY_LOCALE,Locale.ENGLISH.toString(),null));
  properties.add(new CmsProperty(CmsXmlPage.PROPERTY_ALLOW_RELATIVE,CmsStringUtil.FALSE,null));
  cms.createResource(filename,CmsResourceTypeXmlPage.getStaticTypeId(),content.getBytes(UTF8),properties);
  CmsFile file=cms.readFile(filename);
  CmsXmlPage page=CmsXmlPageFactory.unmarshal(cms,file);
  String element="test";
  page.addValue(element,Locale.ENGLISH);
  String text;
  page.setStringValue(cms,element,Locale.ENGLISH,"<a href=\"index.html\">link</a>");
  text=page.getStringValue(cms,element,Locale.ENGLISH);
  assertEquals("<a href=\"/data/opencms/folder1/subfolder11/index.html\">link</a>",text);
  file.setContents(page.marshal());
  String source="/folder1/subfolder11/index.html";
  String destination="/folder1/subfolder11/index_new.html";
  CmsResource movedRes=cms.readResource(source);
  cms.lockResource(source);
  cms.moveResource(source,destination);
  page=CmsXmlPageFactory.unmarshal(cms,file);
  text=page.getStringValue(cms,element,Locale.ENGLISH);
  assertEquals("<a href=\"/data/opencms/folder1/subfolder11/index_new.html\">link</a>",text);
  assertEquals(movedRes.getStructureId(),page.getLinkTable(element,Locale.ENGLISH).getLink("link0").getStructureId());
  file.setContents(page.marshal());
  cms.deleteResource(destination,CmsResource.DELETE_PRESERVE_SIBLINGS);
  cms.unlockResource(destination);
  OpenCms.getPublishManager().publishResource(cms,destination);
  OpenCms.getPublishManager().waitWhileRunning();
  CmsResource newRes=cms.createResource(destination,CmsResourceTypeXmlPage.getStaticTypeId(),content.getBytes(UTF8),properties);
  assertNotSame(movedRes.getStructureId(),newRes.getStructureId());
  page=CmsXmlPageFactory.unmarshal(cms,file);
  text=page.getStringValue(cms,element,Locale.ENGLISH);
  assertEquals("<a href=\"/data/opencms/folder1/subfolder11/index_new.html\">link</a>",text);
  assertEquals(newRes.getStructureId(),page.getLinkTable(element,Locale.ENGLISH).getLink("link0").getStructureId());
  file.setContents(page.marshal());
  page.setStringValue(cms,element,Locale.ENGLISH,"<a href=\"index_noexist.html\">link</a>");
  text=page.getStringValue(cms,element,Locale.ENGLISH);
  assertEquals("<a href=\"/data/opencms/folder1/subfolder11/index_noexist.html\">link</a>",text);
}

{
  String foldername=(String)parameters.get(C_PARA_FOLDER);
  String galleryPath=getGalleryPath();
  if (foldername != null) {
    try {
      CmsFolder fold=cms.readFolder(foldername);
      if (!(fold.getParent().equals(galleryPath))) {
        foldername=galleryPath;
      }
      if (fold.getState() == C_STATE_DELETED) {
        foldername=galleryPath;
      }
    }
 catch (    CmsException exc) {
      foldername=galleryPath;
    }
    session.putValue("lastgallery",foldername);
    parameters.put(C_PARA_FOLDER,foldername);
  }
 else {
    foldername=(String)session.getValue(C_PARA_FOLDER);
    String tmpFolder=(String)session.getValue("lastgallery");
    if (foldername == null) {
      if (tmpFolder != null) {
        try {
          cms.readFolder(tmpFolder);
          foldername=tmpFolder;
        }
 catch (        CmsException e) {
          foldername=galleryPath;
        }
      }
 else {
        foldername=galleryPath;
      }
    }
  }
  session.putValue(C_PARA_FOLDER,foldername);
  return foldername;
}

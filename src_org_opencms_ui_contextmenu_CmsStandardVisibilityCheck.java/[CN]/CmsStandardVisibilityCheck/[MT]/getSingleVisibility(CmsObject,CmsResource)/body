{
  if (flag(roleeditor) && !OpenCms.getRoleManager().hasRole(cms,CmsRole.EDITOR)) {
    return VISIBILITY_INVISIBLE;
  }
  if (flag(rolewpuser) && !OpenCms.getRoleManager().hasRole(cms,CmsRole.WORKPLACE_USER)) {
    return VISIBILITY_INVISIBLE;
  }
  if (flag(notonline) && cms.getRequestContext().getCurrentProject().isOnlineProject()) {
    return VISIBILITY_INVISIBLE;
  }
  if ((resource != null)) {
    if (flag(mainmenu)) {
      return VISIBILITY_INVISIBLE;
    }
    CmsResourceUtil resUtil=new CmsResourceUtil(cms,resource);
    if (flag(file) && !resource.isFile()) {
      return VISIBILITY_INVISIBLE;
    }
    if (flag(xml)) {
      I_CmsResourceType type=resUtil.getResourceType();
      boolean isXml=(type instanceof CmsResourceTypeXmlContent) || (type instanceof CmsResourceTypeXmlPage);
      if (!isXml) {
        return VISIBILITY_INVISIBLE;
      }
    }
    if (flag(unlocked)) {
      CmsLock lock=resUtil.getLock();
      if (!lock.isUnlocked()) {
        return VISIBILITY_INVISIBLE;
      }
    }
    if (flag(otherlock)) {
      CmsLock lock=resUtil.getLock();
      if (lock.isUnlocked() || lock.isOwnedBy(cms.getRequestContext().getCurrentUser())) {
        return VISIBILITY_INVISIBLE;
      }
    }
    if (flag(nootherlock)) {
      CmsLock lock=resUtil.getLock();
      if (!lock.isUnlocked() && !lock.isOwnedBy(cms.getRequestContext().getCurrentUser())) {
        return VISIBILITY_INVISIBLE;
      }
    }
    if (flag(mylock)) {
      CmsLock lock=resUtil.getLock();
      if (!lock.isOwnedBy(cms.getRequestContext().getCurrentUser())) {
        return VISIBILITY_INVISIBLE;
      }
    }
    if (flag(noinheritedlock)) {
      CmsLock lock=resUtil.getLock();
      if (lock.isInherited()) {
        return VISIBILITY_INVISIBLE;
      }
    }
    if (flag(notunchangedfile) && resource.isFile() && resUtil.getResource().getState().isUnchanged()) {
      return VISIBILITY_INVISIBLE;
    }
    if (flag(notnew) && resource.getState().isNew()) {
      CmsMenuItemVisibilityMode.VISIBILITY_INACTIVE.addMessageKey(Messages.GUI_CONTEXTMENU_TITLE_INACTIVE_NEW_UNCHANGED_0);
    }
    if (flag(haseditor) && !OpenCms.getWorkplaceManager().getWorkplaceEditorManager().isEditorAvailableForResource(resource)) {
      return VISIBILITY_INVISIBLE;
    }
    if (flag(inproject) && (!resUtil.isInsideProject() || resUtil.getProjectState().isLockedForPublishing())) {
      return VISIBILITY_INVISIBLE;
    }
    if (flag(publishpermission)) {
      try {
        if (!cms.hasPermissions(resource,CmsPermissionSet.ACCESS_DIRECT_PUBLISH,false,CmsResourceFilter.ALL)) {
          return VISIBILITY_INVISIBLE;
        }
      }
 catch (      CmsException e) {
        LOG.error(e.getLocalizedMessage(),e);
      }
    }
    if (flag(writepermisssion)) {
      try {
        if (!resUtil.isEditable() || !cms.hasPermissions(resUtil.getResource(),CmsPermissionSet.ACCESS_WRITE,false,CmsResourceFilter.ALL)) {
          return CmsMenuItemVisibilityMode.VISIBILITY_INACTIVE.addMessageKey(Messages.GUI_CONTEXTMENU_TITLE_INACTIVE_PERM_WRITE_0);
        }
      }
 catch (      CmsException e) {
        LOG.debug("Error checking context menu entry permissions.",e);
        return CmsMenuItemVisibilityMode.VISIBILITY_INVISIBLE;
      }
    }
    if (flag(notdeleted) && resUtil.getResource().getState().isDeleted()) {
      return CmsMenuItemVisibilityMode.VISIBILITY_INACTIVE.addMessageKey(Messages.GUI_CONTEXTMENU_TITLE_INACTIVE_DELETED_0);
    }
    if (flag(deleted) && !resource.getState().isDeleted()) {
      return CmsMenuItemVisibilityMode.VISIBILITY_INVISIBLE;
    }
  }
 else {
    if (!flag(mainmenu)) {
      return VISIBILITY_INVISIBLE;
    }
  }
  return VISIBILITY_ACTIVE;
}

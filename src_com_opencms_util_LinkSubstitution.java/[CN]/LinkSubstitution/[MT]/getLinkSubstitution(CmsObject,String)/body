{
  if (link == null || "".equals(link)) {
    return "";
  }
  if (!link.startsWith("/")) {
    link=Utils.mergeAbsolutePath(cms.getRequestContext().getRequest().getRequestedResource(),link);
  }
  String linkparam=link;
  link=cms.getRequestContext().addSiteRoot(link);
  String siteRoot=cms.getRequestContext().getAdjustedFullSiteRoot(link);
  int modus=cms.getMode();
  if (modus == I_CmsConstants.C_MODUS_EXPORT) {
    cms.getRequestContext().addLink(linkparam);
    String startRule=OpenCms.getStaticExportProperties().getStartRule();
    if (startRule != null && !"".equals(startRule)) {
      try {
        link=c_perlUtil.substitute(startRule,link);
      }
 catch (      Exception e) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,"[LinkSubstitution.getLinkSubstitution()/1] problems with startrule:\"" + startRule + "\" ("+ e+ "). ");
        }
      }
    }
  }
  boolean httpsMode=false;
  if (modus == I_CmsConstants.C_MODUS_ONLINE) {
    try {
      String scheme=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getScheme();
      if ("https".equalsIgnoreCase(scheme)) {
        httpsMode=true;
      }
    }
 catch (    Exception e) {
      httpsMode=false;
    }
  }
  boolean needsScheme=true;
  if (httpsMode) {
    needsScheme=CmsStaticExport.needsScheme(link);
  }
  String[] rules=CmsStaticExportProperties.getLinkRules(modus);
  if (rules == null || rules.length == 0) {
    return cms.getRequestContext().removeSiteRoot(link);
  }
  String retValue=link;
  for (int i=0; i < rules.length; i++) {
    try {
      boolean nextRule=true;
      if ("*dynamicRules*".equals(rules[i])) {
        Vector booleanReplace=new Vector();
        retValue=CmsStaticExport.handleDynamicRules(cms,link,modus,booleanReplace);
        Boolean goOn=(Boolean)booleanReplace.firstElement();
        if (goOn.booleanValue()) {
          link=retValue;
        }
 else {
          nextRule=false;
        }
      }
 else {
        StringBuffer result=new StringBuffer();
        int matches=c_perlUtil.substitute(result,rules[i],link);
        if (matches != 0) {
          retValue=result.toString();
          nextRule=false;
        }
      }
      if (!nextRule) {
        if (httpsMode && !retValue.startsWith("http")) {
          if (needsScheme) {
            retValue=CmsObject.getStaticExportProperties().getUrlPrefixArray()[3] + retValue;
          }
        }
 else {
          if (CmsObject.getStaticExportProperties().relativLinksInExport() && modus == I_CmsConstants.C_MODUS_EXPORT && (retValue != null) && retValue.startsWith(CmsObject.getStaticExportProperties().getUrlPrefixArray()[0])) {
            retValue=getRelativePath(cms.getRequestContext().getRequest().getRequestedResource(),retValue.substring((CmsObject.getStaticExportProperties().getUrlPrefixArray()[0]).length()));
          }
        }
        if (!retValue.startsWith(CmsObject.getStaticExportProperties().getUrlPrefixArray()[0])) {
          int pos=retValue.indexOf(siteRoot);
          if (pos >= 0) {
            retValue=retValue.substring(0,pos) + retValue.substring(pos + siteRoot.length());
          }
        }
        return retValue;
      }
    }
 catch (    MalformedPerl5PatternException e) {
      if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,"[LinkSubstitution.getLinkSubstitution()/2] problems with rule:\"" + rules[i] + "\" ("+ e+ "). ");
      }
    }
  }
  if (httpsMode && !retValue.startsWith("http")) {
    if (needsScheme) {
      retValue=CmsObject.getStaticExportProperties().getUrlPrefixArray()[3] + retValue;
    }
  }
 else {
    if (CmsObject.getStaticExportProperties().relativLinksInExport() && modus == I_CmsConstants.C_MODUS_EXPORT && (retValue != null) && retValue.startsWith(CmsObject.getStaticExportProperties().getUrlPrefixArray()[0])) {
      retValue=getRelativePath(cms.getRequestContext().getRequest().getRequestedResource(),retValue.substring((CmsObject.getStaticExportProperties().getUrlPrefixArray()[0]).length()));
    }
  }
  if (!retValue.startsWith(CmsObject.getStaticExportProperties().getUrlPrefixArray()[0])) {
    int pos=retValue.indexOf(siteRoot);
    if (pos >= 0) {
      retValue=retValue.substring(0,pos) + retValue.substring(pos + siteRoot.length());
    }
  }
  return retValue;
}

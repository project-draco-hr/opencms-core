{
  if (link == null || "".equals(link)) {
    return "";
  }
  int modus=cms.getMode();
  if (modus == cms.C_MODUS_EXPORT) {
    cms.getRequestContext().addLink(link);
    String startRule=OpenCms.getLinkRuleStart();
    if (startRule != null && !"".equals(startRule)) {
      try {
        link=c_perlUtil.substitute(startRule,link);
      }
 catch (      Exception e) {
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,"[" + this.getClass().getName() + "] problems with startrule:\""+ startRule+ "\" ("+ e+ "). ");
        }
      }
    }
  }
  String[] rules=cms.getLinkRules(modus);
  if (rules == null || rules.length == 0) {
    return link;
  }
  String retValue=link;
  for (int i=0; i < rules.length; i++) {
    try {
      retValue=c_perlUtil.substitute(rules[i],link);
      if (!link.equals(retValue)) {
        return retValue;
      }
    }
 catch (    MalformedPerl5PatternException e) {
      if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,"[" + this.getClass().getName() + "] problems with rule:\""+ rules[i]+ "\" ("+ e+ "). ");
      }
    }
  }
  return retValue;
}

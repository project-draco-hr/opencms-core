{
  CmsResource formatterRes=m_formatters.get(formatter.getName());
  if (formatterRes == null) {
    String formatterPath=getConfiguration().get(formatter.getName());
    if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(formatterPath)) {
      try {
        formatterRes=cms.readResource(formatterPath);
        m_formatters.put(formatter.getName(),formatterRes);
      }
 catch (      CmsException e) {
        if (!LOG.isDebugEnabled()) {
          LOG.warn(e.getLocalizedMessage());
        }
        LOG.debug(e.getLocalizedMessage(),e);
      }
    }
    if (formatterRes == null) {
      formatterPath=formatter.getDefaultPath();
      formatterRes=cms.readResource(formatterPath);
      m_formatters.put(formatter.getName(),formatterRes);
    }
  }
  Map<String,Object> attributeStore=new HashMap<String,Object>();
  Iterator<Entry<String,Object>> attrIt=requestAttributes.entrySet().iterator();
  while (attrIt.hasNext()) {
    Entry<String,Object> ent=attrIt.next();
    attributeStore.put(ent.getKey(),req.getAttribute(ent.getKey()));
    req.setAttribute(ent.getKey(),ent.getValue());
  }
  try {
    String content=new String(OpenCms.getResourceManager().getLoader(formatterRes).dump(cms,formatterRes,null,cms.getRequestContext().getLocale(),req,res),CmsLocaleManager.getResourceEncoding(cms,formatterRes));
    return content.trim();
  }
  finally {
    Iterator<Entry<String,Object>> storeIt=attributeStore.entrySet().iterator();
    while (storeIt.hasNext()) {
      Entry<String,Object> ent=storeIt.next();
      req.setAttribute(ent.getKey(),ent.getValue());
    }
  }
}

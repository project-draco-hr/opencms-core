{
  if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
    A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_STATICEXPORT,"[CmsStaticExport] exporting " + link);
  }
  String deleteFileOnError=null;
  OutputStream outStream=null;
  try {
    CmsExportRequest dReq=new CmsExportRequest();
    int paraStart=link.indexOf("?");
    String externLink=getExternLinkName(link);
    boolean writeFile=true;
    if (externLink == null || externLink.equals("")) {
      writeFile=false;
    }
    if (paraStart >= 0) {
      Hashtable parameter=javax.servlet.http.HttpUtils.parseQueryString(link.substring(paraStart + 1));
      link=link.substring(0,paraStart);
      dReq.setParameters(parameter);
    }
    CmsExportResponse dRes=new CmsExportResponse();
    if (writeFile) {
      String folder=externLink.substring(0,externLink.lastIndexOf('/'));
      String correctur="";
      if (!externLink.startsWith("/")) {
        correctur="/";
        boolean linkIsExtern=true;
        try {
          URL test=new URL(externLink);
        }
 catch (        MalformedURLException e) {
          linkIsExtern=false;
        }
        if (linkIsExtern) {
          throw new CmsException(" This is a extern link.");
        }
      }
      File discFolder=new File(m_exportPath + correctur + folder);
      if (!discFolder.exists()) {
        if (!discFolder.mkdirs()) {
          throw new CmsException("[" + this.getClass().getName() + "] "+ "could't create all folders for "+ folder+ ".");
        }
      }
      File discFile=new File(m_exportPath + correctur + externLink);
      deleteFileOnError=m_exportPath + correctur + externLink;
      try {
        outStream=new FileOutputStream(discFile);
        dRes.putOutputStream(outStream);
      }
 catch (      Exception e) {
        throw new CmsException("[" + this.getClass().getName() + "] "+ "could't open file "+ m_exportPath+ correctur+ externLink+ ": "+ e.getMessage());
      }
    }
 else {
      dRes.putOutputStream(new ByteArrayOutputStream());
    }
    CmsObject cmsForStaticExport=m_cms.getCmsObjectForStaticExport(dReq,dRes);
    cmsForStaticExport.setMode(C_MODUS_EXPORT);
    CmsFile file=m_cms.readFile(link);
    int launcherId=file.getLauncherType();
    String startTemplateClass=file.getLauncherClassname();
    I_CmsLauncher launcher=cmsForStaticExport.getLauncherManager().getLauncher(launcherId);
    if (launcher == null) {
      throw new CmsException("Could not launch file " + link + ". Launcher for requested launcher ID "+ launcherId+ " could not be found.");
    }
    ((CmsExportRequest)cmsForStaticExport.getRequestContext().getRequest()).setRequestedResource(link);
    launcher.initlaunch(cmsForStaticExport,file,startTemplateClass,null);
    Vector linksToAdd=cmsForStaticExport.getRequestContext().getLinkVector();
    for (int i=0; i < linksToAdd.size(); i++) {
      if (!allLinks.contains(linksToAdd.elementAt(i))) {
        allLinks.add(linksToAdd.elementAt(i));
      }
    }
    if (outStream != null) {
      outStream.close();
    }
  }
 catch (  CmsException exc) {
    if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
      A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_STATICEXPORT,"[CmsStaticExport] " + deleteFileOnError + " export "+ link+ " failed: "+ exc.toString());
    }
    if (deleteFileOnError != null) {
      try {
        File deleteMe=new File(deleteFileOnError);
        if (deleteMe.exists() && deleteMe.length() == 0) {
          if (outStream != null) {
            outStream.close();
          }
          deleteMe.delete();
        }
      }
 catch (      Exception e) {
      }
    }
  }
catch (  Exception e) {
    if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
      A_OpenCms.log(I_CmsLogChannels.C_OPENCMS_STATICEXPORT,"[CmsStaticExport]  export " + link + " failed: "+ e.toString());
    }
  }
}

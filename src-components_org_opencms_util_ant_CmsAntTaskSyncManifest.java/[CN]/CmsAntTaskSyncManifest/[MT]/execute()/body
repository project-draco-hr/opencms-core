{
  try {
    Document doc;
    BufferedInputStream in=new BufferedInputStream(new FileInputStream(getXmlFile()));
    try {
      doc=CmsXmlUtils.unmarshalHelper(new InputSource(in),null);
    }
  finally {
      in.close();
    }
    String directory=getDirectory();
    String[] files=new File(directory).list();
    for (int i=0; i < files.length; i++) {
      File file=new File(directory,files[i]);
      if (!file.isDirectory()) {
        continue;
      }
      String[] children=file.list();
      String[] newFiles=new String[files.length + children.length];
      System.arraycopy(files,0,newFiles,0,i + 1);
      for (int j=0; j < children.length; j++) {
        newFiles[j + i + 1]=files[i] + '/' + children[j];
      }
      if (i + 1 < files.length) {
        System.arraycopy(files,i + 1,newFiles,i + 1 + children.length,files.length - (i + 1));
      }
      files=newFiles;
    }
    String prefix=new File(directory).getAbsolutePath().substring(new File(getBase()).getAbsolutePath().length() + 1).replace('\\','/');
    List<Node> xmlFiles=doc.selectNodes("export/files/file/destination[starts-with(.,'" + prefix + "/')]");
    for (    Node xmlFile : xmlFiles) {
      String path=xmlFile.getText();
      File file=new File(getBase() + "/" + path);
      if (!file.exists()) {
        CmsSetupXmlHelper.setValue(doc,getFileXpath(path),null);
      }
    }
    for (int i=0; i < files.length; i++) {
      String destination=prefix + '/' + files[i];
      if (destination.endsWith("/CVS") || destination.contains("/CVS/")) {
        continue;
      }
      String xpath=getFileXpath(destination);
      if (CmsSetupXmlHelper.getValue(doc,xpath) != null) {
        continue;
      }
      String prevDest=prefix + (i == 0 ? "" : '/' + files[i - 1]);
      createEntry(doc,prevDest,destination);
    }
    BufferedOutputStream out=new BufferedOutputStream(new FileOutputStream(getXmlFile()));
    try {
      CmsXmlUtils.marshal(doc,out,"UTF-8");
    }
  finally {
      out.close();
    }
  }
 catch (  Exception e) {
    throw new BuildException(e.getLocalizedMessage(),e);
  }
}

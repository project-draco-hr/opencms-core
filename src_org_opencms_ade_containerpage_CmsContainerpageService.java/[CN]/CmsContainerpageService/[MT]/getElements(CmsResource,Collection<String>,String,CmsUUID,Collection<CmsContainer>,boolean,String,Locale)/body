{
  CmsObject cms=getCmsObject();
  CmsContainerPageBean pageBean=generateContainerPageForContainers(containers,cms.getRequestContext().addSiteRoot(uriParam));
  Map<String,String> idMapping=new HashMap<String,String>();
  List<CmsContainerElementBean> requestedElements=new ArrayList<CmsContainerElementBean>();
  for (  String elemId : clientIds) {
    if ((elemId == null)) {
      continue;
    }
    CmsContainerElementBean element=getCachedElement(elemId);
    if (element.getInstanceId() == null) {
      element=element.clone();
      getSessionCache().setCacheContainerElement(element.editorHash(),element);
    }
    element.initResource(cms);
    idMapping.put(element.editorHash(),elemId);
    requestedElements.add(element);
  }
  if (CmsContainerElement.MENU_CONTAINER_ID.equals(dndOriginContainer)) {
    for (    CmsContainerElementBean element : requestedElements) {
      if (isContainerModelResource(element.getResource())) {
        CmsContainerPageBean modelPage=getContainerModelPage(cms,element.getResource());
        if (modelPage != null) {
          String modelInstanceId=null;
          Map<String,List<CmsContainerBean>> containerByParent=new HashMap<String,List<CmsContainerBean>>();
          for (          CmsContainerBean container : modelPage.getContainers().values()) {
            if (container.getParentInstanceId() != null) {
              if (!containerByParent.containsKey(container.getParentInstanceId())) {
                containerByParent.put(container.getParentInstanceId(),new ArrayList<CmsContainerBean>());
              }
              containerByParent.get(container.getParentInstanceId()).add(container);
            }
            if (modelInstanceId == null) {
              for (              CmsContainerElementBean child : container.getElements()) {
                if (child.getId().equals(element.getId())) {
                  modelInstanceId=child.getInstanceId();
                  break;
                }
              }
            }
          }
          if (containerByParent.containsKey(modelInstanceId)) {
            List<CmsContainerBean> modelContainers=collectModelStructure(modelInstanceId,element.getInstanceId(),containerByParent);
            modelContainers.addAll(pageBean.getContainers().values());
            pageBean=new CmsContainerPageBean(modelContainers);
          }
        }
      }
    }
  }
  CmsElementUtil elemUtil=new CmsElementUtil(cms,uriParam,pageBean,detailContentId,getRequest(),getResponse(),locale);
  Map<String,CmsContainerElementData> result=new HashMap<String,CmsContainerElementData>();
  Set<String> ids=new HashSet<String>();
  for (  CmsContainerElementBean element : requestedElements) {
    String dndId=null;
    if (ids.contains(element.editorHash())) {
      continue;
    }
    if ((dndOriginContainer != null) && !CmsContainerElement.MENU_CONTAINER_ID.equals(dndOriginContainer)) {
      CmsFormatterConfiguration formatterConfig=elemUtil.getFormatterConfiguration(element.getResource());
      Map<String,String> dndSettings=getSettingsToChangeForDnd(element.getIndividualSettings(),formatterConfig,containers,dndOriginContainer,allowNested);
      if (!dndSettings.isEmpty()) {
        CmsContainerElementBean dndElementBean=overrideSettings(element,dndSettings);
        getSessionCache().setCacheContainerElement(dndElementBean.editorHash(),dndElementBean);
        dndId=dndElementBean.editorHash();
        Map<String,CmsContainerElementData> dndResults=getElements(page,Arrays.asList(dndId),uriParam,detailContentId,containers,allowNested,null,locale);
        result.putAll(dndResults);
      }
    }
    CmsContainerElementData elementData=elemUtil.getElementData(page,element,containers,allowNested);
    if (elementData == null) {
      continue;
    }
    elementData.setDndId(dndId);
    result.put(idMapping.get(element.editorHash()),elementData);
    if (elementData.isGroupContainer() || elementData.isInheritContainer()) {
      CmsResource elementRes=cms.readResource(element.getId());
      List<CmsContainerElementBean> subElements=elementData.isGroupContainer() ? getGroupContainerElements(elementRes) : getInheritedElements(elementRes,locale,uriParam);
      for (      CmsContainerElementBean subElement : subElements) {
        getSessionCache().setCacheContainerElement(subElement.editorHash(),subElement);
        if (!ids.contains(subElement.editorHash())) {
          CmsContainerElementData subItemData=elemUtil.getElementData(page,subElement,containers,allowNested);
          ids.add(subElement.editorHash());
          result.put(subElement.editorHash(),subItemData);
        }
      }
    }
    ids.add(element.editorHash());
  }
  return result;
}

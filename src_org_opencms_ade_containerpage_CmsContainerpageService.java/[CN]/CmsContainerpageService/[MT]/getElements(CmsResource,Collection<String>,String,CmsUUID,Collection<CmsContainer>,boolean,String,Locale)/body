{
  CmsObject cms=getCmsObject();
  CmsElementUtil elemUtil=new CmsElementUtil(cms,uriParam,generateContainerPageForContainers(containers,cms.getRequestContext().addSiteRoot(uriParam)),detailContentId,getRequest(),getResponse(),locale);
  Map<String,CmsContainerElementData> result=new HashMap<String,CmsContainerElementData>();
  Set<String> ids=new HashSet<String>();
  for (  String elemId : clientIds) {
    String dndId=null;
    if ((elemId == null) || ids.contains(elemId)) {
      continue;
    }
    CmsContainerElementBean element=getCachedElement(elemId);
    if (element.getInstanceId() == null) {
      element=element.clone();
      getSessionCache().setCacheContainerElement(element.editorHash(),element);
    }
    if (dndOriginContainer != null) {
      CmsFormatterConfiguration formatterConfig=elemUtil.getFormatterConfiguration(element.getResource());
      Map<String,String> dndSettings=getSettingsToChangeForDnd(element.getIndividualSettings(),formatterConfig,containers,dndOriginContainer,allowNested);
      if (!dndSettings.isEmpty()) {
        CmsContainerElementBean dndElementBean=overrideSettings(element,dndSettings);
        getSessionCache().setCacheContainerElement(dndElementBean.editorHash(),dndElementBean);
        dndId=dndElementBean.editorHash();
        Map<String,CmsContainerElementData> dndResults=getElements(page,Arrays.asList(dndId),uriParam,detailContentId,containers,allowNested,null,locale);
        result.putAll(dndResults);
      }
    }
    CmsContainerElementData elementData=elemUtil.getElementData(page,element,containers,allowNested);
    if (elementData == null) {
      continue;
    }
    elementData.setDndId(dndId);
    result.put(elemId,elementData);
    if (elementData.isGroupContainer() || elementData.isInheritContainer()) {
      CmsResource elementRes=cms.readResource(element.getId());
      List<CmsContainerElementBean> subElements=elementData.isGroupContainer() ? getGroupContainerElements(elementRes) : getInheritedElements(elementRes,locale,uriParam);
      for (      CmsContainerElementBean subElement : subElements) {
        getSessionCache().setCacheContainerElement(subElement.editorHash(),subElement);
        if (!ids.contains(subElement.editorHash())) {
          CmsContainerElementData subItemData=elemUtil.getElementData(page,subElement,containers,allowNested);
          ids.add(subElement.editorHash());
          result.put(subElement.editorHash(),subItemData);
        }
      }
    }
    ids.add(elemId);
  }
  return result;
}

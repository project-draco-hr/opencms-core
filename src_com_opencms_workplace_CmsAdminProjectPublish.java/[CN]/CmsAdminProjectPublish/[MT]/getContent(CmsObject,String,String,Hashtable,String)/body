{
  if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging() && C_DEBUG) {
    A_OpenCms.log(C_OPENCMS_DEBUG,this.getClassName() + "getting content of element " + ((elementName == null) ? "<root>" : elementName));
    A_OpenCms.log(C_OPENCMS_DEBUG,this.getClassName() + "template file is: " + templateFile);
    A_OpenCms.log(C_OPENCMS_DEBUG,this.getClassName() + "selected template section is: " + ((templateSelector == null) ? "<default>" : templateSelector));
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=(CmsXmlWpTemplateFile)getOwnTemplateFile(cms,templateFile,elementName,parameters,templateSelector);
  I_CmsSession session=cms.getRequestContext().getSession(true);
  CmsXmlLanguageFile lang=xmlTemplateDocument.getLanguageFile();
  String action=(String)parameters.get("action");
  if ("showResult".equals(action)) {
    A_CmsReportThread doTheWork=(A_CmsReportThread)session.getValue(C_PUBLISH_LINKCHECK_THREAD);
    if (doTheWork.isAlive()) {
      xmlTemplateDocument.setData("endMethod","");
      xmlTemplateDocument.setData("text",lang.getLanguageValue("project.publish.message_linkcheck"));
    }
 else {
      if (doTheWork.brokenLinksFound()) {
        xmlTemplateDocument.setData("endMethod",xmlTemplateDocument.getDataValue("endMethod2"));
        xmlTemplateDocument.setData("autoUpdate","");
        xmlTemplateDocument.setData("text",lang.getLanguageValue("project.publish.message_brokenlinks") + "<br>" + lang.getLanguageValue("project.publish.message_brokenlinks2"));
      }
 else {
        xmlTemplateDocument.setData("endMethod",xmlTemplateDocument.getDataValue("endMethod3"));
        xmlTemplateDocument.setData("autoUpdate","");
        xmlTemplateDocument.setData("text","");
      }
      session.removeValue(C_PUBLISH_LINKCHECK_THREAD);
    }
    xmlTemplateDocument.setData("data",doTheWork.getReportUpdate());
    return startProcessing(cms,xmlTemplateDocument,elementName,parameters,"updateReport");
  }
  if ("doThePublish".equals(action)) {
    int projectId=((Integer)session.getValue(C_PROJECT_ID_FOR_PUBLISH)).intValue();
    session.removeValue(C_PROJECT_ID_FOR_PUBLISH);
    A_CmsReportThread doPublish=new CmsAdminPublishProjectThread(cms,projectId,session);
    doPublish.start();
    session.putValue(C_PUBLISH_THREAD,doPublish);
    xmlTemplateDocument.setData("actionParameter","showPublishResult");
    return startProcessing(cms,xmlTemplateDocument,elementName,parameters,"showresult");
  }
  if ("showPublishResult".equals(action)) {
    A_CmsReportThread doTheWork=(A_CmsReportThread)session.getValue(C_PUBLISH_THREAD);
    if (doTheWork.isAlive()) {
      xmlTemplateDocument.setData("endMethod","");
      xmlTemplateDocument.setData("text",lang.getLanguageValue("project.publish.message_publish"));
    }
 else {
      xmlTemplateDocument.setData("endMethod",xmlTemplateDocument.getDataValue("endMethod"));
      xmlTemplateDocument.setData("autoUpdate","");
      xmlTemplateDocument.setData("text",lang.getLanguageValue("project.publish.message_publish2"));
      session.removeValue(C_PUBLISH_THREAD);
    }
    xmlTemplateDocument.setData("data",doTheWork.getReportUpdate());
    return startProcessing(cms,xmlTemplateDocument,elementName,parameters,"updateReport");
  }
  String paraId=(String)parameters.get("projectid");
  int projectId=-1;
  int projectType=C_PROJECT_TYPE_TEMPORARY;
  if (paraId != null) {
    projectId=Integer.parseInt(paraId);
    CmsProject project=cms.readProject(projectId);
    projectType=project.getType();
    xmlTemplateDocument.setData("projectid",projectId + "");
    xmlTemplateDocument.setData("projectname",project.getName());
  }
  String fromExplorer=(String)parameters.get("fromExplorer");
  if (fromExplorer != null) {
    CmsProject currentProject=cms.getRequestContext().currentProject();
    projectId=currentProject.getId();
    projectType=currentProject.getType();
    xmlTemplateDocument.setData("projectid",projectId + "");
    xmlTemplateDocument.setData("projectname",currentProject.getName());
    if ((action != null) && "check".equals(action)) {
      if (cms.countLockedResources(projectId) == 0) {
        action="ok";
      }
 else {
        return startProcessing(cms,xmlTemplateDocument,elementName,parameters,"asklock");
      }
    }
 else     if ((action != null) && "rmlocks".equals(action)) {
      try {
        cms.unlockProject(projectId);
        action="ok";
      }
 catch (      CmsException exc) {
        xmlTemplateDocument.setData("details",Utils.getStackTrace(exc));
        return startProcessing(cms,xmlTemplateDocument,elementName,parameters,"errorlock");
      }
    }
  }
  if ((action != null) && "ok".equals(action)) {
    if (session.getValue(C_SESSION_THREAD_ERROR) != null) {
      session.removeValue(C_SESSION_THREAD_ERROR);
    }
    if (projectType == C_PROJECT_TYPE_TEMPORARY) {
      cms.getRequestContext().setCurrentProject(cms.onlineProject().getId());
    }
    A_CmsReportThread doCheck=new CmsAdminLinkmanagementThread(cms,projectId);
    doCheck.start();
    session.putValue(C_PUBLISH_LINKCHECK_THREAD,doCheck);
    session.putValue(C_PROJECT_ID_FOR_PUBLISH,new Integer(projectId));
    templateSelector="showresult";
  }
 else {
    if ((action != null) && ("working".equals(action))) {
      A_CmsReportThread doPublish=(A_CmsReportThread)session.getValue(C_PUBLISH_THREAD);
      if (doPublish.isAlive()) {
        String time=(String)parameters.get("time");
        int wert=Integer.parseInt(time);
        wert+=2;
        xmlTemplateDocument.setData("time","" + wert);
        templateSelector="wait";
      }
 else {
        String errordetails=(String)session.getValue(C_SESSION_THREAD_ERROR);
        if (errordetails == null) {
          CmsXmlWpTemplateFile.clearcache();
          templateSelector="done";
        }
 else {
          xmlTemplateDocument.setData("details",errordetails);
          templateSelector="error";
          session.removeValue(C_SESSION_THREAD_ERROR);
        }
      }
    }
  }
  return startProcessing(cms,xmlTemplateDocument,elementName,parameters,templateSelector);
}

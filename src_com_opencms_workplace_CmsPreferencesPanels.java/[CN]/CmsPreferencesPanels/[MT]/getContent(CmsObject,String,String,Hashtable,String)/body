{
  CmsRequestContext reqCont=cms.getRequestContext();
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String template="";
  String panel;
  String oldPanel;
  int explorerSettingsValue;
  String initial=(String)parameters.get(C_PARA_INITIAL);
  if (initial != null) {
    session.removeValue("EXPLORERSETTINGS");
    session.removeValue("TASKSETTINGS");
    session.removeValue("USERSETTINGS");
    session.removeValue("STARTSETTINGS");
    session.removeValue(C_PARA_OLDPANEL);
    session.removeValue("lasturl");
    panel="explorer";
  }
 else {
    panel=(String)parameters.get(C_PARA_PANEL);
  }
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  if ((parameters.get(C_PARA_SUBMIT) != null) || (parameters.get(C_PARA_OK) != null)) {
    if (panel != null) {
      if (panel.equals(C_PANEL_EXPLORER)) {
        int explorerSettings=getExplorerSettings(parameters);
        session.putValue(C_PARA_EXPLORERSETTINGS,new Integer(explorerSettings).toString());
      }
      if (panel.equals(C_PANEL_TASK)) {
        Hashtable taskSettings=getTaskSettings(parameters,session);
        if (taskSettings != null) {
          session.putValue(C_PARA_TASKSETTINGS,taskSettings);
        }
      }
      if (panel.equals(C_PANEL_START)) {
        Hashtable startSettings=getStartSettings(cms,parameters);
        if (startSettings != null) {
          session.putValue(C_PARA_STARTSETTINGS,startSettings);
        }
      }
      if (panel.equals(C_PANEL_USER)) {
      }
    }
    String explorerSettings=(String)session.getValue(C_PARA_EXPLORERSETTINGS);
    if (explorerSettings != null) {
      reqCont.currentUser().setAdditionalInfo(C_ADDITIONAL_INFO_EXPLORERSETTINGS,explorerSettings);
    }
    Hashtable taskSettings=(Hashtable)session.getValue(C_PARA_TASKSETTINGS);
    if (taskSettings != null) {
      reqCont.currentUser().setAdditionalInfo(C_ADDITIONAL_INFO_TASKSETTINGS,taskSettings);
    }
    Hashtable startSettings=(Hashtable)session.getValue(C_PARA_STARTSETTINGS);
    if (startSettings != null) {
      cms.getRequestContext().currentUser().setAdditionalInfo(C_ADDITIONAL_INFO_STARTSETTINGS,startSettings);
      String defaultGroup=(String)startSettings.get(C_START_DEFAULTGROUP);
      reqCont.currentUser().setDefaultGroup(cms.readGroup(defaultGroup));
    }
    String userSettings=(String)session.getValue(C_PARA_USERSETTINGS);
    if (userSettings != null) {
    }
    cms.writeUser(reqCont.currentUser());
  }
  if (panel != null) {
    template=panel;
    if (panel.equals(C_PANEL_EXPLORER)) {
      setExplorerSettings(session,parameters,reqCont,xmlTemplateDocument);
    }
 else {
      if (panel.equals(C_PANEL_TASK)) {
        setTaskSettings(session,parameters,reqCont,xmlTemplateDocument);
      }
 else {
        if (panel.equals(C_PANEL_START)) {
          setStartSettings(cms,session,parameters,reqCont,xmlTemplateDocument);
        }
 else {
          if (panel.equals(C_PANEL_USER)) {
            setUserSettings(session,parameters,reqCont,xmlTemplateDocument);
          }
        }
      }
    }
    oldPanel=(String)session.getValue(C_PARA_OLDPANEL);
    if (oldPanel != null) {
      if (oldPanel.equals("explorer")) {
        int explorerSettings=getExplorerSettings(parameters);
        session.putValue("EXPLORERSETTINGS",new Integer(explorerSettings).toString());
      }
      if (oldPanel.equals("task")) {
        Hashtable taskSettings=getTaskSettings(parameters,session);
        if (taskSettings != null) {
          session.putValue("TASKSETTINGS",taskSettings);
        }
      }
      if (oldPanel.equals("user")) {
      }
      if (oldPanel.equals("start")) {
        Hashtable startSettings=getStartSettings(cms,parameters);
        if (startSettings != null) {
          session.putValue("STARTSETTINGS",startSettings);
        }
      }
    }
    session.putValue(C_PARA_OLDPANEL,panel);
  }
  if ((parameters.get("OK") != null) || (parameters.get("CANCEL") != null)) {
    session.removeValue("EXPLORERSETTINGS");
    session.removeValue("TASKSETTINGS");
    session.removeValue("USERSETTINGS");
    session.removeValue("STARTSETTINGS");
    session.removeValue(C_PARA_OLDPANEL);
    try {
      cms.getRequestContext().getResponse().sendCmsRedirect(getConfigFile(cms).getWorkplaceActionPath() + C_WP_RELOAD);
    }
 catch (    Exception e) {
      throw new CmsException("Redirect fails :" + getConfigFile(cms).getWorkplaceActionPath() + C_WP_RELOAD,CmsException.C_UNKNOWN_EXCEPTION,e);
    }
    return null;
  }
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

{
  CmsObject cms=getCmsObject();
  echo("Testing restoring and deleting a sibling several times");
  String resName="siblingRestoreIteration.txt";
  String sibName="sibling2RestoreIteration.txt";
  int vers=OpenCms.getSystemInfo().getHistoryVersions();
  int delVers=OpenCms.getSystemInfo().getHistoryVersionsAfterDeletion();
  try {
    OpenCms.getSystemInfo().setVersionHistorySettings(true,10,10);
    cms.createResource(resName,CmsResourceTypePlain.getStaticTypeId());
    assertVersion(cms,resName,1);
    assertTrue(cms.readAllAvailableVersions(resName).isEmpty());
    OpenCms.getPublishManager().publishResource(cms,resName);
    OpenCms.getPublishManager().waitWhileRunning();
    assertVersion(cms,resName,1);
    assertEquals(1,cms.readAllAvailableVersions(resName).size());
    cms.copyResource(resName,sibName,CmsResource.COPY_AS_SIBLING);
    CmsResource sib=cms.readResource(sibName);
    assertVersion(cms,resName,1);
    assertEquals(1,cms.readAllAvailableVersions(resName).size());
    assertVersion(cms,sibName,1);
    assertTrue(cms.readAllAvailableVersions(sibName).isEmpty());
    OpenCms.getPublishManager().publishResource(cms,sibName);
    OpenCms.getPublishManager().waitWhileRunning();
    assertVersion(cms,resName,1);
    assertEquals(1,cms.readAllAvailableVersions(resName).size());
    assertVersion(cms,sibName,1);
    assertEquals(1,cms.readAllAvailableVersions(sibName).size());
    for (int i=0; i < 3; i++) {
      cms.lockResource(sibName);
      cms.deleteResource(sibName,CmsResource.DELETE_PRESERVE_SIBLINGS);
      assertVersion(cms,resName,1);
      assertEquals(1,cms.readAllAvailableVersions(resName).size());
      assertVersion(cms,sibName,2 + (i * 2));
      assertEquals(1 + (i * 2),cms.readAllAvailableVersions(sibName).size());
      OpenCms.getPublishManager().publishResource(cms,sibName);
      OpenCms.getPublishManager().waitWhileRunning();
      assertVersion(cms,resName,1);
      assertEquals(1,cms.readAllAvailableVersions(resName).size());
      cms.restoreDeletedResource(sib.getStructureId());
      assertVersion(cms,resName,1);
      assertEquals(1,cms.readAllAvailableVersions(resName).size());
      assertVersion(cms,sibName,3 + (i * 2));
      assertEquals(2 + (i * 2),cms.readAllAvailableVersions(sibName).size());
      OpenCms.getPublishManager().publishResource(cms,sibName);
      OpenCms.getPublishManager().waitWhileRunning();
      assertVersion(cms,resName,1);
      assertEquals(1,cms.readAllAvailableVersions(resName).size());
      assertVersion(cms,sibName,3 + (i * 2));
      assertEquals(3 + (i * 2),cms.readAllAvailableVersions(sibName).size());
    }
  }
  finally {
    OpenCms.getSystemInfo().setVersionHistorySettings(true,vers,delVers);
  }
}

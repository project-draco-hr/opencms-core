{
  CmsObject cms=getCmsObject();
  echo("Testing the version numbers of a file after several modifications");
  String resName="fileVersionTest.txt";
  CmsProject offline=cms.getRequestContext().currentProject();
  CmsProject online=cms.readProject(CmsProject.ONLINE_PROJECT_ID);
  cms.createResource(resName,CmsResourceTypePlain.getStaticTypeId());
  assertHistory(cms,resName,1);
  OpenCms.getPublishManager().publishResource(cms,resName);
  OpenCms.getPublishManager().waitWhileRunning();
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,1);
  cms.getRequestContext().setCurrentProject(offline);
  cms.lockResource(resName);
  cms.setDateLastModified(resName,System.currentTimeMillis(),false);
  assertHistory(cms,resName,2);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,1);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,resName);
  OpenCms.getPublishManager().waitWhileRunning();
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,2);
  cms.getRequestContext().setCurrentProject(offline);
  assertHistory(cms,resName,2);
  cms.lockResource(resName);
  cms.writePropertyObject(resName,new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,"test",null));
  assertHistory(cms,resName,3);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,2);
  cms.getRequestContext().setCurrentProject(offline);
  assertHistory(cms,resName,3);
  OpenCms.getPublishManager().publishResource(cms,resName);
  OpenCms.getPublishManager().waitWhileRunning();
  assertHistory(cms,resName,3);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,3);
  String sibName="fileVersionTest_sib.txt";
  cms.getRequestContext().setCurrentProject(offline);
  cms.createSibling(resName,sibName,null);
  assertHistory(cms,resName,3);
  assertHistory(cms,sibName,3);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,3);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,sibName);
  OpenCms.getPublishManager().waitWhileRunning();
  assertHistory(cms,resName,3);
  assertHistory(cms,sibName,3);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,3);
  assertHistory(cms,sibName,3);
  cms.getRequestContext().setCurrentProject(offline);
  cms.lockResource(sibName);
  cms.writePropertyObject(sibName,new CmsProperty(CmsPropertyDefinition.PROPERTY_DESCRIPTION,null,"test description"));
  assertHistory(cms,resName,4);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,3);
  assertHistory(cms,sibName,3);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,sibName);
  OpenCms.getPublishManager().waitWhileRunning();
  assertHistory(cms,resName,4);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,4);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(offline);
  cms.lockResource(resName);
  cms.setDateExpired(resName,System.currentTimeMillis() + 100000,false);
  assertHistory(cms,resName,5);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,4);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,resName);
  OpenCms.getPublishManager().waitWhileRunning();
  assertHistory(cms,resName,5);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,5);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(offline);
  cms.lockResource(resName);
  cms.writePropertyObject(resName,new CmsProperty(CmsPropertyDefinition.PROPERTY_NAVPOS,null,"1.5"));
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,5);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,5);
  assertHistory(cms,sibName,4);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,resName);
  OpenCms.getPublishManager().waitWhileRunning();
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,5);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,5);
  cms.getRequestContext().setCurrentProject(offline);
  cms.lockResource(sibName);
  cms.setDateReleased(sibName,System.currentTimeMillis() - 1000,false);
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,6);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,5);
  cms.getRequestContext().setCurrentProject(offline);
  OpenCms.getPublishManager().publishResource(cms,sibName);
  OpenCms.getPublishManager().waitWhileRunning();
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,6);
  cms.getRequestContext().setCurrentProject(online);
  assertHistory(cms,resName,6);
  assertHistory(cms,sibName,6);
}

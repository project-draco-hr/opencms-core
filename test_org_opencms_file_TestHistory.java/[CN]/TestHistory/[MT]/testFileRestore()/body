{
  CmsObject cms=getCmsObject();
  echo("Testing restoring a file also possible missing folders are restored");
  List deletedResources=cms.readDeletedResources("/",true);
  assertTrue(deletedResources.isEmpty());
  CmsResource folder=cms.createResource("testFolder",CmsResourceTypeFolder.RESOURCE_TYPE_ID);
  cms.writePropertyObject("testFolder",new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,"strFolder","resFolder"));
  CmsResource res=cms.createResource("testFolder/test.txt",CmsResourceTypePlain.getStaticTypeId(),"test".getBytes(),null);
  cms.writePropertyObject("testFolder/test.txt",new CmsProperty(CmsPropertyDefinition.PROPERTY_TITLE,"strFile","resFile"));
  storeResources(cms,"testFolder",true);
  OpenCms.getPublishManager().publishResource(cms,"testFolder");
  OpenCms.getPublishManager().waitWhileRunning();
  cms.lockResource("testFolder");
  cms.deleteResource("testFolder/test.txt",CmsResource.DELETE_PRESERVE_SIBLINGS);
  cms.deleteResource("testFolder",CmsResource.DELETE_PRESERVE_SIBLINGS);
  OpenCms.getPublishManager().publishResource(cms,"testFolder");
  OpenCms.getPublishManager().waitWhileRunning();
  assertFalse(cms.existsResource("testFolder",CmsResourceFilter.ALL));
  assertFalse(cms.existsResource("testFolder/test.txt",CmsResourceFilter.ALL));
  CmsProject offline=cms.getRequestContext().currentProject();
  cms.getRequestContext().setCurrentProject(cms.readProject(CmsProject.ONLINE_PROJECT_ID));
  assertFalse(cms.existsResource("testFolder",CmsResourceFilter.ALL));
  assertFalse(cms.existsResource("testFolder/test.txt",CmsResourceFilter.ALL));
  cms.getRequestContext().setCurrentProject(offline);
  deletedResources=cms.readDeletedResources("/",false);
  assertEquals(1,deletedResources.size());
  assertEquals("/testFolder/",cms.getSitePath((CmsResource)deletedResources.get(0)));
  deletedResources=cms.readDeletedResources("/",true);
  assertEquals(2,deletedResources.size());
  assertEquals("/testFolder/",cms.getSitePath((CmsResource)deletedResources.get(0)));
  assertEquals("/testFolder/test.txt",cms.getSitePath((CmsResource)deletedResources.get(1)));
  cms.restoreDeletedResource(res.getStructureId());
  deletedResources=cms.readDeletedResources("/",true);
  assertTrue(deletedResources.isEmpty());
  OpenCmsTestResourceConfigurableFilter filter=new OpenCmsTestResourceConfigurableFilter();
  filter.enableDateCreatedSecTest();
  assertFilter(cms,"testFolder/",filter);
  assertFilter(cms,cms.getSitePath(res),filter);
  cms.lockResource("testFolder");
  cms.deleteResource("testFolder/test.txt",CmsResource.DELETE_PRESERVE_SIBLINGS);
  cms.deleteResource("testFolder",CmsResource.DELETE_PRESERVE_SIBLINGS);
  cms.createResource("testFolder",CmsResourceTypeFolder.RESOURCE_TYPE_ID);
  cms.createResource("testFolder/test.txt",CmsResourceTypePlain.getStaticTypeId(),"test".getBytes(),null);
  deletedResources=cms.readDeletedResources("/",false);
  assertEquals(1,deletedResources.size());
  assertEquals("/testFolder/",cms.getSitePath((CmsResource)deletedResources.get(0)));
  deletedResources=cms.readDeletedResources("/",true);
  assertEquals(2,deletedResources.size());
  assertEquals("/testFolder/",cms.getSitePath((CmsResource)deletedResources.get(0)));
  assertEquals("/testFolder/test.txt",cms.getSitePath((CmsResource)deletedResources.get(1)));
  cms.restoreDeletedResource(res.getStructureId());
  assertFalse(cms.readFolder("testFolder").getStructureId().equals(folder.getStructureId()));
  setMapping("/testFolder/test_1.txt","/testFolder/test.txt");
  filter.disableNameTest();
  assertFilter(cms,"/testFolder/test_1.txt",filter);
  cms.restoreDeletedResource(folder.getStructureId());
  setMapping("/testFolder_1/","testFolder/");
  assertFilter(cms,"/testFolder_1/",filter);
}

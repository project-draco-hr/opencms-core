{
  CmsUser user=cms.getRequestContext().getCurrentUser();
  String settingsString=(String)user.getAdditionalInfo(WORKPLACE_APP_SETTINGS_KEY);
  JSONObject settings;
  if (CmsStringUtil.isEmptyOrWhitespaceOnly(settingsString)) {
    settings=new JSONObject();
  }
 else {
    try {
      settings=new JSONObject(settingsString);
    }
 catch (    JSONException e) {
      LOG.error("Failed to parse store workplace app settings. Discarding corrupted settings.",e);
      settings=new JSONObject();
    }
  }
  boolean changed=false;
  try {
    String state=appSettings.getSettingsString();
    if (CmsStringUtil.isEmptyOrWhitespaceOnly(state)) {
      if (settings.has(type.getName())) {
        settings.remove(type.getName());
        changed=true;
      }
    }
 else     if (!settings.has(type.getName()) || !state.equals(settings.getString(type.getName()))) {
      settings.put(type.getName(),state);
      changed=true;
    }
  }
 catch (  JSONException e) {
    LOG.error("Failed to store workplace app settings for type " + type.getName(),e);
  }
  if (changed) {
    settingsString=settings.toString();
    user.setAdditionalInfo(WORKPLACE_APP_SETTINGS_KEY,settingsString);
    try {
      cms.writeUser(user);
    }
 catch (    CmsException e) {
      LOG.error("Failed to store workplace app settings for type " + type.getName(),e);
    }
  }
}

{
  JSONObject result=new JSONObject();
  HttpServletRequest request=getRequest();
  if (!checkParameters(request,result,ReqParam.ACTION.getName())) {
    return result;
  }
  String actionParam=request.getParameter(ReqParam.ACTION.getName());
  Action action=Action.valueOf(actionParam.toUpperCase());
  JSONObject data=new JSONObject();
  if (checkParameters(request,null,ReqParam.DATA.getName())) {
    String dataParam=request.getParameter(ReqParam.DATA.getName());
    data=new JSONObject(dataParam);
  }
  CmsADESessionCache sessionCache=(CmsADESessionCache)request.getSession().getAttribute(CmsADESessionCache.SESSION_ATTR_ADE_CACHE);
  CmsPublishOptions options=sessionCache.getPublishOptions();
  if (action.equals(Action.PUBLISH_OPTIONS)) {
    result.merge(options.toJson(),true,false);
    return result;
  }
  if (checkParameters(data,null,ParamPublish.RELATED.getName())) {
    options.setIncludeRelated(data.optBoolean(ParamPublish.RELATED.getName()));
  }
  if (checkParameters(data,null,ParamPublish.SIBLINGS.getName())) {
    options.setIncludeSiblings(data.optBoolean(ParamPublish.SIBLINGS.getName()));
  }
  if (checkParameters(data,null,ParamPublish.PROJECT.getName())) {
    String projectParam=data.optString(ParamPublish.PROJECT.getName());
    try {
      options.setProjectId(new CmsUUID(projectParam));
    }
 catch (    NumberFormatException e) {
      options.setProjectId(null);
      LOG.warn(e.getLocalizedMessage(),e);
    }
  }
 else {
    options.setProjectId(null);
  }
  CmsObject cms=getCmsObject();
  cms.getRequestContext().setLocale(getWorkplaceLocale());
  CmsADEPublish publish=new CmsADEPublish(cms);
  publish.getOptions().setIncludeRelated(options.isIncludeRelated());
  publish.getOptions().setIncludeSiblings(options.isIncludeSiblings());
  publish.getOptions().setProjectId(options.getProjectId());
  if (action.equals(Action.PUBLISH_LIST)) {
    if (data.has(ParamPublish.REMOVE_RESOURCES.getName())) {
      removeFromPublishList(publish,data.optJSONArray(ParamPublish.REMOVE_RESOURCES.getName()));
    }
    JSONArray groupsToPublish=toJsonArray(publish.getPublishGroups());
    result.put(JsonResponse.GROUPS.getName(),groupsToPublish);
  }
 else   if (action.equals(Action.PROJECTS)) {
    JSONArray manageableProjects=toJsonArray(publish.getManageableProjects());
    result.put(JsonResponse.PROJECTS.getName(),manageableProjects);
  }
 else   if (action.equals(Action.PUBLISH)) {
    if (data.has(ParamPublish.REMOVE_RESOURCES.getName())) {
      removeFromPublishList(publish,data.optJSONArray(ParamPublish.REMOVE_RESOURCES.getName()));
    }
    if (!checkParameters(data,result,ParamPublish.RESOURCES.getName())) {
      return result;
    }
    sessionCache.setCachePublishOptions(new CmsPublishOptions(publish.getOptions().isIncludeRelated(),publish.getOptions().isIncludeSiblings(),publish.getOptions().getProjectId()));
    JSONArray idsToPublish=data.optJSONArray(ParamPublish.RESOURCES.getName());
    List<CmsResource> pubResources;
    try {
      pubResources=resourcesFromJson(idsToPublish);
    }
 catch (    CmsException e) {
      error(result,e.getLocalizedMessage());
      return result;
    }
    Collections.sort(pubResources,I_CmsResource.COMPARE_DATE_LAST_MODIFIED);
    JSONArray resources=new JSONArray();
    if (!data.has(ParamPublish.FORCE.getName()) || !data.optBoolean(ParamPublish.FORCE.getName()) || !isCanPublish()) {
      resources=toJsonArray(publish.getBrokenResources(pubResources));
    }
    if (resources.length() == 0) {
      publish.publishResources(pubResources);
    }
 else {
      result.put(JsonResponse.RESOURCES.getName(),resources);
      result.put(JsonResponse.CANPUBLISH.getName(),isCanPublish());
    }
  }
  return result;
}

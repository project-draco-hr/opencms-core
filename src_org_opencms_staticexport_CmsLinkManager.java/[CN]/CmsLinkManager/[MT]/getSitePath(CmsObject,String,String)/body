{
  URI uri;
  try {
    uri=new URI(targetUri);
  }
 catch (  Exception exc) {
    return null;
  }
  if (uri.isOpaque()) {
    return null;
  }
  if (uri.isAbsolute()) {
    CmsSiteMatcher matcher=new CmsSiteMatcher(targetUri);
    if (OpenCms.getSiteManager().isMatching(matcher)) {
      String path=uri.getPath();
      path=path.substring(OpenCms.getOpenCmsContext().length());
      return OpenCms.getSiteManager().matchSite(matcher).getSiteRoot() + path;
    }
 else {
      return null;
    }
  }
  if (uri.getPath().startsWith(OpenCms.getOpenCmsContext())) {
    return targetUri;
  }
  if (!uri.getPath().startsWith("/")) {
    if (relativePath != null) {
      return cms.getRequestContext().addSiteRoot(relativePath + uri.getPath());
    }
 else {
      return null;
    }
  }
  return cms.getRequestContext().addSiteRoot(uri.getPath());
}

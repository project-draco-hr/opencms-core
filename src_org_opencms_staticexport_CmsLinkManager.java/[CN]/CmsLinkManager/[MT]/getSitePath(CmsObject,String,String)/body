{
  URI uri;
  String path;
  String fragment;
  String query;
  try {
    uri=new URI(targetUri);
    path=uri.getPath();
    fragment=uri.getFragment();
    if (fragment != null) {
      fragment="#" + fragment;
    }
 else {
      fragment="";
    }
    query=uri.getQuery();
    if (query != null) {
      query="?" + query;
    }
 else {
      query="";
    }
  }
 catch (  Exception exc) {
    return null;
  }
  if (uri.isOpaque()) {
    return null;
  }
  if (uri.isAbsolute()) {
    CmsSiteMatcher matcher=new CmsSiteMatcher(targetUri);
    if (OpenCms.getSiteManager().isMatching(matcher)) {
      if (path.startsWith(OpenCms.getOpenCmsContext())) {
        path=path.substring(OpenCms.getOpenCmsContext().length());
      }
      return OpenCms.getSiteManager().matchSite(matcher).getSiteRoot() + path + fragment+ query;
    }
 else {
      return null;
    }
  }
  String context=OpenCms.getOpenCmsContext();
  if (context != null && path.startsWith(context)) {
    String siteRoot=CmsSiteManager.getSiteRoot(relativePath);
    if (siteRoot != null) {
      return siteRoot + path.substring(context.length()) + fragment+ query;
    }
 else {
      return cms.getRequestContext().addSiteRoot(path.substring(context.length())) + fragment + query;
    }
  }
  if (!path.startsWith("/")) {
    if (relativePath != null) {
      String absolutePath=getAbsoluteUri(path,cms.getRequestContext().addSiteRoot(relativePath));
      if (CmsSiteManager.getSiteRoot(absolutePath) != null) {
        return absolutePath + fragment + query;
      }
    }
    return null;
  }
  return cms.getRequestContext().addSiteRoot(path) + fragment + query;
}

{
  if (link == null || "".equals(link)) {
    return "";
  }
  String absoluteLink;
  if (!link.startsWith("/")) {
    absoluteLink=Utils.mergeAbsolutePath(cms.getRequestContext().getUri(),link);
  }
 else {
    absoluteLink=link;
  }
  String vfsName;
  String parameters;
  int pos=absoluteLink.indexOf('?');
  if (pos >= 0) {
    vfsName=absoluteLink.substring(0,pos - 1);
    parameters=absoluteLink.substring(pos);
  }
 else {
    vfsName=absoluteLink;
    parameters=null;
  }
  String resultLink=null;
  boolean exportRequired=false;
  if (OpenCms.getStaticExportProperties().isStaticExportEnabled() && cms.getRequestContext().currentProject().isOnlineProject()) {
    try {
      resultLink=OpenCms.getStaticExportProperties().getCachedOnlineLink(vfsName);
      if (resultLink == null) {
        exportRequired="true".equalsIgnoreCase(cms.readProperty(vfsName,I_CmsConstants.C_PROPERTY_EXPORT,true,"false").trim());
      }
    }
 catch (    Throwable t) {
    }
  }
  if (resultLink == null) {
    if (!exportRequired) {
      resultLink=OpenCms.getStaticExportProperties().getVfsPrefix() + absoluteLink;
    }
 else {
      try {
        String exportname=cms.readProperty(vfsName,I_CmsConstants.C_PROPERTY_EXPORTNAME,true);
        if (exportname != null) {
          if (!exportname.endsWith("/")) {
            exportname=exportname + "/";
          }
          if (!exportname.startsWith("/")) {
            exportname="/" + exportname;
          }
          String value;
          boolean cont;
          String resource=vfsName;
          do {
            try {
              value=cms.readProperty(resource,I_CmsConstants.C_PROPERTY_EXPORTNAME,false);
              cont=((value == null) && (!"/".equals(resource)));
            }
 catch (            CmsSecurityException se) {
              cont=false;
            }
            if (cont)             resource=CmsResource.getParent(resource);
          }
 while (cont);
          absoluteLink=exportname + vfsName.substring(resource.length());
        }
      }
 catch (      CmsException e) {
      }
      resultLink=OpenCms.getStaticExportProperties().getRfsPrefix() + absoluteLink;
    }
    if (cms.getRequestContext().currentProject().isOnlineProject()) {
      OpenCms.getStaticExportProperties().cacheOnlineLink(vfsName,resultLink);
    }
  }
  if (parameters != null) {
    return resultLink + parameters;
  }
 else {
    return resultLink;
  }
}

{
  CmsTaskService taskService=cms.getTaskService();
  taskService.endTask(taskid);
  String comment="";
  taskService.writeTaskLog(taskid,comment,C_TASKLOGTYPE_OK);
  CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
  CmsTask task=taskService.readTask(taskid);
  if (taskService.getTaskPar(task.getId(),C_TASKPARA_COMPLETION) != null) {
    StringBuffer contentBuf=new StringBuffer(lang.getLanguageValue("task.email.end.content"));
    contentBuf.append("\n");
    contentBuf.append(lang.getLanguageValue("task.label.project"));
    contentBuf.append(": ");
    String projectname="?";
    try {
      projectname=taskService.readTask(task.getRoot()).getName();
    }
 catch (    Exception exc) {
    }
    contentBuf.append(projectname);
    contentBuf.append("\n");
    contentBuf.append(lang.getLanguageValue("task.label.task"));
    contentBuf.append(": ");
    contentBuf.append(task.getName());
    contentBuf.append("\n");
    contentBuf.append(lang.getLanguageValue("task.label.taskfor"));
    contentBuf.append(": ");
    contentBuf.append(CmsUser.getFullName(taskService.readOriginalAgent(task)));
    contentBuf.append("\n");
    contentBuf.append(lang.getLanguageValue("task.label.editor"));
    contentBuf.append(": ");
    contentBuf.append(CmsUser.getFullName(taskService.readAgent(task)));
    int projectid=taskService.readProject(task).getId();
    contentBuf.append("\n\n\n" + getTaskUrl(cms,task.getId(),projectid));
    String subject=lang.getLanguageValue("task.email.end.subject") + " " + CmsUser.getFullName(taskService.readAgent(task));
    CmsUser[] users={taskService.readOwner(task)};
    try {
      CmsSimpleMail mail=createMail(taskService.readAgent(task),users,subject,contentBuf.toString());
      new CmsMailTransport(mail).send();
    }
 catch (    Exception exc) {
      if (CmsLog.getLog(CmsTaskAction.class).isWarnEnabled()) {
        CmsLog.getLog(CmsTaskAction.class).warn("Error while sending task mail",exc);
      }
    }
  }
}

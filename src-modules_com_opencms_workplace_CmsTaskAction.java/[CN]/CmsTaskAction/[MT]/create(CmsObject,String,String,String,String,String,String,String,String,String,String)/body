{
  CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
  int priority=Integer.parseInt(priorityString);
  String splittetDate[]=CmsStringUtil.splitAsArray(timeoutString,'.');
  GregorianCalendar cal=new GregorianCalendar(Integer.parseInt(splittetDate[2]),Integer.parseInt(splittetDate[1]) - 1,Integer.parseInt(splittetDate[0]),0,0,0);
  long timeout=cal.getTime().getTime();
  CmsTaskService taskService=cms.getTaskService();
  CmsTask task=taskService.createTask(agentName,roleName,taskName,timeout,priority);
  taskService.setTaskPar(task.getId(),CmsWorkplaceDefault.C_TASKPARA_ACCEPTATION,paraAcceptation);
  taskService.setTaskPar(task.getId(),CmsWorkplaceDefault.C_TASKPARA_ALL,paraAll);
  taskService.setTaskPar(task.getId(),CmsWorkplaceDefault.C_TASKPARA_COMPLETION,paraCompletion);
  taskService.setTaskPar(task.getId(),CmsWorkplaceDefault.C_TASKPARA_DELIVERY,paraDelivery);
  String comment=lang.getLanguageValue("task.label.forrole") + ": " + roleName+ "\n";
  comment+=lang.getLanguageValue("task.label.editor") + ": " + CmsUser.getFullName(cms.readUser(task.getAgentUser()))+ "\n";
  comment+=taskcomment;
  taskService.writeTaskLog(task.getId(),comment,CmsWorkplaceDefault.C_TASKLOGTYPE_CREATED);
  StringBuffer contentBuf=new StringBuffer(lang.getLanguageValue("task.email.create.content"));
  contentBuf.append("\n");
  contentBuf.append(lang.getLanguageValue("task.label.project"));
  contentBuf.append(": ");
  String projectname="?";
  try {
    projectname=taskService.readTask(task.getRoot()).getName();
  }
 catch (  Exception exc) {
  }
  contentBuf.append(projectname);
  contentBuf.append("\n");
  contentBuf.append(lang.getLanguageValue("task.label.task"));
  contentBuf.append(": ");
  contentBuf.append(task.getName());
  contentBuf.append("\n");
  contentBuf.append(lang.getLanguageValue("task.label.actuator"));
  contentBuf.append(": ");
  contentBuf.append(CmsUser.getFullName(taskService.readOwner(task)));
  int projectid=taskService.readProject(task).getId();
  contentBuf.append("\n\n\n" + getTaskUrl(cms,task.getId(),projectid));
  String subject=lang.getLanguageValue("task.email.create.subject") + " " + CmsUser.getFullName(cms.readUser(task.getAgentUser()))+ " / "+ roleName;
  CmsUser[] users={taskService.readAgent(task)};
  CmsSimpleMail mail=null;
  try {
    mail=createMail(taskService.readOwner(task),users,subject,contentBuf.toString());
  }
 catch (  CmsException e) {
    if (CmsLog.getLog(CmsTaskAction.class).isWarnEnabled()) {
      CmsLog.getLog(CmsTaskAction.class).warn("Could not generate mail while creating task for " + taskService.readOwner(task).getName(),e);
    }
  }
  if (taskService.getTaskPar(task.getId(),CmsWorkplaceDefault.C_TASKPARA_ALL) != null) {
    if (taskService.getTaskPar(task.getId(),CmsWorkplaceDefault.C_TASKPARA_ALL).equals("checked")) {
      try {
        CmsGroup group=taskService.readGroup(task);
        List groupUser=cms.getUsersOfGroup(group.getName());
        mail=createMail(taskService.readOwner(task),groupUser,subject,contentBuf.toString(),true);
      }
 catch (      CmsException e) {
        if (CmsLog.getLog(CmsTaskAction.class).isWarnEnabled()) {
          CmsLog.getLog(CmsTaskAction.class).warn("Could not generate mail while creating task for " + taskService.readOwner(task).getName(),e);
        }
      }
    }
  }
  if (mail != null) {
    new CmsMailTransport(mail).send();
  }
}

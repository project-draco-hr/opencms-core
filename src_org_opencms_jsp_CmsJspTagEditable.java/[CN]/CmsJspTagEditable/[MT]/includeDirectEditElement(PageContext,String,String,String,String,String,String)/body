{
  ServletRequest req=context.getRequest();
  ServletResponse res=context.getResponse();
  CmsFlexController controller=CmsFlexController.getController(req);
  String target=null;
  target=(String)req.getAttribute(I_CmsEditorActionHandler.C_DIRECT_EDIT_INCLUDE_FILE_URI);
  if ((target != null) && (editPermissions == null)) {
    editPermissions=OpenCms.getWorkplaceManager().getEditorActionHandler().getEditMode(controller.getCmsObject(),editTarget,null,req);
  }
  if (editPermissions == null) {
    return null;
  }
  element=element + "_" + editPermissions;
  Map parameterMap=new HashMap();
  CmsJspTagInclude.addParameter(parameterMap,I_CmsConstants.C_PARAMETER_ELEMENT,element,true);
  CmsJspTagInclude.addParameter(parameterMap,I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_TARGET,editTarget,true);
  CmsJspTagInclude.addParameter(parameterMap,I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_LOCALE,controller.getCmsObject().getRequestContext().getLocale().toString(),true);
  CmsUserSettings settings=new CmsUserSettings(controller.getCmsObject());
  CmsJspTagInclude.addParameter(parameterMap,I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_BUTTONSTYLE,String.valueOf(settings.getDirectEditButtonStyle()),true);
  if (editElement != null) {
    CmsJspTagInclude.addParameter(parameterMap,I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_ELEMENT,editElement,true);
  }
  if (editOptions != null) {
    CmsJspTagInclude.addParameter(parameterMap,I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_OPTIONS,editOptions,true);
  }
  if (createLink != null) {
    CmsJspTagInclude.addParameter(parameterMap,I_CmsEditorActionHandler.C_DIRECT_EDIT_PARAM_NEWLINK,createLink,true);
  }
  Map oldParameterMap=controller.getCurrentRequest().getParameterMap();
  try {
    controller.getCurrentRequest().addParameterMap(parameterMap);
    context.getOut().print(CmsFlexResponse.C_FLEX_CACHE_DELIMITER);
    controller.getCurrentResponse().addToIncludeList(target,parameterMap);
    controller.getCurrentRequest().getRequestDispatcher(target).include(req,res);
  }
 catch (  ServletException e) {
    Throwable t;
    if (e.getRootCause() != null) {
      t=e.getRootCause();
    }
 else {
      t=e;
    }
    t=controller.setThrowable(t,target);
    throw new JspException(t);
  }
catch (  IOException e) {
    Throwable t=controller.setThrowable(e,target);
    throw new JspException(t);
  }
 finally {
    if (oldParameterMap != null) {
      controller.getCurrentRequest().setParameterMap(oldParameterMap);
    }
  }
  return editPermissions;
}

{
  String viewfile=null;
  String filelist=null;
  String previous=null;
  String url=null;
  String currentFilelist=null;
  ;
  String previousFilelist=null;
  String newFilelist=null;
  String template="template";
  Hashtable preferences=new Hashtable();
  HttpSession session=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getSession(true);
  String servlets=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getServletPath();
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  viewfile=(String)parameters.get(C_PARA_VIEWFILE);
  if (viewfile != null) {
    template="viewfile";
  }
 else {
    url=(String)parameters.get(C_PARA_URL);
    if (url == null) {
      xmlTemplateDocument.clearStartup();
    }
 else {
      if (url.endsWith("/")) {
        xmlTemplateDocument.setXmlData(C_FILELIST,url);
        xmlTemplateDocument.setXmlData(C_STARTUP,xmlTemplateDocument.getProcessedXmlDataValue(C_STARTUP_FOLDER,this));
        currentFilelist=(String)session.getValue(C_PARA_FILELIST);
        if (currentFilelist == null) {
          currentFilelist=cms.getRequestContext().currentFolder().getAbsolutePath();
        }
        session.putValue(C_PARA_PREVIOUSLIST,currentFilelist);
        session.putValue(C_PARA_FILELIST,url);
        session.putValue(C_PARA_FOLDER,url);
      }
 else {
        xmlTemplateDocument.setXmlData(C_LINK_VALUE,servlets + url);
        xmlTemplateDocument.setXmlData(C_STARTUP,xmlTemplateDocument.getProcessedXmlDataValue(C_STARTUP_FILE,this));
      }
    }
    previous=(String)parameters.get(C_PARA_PREVIOUSLIST);
    if (previous != null) {
      session.putValue(C_PARA_PREVIOUSLIST,previous);
    }
    previousFilelist=(String)session.getValue(C_PARA_PREVIOUSLIST);
    filelist=cms.getRequestContext().getRequest().getParameter(C_PARA_FILELIST);
    if (filelist != null) {
      session.putValue(C_PARA_FILELIST,filelist);
    }
    currentFilelist=(String)session.getValue(C_PARA_FILELIST);
    if (currentFilelist == null) {
      currentFilelist=cms.getRequestContext().currentFolder().getAbsolutePath();
    }
    if (!currentFilelist.equals("/")) {
      newFilelist=currentFilelist.substring(0,currentFilelist.length() - 1);
      int end=newFilelist.lastIndexOf("/");
      if (end > -1) {
        newFilelist=newFilelist.substring(0,end + 1);
      }
    }
 else {
      newFilelist=currentFilelist;
    }
    xmlTemplateDocument.setXmlData(C_FILELIST,newFilelist);
    xmlTemplateDocument.setXmlData(C_PREVIOUSLIST,previousFilelist);
    if (currentFilelist.equals("/")) {
      xmlTemplateDocument.setXmlData(C_PARENT,xmlTemplateDocument.getProcessedXmlDataValue(C_PARENT_DISABLED,this));
    }
 else {
      xmlTemplateDocument.setXmlData(C_PARENT,xmlTemplateDocument.getProcessedXmlDataValue(C_PARENT_ENABLED,this));
    }
    if (previousFilelist == null) {
      xmlTemplateDocument.setXmlData(C_PREVIOUS,xmlTemplateDocument.getProcessedXmlDataValue(C_PREVIOUS_DISABLED,this));
    }
 else {
      xmlTemplateDocument.setXmlData(C_PREVIOUS,xmlTemplateDocument.getProcessedXmlDataValue(C_PREVIOUS_ENABLED,this));
    }
  }
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

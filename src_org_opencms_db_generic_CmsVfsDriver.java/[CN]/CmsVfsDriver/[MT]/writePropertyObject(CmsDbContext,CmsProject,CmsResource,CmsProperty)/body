{
  CmsPropertyDefinition propertyDefinition=null;
  PreparedStatement stmt=null;
  Connection conn=null;
  String value=null;
  int mappingType=-1;
  CmsUUID id=null;
  CmsProperty existingProperty=null;
  boolean existsPropertyValue=false;
  boolean deletePropertyValue=false;
  try {
    propertyDefinition=readPropertyDefinition(dbc,property.getName(),project.getId());
  }
 catch (  CmsDbEntryNotFoundException e) {
    propertyDefinition=null;
  }
  if (propertyDefinition == null) {
    if (property.autoCreatePropertyDefinition()) {
      propertyDefinition=createPropertyDefinition(dbc,project.getId(),property.getName());
      try {
        readPropertyDefinition(dbc,property.getName(),CmsProject.ONLINE_PROJECT_ID);
      }
 catch (      CmsDataAccessException e) {
        createPropertyDefinition(dbc,CmsProject.ONLINE_PROJECT_ID,property.getName());
      }
      try {
        m_driverManager.getBackupDriver().readBackupPropertyDefinition(dbc,property.getName());
      }
 catch (      CmsDataAccessException e) {
        m_driverManager.getBackupDriver().createBackupPropertyDefinition(dbc,property.getName());
      }
    }
 else {
      throw new CmsDbEntryNotFoundException(Messages.get().container(Messages.ERR_NO_PROPERTYDEF_WITH_NAME_1,property.getName()));
    }
  }
  String resourceName=resource.getRootPath();
  if (resource.isFolder() && !resourceName.endsWith("/")) {
    resourceName+="/";
  }
  try {
    existingProperty=readPropertyObject(dbc,propertyDefinition.getName(),project,resource);
    if (existingProperty.isIdentical(property)) {
      return;
    }
    conn=m_sqlManager.getConnection(dbc,project.getId());
    for (int i=0; i < 2; i++) {
      mappingType=-1;
      value=null;
      id=null;
      existsPropertyValue=false;
      deletePropertyValue=false;
      if (i == 0) {
        if (existingProperty.getStructureValue() != null && property.deleteStructureValue()) {
          deletePropertyValue=true;
        }
 else {
          value=property.getStructureValue();
          if (CmsStringUtil.isEmptyOrWhitespaceOnly(value)) {
            continue;
          }
        }
        mappingType=CmsProperty.STRUCTURE_RECORD_MAPPING;
        id=resource.getStructureId();
        existsPropertyValue=existingProperty.getStructureValue() != null;
      }
 else       if (i == 1) {
        if (existingProperty.getResourceValue() != null && property.deleteResourceValue()) {
          deletePropertyValue=true;
        }
 else {
          value=property.getResourceValue();
          if (CmsStringUtil.isEmptyOrWhitespaceOnly(value)) {
            break;
          }
        }
        mappingType=CmsProperty.RESOURCE_RECORD_MAPPING;
        id=resource.getResourceId();
        existsPropertyValue=existingProperty.getResourceValue() != null;
      }
      if (!deletePropertyValue) {
        if (existsPropertyValue) {
          stmt=m_sqlManager.getPreparedStatement(conn,project.getId(),"C_PROPERTIES_UPDATE");
          stmt.setString(1,m_sqlManager.validateEmpty(value));
          stmt.setString(2,id.toString());
          stmt.setInt(3,mappingType);
          stmt.setString(4,propertyDefinition.getId().toString());
        }
 else {
          stmt=m_sqlManager.getPreparedStatement(conn,project.getId(),"C_PROPERTIES_CREATE");
          stmt.setString(1,new CmsUUID().toString());
          stmt.setString(2,propertyDefinition.getId().toString());
          stmt.setString(3,id.toString());
          stmt.setInt(4,mappingType);
          stmt.setString(5,m_sqlManager.validateEmpty(value));
        }
      }
 else {
        stmt=m_sqlManager.getPreparedStatement(conn,project.getId(),"C_PROPERTIES_DELETE");
        stmt.setString(1,propertyDefinition.getId().toString());
        stmt.setString(2,id.toString());
        stmt.setInt(3,mappingType);
      }
      stmt.executeUpdate();
      m_sqlManager.closeAll(dbc,null,stmt,null);
    }
  }
 catch (  SQLException e) {
    throw new CmsDbSqlException(Messages.get().container(Messages.ERR_GENERIC_SQL_1,CmsDbSqlException.getErrorQuery(stmt)),e);
  }
 finally {
    m_sqlManager.closeAll(dbc,conn,stmt,null);
  }
}

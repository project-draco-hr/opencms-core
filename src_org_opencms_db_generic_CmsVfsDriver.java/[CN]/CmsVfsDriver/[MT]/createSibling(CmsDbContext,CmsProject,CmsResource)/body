{
  Connection conn=null;
  PreparedStatement stmt=null;
  CmsResourceState newState=CmsResource.STATE_UNCHANGED;
  if (project.getUuid().equals(CmsProject.ONLINE_PROJECT_ID)) {
    newState=CmsResource.STATE_UNCHANGED;
  }
 else {
    newState=CmsResource.STATE_NEW;
  }
  CmsResource existingSibling=null;
  CmsUUID newStructureId=resource.getStructureId();
  try {
    existingSibling=readResource(dbc,project.getUuid(),resource.getRootPath(),true);
    if (existingSibling.getState().isDeleted()) {
      newStructureId=existingSibling.getStructureId();
      newState=CmsResource.STATE_CHANGED;
      List modifiedResources=readSiblings(dbc,project.getUuid(),existingSibling,false);
      int propertyDeleteOption=(existingSibling.getSiblingCount() > 1) ? CmsProperty.DELETE_OPTION_DELETE_STRUCTURE_VALUES : CmsProperty.DELETE_OPTION_DELETE_STRUCTURE_AND_RESOURCE_VALUES;
      deletePropertyObjects(dbc,project.getUuid(),existingSibling,propertyDeleteOption);
      removeFile(dbc,project.getUuid(),existingSibling);
      OpenCms.fireCmsEvent(new CmsEvent(I_CmsEventListener.EVENT_RESOURCES_MODIFIED,Collections.singletonMap("resources",modifiedResources)));
      OpenCms.fireCmsEvent(new CmsEvent(I_CmsEventListener.EVENT_RESOURCE_AND_PROPERTIES_MODIFIED,Collections.singletonMap("resource",existingSibling)));
    }
  }
 catch (  CmsVfsResourceNotFoundException e) {
  }
  if ((existingSibling != null) && !existingSibling.getState().isDeleted()) {
    throw new CmsVfsResourceAlreadyExistsException(Messages.get().container(Messages.ERR_RESOURCE_WITH_NAME_ALREADY_EXISTS_1,dbc.removeSiteRoot(resource.getRootPath())));
  }
  if (!validateResourceIdExists(dbc,project.getUuid(),resource.getResourceId())) {
    throw new CmsVfsResourceNotFoundException(Messages.get().container(Messages.ERR_CREATE_SIBLING_FILE_NOT_FOUND_1,dbc.removeSiteRoot(resource.getRootPath())));
  }
  try {
    conn=m_sqlManager.getConnection(dbc);
    int lastVersion=m_driverManager.getHistoryDriver().readLastVersion(dbc,newStructureId);
    int histStrVersion=0;
    if (lastVersion > 0) {
      I_CmsHistoryResource histRes=m_driverManager.getHistoryDriver().readResource(dbc,newStructureId,lastVersion);
      histStrVersion=histRes.getStructureVersion();
    }
    int newStrVersion=1 + histStrVersion;
    String parentId=internalReadParentId(dbc,project.getUuid(),resource.getRootPath());
    stmt=m_sqlManager.getPreparedStatement(conn,project,"C_STRUCTURE_WRITE");
    stmt.setString(1,newStructureId.toString());
    stmt.setString(2,resource.getResourceId().toString());
    stmt.setString(3,resource.getRootPath());
    stmt.setInt(4,newState.getState());
    stmt.setLong(5,resource.getDateReleased());
    stmt.setLong(6,resource.getDateExpired());
    stmt.setString(7,parentId);
    stmt.setInt(8,newStrVersion);
    stmt.executeUpdate();
    m_sqlManager.closeAll(dbc,null,stmt,null);
    stmt=m_sqlManager.getPreparedStatement(conn,project,"C_RESOURCES_UPDATE_SIBLING_COUNT");
    stmt.setInt(1,countSiblings(dbc,project.getUuid(),resource.getResourceId()));
    stmt.setString(2,resource.getResourceId().toString());
    stmt.executeUpdate();
    m_sqlManager.closeAll(dbc,null,stmt,null);
    stmt=m_sqlManager.getPreparedStatement(conn,project,"C_RESOURCES_UPDATE_RESOURCE_PROJECT");
    stmt.setInt(1,resource.getFlags());
    stmt.setString(2,resource.getProjectLastModified().toString());
    stmt.setString(3,resource.getResourceId().toString());
    stmt.executeUpdate();
  }
 catch (  SQLException e) {
    throw new CmsDbSqlException(Messages.get().container(Messages.ERR_GENERIC_SQL_1,CmsDbSqlException.getErrorQuery(stmt)),e);
  }
 finally {
    m_sqlManager.closeAll(dbc,conn,stmt,null);
  }
}

{
  I_CmsGalleryWidgetHandler handler=new I_CmsGalleryWidgetHandler(){
    public void setWidgetValue(    String resourcePath,    CmsUUID structureId,    CmsCroppingParamBean croppingParameter){
      String path=resourcePath;
      if ((croppingParameter != null) && (croppingParameter.isCropped() || croppingParameter.isScaled())) {
        path+="?" + croppingParameter.toString();
      }
      setValue(path,true);
      m_popup.hide();
    }
  }
;
  if (m_isVfsWidget) {
    GalleryTabId[] tabIds=null;
    if (m_isIncludeFiles) {
      tabIds=new GalleryTabId[]{GalleryTabId.cms_tab_types,GalleryTabId.cms_tab_vfstree,GalleryTabId.cms_tab_sitemap,GalleryTabId.cms_tab_categories,GalleryTabId.cms_tab_search,GalleryTabId.cms_tab_results};
    }
 else {
      tabIds=new GalleryTabId[]{GalleryTabId.cms_tab_vfstree};
    }
    return new CmsGalleryPopup(handler,m_referencePath,getFormValueAsString(),m_types,m_isShowSiteSelector,m_startSite,tabIds);
  }
 else {
    return new CmsGalleryPopup(handler,m_referencePath,m_galleryPath,getFormValueAsString(),m_types,m_galleryTypes,m_useFormats,m_imageFormats,m_imageFormatNames);
  }
}

{
  File sfsFile=null;
  CmsFile updVfsFile=null;
  int action=C_SYNC_NONE;
  String path=m_synchronizePath + m_cms.readAbsolutePath(vfsFile).substring(0,m_cms.readAbsolutePath(vfsFile).lastIndexOf("/"));
  String fileName=m_cms.readAbsolutePath(vfsFile).substring(m_cms.readAbsolutePath(vfsFile).lastIndexOf("/") + 1);
  sfsFile=new File(path,fileName);
  if (!sfsFile.exists()) {
    createNewLocalFile(sfsFile);
    sfsFile=new File(path,fileName);
    action=C_SYNC_SFS;
  }
 else {
    action=compareDate(m_cms.readAbsolutePath(vfsFile),vfsFile.getDateLastModified(),sfsFile.lastModified());
  }
switch (action) {
case 1:
    try {
      writeFileByte(vfsFile.getContents(),sfsFile);
      m_synchronizeList.putDates(m_cms.readAbsolutePath(vfsFile),vfsFile.getDateLastModified(),sfsFile.lastModified());
    }
 catch (    Exception e) {
      throw new CmsException("[" + this.getClass().getName() + "]"+ " Error while updating server filesystem",e);
    }
  break;
case 2:
try {
  byte[] content=getFileBytes(sfsFile);
  m_cms.lockResource(m_cms.readAbsolutePath(vfsFile),true);
  updVfsFile=m_cms.readFile(m_cms.readAbsolutePath(vfsFile));
  updVfsFile.setContents(content);
  m_cms.writeFile(updVfsFile);
  m_synchronizeList.putDates(m_cms.readAbsolutePath(vfsFile),m_cms.readFile(m_cms.readAbsolutePath(updVfsFile)).getDateLastModified(),sfsFile.lastModified());
}
 catch (Exception e) {
  throw new CmsException("[" + this.getClass().getName() + "]"+ " Error while updating virtual filesystem",e);
}
break;
case 3:
File backupFile=new File(path,"$" + fileName);
if (copyServerFile(sfsFile,backupFile)) {
try {
writeFileByte(vfsFile.getContents(),sfsFile);
m_synchronizeList.putDates(m_cms.readAbsolutePath(vfsFile),vfsFile.getDateLastModified(),sfsFile.lastModified());
}
 catch (Exception e) {
throw new CmsException("[" + this.getClass().getName() + "]"+ " Error while updating server filesystem",e);
}
}
 else {
throw new CmsException("[" + this.getClass().getName() + "]"+ " The file "+ sfsFile.getName()+ " could not be copied");
}
break;
default :
break;
}
}

{
  if (!content.isAutoCorrectionEnabled()) {
    Object attribute=cms.getRequestContext().getAttribute(CmsXmlContent.AUTO_CORRECTION_ATTRIBUTE);
    boolean autoCorrectionEnabled=(attribute != null) && ((Boolean)attribute).booleanValue();
    content.setAutoCorrectionEnabled(autoCorrectionEnabled);
  }
  if (!content.isAutoCorrectionEnabled()) {
    content.validateXmlStructure(new CmsXmlEntityResolver(cms));
  }
  String contentConversion=CmsHtmlConverter.getConversionSettings(cms,file);
  if (CmsStringUtil.isEmptyOrWhitespaceOnly(contentConversion)) {
    contentConversion=CmsHtmlConverter.PARAM_XHTML;
  }
  content.setConversion(contentConversion);
  file=content.correctXmlStructure(cms);
  content.setFile(file);
  content.resolveMappings(cms);
  removeEmptyMappings(cms,content);
  file=writeCategories(cms,file,content);
  cms.deleteRelationsFromResource(cms.getSitePath(file),CmsRelationFilter.TARGETS.filterType(CmsRelationType.XSD));
  String schema=content.getContentDefinition().getSchemaLocation();
  if (schema.startsWith(CmsXmlEntityResolver.OPENCMS_SCHEME)) {
    schema=schema.substring(CmsXmlEntityResolver.OPENCMS_SCHEME.length() - 1);
  }
  schema=cms.getRequestContext().removeSiteRoot(schema);
  if (cms.existsResource(schema)) {
    cms.addRelationToResource(cms.getSitePath(file),schema,CmsRelationType.XSD.getName());
  }
 else {
    LOG.warn(org.opencms.db.generic.Messages.get().getBundle().key(org.opencms.db.generic.Messages.ERR_READ_RESOURCE_1,schema));
  }
  return file;
}

{
  try {
    req.setCharacterEncoding(m_defaultEncoding);
  }
 catch (  UnsupportedEncodingException e) {
    OpenCms.getLog(this).error("Unsupported encoding set for workplace '" + m_defaultEncoding + "'",e);
  }
  Locale locale=null;
  if (req != null) {
    HttpSession session=req.getSession(false);
    if (session != null) {
      CmsWorkplaceSettings settings=(CmsWorkplaceSettings)session.getAttribute(CmsWorkplace.C_SESSION_WORKPLACE_SETTINGS);
      if (settings != null) {
        locale=settings.getUserSettings().getLocale();
      }
    }
  }
  if (locale == null) {
    if (!user.isGuestUser()) {
      Hashtable userInfo=(Hashtable)user.getAdditionalInfo(I_CmsConstants.C_ADDITIONAL_INFO_STARTSETTINGS);
      if (userInfo != null) {
        locale=CmsLocaleManager.getLocale((String)userInfo.get(I_CmsConstants.C_START_LOCALE));
      }
    }
    List acceptedLocales=(new CmsAcceptLanguageHeaderParser(req,getDefaultLocale())).getAcceptedLocales();
    if ((locale != null) && (!acceptedLocales.contains(locale))) {
      acceptedLocales.add(0,locale);
    }
    locale=OpenCms.getLocaleManager().getFirstMatchingLocale(acceptedLocales,m_locales);
    if (locale == null) {
      locale=getDefaultLocale();
    }
  }
  return new CmsI18nInfo(locale,m_defaultEncoding);
}

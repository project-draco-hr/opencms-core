{
  if (req != null) {
    HttpSession session=req.getSession(false);
    if (session != null) {
      CmsWorkplaceSettings settings=(CmsWorkplaceSettings)session.getAttribute(CmsWorkplace.C_SESSION_WORKPLACE_SETTINGS);
      if (settings != null) {
        return settings.getUserSettings().getLocale();
      }
    }
  }
  Locale locale=null;
  if (!context.currentUser().isGuestUser()) {
    Hashtable userInfo=(Hashtable)context.currentUser().getAdditionalInfo(I_CmsConstants.C_ADDITIONAL_INFO_STARTSETTINGS);
    if (userInfo != null) {
      locale=CmsLocaleManager.getLocale((String)userInfo.get(I_CmsConstants.C_START_LOCALE));
    }
  }
  List acceptedLocales=(new CmsAcceptLanguageHeaderParser(req)).getAcceptedLocales();
  if ((locale != null) && (!acceptedLocales.contains(locale))) {
    acceptedLocales.add(0,locale);
  }
  locale=OpenCms.getLocaleManager().getFirstMatchingLocale(acceptedLocales,m_locales);
  if (locale == null) {
    locale=getDefaultLocale();
  }
  return locale;
}

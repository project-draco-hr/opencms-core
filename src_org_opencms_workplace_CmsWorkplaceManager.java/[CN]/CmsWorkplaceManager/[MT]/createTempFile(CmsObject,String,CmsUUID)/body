{
  if (!cms.hasPermissions(cms.readResource(resourceName),CmsPermissionSet.ACCESS_WRITE)) {
    throw new CmsPermissionViolationException(org.opencms.db.Messages.get().container(org.opencms.db.Messages.ERR_PERM_DENIED_2,resourceName,"w"));
  }
  CmsObject adminCms=getAdminCms(cms);
  String temporaryFilename=CmsWorkplace.getTemporaryFileName(resourceName);
  if (adminCms.existsResource(temporaryFilename,CmsResourceFilter.ALL)) {
    if (!adminCms.getLock(temporaryFilename).isUnlocked()) {
      adminCms.changeLock(temporaryFilename);
    }
 else {
      adminCms.lockResource(temporaryFilename);
    }
    adminCms.deleteResource(temporaryFilename,CmsResource.DELETE_PRESERVE_SIBLINGS);
  }
  try {
    adminCms.getRequestContext().setCurrentProject(cms.readProject(getTempFileProjectId()));
    adminCms.copyResource(resourceName,temporaryFilename,CmsResource.COPY_AS_NEW);
    adminCms.setDateLastModified(temporaryFilename,System.currentTimeMillis(),false);
    CmsResource tempFile=cms.readResource(temporaryFilename,CmsResourceFilter.ALL);
    int flags=tempFile.getFlags();
    if ((flags & CmsResource.FLAG_TEMPFILE) == 0) {
      flags+=CmsResource.FLAG_TEMPFILE;
    }
    adminCms.chflags(temporaryFilename,flags);
    adminCms.setDateReleased(temporaryFilename,CmsResource.DATE_RELEASED_DEFAULT,false);
    adminCms.setDateExpired(temporaryFilename,CmsResource.DATE_EXPIRED_DEFAULT,false);
    adminCms.chacc(temporaryFilename,I_CmsPrincipal.PRINCIPAL_GROUP,OpenCms.getDefaultUsers().getGroupUsers(),"-v");
    adminCms.chacc(temporaryFilename,I_CmsPrincipal.PRINCIPAL_GROUP,OpenCms.getDefaultUsers().getGroupProjectmanagers(),"-v");
  }
  finally {
    adminCms.getRequestContext().setCurrentProject(cms.readProject(currentProjectId));
  }
  try {
    cms.getRequestContext().setCurrentProject(cms.readProject(getTempFileProjectId()));
    cms.changeLock(temporaryFilename);
  }
  finally {
    cms.getRequestContext().setCurrentProject(cms.readProject(currentProjectId));
  }
  return temporaryFilename;
}

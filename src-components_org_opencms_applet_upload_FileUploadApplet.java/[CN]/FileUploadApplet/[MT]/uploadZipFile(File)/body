{
  m_action=m_actionOutputUpload;
  repaint();
  PostMethod post=new PostMethod(m_targetUrl);
  try {
    Part[] parts=new Part[5];
    parts[0]=new FilePart(uploadFile.getName(),uploadFile);
    parts[1]=new StringPart("action","submitform");
    parts[2]=new StringPart("unzipfile","true");
    parts[3]=new StringPart("uploadfolder",m_uploadFolder);
    parts[4]=new StringPart("clientfolder",m_fileSelector.getCurrentDirectory().getAbsolutePath());
    HttpMethodParams methodParams=post.getParams();
    methodParams.setCookiePolicy(CookiePolicy.BROWSER_COMPATIBILITY);
    MultipartRequestEntity request=new MultipartRequestEntity(parts,methodParams);
    post.setRequestEntity(request);
    String sessionId=getParameter("sessionId");
    String query=";" + C_JSESSIONID.toLowerCase() + "="+ sessionId+ "&uploadapplet=true";
    post.setQueryString(query);
    post.addRequestHeader(C_JSESSIONID,sessionId);
    HttpClient client=new HttpClient();
    HttpConnectionParams connectionParams=client.getHttpConnectionManager().getParams();
    connectionParams.setConnectionTimeout(5000);
    client.getState();
    client.getHostConfiguration().getHost();
    HttpState initialState=new HttpState();
    URI uri=new URI(m_targetUrl,false);
    Cookie sessionCookie=new Cookie(uri.getHost(),C_JSESSIONID,sessionId,"/",null,false);
    initialState.addCookie(sessionCookie);
    client.setState(initialState);
    int status=client.executeMethod(post);
    String responseString=post.getResponseBodyAsString();
    if (status == HttpStatus.SC_OK) {
      String uploadHook=getParameterFromResponse("CMS_UPLOAD_HOOK",responseString);
      String uploadPropertiesDialogUri=getParameter("uriPrefix") + uploadHook;
      String uploadedFilesAsString=getParameterFromResponse("CMS_UPLOADED_FILES",responseString);
      if ((uploadHook != null) && (uploadedFilesAsString != null)) {
        String targetUri=uploadPropertiesDialogUri + "?resources=" + uploadedFilesAsString+ "&closelink="+ m_redirectUrl;
        getAppletContext().showDocument(new URL(targetUri),m_redirectTargetFrame);
      }
 else {
        getAppletContext().showDocument(new URL(m_redirectUrl),m_redirectTargetFrame);
      }
    }
 else {
      String error=m_errorLine1 + "\n" + post.getStatusLine();
      getAppletContext().showDocument(new URL(m_errorUrl + "?action=showerror&uploaderror=" + error),"explorer_files");
    }
  }
 catch (  RuntimeException e) {
    e.printStackTrace();
  }
catch (  Exception e) {
    e.printStackTrace();
  }
 finally {
    post.releaseConnection();
    uploadFile.delete();
  }
}

{
  CmsResource file=getCms().readFileHeader(getParamResource());
  int curProject=getSettings().getProject();
  int tempProject=0;
  try {
    tempProject=Integer.parseInt(getCms().getRegistry().getSystemValue("tempfileproject"));
  }
 catch (  Exception e) {
    throw new CmsException("Can not read projectId of tempfileproject for creating temporary file for editing! " + e.toString());
  }
  String temporaryFilename=CmsResource.getFolderPath(getCms().readAbsolutePath(file)) + I_CmsConstants.C_TEMP_PREFIX + file.getName();
  boolean ok=true;
  getCms().getRequestContext().setCurrentProject(tempProject);
  try {
    getCms().copyResource(getCms().readAbsolutePath(file),temporaryFilename,false,true,I_CmsConstants.C_COPY_AS_NEW);
  }
 catch (  CmsException e) {
    if ((e.getType() == CmsException.C_FILE_EXISTS) || (e.getType() != CmsException.C_SQL_ERROR)) {
      try {
        getCms().changeLockedInProject(tempProject,temporaryFilename);
        getCms().lockResource(temporaryFilename,true);
      }
 catch (      Exception ex) {
        ok=false;
      }
    }
 else {
      throw e;
    }
  }
  String extendedTempFile=temporaryFilename;
  int loop=0;
  while (!ok) {
    ok=true;
    extendedTempFile=temporaryFilename + loop;
    try {
      getCms().copyResource(getCms().readAbsolutePath(file),extendedTempFile);
    }
 catch (    CmsException e) {
      if ((e.getType() != CmsException.C_FILE_EXISTS) && (e.getType() != CmsException.C_SQL_ERROR)) {
        getCms().getRequestContext().setCurrentProject(curProject);
        throw e;
      }
      loop++;
      ok=false;
    }
  }
  getCms().getRequestContext().setCurrentProject(curProject);
  temporaryFilename=extendedTempFile;
  return temporaryFilename;
}

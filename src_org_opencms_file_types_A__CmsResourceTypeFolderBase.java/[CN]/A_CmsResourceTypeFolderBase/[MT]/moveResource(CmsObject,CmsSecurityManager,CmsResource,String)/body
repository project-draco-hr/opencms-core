{
  String dest=cms.getRequestContext().addSiteRoot(destination);
  if (!CmsResource.isFolder(dest)) {
    dest=dest.concat("/");
  }
  if (resource.getRootPath().equals(dest)) {
    throw new CmsVfsException(org.opencms.file.Messages.get().container(org.opencms.file.Messages.ERR_MOVE_SAME_NAME_1,destination));
  }
  if (dest.startsWith(resource.getRootPath())) {
    throw new CmsVfsException(org.opencms.file.Messages.get().container(org.opencms.file.Messages.ERR_MOVE_SAME_FOLDER_2,cms.getSitePath(resource),destination));
  }
  dest=validateFoldername(dest);
  securityManager.moveResource(cms.getRequestContext(),resource,dest);
  List projects=OpenCms.getOrgUnitManager().getAllManageableProjects(cms,"",true);
  CmsProject project;
  List projectResources;
  Iterator itProjectResources;
  String projectResourceRootPath;
  String moveResourceRootPath=resource.getRootPath();
  Iterator itProjects=projects.iterator();
  while (itProjects.hasNext()) {
    project=(CmsProject)itProjects.next();
    projectResources=cms.readProjectResources(project);
    itProjectResources=projectResources.iterator();
    while (itProjectResources.hasNext()) {
      projectResourceRootPath=(String)itProjectResources.next();
      if (moveResourceRootPath.equals(projectResourceRootPath)) {
        CmsObject projectCms=OpenCms.initCmsObject(cms);
        CmsRequestContext context=projectCms.getRequestContext();
        context.setCurrentProject(project);
        securityManager.removeResourceFromProject(context,resource);
        CmsResource movedResource=new CmsResource(resource.getStructureId(),resource.getResourceId(),dest,resource.getTypeId(),resource.isFolder(),resource.getFlags(),resource.getProjectLastModified(),resource.getState(),resource.getDateCreated(),resource.getUserCreated(),resource.getDateLastModified(),resource.getUserLastModified(),resource.getDateReleased(),resource.getDateExpired(),resource.getSiblingCount(),resource.getLength(),resource.getDateContent(),resource.getVersion());
        securityManager.copyResourceToProject(context,movedResource);
      }
    }
  }
}

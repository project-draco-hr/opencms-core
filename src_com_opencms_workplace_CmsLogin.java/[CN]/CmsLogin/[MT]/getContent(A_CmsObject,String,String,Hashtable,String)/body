{
  String username=null;
  HttpSession session=null;
  A_CmsUser user;
  String paraTaskid=(String)parameters.get("taskid");
  if (paraTaskid == null) {
    paraTaskid="";
  }
  String template=templateSelector;
  CmsXmlWpTemplateFile xmlTemplateDocument=new CmsXmlWpTemplateFile(cms,templateFile);
  if (!paraTaskid.equals("")) {
    xmlTemplateDocument.setData("taskid","?taskid=" + paraTaskid);
  }
 else {
    xmlTemplateDocument.setData("taskid","");
  }
  Hashtable preferences=new Hashtable();
  String name=(String)parameters.get("NAME");
  String password=(String)parameters.get("PASSWORD");
  if ((name != null) && (password != null)) {
    try {
      username=cms.loginUser(name,password);
    }
 catch (    CmsException e) {
      if (e.getType() == CmsException.C_NO_ACCESS) {
        username=null;
        xmlTemplateDocument.setData("details",Utils.getStackTrace(e));
        template="error";
      }
 else {
        throw e;
      }
    }
    if (username != null) {
      session=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getSession(true);
      if (A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,"[CmsLogin] Login user " + username);
      }
      user=cms.readUser(username);
      Integer currentProject;
      Hashtable startSettings=null;
      startSettings=(Hashtable)cms.getRequestContext().currentUser().getAdditionalInfo(C_ADDITIONAL_INFO_STARTSETTINGS);
      if (startSettings != null) {
        currentProject=(Integer)startSettings.get(C_START_PROJECT);
        try {
          if (cms.accessProject(currentProject.intValue())) {
            cms.getRequestContext().setCurrentProject(currentProject.intValue());
          }
        }
 catch (        Exception e) {
        }
      }
      preferences=(Hashtable)user.getAdditionalInfo(C_ADDITIONAL_INFO_PREFERENCES);
      if (preferences == null) {
        preferences=getDefaultPreferences();
      }
      session.putValue(C_ADDITIONAL_INFO_PREFERENCES,preferences);
      if ((paraTaskid != null) && (!paraTaskid.equals(""))) {
        Vector viewNames=new Vector();
        Vector viewLinks=new Vector();
        CmsXmlWpConfigFile configFile=new CmsXmlWpConfigFile(cms);
        configFile.getWorkplaceIniData(viewNames,viewLinks,"WORKPLACEVIEWS","VIEW");
        String link="";
        for (int i=0; i < viewNames.size(); i++) {
          if (((String)viewNames.elementAt(i)).equals("tasks")) {
            link=(String)viewLinks.elementAt(i);
            break;
          }
        }
        session.putValue(C_PARA_VIEW,link);
        session.putValue(C_PARA_TASKID,parameters.get("taskid"));
      }
    }
  }
 else {
    session=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getSession(false);
    if (session != null) {
      String[] valueNames=session.getValueNames();
      int numValues=valueNames.length;
      for (int i=0; i < numValues; i++) {
        session.removeValue(valueNames[i]);
      }
    }
  }
  if (username == null) {
    xmlTemplateDocument.clearStartup();
  }
 else {
    xmlTemplateDocument.setData("ID",session.getId().replace('.','_'));
  }
  return startProcessing(cms,xmlTemplateDocument,"",parameters,template);
}

{
  if (!m_completed) {
    return;
  }
  if (m_redirectTarget != null) {
    res.setOnlyBuffering(false);
    res.sendRedirect(m_redirectTarget);
  }
 else {
    CmsFlexResponse.processHeaders(m_headers,res);
    boolean hasNoSubElements=(m_elements.size() == 1);
    for (int i=0; i < m_elements.size(); i++) {
      Object o=m_elements.get(i);
      if (o instanceof String) {
        i++;
        Map<String,String[]> map=(Map<String,String[]>)m_elements.get(i);
        Map<String,String[]> oldMap=null;
        if (map.size() > 0) {
          oldMap=req.getParameterMap();
          req.addParameterMap(map);
        }
        req.getRequestDispatcher((String)o).include(req,res);
        if (oldMap != null) {
          req.setParameterMap(oldMap);
        }
      }
 else {
        try {
          res.writeToOutputStream((byte[])o,hasNoSubElements);
        }
 catch (        IOException e) {
          CmsMessageContainer message=Messages.get().container(Messages.LOG_FLEXCACHEKEY_NOT_FOUND_1,getClass().getName());
          if (LOG.isDebugEnabled()) {
            LOG.debug(message.key());
          }
          throw new CmsFlexCacheException(message,e);
        }
      }
    }
  }
}

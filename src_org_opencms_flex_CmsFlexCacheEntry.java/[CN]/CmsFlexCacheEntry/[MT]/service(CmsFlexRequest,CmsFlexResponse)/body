{
  if (!m_completed) {
    return;
  }
  if (m_redirectTarget != null) {
    res.setOnlyBuffering(false);
    res.sendRedirect(m_redirectTarget);
  }
 else {
    CmsFlexResponse.processHeaders(m_headers,res);
    boolean hasNoSubElements=((m_elements != null) && (m_elements.size() == 1));
    Iterator i=m_elements.iterator();
    while (i.hasNext()) {
      Object o=i.next();
      if (o instanceof String) {
        Map map=(Map)i.next();
        Map oldMap=null;
        if (map.size() > 0) {
          oldMap=req.getParameterMap();
          req.addParameterMap(map);
        }
        req.getRequestDispatcher((String)o).include(req,res);
        if (oldMap != null) {
          req.setParameterMap(oldMap);
        }
      }
 else {
        try {
          res.writeToOutputStream((byte[])o,hasNoSubElements);
        }
 catch (        IOException e) {
          String err=getClass().getName() + ": Could not write to response OutputStream. ";
          if (DEBUG > 0) {
            System.err.println(err);
          }
          throw new CmsException(err + "\n" + e,e);
        }
      }
    }
  }
}

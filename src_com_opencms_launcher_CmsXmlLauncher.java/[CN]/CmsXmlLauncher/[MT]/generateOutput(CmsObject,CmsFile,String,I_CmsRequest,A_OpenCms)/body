{
  byte[] output=null;
  CmsXmlControlFile doc=null;
  try {
    doc=new CmsXmlControlFile(cms,file);
  }
 catch (  Exception e) {
    handleException(cms,e,"There was an error while parsing XML file " + file.getAbsolutePath());
    return "".getBytes();
  }
  String templateClass=doc.getTemplateClass();
  if (templateClass == null || "".equals(templateClass)) {
    templateClass=startTemplateClass;
  }
  if (templateClass == null || "".equals(templateClass)) {
    templateClass="com.opencms.template.CmsXmlTemplate";
  }
  String templateName=doc.getMasterTemplate();
  CmsFile masterTemplate=loadMasterTemplateFile(cms,templateName,doc);
  Hashtable newParameters=new Hashtable();
  Enumeration masterTemplateParams=doc.getParameterNames();
  while (masterTemplateParams.hasMoreElements()) {
    String paramName=(String)masterTemplateParams.nextElement();
    String paramValue=doc.getParameter(paramName);
    newParameters.put(C_ROOT_TEMPLATE_NAME + "." + paramName,paramValue);
  }
  Enumeration elementDefinitions=doc.getElementDefinitions();
  while (elementDefinitions.hasMoreElements()) {
    String elementName=(String)elementDefinitions.nextElement();
    if (doc.isElementClassDefined(elementName)) {
      newParameters.put(elementName + "._CLASS_",doc.getElementClass(elementName));
    }
    if (doc.isElementTemplateDefined(elementName)) {
      newParameters.put(elementName + "._TEMPLATE_",doc.getElementTemplate(elementName));
    }
    if (doc.isElementTemplSelectorDefined(elementName)) {
      newParameters.put(elementName + "._TEMPLATESELECTOR_",doc.getElementTemplSelector(elementName));
    }
    Enumeration parameters=doc.getElementParameterNames(elementName);
    while (parameters.hasMoreElements()) {
      String paramName=(String)parameters.nextElement();
      String paramValue=doc.getElementParameter(elementName,paramName);
      if (paramValue != null) {
        newParameters.put(elementName + "." + paramName,paramValue);
      }
 else {
        if (A_OpenCms.isLogging()) {
          A_OpenCms.log(C_OPENCMS_INFO,getClassName() + "Empty parameter \"" + paramName+ "\" found.");
        }
      }
    }
  }
  String datafor=req.getParameter("datafor");
  if (datafor == null) {
    datafor="";
  }
 else {
    if (!"".equals(datafor)) {
      datafor=datafor + ".";
    }
  }
  Enumeration urlParameterNames=req.getParameterNames();
  while (urlParameterNames.hasMoreElements()) {
    String pname=(String)urlParameterNames.nextElement();
    String paramValue=req.getParameter(pname);
    if (paramValue != null) {
      if ((!"datafor".equals(pname)) && (!"_clearcache".equals(pname))) {
        newParameters.put(datafor + pname,paramValue);
      }
    }
 else {
      if (A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,getClassName() + "Empty URL parameter \"" + pname+ "\" found.");
      }
    }
  }
  if (cms.getRequestContext().isStaging()) {
    CmsStaging staging=null;
    String uri=cms.getRequestContext().getUri();
    staging=openCms.getStaging();
    CmsUriDescriptor uriDesc=new CmsUriDescriptor(uri);
    CmsUriLocator uriLoc=staging.getUriLocator();
    CmsUri cmsUri=uriLoc.get(uriDesc);
    if (cmsUri == null) {
      CmsElementDescriptor elemDesc=new CmsElementDescriptor(templateClass,templateName);
      CmsElementDefinitionCollection eldefs=doc.getElementDefinitionCollection();
      cmsUri=new CmsUri(elemDesc,null,eldefs);
      staging.getUriLocator().put(uriDesc,cmsUri);
    }
    output=staging.callCanonicalRoot(cms,newParameters);
  }
 else {
    try {
      I_CmsTemplate tmpl=getTemplateClass(cms,templateClass);
      if (!(tmpl instanceof I_CmsXmlTemplate)) {
        String errorMessage="Error in " + file.getAbsolutePath() + ": "+ templateClass+ " is not a XML template class.";
        if (A_OpenCms.isLogging()) {
          A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + errorMessage);
        }
        throw new CmsException(errorMessage,CmsException.C_XML_WRONG_TEMPLATE_CLASS);
      }
      output=callCanonicalRoot(cms,(I_CmsTemplate)tmpl,masterTemplate,newParameters);
    }
 catch (    CmsException e) {
      if (A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,"[CmsXmlLauncher] There were exceptions while generating output for " + file.getAbsolutePath());
        A_OpenCms.log(C_OPENCMS_INFO,"[CmsXmlLauncher] Clearing template file cache for this file.");
      }
      doc.removeFromFileCache();
      throw e;
    }
  }
  return output;
}

{
  byte[] output=null;
  Hashtable newParameters=new Hashtable();
  boolean elementCacheEnabled=cms.getRequestContext().isElementCacheEnabled();
  CmsElementCache elementCache=null;
  String uri=cms.getRequestContext().getUri();
  CmsUriDescriptor uriDesc=null;
  CmsUriLocator uriLoc=null;
  CmsUri cmsUri=null;
  String templateClass=null;
  String templateName=null;
  CmsXmlControlFile doc=null;
  if (elementCacheEnabled) {
    elementCache=cms.getRequestContext().getElementCache();
    uriDesc=new CmsUriDescriptor(uri);
    uriLoc=elementCache.getUriLocator();
    cmsUri=uriLoc.get(uriDesc);
  }
  if (cmsUri == null || !elementCacheEnabled) {
    try {
      doc=new CmsXmlControlFile(cms,file);
    }
 catch (    Exception e) {
      handleException(cms,e,"There was an error while parsing XML page file " + file.getAbsolutePath());
      return "".getBytes();
    }
    templateClass=doc.getTemplateClass();
    if (templateClass == null || "".equals(templateClass)) {
      templateClass=startTemplateClass;
    }
    if (templateClass == null || "".equals(templateClass)) {
      templateClass="com.opencms.template.CmsXmlTemplate";
    }
    templateName=doc.getMasterTemplate();
    if (templateName != null && !"".equals(templateName)) {
      templateName=Utils.mergeAbsolutePath(file.getAbsolutePath(),templateName);
    }
    Enumeration masterTemplateParams=doc.getParameterNames();
    while (masterTemplateParams.hasMoreElements()) {
      String paramName=(String)masterTemplateParams.nextElement();
      String paramValue=doc.getParameter(paramName);
      newParameters.put(C_ROOT_TEMPLATE_NAME + "." + paramName,paramValue);
    }
    Enumeration elementDefinitions=doc.getElementDefinitions();
    while (elementDefinitions.hasMoreElements()) {
      String elementName=(String)elementDefinitions.nextElement();
      if (doc.isElementClassDefined(elementName)) {
        newParameters.put(elementName + "._CLASS_",doc.getElementClass(elementName));
      }
      if (doc.isElementTemplateDefined(elementName)) {
        newParameters.put(elementName + "._TEMPLATE_",doc.getElementTemplate(elementName));
      }
      if (doc.isElementTemplSelectorDefined(elementName)) {
        newParameters.put(elementName + "._TEMPLATESELECTOR_",doc.getElementTemplSelector(elementName));
      }
      Enumeration parameters=doc.getElementParameterNames(elementName);
      while (parameters.hasMoreElements()) {
        String paramName=(String)parameters.nextElement();
        String paramValue=doc.getElementParameter(elementName,paramName);
        if (paramValue != null) {
          newParameters.put(elementName + "." + paramName,paramValue);
        }
 else {
          if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
            A_OpenCms.log(C_OPENCMS_INFO,getClassName() + "Empty parameter \"" + paramName+ "\" found.");
          }
        }
      }
    }
  }
  String datafor=req.getParameter("datafor");
  if (datafor == null) {
    datafor="";
  }
 else {
    if (!"".equals(datafor)) {
      datafor=datafor + ".";
    }
  }
  Enumeration urlParameterNames=req.getParameterNames();
  while (urlParameterNames.hasMoreElements()) {
    String pname=(String)urlParameterNames.nextElement();
    String paramValue=req.getParameter(pname);
    if (paramValue != null) {
      if ((!"datafor".equals(pname)) && (!"_clearcache".equals(pname))) {
        newParameters.put(datafor + pname,paramValue);
      }
    }
 else {
      if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,getClassName() + "Empty URL parameter \"" + pname+ "\" found.");
      }
    }
  }
  if (elementCacheEnabled && cmsUri == null) {
    CmsElementDescriptor elemDesc=new CmsElementDescriptor(templateClass,templateName);
    CmsElementDefinitionCollection eldefs=doc.getElementDefinitionCollection();
    cmsUri=new CmsUri(elemDesc,cms.getReadingpermittedGroup(cms.getRequestContext().currentProject().getId(),templateName),eldefs,Utils.isHttpsResource(cms,file));
    elementCache.getUriLocator().put(uriDesc,cmsUri);
  }
  if (elementCacheEnabled) {
    if (cms.getRequestContext().currentProject().getId() == cms.onlineProject().getId()) {
      String scheme=((HttpServletRequest)cms.getRequestContext().getRequest().getOriginalRequest()).getScheme();
      boolean httpsReq="https".equalsIgnoreCase(scheme);
      if (cmsUri.isHttpsResource() != httpsReq) {
        if (httpsReq) {
          throw new CmsException(" " + file.getAbsolutePath() + " needs a http request",CmsException.C_HTTPS_PAGE_ERROR);
        }
 else {
          throw new CmsException(" " + file.getAbsolutePath() + " needs a https request",CmsException.C_HTTPS_REQUEST_ERROR);
        }
      }
    }
    output=elementCache.callCanonicalRoot(cms,newParameters);
  }
 else {
    try {
      CmsFile masterTemplate=loadMasterTemplateFile(cms,templateName,doc);
      I_CmsTemplate tmpl=getTemplateClass(cms,templateClass);
      if (!(tmpl instanceof I_CmsXmlTemplate)) {
        String errorMessage="Error in " + file.getAbsolutePath() + ": "+ templateClass+ " is not a XML template class.";
        if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
          A_OpenCms.log(C_OPENCMS_CRITICAL,getClassName() + errorMessage);
        }
        throw new CmsException(errorMessage,CmsException.C_XML_WRONG_TEMPLATE_CLASS);
      }
      output=callCanonicalRoot(cms,(I_CmsTemplate)tmpl,masterTemplate,newParameters);
    }
 catch (    CmsException e) {
      if (I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_INFO,"[CmsXmlLauncher] There were exceptions while generating output for " + file.getAbsolutePath());
        A_OpenCms.log(C_OPENCMS_INFO,"[CmsXmlLauncher] Clearing template file cache for this file.");
      }
      doc.removeFromFileCache();
      throw e;
    }
  }
  return output;
}

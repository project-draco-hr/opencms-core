{
  CmsObject cms=getCmsObject();
  echo("Testing 'undoChanges' method");
  String sourceName="/index.html";
  CmsResource source=cms.readResource(sourceName);
  String targetName="/folder1/index.html";
  CmsResource target=cms.readResource(targetName);
  List<CmsRelation> relations=cms.getRelationsForResource(targetName,CmsRelationFilter.TARGETS);
  assertEquals(1,relations.size());
  assertTrue(cms.getRelationsForResource(targetName,CmsRelationFilter.SOURCES).isEmpty());
  cms.lockResource(sourceName);
  cms.addRelationToResource(sourceName,targetName,CmsRelationType.CATEGORY.getName());
  relations=cms.getRelationsForResource(sourceName,CmsRelationFilter.TARGETS);
  assertEquals(2,relations.size());
  assertRelation(new CmsRelation(source,target,CmsRelationType.CATEGORY),relations.get(1));
  relations=cms.getRelationsForResource(targetName,CmsRelationFilter.SOURCES);
  assertEquals(1,relations.size());
  assertRelation(new CmsRelation(source,target,CmsRelationType.CATEGORY),relations.get(0));
  OpenCms.getPublishManager().publishResource(cms,sourceName);
  OpenCms.getPublishManager().waitWhileRunning();
  cms.lockResource(sourceName);
  cms.deleteRelationsFromResource(sourceName,CmsRelationFilter.TARGETS.filterResource(target).filterNotDefinedInContent());
  relations=cms.getRelationsForResource(sourceName,CmsRelationFilter.TARGETS);
  assertEquals(1,relations.size());
  assertTrue(cms.getRelationsForResource(targetName,CmsRelationFilter.SOURCES).isEmpty());
  cms.undoChanges(sourceName,CmsResource.UNDO_CONTENT);
  relations=cms.getRelationsForResource(sourceName,CmsRelationFilter.TARGETS);
  assertEquals(2,relations.size());
  assertRelation(new CmsRelation(source,target,CmsRelationType.CATEGORY),relations.get(1));
  relations=cms.getRelationsForResource(targetName,CmsRelationFilter.SOURCES);
  assertEquals(1,relations.size());
  assertRelation(new CmsRelation(source,target,CmsRelationType.CATEGORY),relations.get(0));
}

{
  int state=0;
  if (project.equals(onlineProject)) {
    state=file.getState();
  }
 else {
    state=C_STATE_NEW;
  }
  try {
    readFileHeader(project,filename);
  }
 catch (  CmsException e) {
    if (e.getType() == CmsException.C_RESOURCE_DELETED) {
      removeFile(project,filename);
      state=C_STATE_CHANGED;
    }
  }
  File diskFile=new File(absoluteName(filename,project));
  if (!diskFile.exists()) {
    try {
      OutputStream s=new FileOutputStream(diskFile);
      s.write(file.getContents());
      s.close();
    }
 catch (    Exception e) {
      throw new CmsException("[" + this.getClass().getName() + "] "+ e.getMessage());
    }
    CmsFile newfile=new CmsFile(filename,file.getType(),file.getFlags(),file.getOwnerId(),file.getGroupId(),project.getId(),file.getAccessFlags(),state,file.isLockedBy(),file.getLauncherType(),file.getLauncherClassname(),file.getDateCreated(),System.currentTimeMillis(),new byte[0],file.getLength());
    writeFileHeader(project,onlineProject,newfile,false);
  }
 else {
    throw new CmsException("[" + this.getClass().getName() + "] "+ filename,CmsException.C_FILE_EXISTS);
  }
  return readFile(project,onlineProject,filename);
}

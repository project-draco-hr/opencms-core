{
  long timeTotal=-System.currentTimeMillis();
  long timeLucene;
  long timeResultProcessing;
  if (OpenCms.getLog(this).isDebugEnabled()) {
    StringBuffer searchFields=new StringBuffer();
    if (fields != null) {
      for (int i=0; i < fields.length; i++) {
        searchFields.append(fields[i]);
        if (i + 1 < fields.length) {
          searchFields.append(", ");
        }
      }
    }
    OpenCms.getLog(this).debug("Searching for \"" + searchQuery + "\" in fields ["+ searchFields+ "] of index "+ m_name);
  }
  CmsRequestContext context=cms.getRequestContext();
  CmsProject currentProject=context.currentProject();
  Searcher searcher=null;
  IndexReader reader=null;
  Hits hits;
  List searchResults=new ArrayList();
  int previousPriority=Thread.currentThread().getPriority();
  try {
    if (m_priority > 0) {
      Thread.currentThread().setPriority(m_priority);
    }
    context.setCurrentProject(cms.readProject(m_project));
    if ((searchRoots != null) && (searchRoots.length > 0)) {
      for (int i=0; i < searchRoots.length; i++) {
        searchRoots[i]=cms.getRequestContext().addSiteRoot(searchRoots[i]);
      }
    }
 else {
      searchRoots=new String[]{cms.getRequestContext().getSiteRoot()};
    }
    timeLucene=-System.currentTimeMillis();
    Analyzer languageAnalyzer=OpenCms.getSearchManager().getAnalyzer(m_locale);
    BooleanQuery query=new BooleanQuery();
    StringBuffer phrase=new StringBuffer();
    phrase.append("+(");
    for (int i=0; i < searchRoots.length; i++) {
      phrase.append("\"");
      phrase.append(rewriteResourcePath(searchRoots[i],true));
      phrase.append("\" ");
    }
    phrase.append(")");
    Query phraseQuery=QueryParser.parse(phrase.toString(),I_CmsDocumentFactory.DOC_ROOT,languageAnalyzer);
    query.add(phraseQuery,true,false);
    if ((fields != null) && (fields.length > 0)) {
      BooleanQuery fieldsQuery=new BooleanQuery();
      for (int i=0; i < fields.length; i++) {
        fieldsQuery.add(QueryParser.parse(searchQuery,fields[i],languageAnalyzer),false,false);
      }
      query.add(fieldsQuery,true,false);
    }
 else {
      query.add(QueryParser.parse(searchQuery,I_CmsDocumentFactory.DOC_CONTENT,languageAnalyzer),true,false);
    }
    searcher=new IndexSearcher(m_path);
    Query finalQuery;
    if (OpenCms.getLog(this).isDebugEnabled()) {
      OpenCms.getLog(this).debug("Base query: " + query);
    }
    if (m_createExcerpt || OpenCms.getLog(this).isDebugEnabled()) {
      reader=IndexReader.open(m_path);
      finalQuery=query.rewrite(reader);
    }
 else {
      finalQuery=query;
    }
    if (OpenCms.getLog(this).isDebugEnabled()) {
      OpenCms.getLog(this).debug("Rewritten query: " + finalQuery);
      reader.close();
    }
    if ((sortOrder != null) && (sortOrder != Sort.RELEVANCE)) {
      hits=searcher.search(finalQuery,sortOrder);
    }
 else {
      hits=searcher.search(finalQuery);
    }
    timeLucene+=System.currentTimeMillis();
    timeResultProcessing=-System.currentTimeMillis();
    Document doc;
    CmsSearchResult searchResult;
    String excerpt=null;
    if (hits != null) {
      int start=-1, end=-1;
      if (matchesPerPage > 0 && page > 0 && hits.length() > 0) {
        start=matchesPerPage * (page - 1);
        end=start + matchesPerPage;
        start=(start > hits.length()) ? hits.length() : start;
        end=(end > hits.length()) ? hits.length() : end;
      }
 else {
        start=0;
        end=hits.length();
      }
      for (int i=0, cnt=0; i < hits.length() && cnt < end; i++) {
        try {
          doc=hits.doc(i);
          if (hasReadPermission(cms,doc)) {
            if (cnt >= start) {
              if (m_createExcerpt) {
                excerpt=getExcerpt(doc.getField(I_CmsDocumentFactory.DOC_CONTENT).stringValue(),finalQuery,languageAnalyzer);
              }
              searchResult=new CmsSearchResult(Math.round(hits.score(i) * 100f),doc,excerpt);
              searchResults.add(searchResult);
            }
            cnt++;
          }
        }
 catch (        Exception e) {
          OpenCms.getLog(this).warn("Error during search result iteration",e);
        }
      }
      searchResults.add(new Integer(hits.length()));
    }
 else {
      searchResults.add(new Integer(0));
    }
    timeResultProcessing+=System.currentTimeMillis();
  }
 catch (  Exception exc) {
    throw new CmsException("[" + this.getClass().getName() + "] "+ "Search on "+ m_path+ " failed. ",exc);
  }
 finally {
    Thread.currentThread().setPriority(previousPriority);
    if (searcher != null) {
      try {
        searcher.close();
      }
 catch (      IOException exc) {
      }
    }
    context.setCurrentProject(currentProject);
  }
  timeTotal+=System.currentTimeMillis();
  if (OpenCms.getLog(this).isDebugEnabled()) {
    OpenCms.getLog(this).debug(hits.length() + " results found in " + timeTotal+ " ms"+ " (Lucene: "+ timeLucene+ " ms OpenCms: "+ timeResultProcessing+ " ms)");
  }
  return searchResults;
}

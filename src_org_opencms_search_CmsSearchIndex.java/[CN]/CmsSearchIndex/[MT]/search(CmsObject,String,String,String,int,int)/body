{
  List searchResults=new ArrayList();
  Query query=null;
  Searcher searcher=null;
  Hits hits=null;
  Document luceneDocument=null;
  double maxScore=-1.0;
  CmsSearchResult searchResult=null;
  double score=-1;
  String excerpt=null;
  long totalSearchDuration=-System.currentTimeMillis();
  long luceneSearchDuration=0;
  if (OpenCms.getLog(this).isDebugEnabled()) {
    OpenCms.getLog(this).debug("Searching for \"" + searchQuery + "\" in fields \""+ fields+ "\" of index "+ m_name);
  }
  CmsRequestContext context=cms.getRequestContext();
  CmsProject currentProject=context.currentProject();
  try {
    if (m_priority >= 0) {
      Thread.currentThread().setPriority(Thread.MIN_PRIORITY);
    }
    if (hits == null) {
      context.setCurrentProject(cms.readProject(m_project));
      if (searchRoot != null && !"".equals(searchRoot)) {
        searchRoot=cms.getRequestContext().getSiteRoot() + searchRoot;
      }
 else {
        searchRoot=cms.getRequestContext().getSiteRoot();
      }
      if (!C_SEARCH_QUERY_RETURN_ALL.equals(searchQuery)) {
        searchQuery="(" + searchQuery + ")"+ " AND "+ I_CmsDocumentFactory.DOC_PATH+ ":"+ searchRoot+ "*";
        BooleanQuery.setMaxClauseCount(Integer.MAX_VALUE);
        if (fields != null) {
          BooleanQuery fieldsQuery=new BooleanQuery();
          BooleanQuery.setMaxClauseCount(Integer.MAX_VALUE);
          String fList[]=org.opencms.util.CmsStringUtil.splitAsArray(fields,' ');
          for (int i=0; i < fList.length; i++) {
            fieldsQuery.add(QueryParser.parse(searchQuery,fList[i],OpenCms.getSearchManager().getAnalyzer(m_locale)),false,false);
          }
          query=fieldsQuery;
        }
 else {
          query=QueryParser.parse(searchQuery,I_CmsDocumentFactory.DOC_CONTENT,OpenCms.getSearchManager().getAnalyzer(m_locale));
        }
      }
 else {
        searchQuery=I_CmsDocumentFactory.DOC_PATH + ":" + searchRoot+ "*";
        query=QueryParser.parse(searchQuery,I_CmsDocumentFactory.DOC_CONTENT,OpenCms.getSearchManager().getAnalyzer(m_locale));
      }
      luceneSearchDuration=-System.currentTimeMillis();
      searcher=new IndexSearcher(m_path);
      hits=searcher.search(query);
      luceneSearchDuration+=System.currentTimeMillis();
    }
    if (hits != null) {
      maxScore=(hits.length() > 0) ? hits.score(0) : 0.0;
      int start=-1, end=-1;
      if (matchesPerPage > 0 && page > 0 && hits.length() > 0) {
        start=matchesPerPage * (page - 1);
        end=start + matchesPerPage;
        start=(start > hits.length()) ? hits.length() : start;
        end=(end > hits.length()) ? hits.length() : end;
      }
 else {
        start=0;
        end=hits.length();
      }
      if (m_checkPermissions) {
        for (int i=0, cnt=0; i < hits.length() && cnt < end; i++) {
          try {
            luceneDocument=hits.doc(i);
            score=(hits.score(i) / maxScore) * 100.0;
            if (getIndexResource(cms,luceneDocument) != null) {
              if (cnt >= start) {
                if (m_createExcerpt) {
                  excerpt=getExcerpt(luceneDocument.getField(I_CmsDocumentFactory.DOC_CONTENT).stringValue(),searchQuery);
                }
                searchResult=new CmsSearchResult((int)score,luceneDocument,excerpt);
                searchResults.add(searchResult);
              }
              cnt++;
            }
          }
 catch (          Exception exc) {
          }
        }
      }
 else {
        for (int i=start; i < end; i++) {
          try {
            luceneDocument=hits.doc(i);
            score=(hits.score(i) / maxScore) * 100.0;
            if (m_createExcerpt) {
              excerpt=getExcerpt(luceneDocument.getField(I_CmsDocumentFactory.DOC_CONTENT).stringValue(),searchQuery);
            }
            searchResult=new CmsSearchResult((int)score,luceneDocument,excerpt);
            searchResults.add(searchResult);
          }
 catch (          Exception exc) {
          }
        }
      }
      searchResults.add(new Integer(hits.length()));
    }
 else {
      searchResults.add(new Integer(0));
    }
  }
 catch (  Exception exc) {
    throw new CmsException("[" + this.getClass().getName() + "] "+ "Search on "+ m_path+ " failed. ",exc);
  }
 finally {
    if (searcher != null) {
      try {
        searcher.close();
      }
 catch (      IOException exc) {
      }
    }
    Thread.currentThread().setPriority(Thread.NORM_PRIORITY);
    context.setCurrentProject(currentProject);
  }
  totalSearchDuration+=System.currentTimeMillis();
  if (OpenCms.getLog(this).isDebugEnabled()) {
    OpenCms.getLog(this).debug(hits.length() + " results found in " + totalSearchDuration+ " ms"+ " (Lucene: "+ luceneSearchDuration+ " ms)");
  }
  return searchResults;
}

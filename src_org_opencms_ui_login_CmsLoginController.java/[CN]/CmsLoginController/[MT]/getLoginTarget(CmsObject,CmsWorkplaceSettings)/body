{
  m_params.getLocale();
  String directEditPath=CmsLoginHelper.getDirectEditPath(currentCms,settings.getUserSettings());
  String target="";
  boolean checkRole=false;
  if (m_params.getRequestedWorkplaceApp() != null) {
    target=m_params.getRequestedWorkplaceApp();
    String fragment=UI.getCurrent().getPage().getUriFragment();
    if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(fragment)) {
      target+="#" + UI.getCurrent().getPage().getUriFragment();
    }
    checkRole=true;
  }
 else {
    boolean workplace2=false;
    if (CmsFrameset.JSP_WORKPLACE_URI.equals(m_params.getRequestedResource()) && settings.getUserSettings().getStartView().equals(CmsWorkplace.VIEW_WORKPLACE_2)) {
      workplace2=true;
      checkRole=true;
    }
 else     if (m_params.getRequestedResource() != null) {
      target=m_params.getRequestedResource();
    }
 else     if (directEditPath != null) {
      target=directEditPath;
    }
 else {
      target=CmsFrameset.JSP_WORKPLACE_URI;
      checkRole=true;
    }
    UserAgreementHelper userAgreementHelper=new UserAgreementHelper(currentCms,settings);
    boolean showUserAgreement=userAgreementHelper.isShowUserAgreement();
    if (showUserAgreement) {
      target=userAgreementHelper.getConfigurationVfsPath() + "?" + CmsLoginUserAgreement.PARAM_WPRES+ "="+ target;
    }
    if (workplace2) {
      target=CmsVaadinUtils.getWorkplaceLink();
    }
 else {
      target=OpenCms.getLinkManager().substituteLink(currentCms,target);
    }
  }
  if (checkRole && !OpenCms.getRoleManager().hasRole(currentCms,CmsRole.WORKPLACE_USER)) {
    throw new CmsCustomLoginException(org.opencms.workplace.Messages.get().container(org.opencms.workplace.Messages.GUI_LOGIN_FAILED_NO_WORKPLACE_PERMISSIONS_0));
  }
  return target;
}

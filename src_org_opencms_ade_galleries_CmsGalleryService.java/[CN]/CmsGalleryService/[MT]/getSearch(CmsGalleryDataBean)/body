{
  CmsGallerySearchBean result=null;
  List<String> types=new ArrayList<String>();
  for (  CmsResourceTypeBean info : data.getTypes()) {
    types.add(info.getType());
  }
switch (data.getMode()) {
case editor:
case view:
case widget:
    String currentelement=data.getCurrentElement();
  try {
    if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(currentelement)) {
      log("looking up:" + currentelement);
      if (currentelement.startsWith(OpenCms.getSystemInfo().getOpenCmsContext())) {
        currentelement=currentelement.substring(OpenCms.getSystemInfo().getOpenCmsContext().length());
        log("removed context - result: " + currentelement);
      }
      result=findResourceInGallery(currentelement,data);
    }
    if ((result == null) || (result.getResults() == null) || result.getResults().isEmpty()) {
      result=new CmsGallerySearchBean();
      result.setIgnoreSearchExclude(true);
      String gallery=data.getStartGallery();
      if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(gallery)) {
        List<String> galleries=new ArrayList<String>();
        galleries.add(gallery);
        result.setGalleries(galleries);
      }
      if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(data.getStartFolder())) {
        Set<String> folders=new HashSet<String>();
        folders.add(data.getStartFolder());
        result.setFolders(folders);
      }
      result.setTypes(types);
      result.setLocale(data.getLocale());
      result.setScope(CmsGallerySearchScope.everything);
      result=search(result);
    }
    if (types.size() > 1) {
      result.setTypes(null);
    }
  }
 catch (  CmsException e) {
    logError(e);
    result=null;
  }
break;
case ade:
default :
break;
}
return result;
}

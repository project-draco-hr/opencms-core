{
  CmsGalleryDataBean data=new CmsGalleryDataBean();
  data.setMode(galleryMode);
  data.setLocales(buildLocalesMap());
  data.setLocale(getCmsObject().getRequestContext().getLocale().toString());
  data.setVfsRootFolders(getRootEntries());
  data.setScope(getWorkplaceSettings().getLastSearchScope());
  List<CmsResourceTypeBean> types=null;
switch (galleryMode) {
case editor:
case view:
case widget:
    data.setStartGallery(galleryPath);
  data.setCurrentElement(currentElement);
if (CmsStringUtil.isEmptyOrWhitespaceOnly(referencePath)) {
  referencePath=data.getStartGallery();
}
data.setReferenceSitePath(referencePath);
types=getResourceTypeBeans(galleryMode,data.getReferenceSitePath(),resourceTypes);
data.setTypes(types);
Map<String,CmsGalleryTypeInfo> galleryTypeInfos=readGalleryInfosByTypeBeans(types);
if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(galleryTypes)) {
Map<String,CmsGalleryTypeInfo> infos=new HashMap<String,CmsGalleryTypeInfo>();
String[] galleries=galleryTypes.split(",");
for (int i=0; i < galleries.length; i++) {
CmsGalleryTypeInfo typeInfo=galleryTypeInfos.get(galleries[i]);
if (typeInfo != null) {
infos.put(galleries[i],typeInfo);
}
}
galleryTypeInfos=infos;
}
data.setGalleries(buildGalleriesList(galleryTypeInfos));
data.setStartTab(GalleryTabId.cms_tab_results);
if (CmsStringUtil.isEmptyOrWhitespaceOnly(data.getStartGallery()) && !types.isEmpty()) {
String lastGallery=getWorkplaceSettings().getLastUsedGallery(types.get(0).getTypeId());
if (getCmsObject().existsResource(lastGallery)) {
data.setStartGallery(lastGallery);
}
}
if (CmsStringUtil.isEmptyOrWhitespaceOnly(data.getStartGallery()) && CmsStringUtil.isEmptyOrWhitespaceOnly(data.getCurrentElement())) {
data.setStartTab(GalleryTabId.cms_tab_galleries);
}
break;
case ade:
data.setReferenceSitePath(getCmsObject().getRequestContext().getUri());
types=getResourceTypeBeans(galleryMode,data.getReferenceSitePath(),resourceTypes);
data.setTypes(types);
data.setStartTab(GalleryTabId.cms_tab_types);
break;
default :
break;
}
CmsSiteSelectorOptionBuilder optionBuilder=new CmsSiteSelectorOptionBuilder(getCmsObject());
optionBuilder.addNormalSites(true);
optionBuilder.addSharedSite();
data.setVfsSiteSelectorOptions(optionBuilder.getOptions());
CmsSiteSelectorOptionBuilder sitemapOptionBuilder=new CmsSiteSelectorOptionBuilder(getCmsObject());
sitemapOptionBuilder.addNormalSites(false);
if (data.getReferenceSitePath() != null) {
sitemapOptionBuilder.addCurrentSubsite(getCmsObject().addSiteRoot(data.getReferenceSitePath()));
}
data.setSitemapSiteSelectorOptions(sitemapOptionBuilder.getOptions());
return data;
}

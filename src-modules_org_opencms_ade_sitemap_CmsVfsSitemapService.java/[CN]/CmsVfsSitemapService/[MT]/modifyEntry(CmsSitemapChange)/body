{
  CmsObject cms=getCmsObject();
  CmsResource entryPage=null;
  CmsResource entryFolder=null;
  try {
    if (hasPageChanges(change) && !change.isLeafType()) {
      entryPage=cms.readDefaultFile(change.getEntryId().toString());
      ensureLock(entryPage);
    }
 else     if (change.isLeafType()) {
      entryPage=cms.readResource(change.getEntryId());
      ensureLock(entryPage);
    }
    if (hasFolderChanges(change) && !change.isLeafType()) {
      entryFolder=cms.readResource(change.getEntryId());
      ensureLock(entryFolder);
    }
    if (change.isLeafType()) {
      entryFolder=entryPage;
    }
    if (entryPage != null) {
      cms.writePropertyObjects(cms.getSitePath(entryPage),generateOwnProperties(change));
    }
    if (entryFolder != null) {
      if (change.hasNewParent() || change.hasChangedName()) {
        String destinationPath;
        if (change.hasNewParent()) {
          CmsResource futureParent=cms.readResource(change.getParentId());
          destinationPath=CmsStringUtil.joinPaths(cms.getSitePath(futureParent),change.getName());
        }
 else {
          destinationPath=CmsStringUtil.joinPaths(CmsResource.getParentFolder(cms.getSitePath(entryFolder)),change.getName());
        }
        if (change.isLeafType() && destinationPath.endsWith("/")) {
          destinationPath=destinationPath.substring(0,destinationPath.length() - 1);
        }
        if (!cms.getSitePath(entryFolder).equals(destinationPath)) {
          cms.moveResource(cms.getSitePath(entryFolder),destinationPath);
        }
        entryFolder=cms.readResource(entryFolder.getStructureId());
      }
      cms.writePropertyObjects(cms.getSitePath(entryFolder),generateInheritProperties(change,entryFolder));
    }
  }
  finally {
    if (entryPage != null) {
      try {
        cms.unlockResource(entryPage);
      }
 catch (      CmsException e) {
        LOG.debug(e);
      }
    }
    if (entryFolder != null) {
      try {
        cms.unlockResource(entryFolder);
      }
 catch (      CmsException e) {
        LOG.debug(e);
      }
    }
  }
}

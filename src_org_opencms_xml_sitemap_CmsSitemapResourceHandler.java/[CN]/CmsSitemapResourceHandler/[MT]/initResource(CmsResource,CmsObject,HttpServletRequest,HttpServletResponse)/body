{
  boolean abort=(resource != null);
  abort|=CmsStringUtil.isEmptyOrWhitespaceOnly(cms.getRequestContext().getSiteRoot());
  abort|=cms.getRequestContext().getUri().startsWith(CmsWorkplace.VFS_PATH_SYSTEM);
  if (abort) {
    return resource;
  }
  try {
    CmsSitemapEntry entry=OpenCms.getSitemapManager().getEntryForUri(cms,cms.getRequestContext().getUri());
    if ((entry == null) || entry.isVfs()) {
      return resource;
    }
    resource=cms.readResource(entry.getStructureId());
    if (resource != null) {
      cms.getRequestContext().setUri(cms.getSitePath(resource));
      if (resource.isInternal()) {
        throw new CmsException(Messages.get().container(org.opencms.main.Messages.ERR_READ_INTERNAL_RESOURCE_1,cms.getRequestContext().getUri()));
      }
      if (cms.getRequestContext().currentProject().isOnlineProject()) {
        String secureProp=entry.getProperties(true).get(CmsPropertyDefinition.PROPERTY_SECURE);
        boolean secure=Boolean.valueOf(secureProp).booleanValue();
        if (secure) {
          CmsSite site=OpenCms.getSiteManager().getCurrentSite(cms);
          String secureUrl=null;
          try {
            secureUrl=site.getSecureUrl();
          }
 catch (          Exception e) {
            LOG.error(Messages.get().getBundle().key(org.opencms.main.Messages.ERR_SECURE_SITE_NOT_CONFIGURED_1,resource.getRootPath()),e);
            throw new CmsException(Messages.get().container(org.opencms.main.Messages.ERR_SECURE_SITE_NOT_CONFIGURED_1,resource.getRootPath()),e);
          }
          boolean usingSec=req.getRequestURL().toString().toUpperCase().startsWith(secureUrl.toUpperCase());
          if (site.isExclusiveUrl() && !usingSec) {
            if (site.isExclusiveError()) {
              throw new CmsVfsResourceNotFoundException(Messages.get().container(org.opencms.main.Messages.ERR_REQUEST_SECURE_RESOURCE_0));
            }
 else {
              String target=OpenCms.getLinkManager().getOnlineLink(cms,entry.getRootPath());
              try {
                res.sendRedirect(target);
                return null;
              }
 catch (              Exception e) {
              }
            }
          }
        }
      }
    }
    if (req != null) {
      req.setAttribute(CmsSitemapManager.ATTR_SITEMAP_ENTRY,entry);
    }
    cms.getRequestContext().setUri(cms.getSitePath(resource));
  }
 catch (  CmsPermissionViolationException e) {
    throw e;
  }
catch (  Throwable e) {
    String uri=cms.getRequestContext().getUri();
    CmsMessageContainer msg=Messages.get().container(Messages.ERR_SITEMAP_1,uri);
    LOG.error(msg.key(),e);
    throw new CmsResourceInitException(msg,e);
  }
  return resource;
}

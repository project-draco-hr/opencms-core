{
  boolean abort=(resource != null);
  abort|=CmsStringUtil.isEmptyOrWhitespaceOnly(cms.getRequestContext().getSiteRoot());
  abort|=cms.getRequestContext().getUri().startsWith(CmsWorkplace.VFS_PATH_SYSTEM);
  if (abort) {
    return resource;
  }
  try {
    CmsSiteEntryBean entry=OpenCms.getSitemapManager().getEntryForUri(cms,cms.getRequestContext().getUri());
    if ((entry == null) || entry.isVfs()) {
      return resource;
    }
    resource=cms.readResource(entry.getResourceId());
    if (req != null) {
      req.setAttribute(CmsSitemapManager.ATTR_SITEMAP_ENTRY,entry);
    }
    cms.getRequestContext().setUri(cms.getSitePath(resource));
  }
 catch (  Throwable e) {
    String uri=cms.getRequestContext().getUri();
    CmsMessageContainer msg=Messages.get().container(Messages.ERR_SITEMAP_1,uri);
    LOG.error(msg.key(),e);
    throw new CmsResourceInitException(msg,e);
  }
  return resource;
}

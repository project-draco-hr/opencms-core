{
  boolean abort=(resource != null);
  abort|=CmsStringUtil.isEmptyOrWhitespaceOnly(cms.getRequestContext().getSiteRoot());
  abort|=cms.getRequestContext().getUri().startsWith("/system/");
  if (abort) {
    return resource;
  }
  try {
    CmsSiteEntryBean entry=OpenCms.getSitemapManager().getEntryForUri(cms,cms.getRequestContext().getUri());
    if (entry == null) {
      return resource;
    }
    resource=cms.readResource(entry.getResourceId());
    req.setAttribute(CmsSitemapManager.ATTR_SITEMAP_ENTRY,entry.cloneWithoutSubEntries());
    req.setAttribute(CmsSitemapManager.ATTR_SITEMAP_CURRENT_URI,cms.getRequestContext().getUri());
    cms.getRequestContext().setUri(cms.getSitePath(resource));
  }
 catch (  Throwable e) {
    String uri=cms.getRequestContext().getUri();
    CmsMessageContainer msg=Messages.get().container(Messages.ERR_SITEMAP_1,uri);
    LOG.error(msg.key(),e);
    throw new CmsResourceInitException(msg,e);
  }
  return resource;
}

{
  String resource=getParamResource();
  String timeshiftPublishDate=getParamTimeshiftpublishdate();
  String userName=getCms().getRequestContext().currentUser().getName();
  DateFormat dateFormat=DateFormat.getDateTimeInstance(DateFormat.SHORT,DateFormat.SHORT,getCms().getRequestContext().getLocale());
  Date date=dateFormat.parse(timeshiftPublishDate);
  if (date.getTime() < new Date().getTime()) {
    throw new CmsException(Messages.get().container(Messages.ERR_PUBLISH_SCHEDULED_DATE_IN_PAST_1,date));
  }
  CmsWorkplaceAction action=CmsWorkplaceAction.getInstance();
  CmsObject cmsAdmin=action.getCmsAdminObject();
  CmsObject cms=OpenCms.initCmsObject(getCms());
  cmsAdmin.getRequestContext().setSiteRoot(cms.getRequestContext().getSiteRoot());
  String projectName="timeshiftpublish_" + date + "_"+ resource;
  projectName=projectName.replace("/","_");
  CmsProject tmpProject=cmsAdmin.createProject(projectName,"Timeshift publish project created for user " + cms.getRequestContext().currentUser().getName() + " for resource "+ resource+ ". Publish time is "+ date,CmsRole.WORKPLACE_USER.getGroupName(),CmsRole.PROJECT_MANAGER.getGroupName(),CmsProject.PROJECT_TYPE_TEMPORARY);
  tmpProject.setFlags(CmsProject.PROJECT_FLAG_HIDDEN);
  cmsAdmin.getRequestContext().setCurrentProject(tmpProject);
  cms.getRequestContext().setCurrentProject(tmpProject);
  cmsAdmin.copyResourceToProject(resource);
  CmsLock lock=cms.getLock(resource);
  if ((lock != null) && lock.isOwnedBy(cms.getRequestContext().currentUser()) && !lock.isOwnedInProjectBy(cms.getRequestContext().currentUser(),cms.getRequestContext().currentProject())) {
    cms.changeLock(resource);
  }
  cms.lockResource(resource);
  lock=cms.getLock(resource);
  CmsScheduledJobInfo job=new CmsScheduledJobInfo();
  String jobName=projectName;
  job.setJobName(jobName);
  job.setClassName("org.opencms.scheduler.jobs.CmsTimeShiftPublishJob");
  Calendar calendar=Calendar.getInstance();
  calendar.setTime(date);
  String cronExpr="" + calendar.get(Calendar.SECOND) + " "+ calendar.get(Calendar.MINUTE)+ " "+ calendar.get(Calendar.HOUR_OF_DAY)+ " "+ calendar.get(Calendar.DAY_OF_MONTH)+ " "+ (calendar.get(Calendar.MONTH) + 1)+ " "+ "?"+ " "+ calendar.get(Calendar.YEAR);
  job.setCronExpression(cronExpr);
  job.setActive(true);
  CmsContextInfo contextInfo=new CmsContextInfo();
  contextInfo.setProjectName(projectName);
  contextInfo.setUserName(cmsAdmin.getRequestContext().currentUser().getName());
  SortedMap params=new TreeMap();
  params.put(CmsTimeShiftPublishJob.PARAM_USER,userName);
  params.put(CmsTimeShiftPublishJob.PARAM_JOBNAME,jobName);
  params.put(CmsTimeShiftPublishJob.PARAM_LINKCHECK,"true");
  job.setParameters(params);
  job.setContextInfo(contextInfo);
  OpenCms.getScheduleManager().scheduleJob(cmsAdmin,job);
  return true;
}

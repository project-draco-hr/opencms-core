{
  byte[] result=null;
  CmsElementDefinitionCollection mergedElDefs=new CmsElementDefinitionCollection(elDefs,m_elementDefinitions);
  A_CmsCacheDirectives cd=getCacheDirectives();
  CmsElementVariant variant=null;
  if (cd.isInternalCacheable()) {
    checkReadAccess(cms);
    if (cd.isTimeCritical() && (m_timestamp < cd.getTimeout().getLastChange())) {
      if (this.hasDependenciesVariants()) {
        CmsXmlTemplateLoader.getOnlineElementCache().getElementLocator().removeElementFromDependencies(mergedElDefs.get(elementName).getDescriptor(),this);
      }
      clearVariantCache();
    }
 else {
      variant=getVariant(cd.getCacheKey(cms,parameters));
      if ((variant != null) && variant.isTimeCritical() && variant.getNextTimeout() < System.currentTimeMillis()) {
        CmsXmlTemplateLoader.getOnlineElementCache().getElementLocator().removeVariantFromDependencies(m_className + "|" + m_templateName+ "|"+ cd.getCacheKey(cms,parameters),variant);
        variant=null;
      }
    }
    if (variant != null) {
      result=resolveVariant(cms,variant,elementCache,mergedElDefs,parameters);
    }
  }
  if (variant == null) {
    I_CmsTemplate templateClass=null;
    try {
      templateClass=getTemplateClass(cms,m_className);
    }
 catch (    Throwable e) {
      if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL)) {
        OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,toString() + " Could not load my template class \"" + m_className+ "\". ");
        OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,e.toString());
        return e.toString().getBytes();
      }
    }
    try {
      parameters.put("_ELDEFS_",mergedElDefs);
      String templateSelector=null;
      try {
        templateSelector=mergedElDefs.get(elementName).getTemplateSelector();
      }
 catch (      Exception e) {
      }
      try {
        String theTemplate=m_templateName;
        if (theTemplate == null) {
          try {
            theTemplate=mergedElDefs.get("body").getTemplateName();
          }
 catch (          Exception exc) {
            if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL)) {
              OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,toString() + " could not find the body element to get the default templatefile for " + this.toString());
            }
          }
        }
        result=templateClass.getContent(cms,theTemplate,elementName,parameters,templateSelector);
      }
 catch (      Exception e) {
        if (e instanceof CmsException) {
          CmsException ce=(CmsException)e;
          if (ce instanceof CmsSecurityException) {
            if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_DEBUG)) {
              OpenCms.log(I_CmsLogChannels.C_OPENCMS_DEBUG,toString() + " Access denied in getContent for template class " + m_className);
            }
          }
 else {
            if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_INFO)) {
              OpenCms.log(I_CmsLogChannels.C_OPENCMS_INFO,toString() + " Error in getContent for template class " + m_className);
            }
          }
          throw ce;
        }
 else {
          if (OpenCms.isLogging(I_CmsLogChannels.C_OPENCMS_CRITICAL)) {
            OpenCms.log(I_CmsLogChannels.C_OPENCMS_CRITICAL,toString() + " Non OpenCms error occured in getContent for template class " + m_className);
          }
          throw new CmsException(CmsException.C_UNKNOWN_EXCEPTION,e);
        }
      }
    }
 catch (    CmsException e) {
      throw e;
    }
  }
  return result;
}

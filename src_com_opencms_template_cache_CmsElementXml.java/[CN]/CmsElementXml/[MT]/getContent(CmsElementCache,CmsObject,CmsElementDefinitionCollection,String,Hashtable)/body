{
  byte[] result=null;
  CmsElementDefinitionCollection mergedElDefs=new CmsElementDefinitionCollection(elDefs,m_elementDefinitions);
  I_CmsTemplate templateClass=null;
  try {
    templateClass=getTemplateClass(cms,m_className);
  }
 catch (  Throwable e) {
    if (com.opencms.core.I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
      A_OpenCms.log(C_OPENCMS_CRITICAL,toString() + " Could not load my template class \"" + m_className+ "\". ");
      A_OpenCms.log(C_OPENCMS_CRITICAL,e.toString());
      return e.toString().getBytes();
    }
  }
  CmsCacheDirectives cd=getCacheDirectives();
  boolean streamable=cms.getRequestContext().isStreaming();
  CmsElementVariant variant=null;
  if (cd.isInternalCacheable()) {
    checkReadAccess(cms);
    if (cd.isTimeCritical() && (m_timestamp < cd.getTimeout().getLastChange())) {
      clearVariantCache();
    }
 else {
      variant=getVariant(cd.getCacheKey(cms,parameters));
    }
    if (variant != null) {
      result=resolveVariant(cms,variant,elementCache,mergedElDefs,elementName,parameters);
    }
  }
  if (variant == null) {
    try {
      parameters.put("_ELDEFS_",mergedElDefs);
      try {
        result=templateClass.getContent(cms,m_templateName,elementName,parameters);
      }
 catch (      Exception e) {
        if (e instanceof CmsException) {
          CmsException ce=(CmsException)e;
          if (ce.getType() == ce.C_ACCESS_DENIED) {
            if (com.opencms.core.I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
              A_OpenCms.log(C_OPENCMS_DEBUG,toString() + " Access denied in getContent for template class " + m_className);
            }
          }
 else {
            if (com.opencms.core.I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
              A_OpenCms.log(C_OPENCMS_INFO,toString() + " Error in getContent for template class " + m_className);
            }
          }
          throw ce;
        }
 else {
          if (com.opencms.core.I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
            A_OpenCms.log(C_OPENCMS_CRITICAL,toString() + " Non OpenCms error occured in getContent for template class " + m_className);
          }
          throw new CmsException(CmsException.C_UNKNOWN_EXCEPTION,e);
        }
      }
    }
 catch (    CmsException e) {
      throw e;
    }
  }
  if (streamable) {
    try {
      cms.getRequestContext().getResponse().getOutputStream().write(result);
    }
 catch (    Exception e) {
      if (com.opencms.core.I_CmsLogChannels.C_PREPROCESSOR_IS_LOGGING && A_OpenCms.isLogging()) {
        A_OpenCms.log(C_OPENCMS_CRITICAL,this.toString() + " Error while streaming!");
      }
    }
    result=null;
  }
  return result;
}

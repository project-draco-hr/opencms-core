{
  if (cms.existsResource(resourcename)) {
    CmsResource res=cms.readResource(resourcename,filter);
    if (res.getTypeId() == CmsResourceTypeXmlPage.getStaticTypeId()) {
      return setFolder(res,true);
    }
    return null;
  }
 else {
    CmsResource xmlPage=findXmlPage(cms,resourcename);
    if (xmlPage != null) {
      if (resourcename.endsWith("/")) {
        resourcename=resourcename.substring(0,resourcename.length() - 1);
      }
      String path=getSubPath(cms,xmlPage,resourcename);
      CmsFile file=CmsFile.upgrade(xmlPage,cms);
      CmsXmlPage xml=CmsXmlPageFactory.unmarshal(cms,file);
      String[] tokens=path.split("/");
      if (tokens.length == 1) {
        if ((TMP_FILE_TABLE.containsKey(resourcename)) && (TMP_FILE_TABLE.get(resourcename).equals(new Integer(0)))) {
          return null;
        }
        if (tokens[0].equals(NAME_ELEMENT_CONTROLCODE)) {
          return setRootPath(xmlPage,xmlPage.getRootPath() + "/" + NAME_ELEMENT_CONTROLCODE);
        }
 else         if (tokens[0].equals(xmlPage.getName() + "." + EXTENSION_PROPERTIES)) {
          return createPropertyResource(cms,xmlPage);
        }
 else {
          Locale locale=new Locale(tokens[0]);
          if (xml.hasLocale(locale) && (file.getLength() > 0)) {
            return getResourceForLocale(xmlPage,locale);
          }
        }
      }
 else       if (tokens.length == 2) {
        String name=tokens[1];
        if (name.endsWith("." + EXTENSION_ELEMENT)) {
          name=name.substring(0,name.length() - 5);
        }
        if (xml.hasValue(name,new Locale(tokens[0]))) {
          String content=xml.getStringValue(cms,name,new Locale(tokens[0]));
          content=prepareContent(content,cms,xmlPage,false);
          return getResourceForElement(xmlPage,tokens[0],name,content.getBytes().length);
        }
      }
    }
    return null;
  }
}

{
  CmsXmlLanguageFile lang=new CmsXmlLanguageFile(cms);
  String moduleName="";
  moduleName=getClass().toString();
  moduleName=moduleName.substring(5);
  moduleName=moduleName.trim();
  moduleName=moduleName.replace('.','_');
  I_CmsSession session=cms.getRequestContext().getSession(true);
  String error="";
  String action=(String)parameters.get("action");
  if (action == null) {
    action="";
  }
 else   if (action.equals("exit")) {
    clearSession(session);
    templateSelector="done";
    return startProcessing(cms,template,"",parameters,templateSelector);
  }
  String id=(String)parameters.get("id");
  String channelId=(String)parameters.get("channelId");
  String resourceId=(String)parameters.get("resourceid");
  String nullUUIDStr=CmsUUID.getNullUUID().toString();
  String parentName=(String)parameters.get("parentName");
  if (parentName == null || parentName.equals("")) {
    parentName="/";
  }
  String channelname=(String)parameters.get("channelName");
  if (channelname == null) {
    channelname="";
  }
  if (!action.equals("") && channelname.trim().equals("")) {
    error=lang.getLanguageValue(moduleName + ".error.message2");
  }
  String title=(String)parameters.get("title");
  String owner=(String)parameters.get("owner");
  owner=(owner != null ? owner.trim() : "");
  String group=(String)parameters.get("groupId");
  group=(group != null ? group.trim() : "");
  int accessFlags=this.getAccessValue(parameters);
  if (id == null || id.equals("")) {
    id="new";
  }
  if (channelId == null || channelId.trim().equals("")) {
    channelId="-1";
  }
  if (resourceId == null || resourceId.trim().equals("")) {
    resourceId=nullUUIDStr;
  }
  if (id.equals("new")) {
    if (resourceId.equals(nullUUIDStr)) {
      m_channel=null;
    }
 else {
      id=resourceId;
    }
  }
  if (action.equals("") && !id.equals("new")) {
    m_channel=new CmsChannelContent(cms,new CmsUUID(id));
    parentName=m_channel.getParentName();
    m_channelId=m_channel.getChannelId();
    m_folderId=m_channel.getId();
    channelname=m_channel.getChannelName();
    title=m_channel.getTitle();
    owner=m_channel.getOwner().toString();
    group=m_channel.getGroupId().toString();
    accessFlags=m_channel.getAccessFlags();
  }
 else   if (m_channel == null) {
    m_channel=new CmsChannelContent(cms);
    m_channelId=C_UNKNOWN_ID + "";
    m_folderId=CmsUUID.getNullUUID();
  }
  session.putValue("parentName",parentName);
  session.putValue("id",m_folderId.toString());
  if (error.equals("") && !action.equals("")) {
    m_channel.setChannelId(m_channelId);
    m_channel.setParentName(parentName);
    m_channel.setChannelName(channelname);
    m_channel.setTitle(title);
    m_channel.setGroup(new CmsUUID(group));
    m_channel.setOwner(new CmsUUID(owner));
    m_channel.setAccessFlags(accessFlags);
  }
  String defaultGroup=cms.getRequestContext().currentGroup().getName();
  String defaultUser=cms.getRequestContext().currentUser().getName();
  Vector cmsGroups=cms.getGroups();
  String groupOptions="";
  for (int i=0; i < cmsGroups.size(); i++) {
    String groupName=((CmsGroup)cmsGroups.elementAt(i)).getName();
    CmsUUID groupId=((CmsGroup)cmsGroups.elementAt(i)).getId();
    template.setData("name",groupName);
    template.setData("value",groupId.toString());
    if (!group.equals("") && (cms.readGroup(new CmsUUID(group)).getName()).equals(groupName)) {
      template.setData("check","selected");
    }
 else     if (m_channelId.equals(C_UNKNOWN_ID + "") && groupName.equals(defaultGroup)) {
      template.setData("check","selected");
    }
 else {
      template.setData("check","");
    }
    groupOptions=groupOptions + template.getProcessedDataValue("selectoption",this);
  }
  template.setData("groups",groupOptions);
  String userOptions="";
  Vector cmsUsers=cms.getUsers();
  for (int i=0; i < cmsUsers.size(); i++) {
    String userName=((CmsUser)cmsUsers.elementAt(i)).getName();
    CmsUUID userId=((CmsUser)cmsUsers.elementAt(i)).getId();
    template.setData("name",userName);
    template.setData("value",userId.toString());
    if (!owner.equals("") && (cms.readUser(new CmsUUID(owner)).getName()).equals(userName)) {
      template.setData("check","selected");
    }
 else     if (m_channelId.equals(C_UNKNOWN_ID + "") && userName.equals(defaultUser)) {
      template.setData("check","selected");
    }
 else {
      template.setData("check","");
    }
    userOptions=userOptions + template.getProcessedDataValue("selectoption",this);
  }
  template.setData("users",userOptions);
  this.setAccessValue(template,m_channel.getAccessFlags());
  template.setData("channelId","" + m_channel.getChannelId());
  template.setData("resourceid",m_channel.getId().toString());
  template.setData("channelName",m_channel.getChannelName());
  template.setData("title",Encoder.escape(m_channel.getTitle(),cms.getRequestContext().getEncoding()));
  template.setData("parentName",m_channel.getParentName());
  template.setData("error",error);
  if (action.equals("saveexit") && error.equals("")) {
    try {
      m_channel.setChannelId(channelId);
      m_channel.write(cms);
      clearSession(session);
      templateSelector="done";
      return startProcessing(cms,template,"",parameters,templateSelector);
    }
 catch (    CmsException exc) {
      template.setData("channelId",channelId);
      template.setData("resourceid",m_channel.getId().toString());
      template.setData("channelName",channelname);
      template.setData("title",Encoder.escape(title,cms.getRequestContext().getEncoding()));
      template.setData("parentName",parentName);
      error=lang.getLanguageValue(moduleName + ".error.message3") + " " + exc.getShortException();
      template.setData("error",error);
      exc.printStackTrace(System.err);
    }
catch (    Exception e) {
      template.setData("channelId",channelId);
      template.setData("resourceid",m_channel.getId().toString());
      template.setData("channelName",channelname);
      template.setData("title",Encoder.escape(title,cms.getRequestContext().getEncoding()));
      template.setData("parentName",parentName);
      error=lang.getLanguageValue(moduleName + ".error.message3") + " " + e.getMessage();
      template.setData("error",error);
      e.printStackTrace(System.err);
    }
  }
  if (action.equals("save") && error.equals("")) {
    try {
      m_channel.setChannelId(channelId);
      m_channel.write(cms);
      m_channelId=m_channel.getChannelId();
      template.setData("channelId",m_channelId);
      template.setData("resourceid",m_channel.getId().toString());
      template.setData("newChannelId",m_channelId);
    }
 catch (    CmsException exc) {
      template.setData("channelId",channelId);
      template.setData("resourceid",m_channel.getId().toString());
      template.setData("channelName",channelname);
      template.setData("title",Encoder.escape(title,cms.getRequestContext().getEncoding()));
      template.setData("parentName",parentName);
      error=lang.getLanguageValue(moduleName + ".error.message3") + " " + exc.getShortException();
      template.setData("error",error);
      exc.printStackTrace(System.err);
    }
catch (    Exception e) {
      e.printStackTrace(System.err);
      template.setData("channelId",channelId);
      template.setData("resourceid",m_channel.getId().toString());
      template.setData("channelName",channelname);
      template.setData("title",Encoder.escape(title,cms.getRequestContext().getEncoding()));
      template.setData("parentName",parentName);
      error=lang.getLanguageValue(moduleName + ".error.message3") + " " + e.getMessage();
      template.setData("error",error);
    }
  }
  return startProcessing(cms,template,elementName,parameters,templateSelector);
}

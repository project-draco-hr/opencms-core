{
  CmsResource resource=null;
  CmsProperty locale=CmsProperty.getNullProperty();
  try {
    resource=getCmsObject().readResource(resourceName);
    locale=getCmsObject().readPropertyObject(resource,CmsPropertyDefinition.PROPERTY_LOCALE,true);
  }
 catch (  CmsException e) {
    logError(e);
  }
  CmsGallerySearchBean searchObj=new CmsGallerySearchBean(initialSearchObj);
  if (resource == null) {
    return searchObj;
  }
  String rootPath=resource.getRootPath();
  ArrayList<String> types=new ArrayList<String>();
  types.add(String.valueOf(resource.getTypeId()));
  searchObj.setTypes(types);
  ArrayList<String> galleries=new ArrayList<String>();
  galleries.add(CmsResource.getFolderPath(resourceName));
  searchObj.setGalleries(galleries);
  searchObj.setSortOrder(CmsGallerySearchParameters.CmsGallerySortParam.DEFAULT.toString());
  if (!locale.isNullProperty()) {
    searchObj.setLocale(locale.getValue());
  }
  int currentPage=1;
  boolean found=false;
  searchObj.setPage(currentPage);
  CmsGallerySearchParameters params=prepareSearchParams(searchObj);
  org.opencms.search.galleries.CmsGallerySearch searchBean=new org.opencms.search.galleries.CmsGallerySearch();
  searchBean.init(getCmsObject());
  searchBean.setIndex(ADVANCED_GALLERY_INDEX);
  CmsGallerySearchResultList searchResults=null;
  while (!found) {
    params.setResultPage(currentPage);
    searchResults=searchBean.getResult(params);
    Iterator<CmsGallerySearchResult> resultsIt=searchResults.listIterator();
    while (resultsIt.hasNext()) {
      CmsGallerySearchResult searchResult=resultsIt.next();
      if (searchResult.getPath().equals(rootPath)) {
        found=true;
        break;
      }
    }
    if (!found && (searchResults.getHitCount() / (currentPage * params.getMatchesPerPage()) >= 1)) {
      currentPage++;
    }
 else {
      break;
    }
  }
  CmsGallerySearchBean searchResultsObj=new CmsGallerySearchBean();
  if (found && (searchResults != null)) {
    searchResultsObj.setSortOrder(params.getSortOrder().name());
    searchResultsObj.setResultCount(searchResults.getHitCount());
    searchResultsObj.setPage(params.getResultPage());
    searchResultsObj.setResults(buildSearchResultList(searchResults));
    searchResultsObj.setPage(currentPage);
    searchResultsObj.setTabId(I_CmsGalleryProviderConstants.GalleryTabId.cms_tab_results.name());
  }
  return searchResultsObj;
}

{
  CmsGallerySearchBean result=new CmsGallerySearchBean();
  List<String> types=new ArrayList<String>();
  for (  CmsResourceTypeBean info : data.getTypes()) {
    types.add(info.getType());
  }
  result.setTypes(types);
switch (data.getMode()) {
case editor:
case view:
case widget:
    String gallery=getRequest().getParameter(ReqParam.gallerypath.name());
  if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(gallery)) {
    List<String> galleries=new ArrayList<String>();
    galleries.add(gallery);
    result.setGalleries(galleries);
  }
String currentelement=getRequest().getParameter(ReqParam.currentelement.name());
if (CmsStringUtil.isNotEmptyOrWhitespaceOnly(currentelement)) {
log("looking up:" + currentelement);
if (currentelement.startsWith(OpenCms.getSystemInfo().getOpenCmsContext())) {
  currentelement=currentelement.substring(OpenCms.getSystemInfo().getOpenCmsContext().length());
  log("removed context - result: " + currentelement);
}
CmsSitemapEntry entry=null;
try {
  entry=OpenCms.getSitemapManager().getEntryForUri(getCmsObject(),currentelement);
}
 catch (CmsException e) {
  logError(e);
}
if ((entry != null) && entry.isSitemap()) {
  log("is sitemap entry");
  result=findResourceInGallery(entry.getSitePath(getCmsObject()),result);
}
 else {
  log("is vfs path");
  result=findResourceInGallery(currentelement,result);
}
}
 else {
result=search(result);
}
result.setTypes(null);
break;
case ade:
result=search(result);
result.setTypes(null);
break;
case sitemap:
result=search(result);
result.setTypes(null);
break;
default :
break;
}
return result;
}
